var flexygo;!function(flexygo){!function(events){var subscribers=[],modules={};events.FlexygoEvent=class{constructor(eventClass,eventType,sender,masterIdentity,detailIdentity,firedBy){this.class=eventClass,this.type=eventType,this.sender=sender,this.masterIdentity=masterIdentity,this.detailIdentity=detailIdentity,this.firedBy=firedBy}},events.on=function(context,eventClass,eventType,callback){let event={class:eventClass,type:eventType};if(context&&event&&event.class&&event.type&&callback){let s={context,event,callback};subscribers.push(s);let dbg=$(document).find("#divflxeventviewer");if(dbg.length>0){let template='<div class="row"><div class="col-2"><span>{{now}}</span></div><div class="col-2"><span>{{action}}</span></div><div class="col-2" ><span>{{class}}</span></div><div class="col-2"><span>{{type}}</span></div><div class="col-2"><span title="{{infotitle}}">{{info}}</span></div><div class="col-2"><span>{{detail}}</span></div></div>';var dbgevt={now:moment().format("YYYY-MM-DD HH:mm:ss"),action:"Attach",class:eventClass,type:eventType,info:typeof context,infotitle:JSON.stringify(context),detail:""};let html=flexygo.utils.parser.compile(dbgevt,template);dbg.find("#header").after(html)}}},events.off=function(context,eventClass,eventType,callback){let initial=subscribers.length;if(context&&eventClass){let rest=[];$.each(subscribers,(i,e)=>{context===e.context?eventClass&&eventClass.length>0&&(eventClass!=e.event.class?"all"!==eventClass&&rest.push(e):eventType&&eventType.length>0&&eventType!=e.event.type&&"all"!==eventType&&rest.push(e)):rest.push(e)}),subscribers=rest}let final=initial-subscribers.length,dbg=$(document).find("#divflxeventviewer");if(dbg.length>0){let template='<div class="row"><div class="col-2"><span>{{now}}</span></div><div class="col-2"><span>{{action}}</span></div><div class="col-2" ><span>{{class}}</span></div><div class="col-2"><span>{{type}}</span></div><div class="col-2"><span>{{info}}</span></div><div class="col-2"><span>{{detail}}</span></div></div>';var dbgevt={now:moment().format("YYYY-MM-DD HH:mm:ss"),action:"Detach",class:eventClass,type:eventType,info:final,detail:""};let html=flexygo.utils.parser.compile(dbgevt,template);dbg.find("#header").after(html)}},events.trigger=function(event){if(event&&event.class&&event.type){let dbg=$(document).find("#divflxeventviewer");if(dbg.length>0){let template='<div class="row"><div class="col-2"><span>{{now}}</span></div><div class="col-2"><span>{{action}}</span></div><div class="col-2" ><span>{{class}}</span></div><div class="col-2"><span>{{type}}</span></div><div class="col-2"><span title="{{infotitle}}">{{info}}</span></div><div class="col-2"><span title="{{detailtitle}}">{{detail}}</span></div></div>',detail="string"==typeof event.detailIdentity||event.detailIdentity instanceof String?event.detailIdentity:"[Object]";detail&&detail.length>100&&(detail=detail.substring(0,100)+"....");var dbgevt={now:moment().format("YYYY-MM-DD HH:mm:ss"),action:"Trigger",class:event.class,type:event.type,info:event.masterIdentity,infotitle:JSON.stringify(event.masterIdentity),detail,detailtitle:JSON.stringify(event.detailIdentity)};let html=flexygo.utils.parser.compile(dbgevt,template);dbg.find("#header").after(html)}$.each(subscribers,(i,e)=>{"all"!==e.event.class&&e.event.class!==event.class||"all"!==e.event.type&&e.event.type!==event.type||(event.context=e.context,e.callback.call(e.context,event))}),$.each(modules,(i,e)=>{$.each(e.moduleConfig.Events,(j,ee)=>{if(!("all"!==ee.EventClass&&ee.EventClass!==event.class||"all"!==ee.EventType&&ee.EventType!==event.type)){let catched=!1;switch(event.class){case"entity":let entity=event.sender;(""===ee.ObjectFilter||entity&&entity.objectName&&ee.ObjectFilter.toLowerCase()===entity.objectName.toLowerCase())&&(catched=!0);break;case"property":catched=!0;break;case"process":let processName=event.masterIdentity;""!==ee.ProcessFilter&&ee.ProcessFilter.toLowerCase()!==processName.toLowerCase()||(catched=!0);break;case"module":let module=event.sender;""!==ee.ModuleFilter&&ee.ModuleFilter.toLowerCase()!==module.moduleConfig.ModuleName.toLowerCase()||(catched=!0);break;case"page":let page=event.sender;""!==ee.PageFilter&&ee.PageFilter.toLowerCase()!==page.PageName.toLowerCase()||(catched=!0);break;case"post":let postName=event.masterIdentity;""!==ee.MethodFilter&&ee.MethodFilter.toLowerCase()!==postName.toLowerCase()||(catched=!0);break;case"dialog":catched=!0}if(catched)switch(ee.EventAction){case"refresh":e.refresh();break;case"process":flexygo.nav.execProcess(ee.ProcessName,"entity"==event.class?event.masterIdentity:e.objectname,"entity"==event.class?event.detailIdentity:e.objectwhere,null,null,null,!1,$(e),null,null);break;default:console.warn("Event Action: "+ee.EventAction),flexygo.msg.error(flexygo.localization.translate("flxmodule.noparams"))}}})})}},events.registerModule=function(module){if(!modules.hasOwnProperty(module.uuid)){if(!module.moduleConfig||!module.moduleConfig.Events)return;Object.keys(module.moduleConfig.Events).length>0&&(modules[module.uuid]=module)}},events.unRegisterModule=function(module){modules.hasOwnProperty(module.uuid)&&delete modules[module.uuid]}}(flexygo.events||(flexygo.events={}))}(flexygo||(flexygo={}));