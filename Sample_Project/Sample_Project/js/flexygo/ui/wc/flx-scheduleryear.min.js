var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxSchedulerYearElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.moduleName=null,this.options=null,this.me=$(this),this.today=moment(),this.additionalWhere=null}connectedCallback(){let element=$(this);this.connected=!0,this.moduleName=element.attr("modulename"),this.data=element.attr("value"),"true"!=element.attr("manualInit")&&this.init()}static get observedAttributes(){return["modulename","value"]}attributeChangedCallback(attrName,oldVal,newVal){this.connected&&("modulename"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.moduleName=newVal,this.moduleName&&this.refresh()),"value"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.data=newVal,this.data&&this.refresh()))}refresh(){if("true"!=$(this).attr("manualInit")){let ctx=this,me=$(this);me.find(".calendar").remove(),me.find("flx-multicombo").remove(),ctx.me.filter=null,ctx.init()}}init(){let me=$(this);me.removeAttr("manualInit"),$(this).closest("flx-module").find(".flx-noInitContent").remove();let parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&wcModule.moduleLoaded(this);var thisYear=(new Date).getFullYear(),start=new Date("1/1/"+thisYear);this.me.current=moment(start.valueOf()),this.me.empty(),this.me.append('<div class="calendar"></div>'),this.render()}render(){let ctx=this,me=$(this);me.find(".calendar").calendar({showHeaders:!0,startYear:ctx.me.current.year(),maxYear:null,maxDay:null,maxMonth:null,maxDayMessage:"You can not choose day from future",minYear:null,minDay:null,minMonth:null,minDayMessage:"You can not choose day from past",boostrapVersion:4,cols:12,colsSm:12,colsMd:12,colsLg:12,colsXl:12,l10n:{jan:flexygo.localization.translate("flxscheduleryear.january"),feb:flexygo.localization.translate("flxscheduleryear.february"),mar:flexygo.localization.translate("flxscheduleryear.march"),apr:flexygo.localization.translate("flxscheduleryear.april"),may:flexygo.localization.translate("flxscheduleryear.may"),jun:flexygo.localization.translate("flxscheduleryear.june"),jul:flexygo.localization.translate("flxscheduleryear.july"),aug:flexygo.localization.translate("flxscheduleryear.august"),sep:flexygo.localization.translate("flxscheduleryear.september"),oct:flexygo.localization.translate("flxscheduleryear.october"),nov:flexygo.localization.translate("flxscheduleryear.november"),dec:flexygo.localization.translate("flxscheduleryear.december"),mn:flexygo.localization.translate("flxscheduleryear.mn"),tu:flexygo.localization.translate("flxscheduleryear.tu"),we:flexygo.localization.translate("flxscheduleryear.we"),th:flexygo.localization.translate("flxscheduleryear.th"),fr:flexygo.localization.translate("flxscheduleryear.fr"),sa:flexygo.localization.translate("flxscheduleryear.sa"),su:flexygo.localization.translate("flxscheduleryear.su")},maxDaysToChoose:!1,maxDaysToChooseMessage:"Maximum days to choose is: ",mode:"classic",addUniqueClassOnClick:!1}),me.find(".calendar").on("jqyc.changeYearToPrevious",function(event){ctx.me.current.add(-1,"y"),ctx.changeEvents(ctx.additionalWhere,ctx.me.filter)}),me.find(".calendar").on("jqyc.changeYearToNext",function(event){ctx.me.current.add(1,"y"),ctx.changeEvents(ctx.additionalWhere,ctx.me.filter)});let params={ModuleName:ctx.moduleName};flexygo.ajax.post("~/api/SchedulerYear","GetSchedulerCombo",params,response=>{response&&(response.ObjectName&&me.prepend('<div class="fc-toolbar fc-header-toolbar filter"><div class="a" style="text-align:left;" id="filters"><flx-multicombo class="combo padding-m" ObjectName="'+response.ObjectName+'" ViewName="'+response.ViewName+'" IconClass="flx-icon icon-role" SQLValueField="'+response.SQLValueField+'" SQLDisplayField="'+response.SQLDisplayField+'" SQLFilter="'+response.SQLFilterField+'" filtertype="dbcombo"><template>'+response.DirectTemplate+"</template></flx-multicombo></div></div>"),me.find('flx-multicombo[viewname="'+response.ViewName+'"]').find("div").on("change",function(){$(".calendar").find("tr *").removeAttr("style").removeClass("bg-outstanding txt-danger").popover("destroy"),$(".calendar").find("td *").css("width","26px");let filtros=this.closest("flx-multicombo").getValue();filtros&&(ctx.me.filter=filtros.split("|").join("','"),ctx.changeEvents(ctx.additionalWhere,ctx.me.filter))}))}),ctx.changeEvents(ctx.additionalWhere,ctx.me.filter)}changeEvents(additionalWhere,filter){let ctx=this,me=$(this),date=new Date(ctx.me.current);var start=ctx.formatDate(date,"01","01",date.getFullYear()),end=ctx.formatDate(date,"01","01",date.getFullYear()+1);let paramsHolidays={ModuleName:ctx.moduleName,Start:start,End:end};flexygo.ajax.post("~/api/SchedulerYear","GetSchedulerHolidays",paramsHolidays,response=>{if(response){ctx.me.holidays=response,ctx.me.holidays.forEach(function(ev){ev.date=moment(ev.Date)});let params={ObjName:me.attr("objectname"),ObjectWhere:me.attr("objectwhere"),ModuleName:ctx.moduleName,Start:start,End:end,AdditionalWhere:additionalWhere,Filter:filter};flexygo.ajax.post("~/api/SchedulerYear","GetSchedulerYearConfig",params,response=>{response&&(ctx.me.events=response,ctx.me.events.forEach(function(ev){ev.date=moment(ev.Date),ev.eventName=flexygo.utils.parser.recursiveCompile(ev.Row,ev.eventName)}),ctx.currentYear())})}})}currentYear(){let ctx=this;for(var clone=ctx.me.current.clone();clone.year()===ctx.me.current.year();)ctx.drawEvents(clone),clone.add("days",1)}drawEvents(day){let ctx=this,eventColor="",colores=1,me=$(this);if(day.year()===ctx.me.current.year()){var todaysEvents=ctx.me.events.reduce(function(memo,ev){return ev.date.isSame(day,"day")&&ev.date.isSame(day,"month")&&memo.push(ev),memo},[]),todaysHolidays=ctx.me.holidays.reduce(function(memo,ev){return ev.date.isSame(day,"day")&&ev.date.isSame(day,"month")&&memo.push(ev),memo},[]);if(0!=todaysHolidays.length&&todaysHolidays.forEach(function(ev){var month=ev.date.month()+1,date=ev.date.date();me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').addClass("txt-danger"),me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').css("font-weight","bold")}),0!=todaysEvents.length){var content=document.createElement("div");$(content).addClass("details"),todaysEvents.forEach(function(ev){var month=ev.date.month()+1,date=ev.date.date();""!=eventColor&&eventColor!=ev.color&&colores++,colores>1?(me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').find("div").css("background-color",""),me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').find("div").css("border-radius","60%"),me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').find("div").addClass("bg-outstanding"),me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').css("font-weight","normal")):(me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').find("div").css("background",ev.color),me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').find("div").css("border-radius","60%"),me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').css("font-weight","normal")),me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').css("color","color: #FFF");var div=document.createElement("div");$(div).addClass("event");var square=document.createElement("div");$(square).addClass("event-category").css("background",ev.color);var span=$("<span />").html(" "+ev.eventName);"edit"==ev.pageType&&ev.canEdit?$(div).click(function(){flexygo.nav.openPage(ev.pageType,ev.calendar,ctx.getObjectWhere(ev.table,ev.key,ev.id),null,ev.target,!1,$(this))}):"view"==ev.pageType&&ev.canView?$(div).click(function(){flexygo.nav.openPage(ev.pageType,ev.calendar,ctx.getObjectWhere(ev.table,ev.key,ev.id),null,ev.target,!1,$(this))}):"generic"==ev.pageType&&$(div).click(function(){new Function("objectname","objectwhere","calEvent","jsEvent","view",ev.OnClickJS).call(this,ev.calendar,ctx.getObjectWhere(ev.table,ev.key,ev.id),ev)}),eventColor=ev.color,$(div).append(square),$(div).append(span),$(content).append(div)});var month=day.month()+1,date=day.date();me.find('td[data-month="'+month+'"][data-day-of-month="'+date+'"]').popover({placement:"auto top",html:!0,trigger:"manual",content,container:".calendar"}).on("mouseenter touchstart",function(){var _this2=this;$(this).popover("show"),$(this).siblings(".popover").on("mouseleave",function(){$(_this2).popover("hide")})}).on("mouseleave",function(){var _this2=this,some_function=function(){setTimeout(function(){$(".popover:hover").length?some_function():$(_this2).popover("hide")},10)};some_function()}),me.find(".jqyc").on("touchmove",function(){me.find(".popover").remove()})}var monthDay=day.month()+1,dateDay=day.date();me.find('td[data-month="'+monthDay+'"][data-day-of-month="'+dateDay+'"]').attr("currentdate",day.format("YYYYMMDD")),me.find('td[data-month="'+monthDay+'"][data-day-of-month="'+dateDay+'"]').children().addClass("clickable"),me.find('td[data-month="'+monthDay+'"][data-day-of-month="'+dateDay+'"]').on("click",function(){let ev={class:"module",type:"selected",sender:ctx,masterIdentity:$(this).attr("currentdate"),detailIdentity:null};flexygo.events.trigger(ev)})}}getObjectWhere(table,key,id){let where="",last=0;for(var i=0;i<key.length;i++)where+=table+"."+key[i]+" = '"+id[i]+"'",++last<key.length&&(where+=" and ");return where}formatDate(date,month,day,year){return month.length<2&&(month="0"+month),day.length<2&&(day="0"+day),[year,month,day].join("")}translate(str){return flexygo.localization.translate(str)}startLoading(){$(this).parents("flx-module").length>0&&$(this).parents("flx-module")[0].startLoading()}stopLoading(){$(this).parents("flx-module").length>0&&$(this).parents("flx-module")[0].stopLoading()}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-scheduleryear",flexygo.ui.wc.FlxSchedulerYearElement);