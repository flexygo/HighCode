var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxSearchElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.orderObj=null,this.removeKeys=!1,this.activeFilter=null,this.searcher=null,this.filters=null,this.buttons=null,this.groups=null,this.viewId=null,this.presetId=null,this.presetText=null,this.presetIcon=null}connectedCallback(){let element=$(this);this.connected=!0,element.attr("modulename")&&""!=element.attr("modulename")?this.moduleName=element.attr("modulename"):this.moduleName="sysmod-objectsearch-generic",this.moduleName&&"true"!=element.attr("manualInit")&&this.init()}static get observedAttributes(){return["modulename"]}attributeChangedCallback(attrName,oldVal,newVal){this.connected&&this&&"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.moduleName=newVal,this.moduleName&&this.init())}init(){this.filterValues=null,this.activeFilter=null,this.pagesButtons=3,this.maxRows=0,this.maxPages=0,this.initGrid(!0)}refresh(){"true"!=$(this).attr("manualInit")&&(this.viewId=null,this.initGrid(!1))}setFilter(){"true"!=$(this).attr("manualInit")&&this.initGrid(!1)}initGrid(initMode){let me=$(this);me.removeAttr("manualInit"),this.page=0;let mode=me.attr("mode");mode&&""!=mode||(mode="object");let params={ObjectName:me.attr("ObjectName"),ObjectWhere:me.attr("ObjectWhere"),ModuleName:this.moduleName,PageName:flexygo.history.getPageName(me),Page:this.page,AdditionalWhere:"",OrderInfo:this.orderObj,Mode:mode,SearchId:this.activeFilter,FilterValues:this.filterValues};flexygo.ajax.post("~/api/List","GetSearch",params,response=>{if(response){if(response.Template){let template=response.Template;this.fields=template.TableColumns,this.data=template.TableData,this.tHeader=template.Header,this.tBody=template.Body,this.tFooter=template.Footer,this.tModuleClass=template.ModuleClass,this.objectname=template.ObjectName,this.cryptedSql=template.TableSQL,this.removeKeys=template.RemoveKeys,this.pageSize=template.PageSize,this.groups=template.Groups,this.viewId=template.DataViewName}let parentModule=me.closest("flx-module"),wcModule=parentModule[0];this.tModuleClass&&""!=this.tModuleClass&&parentModule.addClass(this.tModuleClass),initMode&&parentModule&&wcModule&&(response.Buttons&&wcModule.setButtons(response.Buttons,response.ObjectName,response.ObjectWhere),wcModule.setObjectDescrip(response.Title)),response.RowButtons&&(this.buttons=response.RowButtons),response.ViewList&&(this.viewList=response.ViewList),response.Pager&&(this.pagerConfig=response.Pager),response.Presets&&(this.presets=response.Presets),this.hasSearcher=response.Searcher,this.render(),this.loadSearcher(),this.loadPager(),this.loadCount(),initMode&&response.SearchSettings&&this.loadFilters(response.SearchSettings)}},null,()=>{this.stopLoading()},()=>{this.startLoading()})}startLoading(){$(this).parents("flx-module").length>0&&$(this).parents("flx-module")[0].startLoading()}stopLoading(){$(this).parents("flx-module").length>0&&$(this).parents("flx-module")[0].stopLoading()}render(){let me=$(this),rendered="";if(this.checkPresetDisplay(),this.presetId&&this.changePresetText(),this.data.length>0){if(this.tHeader&&""!=this.tHeader&&(rendered+=flexygo.utils.parser.recursiveCompile(this.data[0],this.tHeader,this)),this.tBody&&""!=this.tBody){let lastItem=null;if(this.data.length>0){rendered+=flexygo.utils.parser.paintGroupHeader(this.data[0],this.groups,this);for(let i=0;i<this.data.length;i++){let notExclude=!1;if(this.filter&&""!=this.filter){for(let key in this.data[i])if(-1!=String(this.data[i][key]).toLocaleLowerCase().indexOf(this.filter.toLocaleLowerCase())){notExclude=!0;break}}else notExclude=!0;notExclude&&(rendered+=flexygo.utils.parser.controlGroup(lastItem,this.data[i],this.groups,this),rendered+=flexygo.utils.parser.recursiveCompile(this.data[i],this.tBody,this),lastItem=this.data[i])}rendered+=flexygo.utils.parser.paintGroupFooter(this.data[this.data.length-1],this.groups,this)}}this.tFooter&&""!=this.tFooter&&(rendered+=flexygo.utils.parser.recursiveCompile(this.data[0],this.tFooter,this))}else rendered+='<div class="box-info"><i class="flx-icon icon-information-2 icon-lg icon-margin-right"></i><span><strong>Info!</strong> '+flexygo.localization.translate("flxlist.noentriesfound")+"</span></div>";me.html(rendered),me.find("[data-sort]").on("click",e=>{this.sort(e.currentTarget,$(e.currentTarget).data("sort"))}),this.sortColumn&&(this.sortAsc?me.find('[data-sort="'+this.sortColumn+'"]').addClass("sortAsc"):me.find('[data-sort="'+this.sortColumn+'"]').addClass("sortDsc"));let parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&wcModule.moduleLoaded(this)}sortByObj(orderInfo){this.sortColumn=null,this.orderObj=orderInfo,this.refresh()}sort(columnItem,property,ascMode){ascMode?this.sortAsc=ascMode:this.sortColumn==property?this.sortAsc=!this.sortAsc:this.sortAsc=!0,this.sortColumn=property;let orderProp={ObjectName:this.objectname,PropertyName:property,Asc:this.sortAsc};this.orderObj=[orderProp],this.refresh()}loadPager(){let me=$(this);this.pagerConfig&&(flexygo.utils.isSizeMobile()?this.pagesButtons=5:this.pagesButtons=this.pagerConfig.NumButtons);let template='<span class="firstPage"></span><span class="prevPage"></span><span class="pageButtons"></span><span class="nextPage"></span><span class="lastPage"></span><span class="pageInfo"><span class="activePage"></span>/<span class="numPages"></span>(<span class="numRows"></span>)</span>';if(this.pagerConfig&&this.pagerConfig.Template&&""!=this.pagerConfig.Template&&(template=this.pagerConfig.Template),(void 0===this.pager||null==this.pager)&&(this.pager=$('<div class="pager" />'),this.pagerConfig)){let pagerLocation;switch(this.pagerConfig.Position.toLowerCase()){case"moduleheader":pagerLocation=me.parents("flx-module").find(".cntButtons");break;case"listheader":pagerLocation=me.parents("flx-module").find(".cntBodyHeader");break;case"listfooter":pagerLocation=me.parents("flx-module").find(".cntBodyFooter")}pagerLocation.append(this.pager)}this.pager.empty(),this.pager.append(template),this.pager.find(".activePage").html((this.page+1).toString()),this.pager.find(".numPages").html(this.maxPages.toString()),this.pager.find(".numRows").html(this.maxRows.toString()),this.pager.find(".prevPage").on("click",()=>{this.previousPage()}),this.pager.find(".nextPage").on("click",()=>{this.nextPage()}),this.pager.find(".firstPage").on("click",()=>{this.firstPage()}),this.pager.find(".lastPage").on("click",()=>{this.lastPage()}),this.pager.attr("title",this.pager.find(".pageInfo").text()),this.refreshPager()}setPreset(presetName,presetText,presetIcon){this.presetId=presetName,this.presetText=presetText,this.presetIcon=presetIcon,this.initGrid(!1)}changePresetText(){let me=$(this),bt=me.closest("flx-module").find('[data-type="presets"] span:first');bt&&bt.html(this.presetText),me.closest("flx-module").find('[data-type="presets"] i:first').attr("class",this.presetIcon)}checkPresetDisplay(){void 0===this.presets&&$(this).closest("flx-module").find('[data-type="presets"]').remove()}loadCount(){let params={ObjectName:this.objectname,CryptedSql:this.cryptedSql,Filter:this.filters,ModuleName:this.moduleName,PageName:flexygo.history.getPageName($(this))};flexygo.ajax.post("~/api/List","GetCount",params,response=>{if(response){this.maxRows=response;let numPages=0;0==this.pageSize?numPages=this.maxRows:(numPages=Math.floor(Number(this.maxRows/this.pageSize)),this.maxRows%this.pageSize>0&&numPages++),this.maxPages=numPages,this.refreshPager()}})}nextPage(){this.loadPage(this.page+1)}previousPage(){this.loadPage(this.page-1)}firstPage(){this.loadPage(0)}lastPage(){this.loadPage(this.maxPages-1)}loadPage(newPage){this.page=newPage;let params={ObjectName:this.objectname,CryptedSql:this.cryptedSql,Page:this.page,PageSize:this.pageSize,RemoveKeys:this.removeKeys,Filter:this.filters,ModuleName:this.moduleName,PageName:flexygo.history.getPageName($(this))};flexygo.ajax.post("~/api/List","GetPageList",params,response=>{response&&(this.data=response,this.render(),this.refreshPager())},null,()=>{this.stopLoading()},()=>{this.startLoading()})}loadSearcher(){let me=$(this);if(this.hasSearcher){let template='<flx-genericsearch gridid="'+this.moduleName+'"  class="moduleSearcher"></flx-genericsearch>';this.searcher=$('<div class="listSearcher" />'),me.parents("flx-module").find(".cntBodyHeader").append(this.searcher),this.searcher.empty(),this.searcher.append(template)}}loadFilters(settings){this.searchSettings=settings;let module=$(this).closest("flx-module"),pane=module.find(".cntBodyHeader .filterPanel");0==pane.length&&(pane=$('<div class="filterPanel row" />'),module.find(".cntBodyHeader").append(pane));let flt=$("<flx-filter></flx-filter>");pane.append(flt);let fClt=flt[0];fClt.settings=settings,fClt.key=this.objectname+"-"+this.moduleName,fClt.grid=this,fClt.init()}paintHeader(row){let thead=$("<thead />"),tr=$('<tr class="rowHeader"/>');this.buttons&&tr.append("<th/>");for(let key in row)if("_objectname"!=key&&"_objectwhere"!=key&&"_guid"!=key&&"_ot"!=key){let td=$("<th />").html(key).attr("data-sort",key);tr.append(td)}return thead.append(tr),"<table><thead>"+thead.html()+"<thead><tbody>"}paintFooter(row){return"</tbody></table>"}paintBody(row){let me=$(this);me.closest(".cntBody").addClass("nopadding");let tbody=$("<tbody />"),tr=$("<tr/>"),defString=flexygo.history.getDefaults(row._objectname,me);if(this.buttons&&row._objectname&&row._objectwhere){let td=$("<td/>"),arrBtn=flexygo.utils.sortObject(this.buttons,"PositionId","Order");if(arrBtn.length>0){let btnGroup=$('<div class="btn-group" />');for(let i=0;i<arrBtn.length;i++)btnGroup.append(this._getButton(arrBtn[i],row._objectname,row._objectwhere,defString));td.append(btnGroup)}tr.append(td)}for(let key in row)if("_objectname"!=key&&"_objectwhere"!=key&&"_guid"!=key&&"_ot"!=key){let title=$("<b/>").html(key),val=this.getValue(row[key]),td=$("<td/>").append(title).append(val);tr.append(td)}return tbody.append(tr),tbody.html()}translate(str){return flexygo.localization.translate(str)}refreshPager(){this.pager.find(".activePage").html((this.page+1).toString()),this.pager.find(".numRows").html(this.maxRows.toString()),this.pager.find(".numPages").html(this.maxPages.toString());let iniBtn=this.page-Number(this.pagesButtons/2);iniBtn<0?iniBtn=0:iniBtn>this.maxPages-this.pagesButtons&&(iniBtn=this.maxPages-this.pagesButtons+1);let btns=this.pager.find(".pageButtons");btns.html("");for(let i=0;i<this.pagesButtons&&i<this.maxPages;i++)this._addBtns(btns,iniBtn+i);0==this.page?(this.pager.find(".prevPage").hide(),this.pager.find(".firstPage").hide()):(this.pager.find(".prevPage").show(),this.pager.find(".firstPage").show()),this.data.length<this.pageSize||this.maxPages==this.page?(this.pager.find(".nextPage").hide(),this.pager.find(".lastPage").hide()):(this.pager.find(".nextPage").show(),this.pager.find(".lastPage").show()),this.pager.attr("title",this.pager.find(".pageInfo").text())}_addBtns(btns,pageNum){let btn=$('<span class="pBtn">'+(pageNum+1)+"</span>");pageNum==this.page&&btn.addClass("active"),btn.on("click",()=>{this.loadPage(pageNum)}),btns.append(btn)}getValue(value){let type=typeof value;switch(type=type.toLowerCase(),(value&&-1!=value.toString().indexOf("/Date(")||value&&"function"==typeof value.getMonth)&&(type="00:00"!=moment(value).format("HH:mm")?"datetime":"date"),type){case"undefined":return"";case"boolean":return value?'<i class="flx-icon icon-checked-1"></i>':'<i class="flx-icon icon-non-check-2 "></i>';case"date":return moment(value).format("L");case"datetime":return moment(value).format("L")+" "+moment(value).format("LTS");default:return value}}_getButton(btn,objectname,objectwhere,objectdefaults){return $(this).closest("flx-module")[0].getButton(btn,objectname,objectwhere,objectdefaults)}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-search",flexygo.ui.wc.FlxSearchElement);