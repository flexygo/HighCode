var flexygo;!function(flexygo){var ui_1;ui_1=flexygo.ui||(flexygo.ui={}),(ui_1.wc||(ui_1.wc={})).FlxFilterManagerElement=class extends HTMLElement{constructor(){super(),this.tree=null,this.objcmb=null,this.cmb=null,this.typecmb=null,this.fields=null,this.choosebar=null,this.generic=!1,this.allSaved=!0,this.newValue=0,this.active="",this.resto=0}connectedCallback(){let element=$(this);this.objectname=element.attr("ObjectName"),this.active=element.attr("active"),this.generic=!1;let attr=element.attr("generic");attr&&"true"===attr&&(this.generic=!0),this.init()}init(){this.refresh()}refresh(){let me=$(this);me.append('<span class="label">'+flexygo.localization.translate("filtermanager.objectname")+":</span>"),me.append('<flx-dbcombo objectname="sysObject" viewname="sysOnlineCollections" sqlvaluefield="ObjectName" sqldisplayfield="Descrip"></flx-dbcombo>'),me.append('<span class="label">'+flexygo.localization.translate("filtermanager.choosefilter")+":</span>"),me.append('<div name="choosebar" class="row input-group"> <span class="input-group-addon clickable newFilter" > <i class="flx-icon icon-plus" /></span><span class="input-group-addon clickable editFilter"><i class="flx-icon icon-report-filters" /> </span><select class="filterCmb form-control"></select></div> '),me.append('<span class="label">'+flexygo.localization.translate("filtermanager.filtertype")+":</span>"),me.append('<select class="typefilterCmb form-control"></select><br/>'),me.append('<div class="col-5 box"><span class="label">'+flexygo.localization.translate("filtermanager.properties")+':</span><br/><ul class="objtree list-group"></ul></div>'),me.append('<div class="col-7 box fieldsFilter"><span class="label">'+flexygo.localization.translate("filtermanager.fields")+':</span><br/><ul class="filterFields list-group"></ul></div>'),me.closest("flx-objectmanager .tab-pane").length>0?(me.append('<div class="col-12 box"><button name="filtersave" class="btn btn-default bg-success"><i class="flx-icon icon-save" /> '+flexygo.localization.translate("filtermanager.save")+"</button></div>"),me.find("button[name='filtersave']").on("click",()=>{this.saveFilter()})):(me.closest(".ui-dialog").find("button[name='save']").on("click",()=>{this.saveFilter()}),me.closest(".ui-dialog").find("button[name='delete']").on("click",()=>{this.deleteFilter()})),me.find(".newFilter").on("click",()=>{this.newFilter()}),me.find(".editFilter").on("click",()=>{this.editFilter()}),this.objcmb=me.find("flx-dbcombo"),this.typecmb=me.find(".typefilterCmb"),this.tree=me.find(".objtree"),this.cmb=me.find(".filterCmb"),this.fields=me.find(".filterFields"),this.choosebar=me.find("[name='choosebar']"),!1===this.generic?(this.objcmb.hide(),this.objcmb.prev().hide(),this.typecmb.show(),this.typecmb.prev().show(),this.choosebar.show(),this.choosebar.prev().show(),this.loadObj(this.objectname,this.tree,!0),this.objcmb.off("change"),this.cmb.focus()):(this.objcmb.show(),this.objcmb.prev().show(),this.typecmb.hide(),this.typecmb.prev().hide(),this.choosebar.hide(),this.choosebar.prev().hide(),this.objcmb.focus(),this.objcmb.off("change").on("change",()=>{let value=this.objcmb.val();if(this.objectname!=value){this.objectname=value;let params={ObjectName:value,Generic:this.generic,NonGeneric:!this.generic};flexygo.ajax.post("~/api/Sys","getFilters",params,response=>{this.loadObj(this.objectname,this.tree,!0);let found=!1;response.Filters&&Object.keys(response.Filters).length>0&&$.each(response.Filters,(i,e)=>{if(!0===e.Generic)return this.loadFilter(e),found=!0,!1}),found||this.applyNewFilter(this.objectname+" generic search")})}})),this.getFilters()}getFilters(){let params={ObjectName:this.objectname,Generic:this.generic,NonGeneric:!this.generic};flexygo.ajax.post("~/api/Sys","getFilters",params,response=>{let previous;this.filtertypes=response.Types,this.types=response.FilterTypes,$.each(this.filtertypes,(i,e)=>{let opt=$("<option/>").html(e.Type).attr("value",e.Type);this.typecmb.append(opt)}),this.type=this.typecmb.val(),response.Filters&&$.each(response.Filters,(i,e)=>{let opt=$("<option/>");opt.html(e.Name),opt.attr("value",e.SearchId),opt.data("extvalue",e),this.active&&this.active.length>0&&this.active.toLowerCase()===e.SearchId.toLowerCase()&&opt.prop("selected",!0),this.cmb.append(opt)}),this.cmb.on("focus",()=>{previous=this.value}).change(()=>{if(this.allSaved||confirm(flexygo.localization.translate("filtermanager.unsaved"))){var sel=this.cmb.find("option:selected").data("extvalue");this.showProperties(),this.loadFilter(sel),this.hideProperties(),previous=this.value,this.allSaved=!0,this.active=this.value}else this.value=previous}),this.typecmb.change(()=>{let value=this.typecmb.val();switch(this.type=value,value){case"Text":this.fields.find("select").hide();break;case"Properties":this.fields.find("select").show()}}),this.objcmb[0].setValue(this.objectname),!0===this.generic&&(this.typecmb.val("Text"),this.typecmb.trigger("change")),this.loadFilter(this.cmb.find("option:selected").data("extvalue"))})}hideProperties(){let me=$(this);me.find("ul.filterFields.list-group.ui-sortable").children("li").each((i,li)=>{me.find(".objtree").find(".prop-filter").each((i,e)=>{if($(e).attr("Property")==$(li).attr("Property")&&$(e).attr("ObjectName")==$(li).attr("ObjectName"))return $(e).addClass("hidden"),!1})})}showProperties(){$(this).find(".objtree").find(".prop-filter.hidden").each((i,e)=>{$(e).removeClass("hidden")})}newFilter(){(this.allSaved||confirm(flexygo.localization.translate("filtermanager.unsaved")))&&flexygo.msg.prompt("New filter","Enter new filter's title",res=>{this.applyNewFilter(res)},"new title","")}applyNewFilter(name){if(""!=name){let newVal="newValue"+this.newValue;this.newValue++;let opt=$("<option/>").html(name).val(newVal);this.cmb.append(opt),this.fields.empty(),this.cmb.val(newVal).trigger("change")}}deleteFilter(){let success=!1;flexygo.msg.confirm("filtermanager.sure",result=>{if(result){if(1==this.cmb.is(":visible")&&this.cmb.find("option:selected").data("extvalue")){let id=this.cmb.find("option:selected").data("extvalue").SearchId;-1===id.toLowerCase().indexOf("newval")&&new flexygo.obj.Entity("sysGenericSearch","Objects_Search.SearchId='"+id+"'").delete()&&(success=!0)}else if(0==this.cmb.is(":visible")){let objname=this.objcmb.val();objname&&new flexygo.obj.Entity("sysGenericSearch","Objects_Search.ObjectName='"+objname+"' and Objects_Search.Generic<>0").delete()&&(success=!0)}else success=!0;success&&(this.cmb.find("option:selected").remove(),flexygo.msg.success("Deleted :)",null,null),this.cmb.find("option:selected").length>0?this.loadFilter(this.cmb.find("option:selected").data("extvalue")):this.fields.empty(),this.parentModule)&&this.parentModule[0].refresh()}})}editFilter(){flexygo.msg.prompt("Edit filter","Enter new filter's title",res=>{""!=res&&this.cmb.find("option:selected").text(res)},"edit title",this.cmb.find("option:selected").text())}saveFilter(){this.allSaved=!0;let itms=this.fields.find("li");if(!1===this.generic&&0==this.cmb.find("option:selected").length)flexygo.msg.error(flexygo.localization.translate("filtermanager.errornofilter"),null,null);else if(0==itms.length)flexygo.msg.error(flexygo.localization.translate("filtermanager.errornofields"),null,null);else{let fils=new Array,configs=new Array;$.each(itms,(i,e)=>{let li=$(e),ctl=li.data("extvalue"),fil={ObjectName:ctl.ObjectName,PropertyName:ctl.PropertyName,ObjectPath:ctl.ObjectPath,Size:ctl.Size,Order:i,Label:li.find("input").val(),OriginalLabel:li.find("input").val(),PropertySearchType:li.find("select").val(),Config:null};configs.push(ctl.Config),fils.push(fil)});let searchid=null,filtername=null;!0===this.generic&&this.genericFilter?(searchid=this.genericFilter.SearchId,filtername=this.genericFilter.Name):(searchid=this.cmb.val(),filtername=this.cmb.find("option:selected").text());let params={SearchId:searchid,FilterName:filtername,ObjectName:this.objectname,Type:this.type,Properties:fils,Generic:this.generic};flexygo.ajax.post("~/api/Sys","saveFilter",params,response=>{this.cmb.find("option:selected").val(response),params.Properties=fils,$.each(params.Properties,(i,prop)=>{prop.Config=configs[i]}),this.cmb.find("option:selected").data("extvalue",params),flexygo.msg.success("Saved :)",null,null),this.parentModule&&this.parentModule[0].refresh()})}}loadFilter(filter){!0===this.generic&&(this.genericFilter=filter),this.fields.empty(),filter&&($.each(filter.Properties,(i,e)=>{this.fields.append(this.createField(e))}),this.fields.sortable({update:(event,ui)=>{this.allSaved=!1}}),this.typecmb.val(filter.Type).trigger("change"),this.hideProperties())}loadObj(objectName,elem,first){if(elem.html(""),objectName){let params={ObjectName:objectName};flexygo.ajax.post("~/api/Sys","getRelatedObjetsAndProps",params,response=>{if(first){let bitm=$('<li class="list-group-item"></li>'),btn=$('<button class="btn btn-default bg-info"><i class="flx-icon icon-plus" /> '+flexygo.localization.translate("filtermanager.add")+"</button>");bitm.append(btn),btn.on("click",()=>{this.appendFields()}),elem.append(bitm)}for(let key in response.RelatedObjects){let prop=$("");1==response.RelatedObjects[key].ShowInAnalysis&&((prop=$('<li class="list-group-item objectFolder"></li>')).html('<span><i class="flx-icon icon-folder" /> '+key+"<span>"),prop.data("extvalue",response.RelatedObjects[key]),prop.addClass("obj-filter"),prop.find("span").on("click",e=>{let el=$(e.currentTarget).closest("li");if(el.find("i:first").toggleClass("icon-folder").toggleClass("icon-folder-2"),el.find("ul").length>0)el.find("ul:first").toggle();else{let itm=$('<ul class="list-group" />');this.loadObj(el.data("extvalue").ChildCollection,itm,!1),el.append(itm)}})),elem.append(prop)}let itm=$('<li class="list-group-item"></li>');for(let key in response.Properties)if("separator"!=response.Properties[key].ControlType&&"placeholder"!=response.Properties[key].ControlType){let obj=$("<div />");obj.html('<label><input type="checkbox" /> '+response.Properties[key].OriginalLabel+"</label>"),obj.data("extvalue",response.Properties[key]),obj.addClass("prop-filter"),obj.attr("ObjectName",response.Properties[key].ObjectName),obj.attr("Property",response.Properties[key].Name),itm.append(obj)}itm.on("click",ev=>{ev.stopPropagation()}),elem.append(itm);let bitm=$('<li class="list-group-item"></li>'),btn=$('<button class="btn btn-default bg-info"><i class="flx-icon icon-plus" /> '+flexygo.localization.translate("filtermanager.add")+"</button>");bitm.append(btn),btn.on("click",()=>{this.appendFields()}),elem.append(bitm),this.hideProperties()})}}appendFields(){let inp=this.tree.find("input:checked");$.each(inp,(i,e)=>{let div=$(e).closest("div"),prop=div.data("extvalue"),fld={ObjectName:prop.ObjectName,PropertyName:prop.Name,Label:prop.Label,OriginalLabel:prop.OriginalLabel,Order:this.fields.find(".filterField").length,PropertySearchType:prop.DefaultSearchType,Type:prop.DefaultSearchType,Config:prop,ObjectPath:this.findPath(div),Size:2},fil=this.createField(fld);fil.hide(),this.fields.append(fil),div.addClass("hidden")}),this.fields.find("li:not(:visible)").show("250"),inp.length>0&&(this.allSaved=!1),this.fields.sortable({update:(event,ui)=>{this.allSaved=!1}}),inp.prop("checked",!1)}createField(fld){let itm=$('<li class="list-group-item filterField" />');itm.data("extvalue",fld),itm.attr("ObjectName",fld.ObjectName),itm.attr("Property",fld.PropertyName),itm.html('<input class="form-control" type="text" value="'+fld.OriginalLabel+'" />');let cmd=$(' <select class="form-control" />');return $.each(this.types,(i,e)=>{let tmp=!1,tyCmd=fld.Config.SearchTypes.split("|");if($.each(tyCmd,(j,ee)=>{if(ee.toLowerCase()===e.PropertySearchType.toLowerCase())return tmp=!0,!1}),tmp){let opt=$("<option/>").html(e.Descrip).attr("value",e.PropertySearchType);cmd.append(opt)}}),cmd.val(fld.Type),"Text"===this.type&&cmd.hide(),itm.append(cmd),itm.append(' <span class="comment">('+flexygo.utils.parser.replaceAll(fld.ObjectPath,"|"," > ")+') <i class="flx-icon icon-trash clickable size-l" /></span>'),itm.find(".icon-trash").on("click",e=>{this.allSaved=!1;let li=$(e.currentTarget).closest("li");li.hide(250,()=>{li.remove()}),$(this).find(".objtree").find(".prop-filter.hidden").each((i,e)=>{if($(e).attr("Property")==$(li).attr("Property")&&$(e).attr("ObjectName")==$(li).attr("ObjectName"))return $(e).removeClass("hidden"),!1})}),itm}findPath(obj){let pathArr=new Array,parents=obj.parents("li.objectFolder");return $.each(parents,(i,e)=>{pathArr.unshift($(e).data("extvalue").ObjectName)}),pathArr.push(obj.data("extvalue").ObjectName),pathArr.join("|")}}}(flexygo||(flexygo={})),window.customElements.define("flx-filtermanager",flexygo.ui.wc.FlxFilterManagerElement);