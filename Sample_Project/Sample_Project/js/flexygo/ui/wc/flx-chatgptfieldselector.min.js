var flexygo,__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};!function(flexygo){var ui_1;ui_1=flexygo.ui||(flexygo.ui={}),(ui_1.wc||(ui_1.wc={})).FlxChatGPTFieldsElement=class extends HTMLElement{constructor(){super(),this.checkSintaxis=!1,this.previousOffset={top:null,left:null},this.tables=[],this.tableFields=[],this.typeFields=[],this.selectedFields=[],this.fields={}}connectedCallback(){let element=this;this.connected=!0,this.objectName=$(this).attr("ObjectName"),this.objectWhere=$(this).attr("ObjectWhere"),this.confModuleName=$(this).attr("ConfModuleName")?$(this).attr("ConfModuleName"):"",this.moduleName=$(this).attr("ModuleName"),this.paperScale=1,this.checkVisibilityConfig()&&(flexygo.events.off(this,"module","resized"),flexygo.events.off(this,"property","changed"),flexygo.events.off(this,"module","loaded"),flexygo.events.off(this,"module","refreshed"),$(window).off("resize.tables").on("resize.tables",function(){element.paperScale=1}),flexygo.events.on(this,"module","resized",function(e){this.refresh()}),flexygo.events.on(this,"module","refreshed",function(e){var _a,_b;let me=this,moduleConf=this.confModule?this.confModule:$($(this).closest("main")).find(`flx-module[modulename="${this.confModuleName}"]`).length>0?$($(this).closest("main")).find(`flx-module[modulename="${this.confModuleName}"]`)[0]:void 0;(null===(_b=null===(_a=null==e?void 0:e.sender)||void 0===_a?void 0:_a.moduleName)||void 0===_b?void 0:_b.toLowerCase())==this.confModuleName&&$(moduleConf).length>0&&$(moduleConf)[0]===e.sender&&flexygo.events.off(me,"property","changed")}),$("#mainContent").off("scroll.tables").on("scroll.tables",function(){let initialX=element.initialDimentions.wrapper.properties.translateX,initialY=element.initialDimentions.wrapper.properties.translateY;$(element).find(".wrapper").css("transform",`translate(${initialX+this.scrollLeft}px,${initialY+this.scrollTop}px)`),element.adjustWrapper()}),this.init())}disconnectedCallback(){flexygo.events.off(this,"module","resized"),$(window).off("resize.tables"),$("#mainContent").off("scroll.tables"),flexygo.events.off(this,"property","changed"),flexygo.events.off(this,"module","loaded"),flexygo.events.off(this,"module","refreshed")}observedAttributes(){return[]}attributeChangedCallback(attrName,oldVal,newVal){}init(refresh=!1){var _a,_b;return __awaiter(this,void 0,void 0,function*(){try{this.paperScale=1,$(this).removeAttr("manualInit"),$(this).closest("flx-module").find(".flx-noInitContent").remove(),$(this).closest("flx-module").removeClass("hidden"),yield this.getSavedTables(),this.render(),$(this).find(".tables-container").data("lastScale",this.paperScale),$(this).closest("flx-module").hasClass("fullscreen")&&$(this).find(".scroller-paper").css({height:"85vh",width:"97vw"}),$(this).find(".paper").css({height:3*$("#mainContent")[0].getBoundingClientRect().height,width:$("#mainContent")[0].getBoundingClientRect().width*(this.tables.length/2)>$(this).find(".scroller-paper").width()?$("#mainContent")[0].getBoundingClientRect().width*(this.tables.length/2):$(this).find(".scroller-paper").width()}),this.confModule=$(this).closest("main").find(`flx-module[modulename="${this.confModuleName}"]`);const module=this.closest("flx-module");module.skeleton&&(null===(_a=module.querySelector(".flxSkeleton"))||void 0===_a||_a.remove(),null===(_b=module.querySelector(".cntBody"))||void 0===_b||_b.classList.remove("displayingSkeleton")),this.renderTables(),this.adjustPaperSize(),this.getSelectedFields(),this.mainEvents(),this.updateDimentions(),this.centerOffset(),this.adjustWrapper(),this.adjustTablesPosition(),this.closest("flx-module").moduleLoaded(this)}catch(ex){console.log(ex)}})}refresh(){this.tables=[],this.tableFields=[],this.typeFields=[],this.selectedFields=[],this.fields={},this.checkVisibilityConfig()&&this.init(!0)}checkVisibilityConfig(){let entity=new flexygo.obj.Entity(this.objectName,this.objectWhere);return!(!entity.read()||!entity.data.CanAccessDB.Value&&($(this).closest("flx-module").addClass("hidden"),1))}render(){try{let me=$(this),rendered="";rendered=`<div class="scroller-paper">\n                                <div class="paper">\n                                    <div class="tables-container" scale="1" >\n                                    </div>\n                                    <div class="wrapper"></div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="tables-toolbar">\n                        <span class="tables-buttons">\n                            <b title="${flexygo.localization.translate("flxrelationship.zoomInButton")}" id="zoomInTables" class="flx-icon icon-zoom-1" ></b>\n                            <b title="${flexygo.localization.translate("flxrelationship.zoomOutButton")}" id="zoomOutTables" class="flx-icon icon-zoomout" ></b>\n                            <b title="${flexygo.localization.translate("flxchatgptfieldselector.addButton")}" id="addTables" class="flx-icon icon-plus-1"></b>\n                            <b title="${flexygo.localization.translate("flxchatgptfieldselector.clearButton")}" id="clearTables" class="flx-icon icon-clean-1" ></b>\n                            <b title="${flexygo.localization.translate("flxchatgptfieldselector.saveButton")}" id="saveTables" class="flx-icon icon-save" ></b>\n                        </span>\n                    </div>`,me.html(rendered)}catch(ex){console.log(ex)}}renderTables(){let renderedTables="",i=0;this.tables.forEach(tableName=>{let fieldLines="",j=0;this.tableFields[i].forEach(fieldName=>{let isForeignKey=!1,referencedField="",isPrimaryKey=!1;fieldName.startsWith("$")&&(isPrimaryKey=!0,fieldName=fieldName.substr(1)),-1!==fieldName.indexOf("$$")&&(isPrimaryKey=!0,fieldName=fieldName.replace("$$","$"));let count=0;for(let i=0;i<fieldName.length;i++)"$"===fieldName.charAt(i)&&count++;for(;count>=1;){let dollarPos=fieldName.indexOf("$");isForeignKey=!0,referencedField+=fieldName.substr(0,dollarPos)+"\n\t\t  ",fieldName=fieldName.substr(dollarPos+1),count--}let isSelected=-1!==this.selectedFields.indexOf(tableName+"."+fieldName);fieldLines+=`<li PropertyName="${tableName+"."+fieldName}" ${isSelected?'class="selectedProperty"':""} ${`title="${fieldName+(isForeignKey?"\nRelated to: "+referencedField:"")}"`}>\n                                            \n                                        <div class="chk">\n                                            <span><input type="checkbox" ${isSelected?"checked":""}/></span>\n                                        </div>    \n\n                                        <div class="nameProperties">\n                                            <span>${fieldName}</span>\n                                        </div>\n\n                                        <div class="typeProperties">\n                                            <span>${this.typeFields[i][j]}\n                                                ${isPrimaryKey?'<i class="flx-icon icon-key-2"></i>':""}\n                                                ${isForeignKey?'<i class="flx-icon icon-arrow-31"></i>':""}\n                                            </span>\n                                        </div>\n                                    </li>`,j++}),renderedTables+=`<div class="table parent-object" style="margin:0 4em 0 0;">\n                                <div class="tableTab"></div>\n                                <div class="tables-header" title="${tableName}">\n                                    <span class="title">${tableName}</span>\n                                </div>\n                                    <div class="properties">\n                                        <ul>\n                                            ${fieldLines}\n                                        </ul>\n                                    </div>\n                                </div>\n                            </div>`,i++}),$(this).find(".tables-container").html(renderedTables),$(this).find(".table .tables-header").each((i,element)=>{let headerDims=element.getBoundingClientRect(),titleDims=$(element).find(".title")[0].getBoundingClientRect();headerDims.width<titleDims.width&&($(element).css("justify-content","start"),$(element).find(".title").css({width:"100%","text-overflow":"ellipsis",overflow:"hidden"}),$(element).attr("title",$(element).closest(".table").attr("objectname")))}),$(this).find(".table .properties li").each((i,element)=>{let listItemDims=element.getBoundingClientRect(),spanDims=$(element).find("span")[0].getBoundingClientRect();listItemDims.width<spanDims.width&&$(element).attr("title",$(element).attr("propertyname"))})}updateDimentions(){let wrapperTransform=/\(([^)]+)\)/g.exec($(this).find(".wrapper").css("transform")),wrapperTranslateValues=wrapperTransform?wrapperTransform[1].split(","):null,wrapperTranslateX=0,wrapperTranslateY=0;wrapperTranslateValues&&wrapperTranslateValues.length>5?(wrapperTranslateX=parseInt(wrapperTranslateValues[4]),wrapperTranslateY=parseInt(wrapperTranslateValues[5])):this.initialDimentions&&this.initialDimentions.wrapper&&this.initialDimentions.wrapper.properties&&(wrapperTranslateX=this.initialDimentions.wrapper.properties.translateX,wrapperTranslateY=this.initialDimentions.wrapper.properties.translateY),this.initialDimentions={table:{properties:{width:flexygo.utils.parser.replaceAll($(this).find(".table").css("width"),"px","")},elementData:{ListItem:{selector:".table li",properties:{"font-size":flexygo.utils.parser.replaceAll($(this).find(".table li").css("font-size"),"px",""),padding:flexygo.utils.parser.replaceAll($(this).find(".table li").css("padding"),"px","")}},List:{selector:".table ul",properties:{padding:flexygo.utils.parser.replaceAll($(this).find(".table ul").css("padding"),"px","")}},TableTab:{selector:".table .tableTab",properties:{height:flexygo.utils.parser.replaceAll($(this).find(".table .tableTab").css("height"),"px","")}},Header:{selector:".table .tables-header",properties:{margin:flexygo.utils.parser.replaceAll($(this).find(".table .tables-header").css("margin"),"px","")}},Title:{selector:".table .title",properties:{"font-size":flexygo.utils.parser.replaceAll($(this).find(".table .title").css("font-size"),"px",""),padding:flexygo.utils.parser.replaceAll($(this).find(".table .title").css("padding"),"px","")}}},"parent-object":{properties:{margin:flexygo.utils.parser.replaceAll($(this).find(".table.parent-object").css("margin"),"px",""),height:$(this).find(".table.parent-object").height()}}},paper:{properties:{width:flexygo.utils.parser.replaceAll($(this).find(".paper").css("width"),"px",""),height:$(this).find(".paper").data("originalHeight")}},"tables-container":{properties:{width:$(this).find(".tables-container").width(),height:$(this).find(".tables-container").height(),padding:flexygo.utils.parser.replaceAll($(this).find(".tables-container").css("padding"),"px","")}},wrapper:{properties:{translateX:wrapperTranslateX,translateY:wrapperTranslateY}},input:{properties:{width:$(this).find("input").width(),height:$(this).find("input").height()}}}}mainEvents(){let me=this;$(this).find(".properties ul").off("mouseenter.toogleHover").on("mouseenter.toogleHover","li",function(){me.toogleOnHover(this,!0)}),$(this).find(".properties ul").off("mouseleave.toogleHover").on("mouseleave.toogleHover","li",function(){me.toogleOnHover(this,!1)}),$(this).find(".properties ul").off("click.addTables").on("click.addTables","li",function(){me.propertySelected(this,!1)}),$(this).find("i.flx-icon.icon-arrow-31").off("click.addTables").on("click.addTables",function(){me.relatedSelected(this)}),$(this).find(".tables-header").on("dblclick",function(){$(this).hasClass("allSelected")?($(this).removeClass("allSelected"),me.tableSelected($(this).closest(".table.parent-object"),!1)):($(this).addClass("allSelected"),me.tableSelected($(this).closest(".table.parent-object"),!0))}),$(this).find(".paper").off("mousewheel.paperZoom").on("mousewheel.paperZoom",function(e){let zoomLevel=me.paperScale;(e.originalEvent.wheelDelta||-e.originalEvent.detail)>0?zoomLevel+=.2:zoomLevel-=.2,zoomLevel=Math.min(Math.max(zoomLevel,.4),3),(me.paperScale>.4||me.paperScale<3)&&(me.paperScale=parseFloat(zoomLevel.toFixed(1)),me.resizePaper(e)),e.preventDefault()}),$(this).find('.tables-buttons [id="zoomInTables"]').off("click.zoomButton").on("click.zoomButton",function(e){let zoomLevel=me.paperScale;zoomLevel+=.2,zoomLevel=Math.min(Math.max(zoomLevel,.4),3),(me.paperScale>.4||me.paperScale<3)&&(me.paperScale=parseFloat(zoomLevel.toFixed(1)),me.resizePaper(e))}),$(this).find('.tables-buttons [id="zoomOutTables"]').off("click.zoomOutButton").on("click.zoomOutButton",function(e){let zoomLevel=me.paperScale;zoomLevel-=.2,zoomLevel=Math.min(Math.max(zoomLevel,.4),3),(me.paperScale>.4||me.paperScale<3)&&(me.paperScale=parseFloat(zoomLevel.toFixed(1)),me.resizePaper(e))}),$(this).find('.tables-buttons [id="addTables"]').off("click.addTables").on("click.addTables",function(){me.getTables()}),$(this).find('.tables-buttons [id="clearTables"]').off("click.clearTablesButton").on("click.clearTablesButton",function(){return __awaiter(this,void 0,void 0,function*(){yield me.clearTables()})}),$(this).find('.tables-buttons [id="saveTables"]').off("click.saveTablesButton").on("click.saveTablesButton",function(){return __awaiter(this,void 0,void 0,function*(){yield me.saveTables()})}),$(this).find(".paper").draggable({drag:function(event,ui){if(null==me.previousOffset.left)me.previousOffset.left=ui.offset.left,me.previousOffset.top=ui.offset.top;else{me.previousOffset.left=ui.offset.left,me.previousOffset.top=ui.offset.top;let parts=$(me).find(".paper").css("inset").split(" "),left=-1*parseInt(parts[0])+"px",right=-1*parseInt(parts[3])+"px",transformedValue=left+" "+parts[1]+" "+parts[2]+" "+right;$(me).find(".wrapper").css("inset",transformedValue),me.adjustWrapper()}},scroll:!1})}propertySelected(selectedProperty,onlySelect){let chk=$(selectedProperty).find('input[type="checkbox"]');onlySelect?($(selectedProperty).addClass("selectedProperty"),chk.prop("checked",!0)):($(selectedProperty).toggleClass("selectedProperty"),$(selectedProperty).hasClass("selectedProperty")?chk.prop("checked",!0):chk.prop("checked",!1)),this.getSelectedFields()}relatedSelected(selectedProperty){return __awaiter(this,void 0,void 0,function*(){let titulo=$(selectedProperty).closest("li").attr("title");this.propertySelected($(selectedProperty).closest("li"),!0),yield this.saveTables();const lines=titulo.split("\n");let names=new Set;lines.forEach(line=>{let trimmedLine=line.trim();if(trimmedLine.includes(":")){const parts=trimmedLine.split(":");trimmedLine=parts[1].trim()}if(trimmedLine.includes(".")){const parts=trimmedLine.split(".");names.add(parts[0]+";"+parts[1]+"@int")}}),names.size>0&&this.addNewTables(names)})}tableSelected(selectedTable,select){select?$(selectedTable).find(".properties ul").find("li").each(function(){$(this).addClass("selectedProperty"),$(this).find('input[type="checkbox"]').prop("checked",!0)}):$(selectedTable).find(".properties ul").find("li").each(function(){$(this).removeClass("selectedProperty"),$(this).find('input[type="checkbox"]').prop("checked",!1)}),this.getSelectedFields()}adjustPaperSize(){let currentPaperDimentions={width:0,height:0};this.initialDimentions?(currentPaperDimentions.width=parseFloat(this.initialDimentions.paper.properties.width),currentPaperDimentions.height=parseFloat(this.initialDimentions.paper.properties.height)):(currentPaperDimentions.width=$(this).find(".paper")[0].getBoundingClientRect().width,currentPaperDimentions.height=$(this).find(".paper")[0].getBoundingClientRect().height);let widthDiff=currentPaperDimentions.width-flexygo.utils.parser.replaceAll($(this).find(".tables-container").css("width"),"px",""),heightDiff=currentPaperDimentions.height-flexygo.utils.parser.replaceAll($(this).find(".tables-container").css("height"),"px","");if(widthDiff<400){let increaseSize=400;widthDiff<0&&(increaseSize-=widthDiff),$(this).find(".paper").css("height",currentPaperDimentions.width+increaseSize)}if(heightDiff<400){let increaseSize=400;heightDiff<0&&(increaseSize-=heightDiff),$(this).find(".paper").css("height",currentPaperDimentions.height+increaseSize)}}adjustTablesPosition(){let conteinerHeight=0,scrollerHeight=$(this).find(".scroller-paper")[0].getBoundingClientRect().height;if(scrollerHeight<(conteinerHeight=this.initialDimentions?this.initialDimentions["tables-container"].properties.height:$(this).find(".tables-container")[0].getBoundingClientRect().height)){$(this).find(".tables-container").css("top",0);let scrollerRects=$(this).find(".scroller-paper")[0].getBoundingClientRect(),newTop=-$(this).find(".tables-container")[0].getBoundingClientRect().top+scrollerRects.top+10;$(this).find(".tables-container").css("top",newTop);let maximumTablesHeight=3*conteinerHeight+newTop;if(scrollerHeight<maximumTablesHeight){let newHeight=scrollerHeight+Math.abs(conteinerHeight-maximumTablesHeight);$(this).find(".paper").css("height",newHeight+300+"px")}this.tablesPositioned=!0}else $(this).find(".tables-container").css("top",""),this.centerOffset(),this.tablesPositioned=!1}adjustWrapper(){let wrapper=$(this).find(".wrapper");wrapper.css({inset:"",transform:""});let translateX=`${wrapper[0].getBoundingClientRect().left+pageXOffset}`,translateY=`${wrapper[0].getBoundingClientRect().top+pageYOffset}`;this.initialDimentions&&this.tablesPositioned&&(this.initialDimentions.wrapper.properties.translateX=-translateX,this.initialDimentions.wrapper.properties.translateY=-translateY),wrapper.css("transform",`translate(-${translateX}px,-${translateY}px)`)}resizePaper(event){let currentScale=parseFloat($(this).find(".tables-container").attr("scale"));if((.4==currentScale||3==currentScale)&&currentScale==this.paperScale)return;let $container=$(this).find(".tables-container");$container.data("lastScale",currentScale);for(let key in this.initialDimentions.table.elementData){let element=this.initialDimentions.table.elementData[key];for(let property in element.properties){let value=element.properties[property];this.scaleStyle(element.selector,property,value)}}this.scaleStyle(".table","width",this.initialDimentions.table.properties.width),this.scaleStyle(".table.parent-object","top",flexygo.utils.parser.replaceAll($(this).find(".table.parent-object").css("top"),"px",""),currentScale),this.scaleStyle(".table.parent-object","left",flexygo.utils.parser.replaceAll($(this).find(".table.parent-object").css("left"),"px",""),currentScale),this.scaleStyle("input","height",this.initialDimentions.input.properties.height),this.scaleStyle("input","width",this.initialDimentions.input.properties.width),$container.attr("scale",this.paperScale)}scaleStyle(element,property,initialValue,currentScale=null){let result="";initialValue=initialValue||0;for(let currentVal of initialValue.toString().split(" "))result+=(currentScale?currentVal/currentScale*this.paperScale:currentVal*this.paperScale)+"px ";$(this).find(element).css(property,result)}toogleOnHover(element,onHover){if(onHover){let index=$(element).index();element.closest("div").classList.value,$($(element).closest(".properties")).find("ul li").eq(index).addClass("active")}else{let index=$(element).index();element.closest("div").classList.value,$($(element).closest(".properties")).find("ul li").eq(index).removeClass("active")}}centerOffset(element=null){let context=element&&"flx-chagptfieldselector"==element.tagName.toLowerCase()?$(element)[0]:this;if(context){let container=$(context).find(".scroller-paper")[0];container.scrollLeft=(container.scrollWidth-container.clientWidth)/2,container.scrollTop=(container.scrollHeight-container.clientHeight)/2}}clearTables(){return __awaiter(this,void 0,void 0,function*(){this.fields={},yield this.saveTables()})}getSelectedFields(){let selectedFields=$(this).find(".table .properties ul .selectedProperty"),allFields={};selectedFields.each(function(){let propertyName=$(this).attr("propertyname");if(propertyName){let parts=propertyName.split(".");allFields.hasOwnProperty(parts[0])?allFields[parts[0]].push(parts[1]):allFields[parts[0]]=[parts[1]]}}),this.fields=allFields}getTables(){var loadingProcessPage=setInterval(()=>{if($('[modulename="sysmod-edit-processparams"]').length>0){let modal=$('[modulename="sysmod-edit-processparams"]').closest(".flx-dialog-modal"),container=$(modal).find("main");flexygo.utils.showLoadingEffect(0,container[0],null,null,!0),$(modal).find(".ui-dialog-title").html(`${flexygo.localization.translate("utils.loading")}...`),clearInterval(loadingProcessPage)}},1);flexygo.nav.execProcess("sysChatGPT_getTablesAndFields",this.objectName,this.objectWhere,null,null,"modal640x480",!1,$(this),null,!1,null,null)}saveTables(){return __awaiter(this,void 0,void 0,function*(){let params=[];params.push({key:"SettingId",value:this.confModule.find('[property="SettingId"]').val()},{key:"Json",value:JSON.stringify(this.fields)}),yield flexygo.nav.execProcess("sysChatGPT_saveTablesAndFields",this.objectName,this.objectWhere,null,params,"popup",!1,$(this),response=>{flexygo.msg.success(flexygo.localization.translate("flxmodule.saved"))},!1),this.tables=[],this.tableFields=[],this.typeFields=[],this.selectedFields=[],this.fields={},yield this.getSavedTables(),this.getSelectedFields();let mod=$(this).closest("flx-module")[0];yield mod.refresh(),yield this.refresh()})}getSavedTables(){return __awaiter(this,void 0,void 0,function*(){return new Promise((resolve,reject)=>{let SQLValidatorparams={objectWhere:this.objectWhere};flexygo.ajax.syncPost("~/api/AI","GetSavedTables",SQLValidatorparams,response=>{if(""!==response){let all=response.split("@"),selectedfields=all[1].split(";");selectedfields.pop();let newTables=all[0].split("|");newTables.pop();let typefields=all[2].split("|");typefields.pop(),newTables.forEach(tables=>{let nameAndColumns=tables.split(";");nameAndColumns.pop();let names=[nameAndColumns.shift()];this.tables.push(names[0]);let fields=[nameAndColumns];this.tableFields.push(...fields)}),typefields.forEach(table=>{let types=table.split(";");types.pop(),this.typeFields.push(...[types])}),this.selectedFields.push(...selectedfields)}resolve(!0)},err=>{reject(err)})})})}addNewTables(names){return __awaiter(this,void 0,void 0,function*(){names.forEach(tables=>{let typesAndTables=tables.split("@"),nameAndColumns=typesAndTables[0].split(";"),fieldTypes=typesAndTables[1].split(";"),names=[nameAndColumns.shift()];this.tables=Array.from(new Set([...this.tables,...names]));let fields=[nameAndColumns];this.tableFields=Array.from(new Set([...this.tableFields,...fields]));let types=[fieldTypes];this.typeFields=Array.from(new Set([...this.typeFields,...types]));let save=names[0]+"."+fields[0];this.selectedFields.push(...[save])}),this.renderTables(),this.getSelectedFields(),yield this.saveTables()})}}}(flexygo||(flexygo={})),window.customElements.define("flx-chatgptfieldselector",flexygo.ui.wc.FlxChatGPTFieldsElement);