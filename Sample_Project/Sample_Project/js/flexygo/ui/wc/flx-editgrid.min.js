var flexygo;!function(flexygo){!function(ui){!function(wc_1){(ui.wc||(ui.wc={})).FlxEditGridElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.tbName=null,this.canDelete=null,this.canInsert=null,this.canUpdate=null,this.canPrint=null,this.sortColumnId=null,this.sortAsc=!1,this.filter=null,this.data=null,this.refreshing=null}connectedCallback(){let elem=$(this);this.connected=!0;let tableName=elem.attr("tablename");tableName&&""!=tableName?(this.load(tableName),elem.html(flexygo.utils.loadingMsg())):elem.html("TableName is missing")}static get observedAttributes(){return[]}attributeChangedCallback(attrName,oldVal,newVal){this.connected}load(tbName){this.tbName=tbName,this.loadSchema()}loadSchema(){let params={tablename:this.tbName};flexygo.ajax.post("~/api/MasterTable","GetSettings",params,response=>{this.schema=response.TableFields,this.canDelete=response.canDelete,this.canInsert=response.canInsert,this.canUpdate=response.canUpdate,this.canPrint=response.canPrint,this.loadData()})}loadData(){flexygo.ajax.post("~/api/MasterTable","GetTableData",{tablename:this.tbName},response=>{this.loadRet(response)})}loadRet(rsp){this.data=rsp,this.refresh()}selectAll(elm){$(elm).closest("table").find("tr td:first-child input").prop("checked",!0),$(elm).closest("table").find("tr:not(.rowInsert):not(.rowHeader)").addClass("selected"),$("#mainFooterMenu")[0].show(),this.refreshColMenu($(elm).closest("table"))}selectNone(elm){$(elm).closest("table").find("tr td:first-child input").prop("checked",!1),$(elm).closest("table").find("tr:not(.rowInsert):not(.rowHeader)").removeClass("selected"),$("#mainFooterMenu")[0].hide()}cancelEdit(elm){let row=$(elm).closest("tr");row.removeClass("rowEdit"),row.find("td:not(:first-child) span").show(),row.find("td:not(:first-child) input").remove(),row.find("td:not(:first-child) select").remove(),this.refreshColMenu($(elm).closest("table"))}clearInsert(elm){let row=$(elm).closest("tr"),cells=row.find("td");for(let i=1;i<cells.length;i++){let ctl=$(cells[i]).find("input");ctl.length>0?ctl.attr("checkbox")?ctl.prop("checked",ctl.attr("default")):ctl.val(ctl.attr("default")):(ctl=$(cells[i]).find("select")).val(ctl.attr("default"))}row.closest("table").find(".rowInsert input:first").focus(),this.refreshColMenu($(elm).closest("table"))}edit(elm){let row=$(elm).closest("tr");row.addClass("rowEdit"),row.find("td:not(:first-child) span").hide(),row.find("td:not(:first-child) input").remove(),row.find("td:not(:first-child) select").remove();let cells=row.find("td");for(let i=1;i<cells.length;i++){let key=$(elm).closest("table").find("tr th:nth-child("+(i+1)+")").attr("name"),ctl=this.getControl(this.schema[key],$(cells[i]).attr("value"));$(cells[i]).append(ctl),i==cells.length-1&&ctl.on("keydown",e=>{9==(e.keyCode||e.which)&&this.update(row.find('td i[class*="save"]')[0],!0)})}for(let key in this.schema)this.getControl(this.schema[key]);this.refreshColMenu($(elm).closest("table"))}insert(elm){let me=$(this),cells=$(elm).closest("tr").find("td"),props=new Array;for(let i=1;i<cells.length;i++){let ctl=$(cells[i]).find("input");0==ctl.length&&(ctl=$(cells[i]).find("select"));let key=$(elm).closest("table").find("tr th:nth-child("+(i+1)+")").attr("name"),newValue=ctl.val();"checkbox"==ctl.attr("type")&&(newValue=ctl.prop("checked")),props.push({key,value:newValue})}let params={tablename:this.tbName,values:props};flexygo.ajax.post("~/api/MasterTable","Insert",params,response=>{let index=this.data.length;this.data[index]=response;let row=this.getRow(response,index);row.hide(),me.find(".rowInsert").before(row),row.show(1e3),this.clearInsert(elm)})}update(elm,hideMsg){let row=$(elm).closest("tr"),keys=row.data("keys"),cells=row.find("td"),props=new Array;for(let i=1;i<cells.length;i++){let ctl=$(cells[i]).find("input");0==ctl.length&&(ctl=$(cells[i]).find("select"));let key=$(elm).closest("table").find("tr th:nth-child("+(i+1)+")").attr("name"),originalValue=$(cells[i]).attr("value"),newValue=ctl.val();"checkbox"==ctl.attr("type")&&(newValue=ctl.prop("checked")),newValue!=originalValue&&props.push({key,value:newValue})}if(0==props.length)hideMsg?setTimeout(()=>{this.cancelEdit(elm)},500):flexygo.msg.alert("No se ha realizado ningÃºn cambio en la linea.");else{let params={tablename:this.tbName,keys,values:props};flexygo.ajax.post("~/api/MasterTable","Update",params,response=>{let oldRow=$(elm).closest("tr"),index=oldRow.data("index"),row=this.getRow(response,index);oldRow.animate({backgroundColor:flexygo.colors.success},700,()=>{oldRow.animate({backgroundColor:"none"},700,()=>{oldRow.replaceWith(row),this.data[index]=response,this.refreshColMenu($(elm).closest("table"))})})},error=>{flexygo.exceptions.httpShow(error,$(elm))})}}delete(elm,confirmed){let resultCallback=result=>{let keys=$(elm).closest("tr").data("keys"),params={tablename:this.tbName,keys};flexygo.ajax.post("~/api/MasterTable","Delete",params,response=>{let tr=$(elm).closest("tr");tr.hide(1e3,()=>{let index=tr.data("index");tr.data[index]=null,tr.remove(),this.refreshColMenu($(elm).closest("table"))})})};confirmed?resultCallback.call(this,confirmed):flexygo.msg.confirm(flexygo.localization.translate("flxeditgrid.deleteconfirm"),resultCallback)}editAll(){$(this).find('table tr:not(.rowInsert) td:first-child input[type="checkbox"]:checked').each((i,e)=>{this.edit(e)})}uneditAll(){$(this).find('table tr.rowEdit td:first-child input[type="checkbox"]:checked').each((i,e)=>{this.cancelEdit(e)})}saveAll(){$(this).find('table tr.rowEdit td:first-child input[type="checkbox"]:checked').each((i,e)=>{this.update(e,!0)})}deleteAll(elm){flexygo.msg.confirm(flexygo.localization.translate("flxeditgrid.deleteconfirm"),result=>{result&&$(this).find('table tr:not(.rowInsert) td:first-child input[type="checkbox"]:checked').each((i,e)=>{this.delete(e,!0)})})}refresh(){let nGrid=$('<table data-role="table" class="ui-responsive"><thead/><tbody/><tfoot/></table>'),row=$('<tr class="rowHeader" />'),width=20;this.canUpdate&&(width+=20),this.canDelete&&(width+=20);let btn,th=$('<th style="width:'+width+'px;"/>');this.canInsert&&((btn=$('<i class="flx-icon icon-add" title="'+flexygo.localization.translate("flxeditgrid.addrow")+'" />')).on("click",e=>{$(e.currentTarget).closest("table").find(".rowInsert input:first").focus()}),th.append(btn)),row.append(th);for(let key in this.schema)row.append($("<th/>").html(this.schema[key].ColumnDescrip).attr("name",key).on("click",e=>{this.sort(e.currentTarget)}));(btn=$('<i class="flx-icon icon-bullet-list-2 right" title="'+flexygo.localization.translate("flxeditgrid.removeselection")+'" />')).on("click",e=>{e.stopPropagation(),this.selectNone(this)}),row.find("th:last").append(btn),(btn=$('<i class="flx-icon icon-bullet-list-1 right" title="'+flexygo.localization.translate("flxeditgrid.selectall")+'" />')).on("click",e=>{e.stopPropagation(),this.selectAll(this)}),row.find("th:last").append(btn),nGrid.find("thead").append(row);for(let i=0;i<this.data.length;i++)this.data[i]&&nGrid.find("tbody").append(this.getRow(this.data[i],i));this.canInsert&&nGrid.find("tfoot").append(this.getEditLine()),$(this).html(nGrid)}render(){this.refresh()}getEditLine(){let btn,row=$('<tr class="rowInsert" />'),cellButtons=$("<td/>");(btn=$('<i class="flx-icon icon-save" />')).on("click",e=>{this.insert(e.currentTarget)}),cellButtons.append(btn),(btn=$('<i class="flx-icon icon-clean-1" />')).on("click",e=>{this.clearInsert(e.currentTarget)}),cellButtons.append(btn),row.append(cellButtons);for(let key in this.schema)row.append($("<td/>").append(this.getControl(this.schema[key],this.schema[key].DefaultValue)));let ctl=row.find("td:last-child").find("input");return 0==ctl.length&&(ctl=row.find("td:last-child").find("select")),ctl.on("keydown",e=>{9==(e.keyCode||e.which)&&(this.insert(row.find('td i[class*="save"]')[0]),e.preventDefault())}),row}getRow(dataRow,index,returnAlways){let row=$("<tr/>");row.data("index",index);let cellButtons=$("<td>"),btn=$('<input type="checkbox" />');btn.on("click",e=>{$(e.currentTarget).parents("tr").toggleClass("selected"),this.refreshColMenu($(e.currentTarget).closest("table"))}),cellButtons.append(btn),this.canUpdate&&((btn=$('<i class="flx-icon icon-edit" />')).on("click",e=>{this.edit(e.currentTarget)}),cellButtons.append(btn)),this.canDelete&&((btn=$('<i class="flx-icon icon-trash" />')).on("click",e=>{this.delete(e.currentTarget)}),cellButtons.append(btn)),(btn=$('<i class="flx-icon icon-save" />')).on("click",e=>{this.update(e.currentTarget)}),cellButtons.append(btn),(btn=$('<i class="flx-icon icon-remove" />')).on("click",e=>{this.cancelEdit(e.currentTarget)}),cellButtons.append(btn),row.append(cellButtons);let notExclude=!0;!returnAlways&&this.filter&&""!=this.filter&&(notExclude=!1);let keys=new Array;for(let key in this.schema){this.schema[key].IsKeyField&&keys.push({key,value:dataRow[key]}),this.filter&&""!=this.filter&&-1!=String(dataRow[key]).toLocaleLowerCase().indexOf(this.filter.toLocaleLowerCase())&&(notExclude=!0);let value=null==dataRow[key]?"":dataRow[key],text=this.getText(null==dataRow[key]?"":dataRow[key],key),title=$("<b/>").html(this.schema[key].ColumnName);row.append($("<td/>").attr("value",value).append(title).append(text))}return row.data("keys",keys),notExclude?row:null}getControl(def,val){let key=def.ColumnName,desc=def.ColumnDescrip;if(def.AutoIncrement)return $('<input type="text" readonly />').attr("placeholder",desc);if(def.ListValues.length>0){let combo=$("<select  />").data("field",key);combo.append($("<option />").val("").html(key));let valueFiled=null,displayField=null;def.ListValues.length>0&&(valueFiled=Object.keys(def.ListValues[0])[0],displayField=Object.keys(def.ListValues[0])[0],Object.keys(def.ListValues[0]).length>1&&(displayField=Object.keys(def.ListValues[0])[1]));for(let i=0;i<def.ListValues.length;i++)combo.append($("<option />").val(def.ListValues[i][valueFiled]).html(def.ListValues[i][displayField]));return null!=val?(combo.val(val),combo.attr("default",val)):combo.attr("default",""),combo}{let input=$("<input />").data("field",key);switch(input.data("keyField",def.IsKeyField),input.attr("placeholder",desc),def.MaxLength&&-1!=def.MaxLength&&input.attr("maxlength",def.MaxLength),def.ReadOnly&&input.prop("readonly",!0),def.DataType.toLocaleLowerCase()){case"system.int16":case"system.int32":input.attr("type","number");break;case"system.double":input.attr("type","number"),input.attr("step","0.01");break;case"system.boolean":case"system.byte":input.attr("type","checkbox");break;case"system.datetime":input.attr("type","date");break;default:input.attr("type","text")}return null!=val?"checkbox"==input.attr("type")?val&&"false"!=val&&(input.prop("checked",!0),input.attr("default","true")):(input.val(val),input.attr("default",val)):input.attr("default",""),input}}getText(value,prop){let def=this.schema[prop],text=$("<span>");if(null!=value)if(def.ListValues.length>0&&Object.keys(def.ListValues[0]).length>1){for(let i=0;i<def.ListValues.length;i++)if(value==def.ListValues[i][Object.keys(def.ListValues[0])[0]]){text.html(def.ListValues[i][Object.keys(def.ListValues[0])[1]]);break}""==text.html()&&text.html(value)}else switch(def.DataType.toLocaleLowerCase()){case"system.int16":case"system.int32":text.html(flexygo.utils.parser.formatNumber(value));break;case"system.double":text.html(flexygo.utils.parser.formatDecimal(value));break;case"system.boolean":case"system.byte":"true"==value.toString()?text.html('<i class="flx-icon icon-checked"></i>'):text.html('<i class="flx-icon icon-non-check-2"></i>');break;case"system.datetime":text.html(flexygo.utils.parser.formatDate(value));break;default:text.html(value)}return text}refreshColMenu(tbl){let me=$(this);0==me.find('table tr:not(.rowInsert) td:first-child input[type="checkbox"]:checked').length?$("#mainFooterMenu i.icon-trash").parent().hide():$("#mainFooterMenu i.icon-trash").parent().show(),0==me.find('table tr.rowEdit td:first-child input[type="checkbox"]:checked').length?($("#mainFooterMenu i.icon-save").parent().hide(),$("#mainFooterMenu i.icon-remove").parent().hide()):($("#mainFooterMenu i.icon-save").parent().show(),$("#mainFooterMenu i.icon-remove").parent().show()),0==me.find('table tr:not(.rowInsert):not(.rowEdit) td:first-child input[type="checkbox"]:checked').length?$("#mainFooterMenu i.icon-edit").parent().hide():$("#mainFooterMenu i.icon-edit").parent().show(),this.canUpdate||($("#mainFooterMenu i.icon-edit").parent().hide(),$("#mainFooterMenu i.icon-save").parent().hide(),$("#mainFooterMenu i.icon-remove").parent().hide()),this.canDelete||$("#mainFooterMenu i.icon-trash").parent().hide();let menu=$("#mainFooterMenu"),wc=menu[0];tbl&&0==$(tbl).find("tr td:first-child input:checked").length?menu.is(":visible")&&wc.hide():menu.is(":hidden")&&wc.show()}sort(columnItem,ascMode){let me=$(this),columnId=me.find("thead tr.rowHeader th").index(columnItem);ascMode?this.sortAsc=ascMode:this.sortColumnId==columnId?this.sortAsc=!this.sortAsc:this.sortAsc=!0,this.sortColumnId=columnId;let rows=me.find("tbody tr:not(.rowHeader):not(.rowInsert)").get();rows.sort((a,b)=>{let A=$(a).children("td").eq(this.sortColumnId).find("span").text().toUpperCase(),B=$(b).children("td").eq(this.sortColumnId).find("span").text().toUpperCase();return $.isNumeric(A)&&$.isNumeric(B)&&(A=parseFloat(A),B=parseFloat(B)),A<B?this.sortAsc?-1:1:A>B?this.sortAsc?1:-1:0}),$.each(rows,(index,row)=>{me.find("table tbody").append(row)}),me.find("table tbody").append(me.find("tbody tr.rowInsert").get()),me.find(".sortAsc, .sortDsc").removeClass("sortAsc").removeClass("sortDsc"),this.sortAsc?$(columnItem).addClass("sortAsc"):$(columnItem).addClass("sortDsc")}}}()}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-editgrid",flexygo.ui.wc.FlxEditGridElement);