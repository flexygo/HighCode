var flexygo;!function(flexygo){!function(ui){!function(wc){class FlxTimelineElement extends HTMLElement{constructor(){super(),this.timelineRanges={Hour:18e5,Day:432e5,Week:3024e5,Month:1296e6,Year:158112e5}}init(){try{let me=$(this);if(me.removeAttr("manualInit"),$(this).closest("flx-module").find(".flx-noInitContent").remove(),this.filterValues=null,this.activeFilter=null,this.wcParentModule=me.closest("flx-module")[0],!this.wcParentModule)throw flexygo.msg.error("flx-timeline has to be inside a flx-module"),"flx-timeline has to be inside a flx-module";let history=flexygo.history.get(me);if(history&&history.filtersValues&&history.filtersValues[this.wcParentModule.moduleName]){let filterHistoryValue=history.filtersValues[this.wcParentModule.moduleName];filterHistoryValue.activeFilter&&(this.activeFilter=filterHistoryValue.activeFilter),filterHistoryValue.properties&&(this.filterValues=filterHistoryValue.properties)}this.getTimeline()}catch(ex){console.error("FlexyGo Timeline",ex)}}refresh(){"true"!=$(this).attr("manualInit")&&this.init()}setFilter(){"true"!=$(this).attr("manualInit")&&this.getTimeline()}render(){try{let itemsWithoutGroup=`<aside id="items_without_group" class="folded">\n                                                        <div>\n                                                            <h4>${this.timelineSetting.TitleItemsWithoutGroup}</h4>\n                                                        </div>\n                                                        <div id="items-container"></div>\n                                                        <div class="fold"> \n                                                            <i class="flx-icon icon-arrow-head-5"/> \n                                                        </div>\n                                                    </aside>`,controls=`<div id="controls">\n                                            <div>                            \n                                                <button type="button" method="navigation" value="0.9" accesskey="l"><i class="fa fa-angle-left"/></button>\n                                                <button type="button" method="today" accesskey="t">${flexygo.localization.translate("flxtimeline.today")}</button>\n                                                <button type="button" method="navigation" value="-0.9" value="0.9" accesskey="r"><i class="fa fa-angle-right"/></button>                           \n                                            </div>\n                                            <div>\n                                                <button type="button" method="changeRange" range="Hour" value="${this.timelineRanges.Hour}" accesskey="1">${flexygo.localization.translate("flxtimeline.hour")}</button>\n                                                <button type="button" method="changeRange" range="Day" value="${this.timelineRanges.Day}" accesskey="2">${flexygo.localization.translate("flxtimeline.day")}</button>\n                                                <button type="button" method="changeRange" range="Week" value="${this.timelineRanges.Week}" accesskey="3">${flexygo.localization.translate("flxtimeline.week")}</button>\n                                                <button type="button" method="changeRange" range="Month" value="${this.timelineRanges.Month}" accesskey="4">${flexygo.localization.translate("flxtimeline.month")}</button>\n                                                <button type="button" method="changeRange" range="Year" value="${this.timelineRanges.Year}" accesskey="5">${flexygo.localization.translate("flxtimeline.year")}</button>\n                                            </div>                                         \n                                        </div>`,title=`<div id="title">\n                                            <h3>${this.timelineSetting.TimelineSettingDescrip}</h3>\n                                        </div>`;$(this).html(`<section id="timeline_container" ShowControls="${this.timelineSetting.ShowControls}" layout="${this.timelineSetting.WithGroups&&this.timelineSetting.Editable&&this.timelineSetting.ShowItemsWithoutGroup&&this.timelineSetting.LayoutName?this.timelineSetting.LayoutName:""}">\n                               ${this.timelineSetting.WithGroups&&this.timelineSetting.Editable&&this.timelineSetting.ShowItemsWithoutGroup?itemsWithoutGroup:""}\n                                <div id="vis">\n                                    <div class="help">\n                                        <i class="fa fa-question-circle"/> \n                                    </div>\n                                ${this.timelineSetting.ShowControls?controls+title:""} \n                                </div>\n                                <div id="not_supported">\n                                    <h1>${flexygo.localization.translate("flxtimeline.notsupported")}</h1>\n                                </div>\n                            </section>`),flexygo.utils.isBlank(this.timelineSetting.DefaultRangeName)||$(this).find(`#controls > div > button[range="${this.timelineSetting.DefaultRangeName}"]`).addClass("active"),this.setStructureEvents()}catch(ex){console.error("FlexyGo Timeline",ex)}}setStructureEvents(){let flagEventMousewheel,removeActiveRangeEvent=e=>{$(this).find("#controls > div > button.active").removeClass("active")},flagAccessKeyVisible=!1;$(this).find("#vis > div.help").off("click.timeline").on("click.timeline",e=>{$.sweetModal({title:`${flexygo.localization.translate("flxtimeline.title")} ðŸ™Š`,content:`<div id="timeline-help">\n                                <table>\n                                    <thead>\n                                        <tr>\n                                            <th>\n                                                <h2>${flexygo.localization.translate("flxtimeline.description")}</h2>\n                                            </th>\n                                            <th>\n                                                <h2>${flexygo.localization.translate("flxtimeline.action")}</h2>\n                                            </th>                        \n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                    <tr class="bgseparator">\n                                        <th>\n                                            <h4>SHORTCUTS</h4>\n                                          </th>\n                                        </tr>\n                                         <tr>\n                                            <td>${flexygo.localization.translate("flxtimeline.zoom")}</td>\n                                            <td>\n                                                <kbd>\n                                                   Alt\n                                                </kbd>\n                                                <kbd>\n                                                   L\n                                                </kbd>\n                                                ${flexygo.localization.translate("flxtimeline.or")}\n                                                <kbd>\n                                                   T\n                                                </kbd>\n                                                ${flexygo.localization.translate("flxtimeline.or")}\n                                                <kbd>\n                                                   R\n                                                </kbd>\n                                            </td>\n                                        </tr>\n                                         <tr>\n                                            <td>${flexygo.localization.translate("flxtimeline.navigationtime")}</td>\n                                            <td>\n                                                  \n                                                <kbd>\n                                                   Alt\n                                                </kbd>\n                                                <kbd>\n                                                   1\n                                                </kbd>                                                \n                                                    ${flexygo.localization.translate("flxtimeline.to")}                                           \n                                                <kbd>\n                                                   5\n                                                </kbd>                                              \n                                            </td>                                            \n                                        </tr>\n                                    <tr class="bgseparator">\n                                        <th>\n                                            <h4>HELP</h4>\n                                          </th>\n                                        </tr>\n                                        <tr>                                           \n                                            <td>${flexygo.localization.translate("flxtimeline.selectitem")}</td>\n                                            <td>\n                                                <kbd>\n                                                    <i class="fa fa-hand-pointer-o"/>\n                                                </kbd>\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td>${flexygo.localization.translate("flxtimeline.multiselectitems")}</td>\n                                            <td>\n                                                <kbd>\n                                                    Ctrl\n                                                </kbd>\n                                                <kbd>\n                                                    <i class="fa fa-hand-pointer-o"/>\n                                                </kbd>\n                                                ${flexygo.localization.translate("flxtimeline.or")}\n                                                <kbd>\n                                                    <i class="fa fa-hand-pointer-o"/> \n                                                    <span>1s</span>\n                                                </kbd>\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td>${flexygo.localization.translate("flxtimeline.multiselectbyrange")}</td>\n                                            <td>\n                                                <kbd>\n                                                    Shift\n                                                </kbd>\n                                                <kbd>\n                                                    <i class="fa fa-hand-pointer-o"/>\n                                                </kbd>\n                                            </td>\n                                        </tr>\n                                        <tr class="separator">\n                                            <td>${flexygo.localization.translate("flxtimeline.multiselectbyrangegroup")}</td>\n                                            <td>\n                                                <kbd>\n                                                    Shift\n                                                </kbd>\n                                                <kbd>\n                                                    G\n                                                </kbd>\n                                                <kbd>\n                                                    <i class="fa fa-hand-pointer-o"/>\n                                                </kbd>\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td>${flexygo.localization.translate("flxtimeline.createitem")}</td>\n                                            <td>\n                                                <kbd>\n                                                    <i class="fa fa-hand-pointer-o"/> \n                                                    <span>2x</span>\n                                                </kbd>\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td>${flexygo.localization.translate("flxtimeline.createitemwithrange")}</td>\n                                            <td>\n                                                <kbd>\n                                                    Ctrl\n                                                </kbd>\n                                                <kbd>\n                                                    <i class="fa fa-hand-pointer-o"/>\n                                                </kbd>\n                                                <kbd>\n                                                    <i class="fa fa-arrows-h"/> \n                                                </kbd>\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td>${flexygo.localization.translate("flxtimeline.edititem")}</td>\n                                            <td>\n                                                <kbd>\n                                                    <i class="fa fa-hand-pointer-o"/> \n                                                </kbd>\n                                                <span class="vertical-separator"/>\n                                                <kbd>\n                                                    <i class="flx-icon icon-drag"/> \n                                                </kbd>\n                                                   ${flexygo.localization.translate("flxtimeline.or")}\n                                                <kbd>\n                                                    <i class="fa fa-arrows-h"/> \n                                                </kbd>\n                                                   ${flexygo.localization.translate("flxtimeline.or")}\n                                                <kbd>\n                                                    <i class="flx-icon icon-remove"/> \n                                                </kbd>\n\n                                            </td>\n                                        </tr>\n                                        <tr class="separator">\n                                            <td>${flexygo.localization.translate("flxtimeline.openeditview")}</td>\n                                            <td>\n                                                <kbd>\n                                                    <i class="fa fa-hand-pointer-o"/> \n                                                    <span>2x</span>\n                                                </kbd>\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td>${flexygo.localization.translate("flxtimeline.zoom")} (Zoom)</td>\n                                            <td>\n                                                <kbd>\n                                                    Ctrl\n                                                </kbd>\n                                                <kbd>\n                                                    <svg id="mouseAnimation" width="18px" height="100%" viewBox="0 0 247 390" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:1.5;">\n\t                                                    <style>\n\t\t                                                    @keyframes scroll {\n\t\t\t                                                    0% {\n\t\t\t\t                                                    transform: translateY(0);\n\t\t\t                                                    }\n\t\t\t                                                    30% {\n\t\t\t\t                                                    transform: translateY(60px);\n\t\t\t                                                    }\n\t\t                                                    }\n\n\t\t                                                    svg#mouseAnimation #wheel {\n\t\t\t                                                    animation: scroll ease 2s infinite;\n\t\t                                                    }\n\t                                                    </style>\n\t                                                    <path id="wheel" d="M123.359,79.775l0,32.843" style="fill:none;stroke:var(--timeline-light-color);stroke-width:15px;"/>\n\t                                                    <path id="mouse" d="M236.717,123.359c0,-62.565 -50.794,-113.359 -113.358,-113.359c-62.565,0 -113.359,50.794 -113.359,113.359l0,143.237c0,62.565 50.794,113.359 113.359,113.359c62.564,0 113.358,-50.794 113.358,-113.359l0,-143.237Z" style="fill:none;stroke:var(--timeline-light-color);stroke-width:15px;"/>\n                                                    </svg>\n                                                </kbd>\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td>${flexygo.localization.translate("flxtimeline.navigationtime")}</td>\n                                            <td>\n                                                <kbd>\n                                                    <i class="fa fa-hand-pointer-o"/>\n                                                </kbd>\n                                                <kbd>\n                                                    <i class="flx-icon icon-drag"/>\n                                                </kbd>\n                                            </td>\n                                        </tr>\n                                    </tbody>\n                                </table>\n                             </div>`,width:"60%",theme:$.sweetModal.THEME_LIGHT})}),this.timelineSetting.WithGroups&&this.timelineSetting.Editable&&this.timelineSetting.ShowItemsWithoutGroup&&$(this).find("#items_without_group > div.fold").off("click.timeline").on("click.timeline",()=>{let itemsWithoutGroup=$(this).find("#items_without_group");itemsWithoutGroup.hasClass("folded")?itemsWithoutGroup.removeClass("folded"):itemsWithoutGroup.addClass("folded")}),$(document).off("keydown.timeline keyup.timeline").on({"keydown.timeline":e=>{e.shiftKey&&71===e.keyCode&&!this.visTimeline.itemSet.options.multiselectPerGroup&&this.visTimeline.setOptions({multiselectPerGroup:!0}),e.ctrlKey&&!flagEventMousewheel&&(flagEventMousewheel=!0,this.visTimeline.on("mousewheel",removeActiveRangeEvent)),!e.altKey&&"Alt"!==e.key||e.ctrlKey||flagAccessKeyVisible||(e.preventDefault(),e.stopPropagation(),flagAccessKeyVisible=!0,$(this).find("[accesskey]").filter(":visible").each((index,elem)=>{let overlayParent,jElem=$(elem),overlay=$(`<div class="accesskey_overlay">${jElem.attr("accesskey")}</div>`);"absolute"!==(overlayParent="input"===elem.tagName.toLowerCase()?jElem.parent():jElem).css("position")&&overlayParent.css("position","relative"),overlay.appendTo(overlayParent)}))},"keyup.timeline":e=>{if(16!==e.keyCode&&71!==e.keyCode||!this.visTimeline.itemSet.options.multiselectPerGroup||this.visTimeline.setOptions({multiselectPerGroup:!1}),17===e.keyCode&&flagEventMousewheel&&(flagEventMousewheel=!1,this.visTimeline.off("mousewheel",removeActiveRangeEvent)),(e.altKey||"Alt"===e.key)&&!e.ctrlKey&&flagAccessKeyVisible){e.preventDefault(),e.stopPropagation(),flagAccessKeyVisible=!1;let overlays=$(this).find(".accesskey_overlay");overlays.length&&overlays.remove()}}}),this.timelineSetting.ShowControls&&($(this).find("#controls > div > button").off("click.timeline").on("click.timeline",e=>{let element=$(e.currentTarget),method=element.attr("method"),value=parseFloat(element.attr("value")),range=this.visTimeline.getWindow();switch(method){case"navigation":let intervalArrows=range.end.getTime()-range.start.getTime();this.visTimeline.setWindow(range.start.valueOf()-intervalArrows*value,range.end.valueOf()-intervalArrows*value);break;case"today":this.visTimeline.moveTo(moment().format());break;case"changeRange":let interval=moment((range.start.getTime()+range.end.getTime())/2).format();this.visTimeline.setWindow(moment(interval).subtract(value,"millisecond"),moment(interval).add(value,"millisecond")),$(this).find("#controls > div > button.active").removeClass("active"),element.addClass("active")}}),$(this).find("#controls > div:nth-child(1)").tooltip({title:flexygo.localization.translate("flxtimeline.navigation"),placement:"right",trigger:"hover"}),$(this).find("#controls > div:nth-child(2)").tooltip({title:flexygo.localization.translate("flxtimeline.range"),placement:"right",trigger:"hover"}))}initVisTimeline(visItems,visGroups,visOptions={}){try{this.visTimeline=new vis.Timeline($(this).find("#timeline_container > #vis")[0],visItems,visGroups,visOptions)}catch(ex){console.error("FlexyGo Timeline",ex),flexygo.msg.error(ex.message,null,"Error initializing the timeline")}}setItemsWithoutGroups(visItems){if(0===visItems.length)$(this).find("#timeline_container > #items_without_group > #items-container").append(`<span>${flexygo.localization.translate("flxtimeline.withoutRegisters")}</span>`);else{for(const item of visItems){let visItemData=this.buildVisItem(item,!0);$(`<div class="item ${flexygo.utils.isBlank(visItemData.className)?"":visItemData.className}" ${flexygo.utils.isBlank(visItemData.style)?"":`style="${visItemData.style}"`} draggable= "true"> \n                                                                                        ${this.timelineSetting.ItemContentTemplate?flexygo.utils.parser.recursiveCompile(item,this.timelineSetting.ItemContentTemplate):item[this.timelineSetting.Advanced?this.timelineSetting.ItemDescripField:this.timelineSetting.PropertyDescrip]} \n                                                                                     </div>`).appendTo($(this).find("#timeline_container > #items_without_group > #items-container"))[0].visItemData=visItemData}$(this).find("#timeline_container > #items_without_group > #items-container > .item").off("dragstart.timeline").on("dragstart.timeline",event=>{event.originalEvent.dataTransfer.effectAllowed="move",event.originalEvent.dataTransfer.setData("text",JSON.stringify(event.currentTarget.visItemData))})}}getTimeline(){let params={PageName:flexygo.history.getPageName($(this)),ModuleName:this.moduleName,ObjectName:$(this).attr("ObjectName"),ObjectWhere:$(this).attr("ObjectWhere"),SearchId:this.activeFilter,FilterValues:this.filterValues};flexygo.ajax.post("~/api/Timeline","GetTimeline",params,response=>{if(response){let visGroups,visItems=new vis.DataSet;this.timelineSetting=response.TimelineSetting,this.defaults=response.Defaults?response.Defaults:{},this.toolbar=response.Toolbar,this.searchSettings=response.SearchSettings,this.savedSearches=response.SavedSearches,this.objectName=this.timelineSetting.EntityConfiguration.ObjectName,this.objectWhere=response.ObjectWhere,this.filterWhere=response.FilterWhere,this.render(),this.wcParentModule.setButtons(this.toolbar,this.timelineSetting.EntityConfiguration.CollectionName,this.objectWhere),this.loadFilters();for(const item of response.Items.filter(item=>!(this.timelineSetting.WithGroups&&flexygo.utils.isBlank(item[this.timelineSetting.Advanced?this.timelineSetting.ItemGroupField:this.timelineSetting.PropertyGroup]))))visItems.add(this.buildVisItem(item));if(this.timelineSetting.WithGroups){let groups=[];for(let i=0;i<response.Groups.length;i++)groups.push(this.buildVisGroup(response.Groups[i],i));visGroups=new vis.DataSet(groups)}else visGroups=null;this.timelineSetting.WithGroups&&this.timelineSetting.Editable&&this.timelineSetting.ShowItemsWithoutGroup&&this.setItemsWithoutGroups(response.Items.filter(item=>flexygo.utils.isBlank(item[this.timelineSetting.Advanced?this.timelineSetting.ItemGroupField:this.timelineSetting.PropertyGroup]))),this.initVisTimeline(visItems,visGroups,this.buildVisOptions()),this.wcParentModule.moduleLoaded(this)}})}buildVisOptions(){let visOptions={editable:this.timelineSetting.Editable?{add:this.timelineSetting.EntityConfiguration.CanInsert,remove:this.timelineSetting.EntityConfiguration.CanDelete,updateGroup:this.timelineSetting.EntityConfiguration.CanUpdate&&this.timelineSetting.CanEditPropertyGroup,updateTime:this.timelineSetting.EntityConfiguration.CanUpdate&&(this.timelineSetting.CanEditPropertyStartDate||this.timelineSetting.CanEditPropertyEndDate),overrideItems:!1}:this.timelineSetting.Editable,end:moment().add(this.timelineRanges[this.timelineSetting.DefaultRangeName],"millisecond").format(),groupOrder:function(a,b){return a.value-b.value},height:this.timelineSetting.ShowControls?"calc(100% - 42px)":"100%",locale:flexygo.context.currentUserLang,margin:{item:{horizontal:-1}},max:moment().add("years",25).format(),min:moment().add("years",-25).format(),multiselect:!0,onAdd:(item,callback)=>{this.objectActions(item,item.withOutGroup?"update":"insert").then(data=>{callback(data),data&&($(this).find("#timeline_container > #items_without_group > #items-container > .item").filter((index,element)=>element.visItemData.id===data.id).remove(),this.visTimeline.focus(data.id))},function(error){callback(null),console.error("FlexyGo Timeline",error)})},onMove:(item,callback)=>{this.objectActions(item,"update").then(data=>{callback(data),data&&this.visTimeline.focus(data.id)},function(error){callback(null),console.error("FlexyGo Timeline",error)})},onRemove:(item,callback)=>{this.objectActions(item,"delete").then(data=>{callback(data)},function(error){callback(null),console.error("FlexyGo Timeline",error)})},onUpdate:(item,callback)=>{(void 0===item.editable||item.editable&&"boolean"==typeof item.editable||item.editable&&"object"==typeof item.editable&&(item.editable.updateGroup||item.editable.updateTime||item.editable.remove))&&this.objectActions(item,"edit").then(data=>{callback(data),data&&this.visTimeline.focus(data.id)},function(error){callback(null),console.error("FlexyGo Timeline",error)})},orientation:{axis:"top",item:"top"},start:moment().subtract(this.timelineRanges[this.timelineSetting.DefaultRangeName],"millisecond").format(),tooltipOnItemUpdateTime:{template:item=>`<div>\n                                    <i class="fa fa-hourglass-1"/></i> ${moment(item.start).utc().format("l")} ${moment(item.start).utc().format("LT")}\n                                </div>\n                                ${item.end?`<div>\n                                                    ${moment(item.end).utc().format("l")} ${moment(item.end).utc().format("LT")} <i class="fa fa-hourglass-end"></i>\n                                                </div>`:""}`},verticalScroll:!0,zoomKey:"ctrlKey",zoomMax:15768e7,zoomMin:6e4};return this.timelineSetting.Advanced&&!flexygo.utils.isBlank(this.timelineSetting.OnDropObjectOnItemFunction)&&(visOptions.onDropObjectOnItem=((objectData,item,callback)=>{new Function("objectData","item",`return new Promise((resolve, reject) => { try {${this.timelineSetting.OnDropObjectOnItemFunction}} catch (ex) { reject(ex); } });`).call(this,objectData,item).then(function(data){callback(data)},function(error){callback(item),console.error("FlexyGo Timeline","OnDropObjectOnItemFunction",error)})})),this.timelineSetting.Advanced&&!flexygo.utils.isBlank(this.timelineSetting.OnMovingFunction)&&(visOptions.onMoving=((item,callback)=>{new Function("item",`return new Promise((resolve, reject) => { try {${this.timelineSetting.OnMovingFunction}} catch (ex) { reject(ex); } });`).call(this,item).then(function(data){callback(data)},function(error){callback(item),console.error("FlexyGo Timeline","onMovingFunction",error)})})),this.timelineSetting.Advanced&&!flexygo.utils.isBlank(this.timelineSetting.OnMoveFunction)&&(visOptions.onMove=((item,callback)=>{new Function("item",`return new Promise((resolve, reject) => { try {${this.timelineSetting.OnMoveFunction}} catch (ex) { reject(ex); } });`).call(this,item).then(function(data){callback(data)},function(error){callback(item),console.error("FlexyGo Timeline","onMoveFunction",error)})})),this.timelineSetting.Advanced&&!flexygo.utils.isBlank(this.timelineSetting.OnAddFunction)&&(visOptions.onAdd=((item,callback)=>{new Function("item",`return new Promise((resolve, reject) => { try {${this.timelineSetting.OnAddFunction}} catch (ex) { reject(ex); } });`).call(this,item).then(function(data){callback(data)},function(error){callback(item),console.error("FlexyGo Timeline","onAddFunction",error)})})),this.timelineSetting.Advanced&&!flexygo.utils.isBlank(this.timelineSetting.ItemVisibleFrameTemplate)&&(visOptions.visibleFrameTemplate=((item,element)=>item&&item.data?flexygo.utils.parser.recursiveCompile(item.data,this.timelineSetting.ItemVisibleFrameTemplate):"")),$.extend(!0,visOptions,this.isJson(this.timelineSetting.CustomOptions)?JSON.parse(this.timelineSetting.CustomOptions,(key,value)=>value&&"string"==typeof value&&0===value.indexOf("function")?new Function("return "+value)():value):null)}buildVisItem(data,isNew=!1){if(data){let id=new Array;this.timelineSetting.EntityConfiguration.ObjectKeys.forEach(key=>id.push({[key]:data[key]}));let item={id:JSON.stringify(id),group:data[this.timelineSetting.Advanced?this.timelineSetting.ItemGroupField:this.timelineSetting.PropertyGroup],content:this.timelineSetting.ItemContentTemplate?flexygo.utils.parser.recursiveCompile(data,this.timelineSetting.ItemContentTemplate):data[this.timelineSetting.Advanced?this.timelineSetting.ItemDescripField:this.timelineSetting.PropertyDescrip]?data[this.timelineSetting.Advanced?this.timelineSetting.ItemDescripField:this.timelineSetting.PropertyDescrip]:flexygo.localization.translate("flxtimeline.withoutDescription"),start:data[this.timelineSetting.Advanced?this.timelineSetting.ItemStartDateField:this.timelineSetting.PropertyStartDate]?moment(data[this.timelineSetting.Advanced?this.timelineSetting.ItemStartDateField:this.timelineSetting.PropertyStartDate]).utc().format("YYYY-MM-DD HH:mm"):null,end:data[this.timelineSetting.Advanced?this.timelineSetting.ItemEndDateField:this.timelineSetting.PropertyEndDate]?moment(data[this.timelineSetting.Advanced?this.timelineSetting.ItemEndDateField:this.timelineSetting.PropertyEndDate]).utc().format("YYYY-MM-DD HH:mm"):null,title:data[this.timelineSetting.Advanced?this.timelineSetting.ItemDescripField:this.timelineSetting.PropertyDescrip],withOutGroup:!data[this.timelineSetting.Advanced?this.timelineSetting.ItemGroupField:this.timelineSetting.PropertyGroup],editable:this.timelineSetting.Advanced&&this.timelineSetting.Editable&&this.checkEditableProperty(data[this.timelineSetting.ItemEditableField])?JSON.parse(data[this.timelineSetting.ItemEditableField]):void 0,className:this.timelineSetting.Advanced?data[this.timelineSetting.ItemClassNameField]:null,style:this.timelineSetting.Advanced?data[this.timelineSetting.ItemStyleField]:null,type:this.timelineSetting.Advanced&&data[this.timelineSetting.ItemTypeField]?data[this.timelineSetting.ItemTypeField].trim().toLowerCase():null,data};return isNew&&(item.start=null,item.end=null),item}return null}buildVisGroup(data,order){return data?{value:order,id:void 0!==data[this.timelineSetting.GroupIdField]&&null!=data[this.timelineSetting.GroupIdField]?data[this.timelineSetting.GroupIdField]:data[this.timelineSetting.PropertyGroup],content:this.timelineSetting.GroupContentTemplate?flexygo.utils.parser.recursiveCompile(data,this.timelineSetting.GroupContentTemplate):data[this.timelineSetting.GroupDescripField]||data[this.timelineSetting.PropertyGroup],className:this.timelineSetting.Advanced?data[this.timelineSetting.GroupClassNameField]:null,style:this.timelineSetting.Advanced?data[this.timelineSetting.GroupStyleField]:null,data}:null}objectActions(object,action){return new Promise((resolve,reject)=>{try{let objectEntity=new flexygo.obj.Entity(this.timelineSetting.EntityConfiguration.ObjectName,this.hasIdStructure(object.id.toString())?this.getObjectWhere(JSON.parse(object.id.toString())):null);switch(action){case"insert":case"edit":case"update":object.end||(object.end=moment(object.start).add(this.timelineSetting.DefaultTime,"minutes").format("YYYY-MM-DD HH:mm")),"insert"===action&&this.timelineSetting.OnInsertOpenNewWithDefaults||"edit"===action?this.openObjectEdit(object,objectEntity).then(function(data){resolve(data)},function(error){throw error}):objectEntity.read()?($.extend(!0,objectEntity.data,{[this.timelineSetting.PropertyGroup]:this.timelineSetting.WithGroups&&this.timelineSetting.PropertyGroup?{Value:object.group}:void 0,[this.timelineSetting.PropertyStartDate]:{Value:moment(object.start).format("YYYY-MM-DD HH:mm")},[this.timelineSetting.PropertyEndDate]:this.timelineSetting.PropertyEndDate?{Value:object.end?moment(object.end).format("YYYY-MM-DD HH:mm"):object.end}:void 0}),("insert"===action?objectEntity.insert():objectEntity.update())?(objectEntity.jsCode&&flexygo.utils.execDynamicCode.call(this,objectEntity.jsCode),objectEntity.warningMessage&&flexygo.msg.warning(objectEntity.warningMessage),objectEntity.objectName=this.timelineSetting.EntityConfiguration.CollectionName,resolve(this.buildVisItem(objectEntity.getView(this.timelineSetting.Advanced?this.timelineSetting.ItemViewName:null,null,null,null,null,null,!0)[0]))):resolve(null)):resolve(null);break;case"delete":flexygo.msg.confirm(flexygo.localization.translate("flxeditgrid.deleteconfirm"),result=>{if(result)if(this.timelineSetting.OnDeleteFunction){let delFun=new Function("entity","timeline",this.timelineSetting.OnDeleteFunction);resolve(delFun.call(objectEntity,objectEntity,this)?object:null)}else resolve(objectEntity.delete()?object:null)});break;default:resolve(null)}}catch(ex){reject(ex)}})}openObjectEdit(object,objectEntity){return new Promise((resolve,reject)=>{try{flexygo.nav.openPage(this.timelineSetting.EventPageTypeId,objectEntity.objectName,objectEntity.objectWhere,JSON.stringify(Object.assign(this.defaults,{[this.timelineSetting.PropertyStartDate]:moment(object.start).format("YYYY-MM-DD HH:mm"),[this.timelineSetting.PropertyEndDate]:this.timelineSetting.PropertyEndDate?object.end?moment(object.end).format("YYYY-MM-DD HH:mm"):object.end:void 0,[this.timelineSetting.PropertyGroup]:this.timelineSetting.WithGroups&&this.timelineSetting.PropertyGroup?object.group:void 0})),"modal"),flexygo.events.on(this,"entity","all",e=>{this===e.context&&e.sender.objectName===objectEntity.objectName&&(flexygo.events.off(this,"entity","all"),flexygo.events.off(this,"dialog","closed"),"deleted"===e.type?(resolve(null),this.visTimeline.itemsData.remove(object.id)):(e.sender.objectName=this.timelineSetting.EntityConfiguration.CollectionName,resolve(this.buildVisItem(e.sender.getView(this.timelineSetting.Advanced?this.timelineSetting.ItemViewName:null,null,null,null,null,null,!0)[0]))),flexygo.nav.closePage($(`flx-edit[objectname="${objectEntity.objectName}"]`)))}),flexygo.events.on(this,"dialog","closed",e=>{this===e.context&&e.sender.objectname===objectEntity.objectName&&(flexygo.events.off(this,"entity","all"),flexygo.events.off(this,"dialog","closed"),resolve(null))})}catch(ex){reject(ex)}})}getObjectWhere(id){let where="";return id.forEach((value,index)=>{where+=`[${this.timelineSetting.EntityConfiguration.TableName}].[${Object.keys(value)[0]}] = '${value[Object.keys(value)[0]]}'${index<id.length-1?" AND ":""}`}),where}hasIdStructure(id){try{return!!isNaN(JSON.parse(id))}catch(e){return!1}}isJson(json){try{JSON.parse(json)}catch(e){return!1}return!0}checkEditableProperty(valueJson){let value;if(this.isJson(valueJson)&&valueJson){if("boolean"==typeof(value=JSON.parse(valueJson)))return!0;if("object"==typeof value){for(const key of["updateGroup","updateTime","remove"])if(key in value)return!0;return!1}return!1}return!1}loadFilters(){if(this.searchSettings){let pane=$(this.wcParentModule).find(".cntBodyHeader .filterPanel"),filter=$("<flx-filter></flx-filter>"),wcFilter=filter[0];0==pane.length&&this.toolbar&&Object.keys(this.toolbar).length>0&&(pane=$('<div class="filterPanel"/>'),$(this.wcParentModule).find(".cntBodyHeader").append(pane)),pane.html(filter),wcFilter&&(wcFilter.settings=this.searchSettings,wcFilter.key=this.timelineSetting.EntityConfiguration.ObjectName+"-"+this.moduleName,wcFilter.grid=this,wcFilter.init())}}configure(){flexygo.nav.openPage("edit","sysTimeline_Setting",`[Timelines_Settings].[TimelineSettingName]='${this.timelineSetting.TimelineSettingName}'`,null,"popup",!0)}connectedCallback(){let element=$(this);this.connected=!0,this.moduleName=element.attr("ModuleName"),this.objectName=element.attr("ObjectName"),this.objectWhere=element.attr("ObjectWhere"),"true"!=element.attr("manualInit")&&this.init()}disconnectedCallback(){flexygo.events.off(this,"entity","all"),flexygo.events.off(this,"dialog","closed"),$(document).off("keydown.timeline keyup.timeline")}attributeChangedCallback(attrName,oldVal,newVal){let needInit=!1;"modulename"==attrName.toLowerCase()&&newVal?(this.moduleName=newVal,needInit=!0):"objectname"==attrName.toLowerCase()&&newVal?(this.objectName=newVal,needInit=!0):"objectwhere"==attrName.toLowerCase()&&newVal&&(this.objectWhere=newVal,needInit=!0),this.connected&&needInit&&this.init()}}FlxTimelineElement.observedAttributes=["ModuleName","ObjectName","ObjectWhere"],wc.FlxTimelineElement=FlxTimelineElement;class FlxTimelineProgressBar extends HTMLElement{constructor(){super(),this.connected=!1}init(){this.render()}refresh(){this.init()}render(){$(this).html(`<div class="progressbar-container">                \n                            <div class="bar" style="width: ${this.percentage}%${this.color?";background-color:"+this.color:""}; "> </div>\n                            <div class="template" style="${this.percentage?"":"color:#b31512"}">${this.percentage?this.template.trim()?this.template:this.percentage+"%":flexygo.localization.translate("flxtimeline.withoutpercentage")}</div>                       \n                        </div>`)}connectedCallback(){let element=$(this);this.connected||(this.template=element.html()),this.connected=!0,this.color=element.attr("color"),this.percentage=element.attr("percentage"),this.init()}attributeChangedCallback(attrName,oldVal,newVal){let needInit=!1;"color"==attrName.toLowerCase()&&newVal?(this.color=newVal,needInit=!0):"percentage"==attrName.toLowerCase()&&newVal&&(this.percentage=newVal,needInit=!0),this.connected&&needInit&&this.init()}}FlxTimelineProgressBar.observedAttributes=["color","percentage"],wc.FlxTimelineProgressBar=FlxTimelineProgressBar}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-timeline",flexygo.ui.wc.FlxTimelineElement),window.customElements.define("flx-timeline-progressbar",flexygo.ui.wc.FlxTimelineProgressBar);