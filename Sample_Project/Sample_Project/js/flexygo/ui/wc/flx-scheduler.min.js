var flexygo;!function(flexygo){!function(ui){!function(wc){class FlxScheduler extends HTMLElement{constructor(){super(),this.objects=new Array,this.checkObjects=new Array,this.connected=!1,this.moduleName=null,this.n=0,this.additionalWhere=null,this.dayClick=!1,this.events=new Array,this.allDay=!1,this.eventsRefresh=!0,this.hasPendingRefresh=!1}connectedCallback(){let element=$(this);this.connected=!0,this.objectName=element.attr("ObjectName"),this.objectWhere=element.attr("ObjectWhere"),this.moduleName=element.attr("ModuleName"),"true"!=element.attr("manualInit")&&this.init()}init(){let activeMode,SQLValueField,SQLDisplayField,SQLFilterField,directTemplate,objectName,viewName,maxTime,minTime,onClickEvent,tokenDefault,allDaySlot,slotDuration,pageType,target,eventLimit,disableResize,disableDrag,onClickJS,onClickDayJS,ctx=this,me=$(this);me.removeAttr("manualInit"),$(this).closest("flx-module").find(".flx-noInitContent").remove();let parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&wcModule.moduleLoaded(this);let options=new Array,schedulerParams={ModuleName:ctx.moduleName};flexygo.ajax.post("~/api/Scheduler","GetSchedulerTemplate",schedulerParams,response=>{if(response){activeMode=response.ActiveMode,SQLValueField=response.SQLValueField,SQLDisplayField=response.SQLDisplayField,SQLFilterField=response.SQLFilterField,directTemplate=response.DirectTemplate,objectName=response.ObjectName,viewName=response.ViewName,maxTime=response.MaxTime,minTime=response.MinTime,onClickEvent=response.OnClickEvent,onClickJS=response.OnClickJS,onClickDayJS=response.OnClickDayJS,tokenDefault=response.TokenDefault,allDaySlot=response.AllDaySlot,slotDuration=response.SlotDuration,pageType=response.PageType,target=response.Target,eventLimit=response.EventLimit,disableResize=response.DisableResize,disableDrag=response.DisableDrag,"True"==response.MonthView&&options.push("month"),"True"==response.AgendaWeekView&&options.push("agendaWeek"),"True"==response.AgendaDayView&&options.push("agendaDay"),"True"==response.ListWeekView&&options.push("listWeek");var objectParams={Scheduler:response.SchedulerName};flexygo.ajax.post("~/api/Scheduler","GetSchedulerConfig",objectParams,response=>{if(response){for(var i in me.append('<div id="loading"></div><div id="calendar" style="margin:1%;"></div>'),response)ctx.objects.push({SchedulerName:response[i].SchedulerName,ObjectName:response[i].ObjectName,ObjectDescrip:response[i].ObjectDescrip,StartDateField:response[i].StartDateField,EndDateField:response[i].EndDateField,EndTimeField:response[i].EndTimeField,StartTimeField:response[i].StartTimeField,DurationField:response[i].DurationField,ViewName:response[i].ViewName,ColorField:response[i].ColorField,DescripTemplate:response[i].DescripTemplate,key:response[i].key,table:response[i].table,Icon:response[i].Icon,UserIdField:response[i].UserIdField,Filter:"",TextColorField:response[i].TextColorField,TokenDefault:tokenDefault,CanInsert:response[i].CanInsert,CanView:response[i].CanView,CanEdit:response[i].CanEdit,AllDayField:response[i].AllDayField}),ctx.checkObjects.push(response[i].ObjectName);if(ctx.objects.length>0){if(ctx.render(options,activeMode,maxTime,minTime,onClickEvent,allDaySlot,slotDuration,pageType,target,eventLimit,disableResize,disableDrag,onClickJS,onClickDayJS),""!=objectName&&($("#calendar").prepend('<div class="fc-toolbar fc-header-toolbar filter"><div class="a" style="text-align:left;" id="filters"><flx-multicombo class="combo" ObjectName="'+objectName+'" ViewName="'+viewName+'" IconClass="flx-icon icon-role" SQLValueField="'+SQLValueField+'" SQLDisplayField="'+SQLDisplayField+'" SQLFilter="'+SQLFilterField+'" filtertype="dbcombo"><template>'+directTemplate+"</template></flx-multicombo></div></div>"),$(".fc-left").css("margin-left","10px")),ctx.objects.length>1){$(".fc-left").append("<div style='margin-right: .75em;' class='fc-button'><div style='width: 140px;'><div class='panel panel-default objects' style='margin-bottom: 0px;background-color: #f5f5f5;'><div style='padding: 3.5px 10px;'><div><div class='fa fa-filter'></div><a data-toggle='collapse' href='#collapse1' style='color: #777;'>  "+flexygo.localization.translate("flxscheduler.objects")+"</a></div></div><div id='collapse1' class='panel-collapse collapse'></div></div></div></div>");for(var x=0;x<ctx.objects.length;x++)$("#collapse1").append("<div class='panel-footer'><i style='float:left;margin-top: 2px;margin-right: 5px;' class='"+ctx.objects[x].Icon+"'></i>"+ctx.objects[x].ObjectName+"<flx-check style='float:right;' id='"+ctx.objects[x].ObjectName+"' property='"+ctx.objects[x].ObjectName+"' checked></flx-check>");$("#collapse1").on("show.bs.collapse",function(){$(".objects").css("position","absolute")}),$("#collapse1").on("hide.bs.collapse",function(){$(".objects").css("position","static")}),$("#mainContent").on("scroll",function(){$("#collapse1").removeClass("in"),$(".objects").css("position","static")}),$("flx-check input[type=checkbox]").click(function(){if(this.checked)ctx.checkObjects.push(this.parentElement.parentElement.id);else for(var i in ctx.checkObjects)ctx.checkObjects[i]==this.parentElement.parentElement.id&&ctx.checkObjects.splice(ctx.checkObjects.indexOf(ctx.checkObjects[i]),1);0!=ctx.checkObjects.length?ctx.checkPanelObjects(ctx.additionalWhere):me.find("#calendar").fullCalendar("removeEvents")})}}else me.append('<div class="box-danger"><i class="flx-icon icon-close icon-lg icon-margin-right"></i><span><strong>Error</strong> No scheduler objects configurations are found</span></div>');$('flx-multicombo[viewname="'+viewName+'"]').find("div:not(.mobileinputdiv)").on("change",function(){let filtros=this.closest("flx-multicombo").getValue();for(var i in ctx.checkObjects)ctx.objects[i].Filter=filtros.split("|").join("','");ctx.checkPanelObjects(ctx.additionalWhere)})}})}})}refresh(){if("true"!=$(this).attr("manualInit")){let ctx=this;if(ctx.eventsRefresh){$(this).find("#calendar").fullCalendar("removeEvents"),ctx.checkPanelObjects(this.additionalWhere)}else ctx.hasPendingRefresh=!0}}render(options,activeMode,maxTime,minTime,onClickEvent,allDaySlot,slotDuration,pageType,target,eventLimit,disableResize,disableDrag,onClickJS,onClickDayJS){let defaultDate,ctx=this,me=$(this),right="",navLinks=!1;for(var i in flexygo.events.on(this,"dialog","closed",e=>{if(ctx.eventsRefresh)for(var i=0;i<ctx.objects.length;i++)e.sender.objectname&&e.sender.objectname.toLowerCase()===ctx.objects[i].ObjectName.toLowerCase()&&ctx.checkPanelObjects(ctx.additionalWhere)}),options.indexOf("agendaDay")>-1&&(navLinks=!0),options)right+=options[i]+",";right=right.substring(0,right.length-1);let myCalendar=me.find("#calendar");""==minTime?minTime="00:00:00":minTime+=":00",""==maxTime?maxTime="24:00:00":maxTime+=":00",""==slotDuration?slotDuration="00:30:00":slotDuration+=":00","True"==allDaySlot&&(ctx.allDay=!0),defaultDate=me.attr("dateInit")?new Date($(this).attr("dateInit")):Date.now(),myCalendar.fullCalendar({header:{left:"prev,next today",center:"title",right},firstDay:1,locale:flexygo.profiles.langKey.toLowerCase().slice(0,2),allDaySlot:ctx.allDay,defaultDate,defaultView:activeMode,timeFormat:"HH:mm",nextDayThreshold:"00:00:00",minTime,maxTime,navLinks,height:"auto",slotEventOverlap:!1,eventStartEditable:!disableDrag,eventDurationEditable:!disableResize,eventLimit,slotDuration,eventDrop:function(event,delta,revertFunc){let obj=new flexygo.obj.Entity(event.objectName,ctx.getObjectWhere(event.table,event.key,event.id));if(obj.read(),""!=event.startDate&&null!=event.start&&(obj.data[event.startDate].Value=event.start.format()),""!=event.endDate&&null!=event.end)if(event.allDay&&ctx.allDay){var date=moment(event.end.format()).add("days",-1).format("YYYY-MM-DD");obj.data[event.endDate].Value=date+" 23:59:00"}else obj.data[event.endDate].Value=event.end.format();""!=event.startTime&&null!=event.start&&(event.allDay&&ctx.allDay?obj.data[event.startTime].Value="00:00":obj.data[event.startTime].Value=event.start.format().slice(11,16)),""!=event.endTime&&null!=event.end&&(event.allDay&&ctx.allDay?obj.data[event.endTime].Value="23:59":obj.data[event.endTime].Value=event.end.format().slice(11,16)),obj.update()&&(obj.jsCode&&flexygo.utils.execDynamicCode.call(this,obj.jsCode),flexygo.msg.success("Saved"))},eventResize:function(event,delta,revertFunc){let obj=new flexygo.obj.Entity(event.objectName,ctx.getObjectWhere(event.table,event.key,event.id));if(obj.read(),""!=event.endDate&&null!=event.end)if(event.allDay&&ctx.allDay){var date=moment(event.end.format()).add("days",-1).format("YYYY-MM-DD");obj.data[event.endDate].Value=date+" 23:59:00"}else obj.data[event.endDate].Value=event.end.format();if(""!=event.endTime&&null!=event.end&&(event.allDay&&ctx.allDay?obj.data[event.endTime].Value="23:59":obj.data[event.endTime].Value=event.end.format().slice(11,16)),""!=event.duration){let start=new Date(event.start.format()).getTime(),diffMs=new Date(event.end.format()).getTime()-start,diffMins=Math.round(diffMs/6e4);obj.data[event.duration].Value=diffMins}obj.update()&&(obj.jsCode&&flexygo.utils.execDynamicCode.call(this,obj.jsCode),flexygo.msg.success("Saved"))},eventClick:function(calEvent,jsEvent,view){if("True"==onClickEvent)if("view"==pageType&&calEvent.canView)flexygo.nav.openPage(pageType,calEvent.objectName,ctx.getObjectWhere(calEvent.table,calEvent.key,calEvent.id),null,target,!1,$(this));else if("edit"==pageType&&calEvent.canEdit)flexygo.nav.openPage(pageType,calEvent.objectName,ctx.getObjectWhere(calEvent.table,calEvent.key,calEvent.id),null,target,!1,$(this));else if("generic"==pageType){new Function("objectname","objectwhere","calEvent","jsEvent","view",onClickJS).call(this,calEvent.objectName,ctx.getObjectWhere(calEvent.table,calEvent.key,calEvent.id),calEvent,jsEvent,view)}},eventRender:function(event,element,view){let el=$(element);switch(view.name){case"month":if(element.find("span.fc-title").html(element.find("span.fc-title").text()),el.addClass("test"),0===el.find("flx-tooltip").length)(text=element.find("span.fc-title").clone()).find(".hidden").remove(),el.tooltip({title:text.text(),delay:{show:1e3},placement:"top",trigger:"hover"});break;case"agendaWeek":if(element.find("div.fc-content").find(".fc-title").html(element.find("div.fc-content").find(".fc-title").text()),el.addClass("test"),0===el.find("flx-tooltip").length)(text=element.find("div.fc-title").clone()).find(".hidden").remove(),el.tooltip({title:text.text(),delay:{show:1e3},placement:"top",trigger:"hover"});break;case"agendaDay":if(element.find("div.fc-content").find(".fc-title").html(element.find("div.fc-content").find(".fc-title").text()),el.addClass("test"),el.addClass("fc-day-size"),0===el.find("flx-tooltip").length)(text=element.find("div.fc-title").clone()).find(".hidden").remove(),el.tooltip({title:text.text(),delay:{show:1e3},placement:"top",trigger:"hover"});break;case"listWeek":var text;if(element.find("td.fc-list-item-title").html(element.find("td.fc-list-item-title").text()),el.addClass("test"),0===el.find("flx-tooltip").length)(text=element.find("td.fc-list-item-title").clone()).find(".hidden").remove(),el.tooltip({title:text.text(),delay:{show:1e3},placement:"top",trigger:"hover"})}},dayClick:function(date,jsEvent,view){if(touches<=1)if(flexygo.utils.isBlank(onClickDayJS)){if(!ctx.dayClick){ctx.dayClick=!0;let hasTime=date.hasTime();if(ctx.objects.length>1){let myButtons=new Object,buttons="";for(var i=0;i<ctx.objects.length;i++)myButtons[ctx.objects[i].ObjectName]={class:"btn btn-default",text:ctx.objects[i].ObjectName,SchedulerName:ctx.objects[i].SchedulerName,ObjectName:ctx.objects[i].ObjectName,StartDateField:ctx.objects[i].StartDateField,EndDateField:ctx.objects[i].EndDateField,StartTimeField:ctx.objects[i].StartTimeField,EndTimeField:ctx.objects[i].EndTimeField,DurationField:ctx.objects[i].DurationField,closeOnClick:!0,Icon:ctx.objects[i].Icon},ctx.objects[i].CanInsert&&(buttons+='<a style="padding: 0.7em;margin-right: 3%;margin-bottom: 3%;" class="btn btn-default bg-outstanding modalButton" objectName="'+ctx.objects[i].ObjectName+'"><i style="margin-right:4px;" class="'+ctx.objects[i].Icon+'"></i>'+ctx.objects[i].ObjectDescrip+"</a>");""!=buttons&&($.sweetModal({title:flexygo.localization.translate("flxscheduler.chooseobjects"),content:"<div>"+buttons+"</div>",theme:$.sweetModal.THEME_MIXED,width:"31%",onClose:()=>{ctx.dayClick=!1}}),$(".modalButton").click(function(){let object=myButtons[this.getAttribute("objectName")];ctx.openEvent(object.ObjectName,object.StartDateField,object.EndDateField,object.StartTimeField,object.EndTimeField,object.DurationField,date.format("YYYY-MM-DD"),date.format("HH:mm"),object.AllDayField,hasTime),$(".sweet-modal-overlay").remove()}))}else ctx.objects[0].CanInsert&&ctx.openEvent(ctx.objects[0].ObjectName,ctx.objects[0].StartDateField,ctx.objects[0].EndDateField,ctx.objects[0].StartTimeField,ctx.objects[0].EndTimeField,ctx.objects[0].DurationField,date.format("YYYY-MM-DD"),date.format("HH:mm"),ctx.objects[0].AllDayField,hasTime)}}else new Function("date","jsEvent","view",onClickDayJS).call(this,date,jsEvent,view)}}),ctx.checkPanelObjects(ctx.additionalWhere),$(".fc-center").append('<div class="col-6 col-m-12"><div id="datepicker" style="display:none;position:absolute;z-index: 4;" class="cute-calendar"></div></div>');let dp1=$("#datepicker");$(".fc-center").click(function(){dp1.show()}),dp1.datepicker({onSelect:function(dateText,inst){dp1.hide(),myCalendar.fullCalendar("gotoDate",dateText),ctx.checkPanelObjects(ctx.additionalWhere)},firstDay:1}),$(".fc-prev-button").click(function(){ctx.checkPanelObjects(ctx.additionalWhere)}),$(".fc-next-button").click(function(){ctx.checkPanelObjects(ctx.additionalWhere)}),$(".fc-agendaWeek-button").click(function(){ctx.checkPanelObjects(ctx.additionalWhere)}),$(".fc-month-button").click(function(){ctx.checkPanelObjects(ctx.additionalWhere)}),$(".fc-listWeek-button").click(function(){ctx.checkPanelObjects(ctx.additionalWhere)}),$(".fc-agendaDay-button").click(function(){ctx.checkPanelObjects(ctx.additionalWhere)}),$(".fc-today-button").click(function(){ctx.checkPanelObjects(ctx.additionalWhere)}),$("#mainContent").on("scroll",function(){dp1.hide()});var touches=0;me.on("touchstart",ev=>{touches=ev.originalEvent.touches.length,me.on("touchend",ev=>{ev.originalEvent.touches?touches=ev.originalEvent.touches.length:touches--})}),$(document).mouseup(function(e){dp1.is(e.target)||0!==dp1.has(e.target).length||dp1.hide()})}checkPanelObjects(additionalWhere){let ctx=this,me=$(this);for(var x in me.find("#loading").html(flexygo.utils.loadingMsg()),ctx.eventsRefresh=!1,ctx.checkObjects)for(var i=0;i<ctx.objects.length;i++)ctx.checkObjects[x]==ctx.objects[i].ObjectName&&ctx.changeEvents(ctx.objects[i].ObjectName,ctx.objects[i].ViewName,ctx.objects[i].ColorField,ctx.objects[i].StartDateField,ctx.objects[i].EndDateField,ctx.objects[i].StartTimeField,ctx.objects[i].EndTimeField,ctx.objects[i].DurationField,ctx.objects[i].DescripTemplate,ctx.objects[i].key,ctx.objects[i].table,ctx.objects[i].UserIdField,ctx.objects[i].Filter,ctx.objects[i].TextColorField,additionalWhere,ctx.objects[i].TokenDefault,ctx.objects[i].CanEdit,ctx.objects[i].CanView,ctx.objects[i].AllDayField)}openEvent(objectName,startDate,endDate,startTime,endTime,duration,date,time,allday,hasTime){let displayTimeEnd=new Date,hour=time.slice(0,2),minutes=time.slice(3,5),localDate=date+" "+time;displayTimeEnd.setHours(parseInt(hour)),displayTimeEnd.setMinutes(parseInt(minutes)),displayTimeEnd.setMinutes(displayTimeEnd.getMinutes()+15);let timeEnd=displayTimeEnd.toTimeString(),defaults={};defaults[startDate]=localDate,startTime&&(defaults[startTime]=time),endDate&&(defaults[endDate]=localDate),endTime&&(defaults[endTime]=timeEnd.slice(0,5)),duration&&(defaults[duration]="15"),allday&&(defaults[allday]=!hasTime),flexygo.nav.openPage("edit",objectName,null,JSON.stringify(defaults),"modal1024x768",!1,$(this)),this.dayClick=!1}changeEvents(objectName,viewName,color,startDate,endDate,startTime,endTime,duration,descripTemplate,key,table,userIdField,filter,textColor,additionalWhere,tokenDefault,canEdit,canView,allDayField){let ctx=this,myCalendar=$(this).find("#calendar");myCalendar.fullCalendar("removeEvents");let moment=myCalendar.fullCalendar("getDate"),date=new Date(moment),dateStartWeek=ctx.getStartWeek(new Date(moment)),dateWeek=new Date(dateStartWeek.getTime()+6048e5),dateDay=new Date(date.getTime()+864e5),view=myCalendar.fullCalendar("getView"),start="",end="";switch($("#datepicker").datepicker("setDate",date.getMonth()+1+"/"+date.getDate()+"/"+date.getFullYear()),view.name){case"month":start=ctx.formatDate(date,""+(date.getMonth()+1),"01",date.getFullYear()),end=date.getMonth()+1==12?ctx.formatDate(date,"01","01",date.getFullYear()+1):ctx.formatDate(date,""+(date.getMonth()+2),"01",date.getFullYear());break;case"agendaWeek":case"listWeek":start=ctx.formatDate(dateStartWeek,""+(dateStartWeek.getMonth()+1),""+dateStartWeek.getDate(),dateStartWeek.getFullYear()),end=ctx.formatDate(dateWeek,""+(dateWeek.getMonth()+1),""+dateWeek.getDate(),dateWeek.getFullYear());break;case"agendaDay":start=ctx.formatDate(date,""+(date.getMonth()+1),""+date.getDate(),date.getFullYear()),end=ctx.formatDate(dateDay,""+(dateDay.getMonth()+1),""+dateDay.getDate(),dateDay.getFullYear())}ctx.schedulerResult(objectName,viewName,start,end,color,startDate,endDate,startTime,endTime,duration,descripTemplate,key,table,userIdField,filter,textColor,additionalWhere,tokenDefault,canEdit,canView,allDayField)}schedulerResult(objectName,viewName,start,end,color,startDate,endDate,startTime,endTime,duration,descripTemplate,key,table,userIdField,filter,textColor,additionalWhere,tokenDefault,canEdit,canView,allDayField){let ctx=this,me=$(this),myCalendar=me.find("#calendar");me.find("#loading").css("display","");let params={ObjectName:objectName,ViewName:viewName,Start:start,End:end,StartDate:startDate,EndDate:endDate,StartTime:startTime,EndTime:endTime,Duration:duration,DescripTemplate:descripTemplate,Keys:key,Color:color,UserIdField:userIdField,Filter:filter,TextColor:textColor,AdditionalWhere:additionalWhere,TokenDefault:tokenDefault,AllDayField:allDayField};flexygo.ajax.post("~/api/Scheduler","GetSchedulerResult",params,response=>{if(ctx.n=ctx.n+1,response)for(var i in response){let st=response[i].StartTime,et=response[i].EndTime;5==st.length&&(st+=":00"),5==et.length&&(et+=":00");let descrip=flexygo.utils.parser.recursiveCompile(response[i].Row,response[i].Descrip),newEvent={id:response[i].Id,color:response[i].Color,textColor:response[i].TextColor,title:descrip,start:response[i].StartDate.slice(0,10)+" "+st,end:response[i].EndDate.slice(0,10)+" "+et,objectName,startDate,endDate,startTime,endTime,duration,key,table,canEdit,canView,allDay:!1};if(response[i].AllDayField&&ctx.allDay){newEvent.allDay=response[i].AllDayField;var date=moment(response[i].EndDate.slice(0,10)+" "+et).add("days",1).format("YYYY-MM-DD HH:MM:SS");newEvent.end=date}ctx.events.push(newEvent)}ctx.n==ctx.checkObjects.length&&(myCalendar.fullCalendar("addEventSource",ctx.events),me.find(".fc-view-container").css("display",""),me.find("#loading").css("display","none"),ctx.n=0,ctx.events=[]),ctx.eventsRefresh=!0,ctx.hasPendingRefresh&&(ctx.hasPendingRefresh=!1,ctx.refresh())})}formatDate(date,month,day,year){return month.length<2&&(month="0"+month),day.length<2&&(day="0"+day),[year,month,day].join("")}getStartWeek(d){let day=d.getDay(),diff=d.getDate()-day+(0==day?-6:1);return new Date(d.setDate(diff))}getObjectWhere(table,key,id){let where="",last=0;for(var i=0;i<key.length;i++)where+=table+"."+key[i]+" = '"+id[i]+"'",++last<key.length&&(where+=" and ");return where}disconnectedCallback(){flexygo.events.off(this,"dialog","closed")}}FlxScheduler.observedAttributes=["ObjectName","ObjectWhere","ModuleName"],wc.FlxScheduler=FlxScheduler;wc.FlxSchedulerElement=class extends HTMLElement{attachedCallback(){let element=$(this),ctl=new FlxScheduler;ctl.webControl=element,ctl.objectName=element.attr("ObjectName"),ctl.objectWhere=element.attr("ObjectWhere"),ctl.moduleName=element.attr("ModuleName"),ctl.pageName=element.attr("PageName"),element.data("controller",ctl),ctl.init()}attributeChangedCallback(attrName,oldVal,newVal){let ctl=$(this).data("controller"),needInit=!1;ctl&&"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal?(ctl.moduleName=newVal,needInit=!0):ctl&&"objectname"==attrName.toLowerCase()&&newVal&&""!=newVal?(ctl.objectName=newVal,needInit=!0):ctl&&"objectwhere"==attrName.toLowerCase()&&newVal&&""!=newVal?(ctl.objectWhere=newVal,needInit=!0):ctl&&"pagename"==attrName.toLowerCase()&&newVal&&""!=newVal&&(ctl.pageName=newVal,needInit=!0),needInit&&ctl.init()}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-scheduler",flexygo.ui.wc.FlxScheduler);