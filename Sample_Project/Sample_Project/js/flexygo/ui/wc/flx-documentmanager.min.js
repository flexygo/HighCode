var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxDocumentManagerElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.additionalWhere=null,this.managerMode="flexygo",this.type="edit"}connectedCallback(){let element=$(this);this.connected=!0,this.objectName=element.attr("ObjectName"),this.objectWhere=element.attr("ObjectWhere"),this.objectId=element.attr("ObjectId"),this.moduleName=element.attr("ModuleName"),this.managerMode=element.attr("mode"),element.attr("type")&&(this.type=element.attr("type")),"true"!=element.attr("manualInit")&&this.init()}disconnectedCallback(){flexygo.events.off(this,"entity","all",this.onEntityUpdate)}static get observedAttributes(){return["modulename","objectname","objectwhere","objectid","mode"]}attributeChangedCallback(attrName,oldVal,newVal){if(!this.connected)return;let needInit=!1;"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.moduleName=newVal,needInit=!0):"objectname"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectName=newVal,needInit=!0):"objectwhere"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectWhere=newVal,needInit=!0):"objectid"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectId=newVal,needInit=!0):"mode"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.managerMode=newVal,needInit=!0),needInit&&this.init()}init(){flexygo.events.on(this,"entity","all",this.onEntityUpdate);try{let me=$(this);var defString,defObject;me.removeAttr("manualInit"),defString=flexygo.history.getDefaults(this.objectName,me),defObject=JSON.parse(flexygo.utils.parser.replaceAll(defString,"'",'"'));let wcModule=me.closest("flx-module")[0];"flexygo"==this.managerMode?(this.rObjectName=this.objectName&&this.objectId?this.objectName:defObject?defObject.ObjectName:wcModule.objectdefaults?wcModule.objectdefaults.ObjectName:"",this.rObjectId=this.objectName&&this.objectId?this.objectId:defObject?defObject.ObjectId:wcModule.objectdefaults?wcModule.objectdefaults.ObjectId:""):(this.rObjectName=this.objectName&&this.objectId?this.objectName:defObject?defObject.Tabla:wcModule.objectdefaults?wcModule.objectdefaults.Tabla:"",this.rObjectId=this.objectName&&this.objectId?this.objectId:defObject?defObject.IdDoc:wcModule.objectdefaults?wcModule.objectdefaults.IdDoc:""),defObject&&defObject.additionalWhere?this.additionalWhere=defObject.additionalWhere:wcModule.objectdefaults&&wcModule.objectdefaults.additionalWhere&&(this.additionalWhere=wcModule.objectdefaults.additionalWhere),this.getConfig(),this.getCategories()}catch(ex){console.log(ex)}}refresh(){if("true"!=$(this).attr("manualInit"))try{this.getConfig(),this.getCategories()}catch(ex){console.log(ex)}}render(){try{let me=$(this);var rendered;rendered=`<div class="dtc-main"><div class="dtc-btn-container ${"view"==this.type.toLowerCase()?"hidden":""}">\n                                 <button type="button" method="opendialog" value="upload" class="btn btn-default bg-outstanding dtc-btn" data-original-title="" title="">\n                                    <i class="flx-icon icon-upload" flx-fw="" ></i><span class="hidden-xs">  `+flexygo.localization.translate("documentmanager.upload")+'</span>\n                                </button>\n                                <button type="button" method="opendialog" value="link" class="btn btn-default bg-primary dtc-btn" data-original-title="" title="">\n                                    <i class="flx-icon icon-link" flx-fw="" ></i><span class="hidden-xs">  '+flexygo.localization.translate("documentmanager.link")+'</span>\n                                </button>\n                                <div style="display:none" class="btn-group dtc-filter dtc-btn dtc-btn-filter" data-toggle="buttons">\n                                            <label class="btn btn-default active">\n                                                <i class="fa fa-hdd-o txt-outstanding" flx-fw=""></i>\n                                                <input method="filter" value="disk" type="checkbox" checked autocomplete= "off">\n                                            </label>\n                                            <label class="btn btn-default active">\n                                                <i class="fa fa-google txt-primary" flx- fw="" > </i>\n                                                <input method="filter" value="drive" type="checkbox" checked autocomplete= "off">\n                                            </label>\n                                            <label class="btn btn-default active">\n                                                <i class="fa fa-dropbox txt-info" flx-fw=""></i>\n                                                <input method="filter" value="dropbox" type="checkbox" checked autocomplete= "off">\n                                            </label>\n                                </div>\n                                <button type="button" method="opensettings" value="settings" class="btn btn-default dtc-btn dtc-btn-settings develop-only" data-original-title="" title="">\n                                    <i class="flx-icon icon-settings" flx-fw="" ></i>\n                                </button>\n                                 <button type="button" method="downloadall" value="downloadall" class="btn btn-default dtc-btn dtc-btn-settings" data-original-title="" title="">\n                                    <i class="flx-icon icon-download"  ></i>\n                                </button>\n                            </div>\n                            <div class="dtc-pry-container">\n                           </div></div>',me.html(rendered),this.dropboxFolderCreate||this.dropboxFileCreate||this.driveFolderCreate||this.driveFileCreate||this.diskFolderCreate||this.diskFileCreate?me.find('button[method="opendialog"][value="upload"]').tooltip({title:flexygo.localization.translate("documentmanager.upload"),placement:"bottom",trigger:"hover"}):me.find('button[method="opendialog"][value="upload"]').hide(),this.dropboxFolderLink||this.dropboxFileLink||this.driveFolderLink||this.driveFileLink||this.diskFolderLink||this.diskFileLink?me.find('button[method="opendialog"][value="link"]').tooltip({title:flexygo.localization.translate("documentmanager.link"),placement:"bottom",trigger:"hover"}):me.find('button[method="opendialog"][value="link"]').hide(),me.find("div.dtc-filter").tooltip({title:flexygo.localization.translate("documentmanager.filter"),placement:"bottom",trigger:"hover"}),me.find('button[method="opensettings"][value="settings"]').tooltip({title:flexygo.localization.translate("documentmanager.settings"),placement:"bottom",trigger:"hover"}),me.find('button[method="downloadall"][value="downloadall"]').tooltip({title:flexygo.localization.translate("documentmanager.downloadall"),placement:"bottom",trigger:"hover"}),"view"!==this.type.toLocaleLowerCase()&&this.mainEvents(),this.getDocument()}catch(ex){console.log(ex)}}renderDocument(docGuid,path,downloadLink,name,origin,iconClass,creationDate,category,categoryId,description,documentType,extension,inProgress){try{let me=$(this);var date,rendered,permissionLink;if(description||(description=""),!category){let cats=$.grep(this.categories,function(a){return a.categoryId==categoryId});cats.length>0&&(category=cats[0].category)}let subcontainerbuttons='<div class="dtc-subcontainerbuttons">\n                            <i method="edit" value="" class="flx-icon icon-pencil txt-primary dtc-hover dtc-transition dtc-i-btn" flx-fw=""></i>\n                            <a class="dtc-a" href="'+flexygo.utils.resolveUrl(downloadLink)+'" download="'+name+extension+'">\n                                <i method="download" value= "" class="flx-icon icon-download txt-primary dtc-hover dtc-transition dtc-i-btn" flx- fw="" > </i>\n                            </a>\n                            <i method="remove" value="'+docGuid+'" class="flx-icon icon-delete-2 txt-danger dtc-hover dtc-transition dtc-i-btn" flx- fw="" > </i>\n                            <i method="link" value="'+docGuid+'" class="flx-icon icon-link txt-primary dtc-hover dtc-transition dtc-i-btn" flx- fw="" > </i>';switch(".pdf"==extension?subcontainerbuttons=subcontainerbuttons+'<i method="view" value= "'+flexygo.utils.resolveUrl(downloadLink)+'&mode=view" download= "'+name+extension+'" class="flx-icon icon-eye txt-primary dtc-hover dtc-transition dtc-i-btn" flx- fw="" > </i>\n                        </div>':subcontainerbuttons+='<i class="flx-icon icon-eye text-muted dtc-i-btn"></i></div>',"view"==this.type.toLowerCase()&&(subcontainerbuttons='<a class="dtc-a" href="'+flexygo.utils.resolveUrl(downloadLink)+'" download="'+name+extension+'">\n                                <i method="download" value= "" class="flx-icon icon-download txt-primary dtc-hover dtc-transition dtc-i-btn" flx- fw="" > </i>\n                            </a>',".pdf"==extension?subcontainerbuttons=subcontainerbuttons+'< i method= "view" value= "'+flexygo.utils.resolveUrl(downloadLink)+'&mode=view" download= "'+name+extension+'" class="flx-icon icon-eye txt-primary dtc-hover dtc-transition dtc-i-btn" flx- fw="" > </i>':subcontainerbuttons+='<i class="flx-icon icon-eye text-muted dtc-i-btn"></i>'),date=new Date(parseInt(creationDate.substr(6))),rendered='<div id="'+docGuid+'" documenttype="'+documentType+'" class="dtc-container dtc-transition">\n                                <div class="dtc-subcontainer dtc-subcontainer1">\n                                   \x3c!--<a class="dtc-a" target="_blank" href="'+flexygo.utils.resolveUrl(path)+'">--\x3e\n                                        <i method="preview" class="'+iconClass+' dtc-icon" flx-fw=""></i> \x3c!--dtc-hover dtc-transition--\x3e\n                                    \x3c!--</a>--\x3e\n                                    <div class="dtc-containertext">\n                                        <span class="size-l dtc-name" title="'+name+'">'+name+'</span>\n                                        <span class="size-xs"><em><small>'+origin+'</small></em></span>\n                                    </div>\n                                </div>\n                                <div class="dtc-subcontainer dtc-subcontainer2 hidden-xs">\n                                    <i class="fa dtc-icontype" flx- fw="" > </i>\n                                    <div class="dtc-containertext">\n                                       \x3c!-- <span class="size-m">'+docGuid+'<i method="copy" class="fa fa-copy dtc-iconcopy dtc-hover dtc-transition" flx-fw=""></i></span>--\x3e\n                                       \x3c!-- <div class="dtc-subcontainer dtc-margin">--\x3e\n                                            <span class="dtc-category size-m" value="'+categoryId+'">'+category+"</span>"+(inProgress?' <strong class="uploadIncomplete txt-danger size-l">Upload Incomplete</strong>':"")+'\n                                            <span class="size-m">'+date.toLocaleString().slice(0,-3)+'</span>\n                                       \x3c!-- </div>--\x3e\n                                    </div>\n                                </div>\n                                <div class="dtc-subcontainer hidden-xs hidden-sm hidden-md">\n                                     <span class="dtc-description size-m">'+description+"</span>\n                                </div>"+subcontainerbuttons+"\n                            </div>",me.find("div.dtc-pry-container").prepend(rendered),documentType){case"diskfile":permissionLink=this.diskFileLink;break;case"diskfolder":permissionLink=this.diskFolderLink;break;case"drivefile":permissionLink=this.driveFileLink;break;case"drivefolder":permissionLink=this.driveFolderLink;break;case"dropboxfile":permissionLink=this.dropboxFileLink;break;case"dropboxfolder":permissionLink=this.dropboxFolderLink;break;default:permissionLink=!1}permissionLink||me.find("div#"+docGuid).find('i[method="link"]').removeClass("dtc-hover").addClass("dtc-disabled"),me.find('i[method="copy"]').tooltip({title:flexygo.localization.translate("documentmanager.copy"),placement:"bottom",trigger:"hover"}),me.find('i[method="edit"]').tooltip({title:flexygo.localization.translate("documentmanager.edit"),placement:"bottom",trigger:"hover"}),me.find('i[method="download"]').tooltip({title:flexygo.localization.translate("documentmanager.download"),placement:"bottom",trigger:"hover"}),me.find('i[method="remove"]').tooltip({title:flexygo.localization.translate("documentmanager.remove"),placement:"bottom",trigger:"hover"}),me.find('i[method="link"]').tooltip({title:flexygo.localization.translate("documentmanager.link"),placement:"bottom",trigger:"hover"}),me.find('i[method="view"]').tooltip({title:flexygo.localization.translate("documentmanager.view"),placement:"bottom",trigger:"hover"}),me.find("div#"+docGuid).find('i[method="link"]').removeClass("dtc-hover").addClass("dtc-disabled")}catch(ex){console.log(ex)}}openDialog(dialogType){try{var renderedDiskbutton,renderedDriveButton,renderedDropboxButton,dialogWidth,diskFilePermission,driveFilePermission,dropboxFilePermission;$(this),"upload"===dialogType?(renderedDiskbutton='<div class="btn-group dtc-btn dtc-btn-group-disk">\n                                               <label value="disk" type="file" class="btn btn-default btn-file dtc-btn-disk">\n                                                    <i class="fa fa-file-o txt-outstanding" flx-fw=""></i><input method="'+dialogType+'" value="disk" type="file" multiple class="hide"/>\n                                              </label>\n                                              <label value="disk" type="directory" class="btn btn-default btn-file dtc-btn-disk">\n                                                    <i class="fa fa-folder-o txt-outstanding" flx-fw=""></i><input method="'+dialogType+'" value="disk" type="file" webkitdirectory multiple class="hide"/>\n                                              </label>\n                                          </div>',diskFilePermission=!(!this.diskFileCreate&&!this.diskFolderCreate),driveFilePermission=!(!this.driveFileCreate&&!this.driveFolderCreate),dropboxFilePermission=!(!this.dropboxFileCreate&&!this.dropboxFolderCreate)):"link"===dialogType&&(renderedDiskbutton='<button type="button" method="'+dialogType+'" value="disk" class="btn btn-default dtc-btn" data-original-title="" title="">\n                                            <i class="fa fa-hdd-o txt-outstanding" flx-fw=""></i>\n                                       </button>',diskFilePermission=!(!this.diskFileLink&&!this.diskFolderLink),driveFilePermission=!(!this.driveFileLink&&!this.driveFolderLink),dropboxFilePermission=!(!this.dropboxFileLink&&!this.dropboxFolderLink)),renderedDriveButton='<button type="button" method="'+dialogType+'" value="drive" class="btn btn-default dtc-btn" data-original-title="" title="">\n                                            <i class="fa fa-google txt-primary" flx-fw=""></i>\n                                        </button>',renderedDropboxButton='<button type="button" method="'+dialogType+'" value="dropbox" class="btn btn-default dtc-btn" data-original-title="" title="">\n                                            <i class="fa fa-dropbox txt-info" flx-fw=""></i>\n                                          </button>',this.dialog=$('<div class="flx-dlg-document">\n                                    <i class="flx-icon icon-'+dialogType+' icon-2x dtc-dlg-icon" flx-fw="" ></i>'+renderedDiskbutton+renderedDriveButton+renderedDropboxButton+"</div>"),"link"===dialogType?diskFilePermission||this.dialog.find('button[value="disk"]').addClass("hidden"):"upload"===dialogType&&(this.diskFileCreate||this.dialog.find('label[value="disk"][type="file"]').addClass("hidden"),this.diskFolderCreate||this.dialog.find('label[value="disk"][type="directory"]').addClass("hidden"),diskFilePermission||this.dialog.find("div.dtc-btn-group-disk").addClass("hidden")),driveFilePermission||this.dialog.find('button[value="drive"]').addClass("hidden"),dropboxFilePermission||this.dialog.find('button[value="dropbox"]').addClass("hidden"),this.dialog.find('button[value="disk"]').tooltip({title:flexygo.localization.translate("documentmanager.disk"),placement:"top",trigger:"hover"}),this.dialog.find('label[value="disk"][type="file"]').tooltip({title:flexygo.localization.translate("documentmanager.diskfiles"),placement:"top",trigger:"hover"}),this.dialog.find('label[value="disk"][type="directory"]').tooltip({title:flexygo.localization.translate("documentmanager.diskfolders"),placement:"top",trigger:"hover"}),this.dialog.find('button[value="drive"]').tooltip({title:flexygo.localization.translate("documentmanager.drive"),placement:"top",trigger:"hover"}),this.dialog.find('button[value="dropbox"]').tooltip({title:flexygo.localization.translate("documentmanager.dropbox"),placement:"top",trigger:"hover"}),this.dialog.find("i.dtc-dlg-switch-icon").tooltip({title:flexygo.localization.translate("documentmanager.folderorfile"),placement:"right",trigger:"hover"}),dialogWidth=$("body").width()<400?$("body").width():400,this.dialog.dialog({position:{my:"center top",at:"center top+70",of:$("body")},width:dialogWidth,height:130,dialogClass:"flx-dialog-modal",modal:!0,close:function(){$(this).dialog("destroy").remove()}}).dialogExtend({closable:!0,maximizable:!1,minimizable:!1,collapsable:!1,dblclick:!1,modal:!0,resizable:!1,close:function(){$(this).remove()}}),this.dialogEvents()}catch(ex){console.log(ex)}}mainEvents(){try{let me=$(this);if(this.diskFileCreate){var dragDropZone=me.find("div.dtc-main");dragDropZone.on("dragover",ev=>{ev.originalEvent&&ev.originalEvent.dataTransfer&&(ev.originalEvent.dataTransfer.dropEffect="copy"),dragDropZone.css("background-color","rgba(0,0,0,0.5)"),dragDropZone.find(".dtc-container, .dtc-btn-container button").css("background-color","rgba(0,0,0,0.5)")}).on("dragleave",ev=>{dragDropZone.css("background-color",""),dragDropZone.find(".dtc-container, .dtc-btn-container button").css("background-color","")}).on("drop",ev=>{ev.preventDefault(),dragDropZone.css("background-color",""),dragDropZone.find(".dtc-container, .dtc-btn-container button").css("background-color","");let dEvent=ev.originalEvent;this.filesPending=dEvent.dataTransfer.files.length,this.filesTotal=this.filesPending;for(var i=0;i<dEvent.dataTransfer.files.length;i++)new flexygo.io.DocumentUpload(dEvent.dataTransfer.files[i],this.rObjectName,this.rObjectId,"diskfile","upload",this).startUpload()})}me.find("input").off("change").on("change",e=>{var element,method,value;method=(element=$(e.currentTarget)).attr("method"),value=element.attr("value"),"checkbox"===element.attr("type")&&"filter"===method&&(element.prop("checked")?me.find('div[documenttype*="'+value+'"]').removeClass("hide"):me.find('div[documenttype*="'+value+'"]').addClass("hide"))}),me.find("button").off("click").on("click",e=>{var element,method,value;element=$(e.currentTarget),method=$(element).attr("method"),value=$(element).attr("value"),"opendialog"===method?"upload"===value?this.openDialog(value):"link"===value&&this.openDialog(value):"opensettings"===method?this.rObjectName&&flexygo.nav.openPage("edit","Documents_Object_Config","ObjectName = '"+this.rObjectName+"'",null,"modal900x580",!1,$(this)):"getDriveAccount"===method&&(window.location.href=encodeURI("https://accounts.google.com/o/oauth2/v2/auth?scope=https://www.googleapis.com/auth/drive.file&redirect_uri=http://localhost:63083/api/Document/getDriveAccount&response_type=code&client_id=300930594896-aos8bnjfgtg9q8e2rhiauhr0sdji4c81.apps.googleusercontent.com&access_type=offline")),$(this).find("div.dtc-container").length<=0&&"downloadall"===method?flexygo.msg.warning("documentmanager.nodocuments"):"downloadall"===method&&"downloadall"===value&&this.rObjectName&&!flexygo.utils.isBlank(this.rObjectId)&&this.downloadAllDocuments(this.rObjectName,this.rObjectId)})}catch(ex){console.log(ex)}}onEntityUpdate(e){try{if("inserted"===e.type||"updated"===e.type){let obj=e.sender;"document_object"!==obj.objectName.toLowerCase()&&"documents_object_config"!==obj.objectName.toLowerCase()||("inserted"===e.type?"document_object"===obj.objectName.toLowerCase()&&this.getDocument(obj.data.DocGuid.Value):"updated"===e.type&&"documents_object_config"===obj.objectName.toLowerCase()&&this.refresh(),$(document).find('flx-edit[objectname="'+obj.objectName+'"]').closest(".ui-dialog").remove())}}catch(ex){console.log(ex)}}dialogEvents(){try{$(this),this.dialog.find("input").off("change").on("change",e=>{var element,method,value,doctype;if(element=$(e.currentTarget),method=$(element).attr("method"),value=$(element).attr("value"),"file"===$(element).attr("type")&&"upload"===method&&"disk"===value&&(this.dialog.dialog("destroy").remove(),(this.diskFileCreate||this.diskFolderCreate)&&(doctype=$(element).prop("webkitdirectory")?"diskfolder":"diskfile",element[0].files))){this.filesPending=element[0].files.length,this.filesTotal=this.filesPending;for(let i=0;i<element[0].files.length;i++){let fl=element[0].files[i];new flexygo.io.DocumentUpload(fl,this.rObjectName,this.rObjectId,doctype,method,this).startUpload()}}}),this.dialog.find("button").off("click").on("click",e=>{var element,method,value,dropboxChooserOptions,defaults;element=$(e.currentTarget),method=$(element).attr("method"),value=$(element).attr("value"),dropboxChooserOptions={success:files=>{for(var fl in files){var name,downloadLink,doctype;files[fl].isDir?(name=files[fl].name+".folder",doctype="dropboxfolder"):(name=files[fl].name,doctype="dropboxfile"),downloadLink=-1===files[fl].link.search("/?dl=0")?files[fl].link+"?dl=1":files[fl].link.replace("?dl=0","?dl=1"),this.setCloudDocument(null,name,doctype,files[fl].id,files[fl].link,downloadLink,method,!1)}},cancel:function(){},linkType:"preview",multiselect:!0,folderselect:!1,iframe:!1,extensions:[]},"upload"===method?"disk"===value?this.diskFileCreate||this.diskFolderCreate:"drive"===value?(this.driveFileCreate||this.driveFolderCreate)&&this.loadPicker(method):"dropbox"===value&&(this.dropboxFileCreate||this.dropboxFolderCreate)&&(Dropbox.isBrowserSupported()?(dropboxChooserOptions.extensions=[".folder"],Dropbox.choose(dropboxChooserOptions)):flexygo.msg.warning("documentmanager.browsernotsupported")):"link"===method&&("disk"===value?(this.diskFileLink||this.diskFolderLink)&&this.rObjectName&&this.rObjectId&&("flexygo"==this.managerMode?(defaults={ObjectName:this.rObjectName,ObjectId:this.rObjectId},flexygo.nav.openPage("edit","Document_Object",null,JSON.stringify(defaults),"modal600x385",!1,$(this))):(defaults={Tabla:this.ERPObjectName,IdDoc:this.rObjectId},flexygo.nav.openPage("edit","AHORA_Documento_Tabla",null,JSON.stringify(defaults),"modal600x385",!1,$(this)))):"drive"===value?(this.driveFileLink||this.driveFolderLink)&&this.loadPicker(method):"dropbox"===value&&(this.dropboxFileLink||this.dropboxFolderLink)&&(this.dropboxFileLink||(dropboxChooserOptions.extensions=[".folder"]),this.dropboxFolderLink&&(dropboxChooserOptions.folderselect=!0),Dropbox.isBrowserSupported()?Dropbox.choose(dropboxChooserOptions):flexygo.msg.warning("documentmanager.browsernotsupported"))),this.dialog.dialog("destroy").remove()})}catch(ex){console.log(ex)}}documentEvents(){try{$(this).find("i.dtc-i-btn").off("click").on("click",e=>{var element,method,value,Guid,filename;switch(method=(element=$(e.currentTarget)).attr("method"),value=element.attr("value"),Guid=element.closest("div.dtc-container").attr("id"),filename=element.attr("download"),method){case"remove":this.removeDocument(value);break;case"edit":this.editStartDocument(Guid);break;case"saveedit":this.editFinishDocument(Guid);break;case"return":this.editReturn(Guid);break;case"view":this.viewDocument(value,filename)}})}catch(ex){console.log(ex)}}viewDocument(content,filename){let histObj=new flexygo.nav.FlexygoHistory;histObj.targetid="modal";let modal=flexygo.targets.createContainer(histObj,!0,null,!0,null);modal.empty(),modal.closest(".ui-dialog").find(".ui-dialog-title").html(filename),modal.append('<embed style="height:100%;width:100%" src="'+content+'"></embed>')}removeDocument(docGuid){try{if(this.rObjectId||0==this.rObjectId){let me=$(this);var params;params={DocGuid:docGuid,ObjectName:this.rObjectName,ObjectId:this.rObjectId},flexygo.ajax.post("~/api/DocumentManager","RemoveDocument",params,response=>{response&&!response.documentError?(me.find("div#"+docGuid).remove(),flexygo.msg.success("documentmanager.removed")):response.permissionError?flexygo.msg.warning("documentmanager.permissionerror"):flexygo.msg.error("documentmanager.errorremoving")},null,()=>{this.closeLoading(!1)},()=>{this.showLoading(!1)})}}catch(ex){console.log(ex)}}setCloudDocument(base64,documentName,documentType,cloudId,cloudLink,downloadLink,action,multi){try{if((this.rObjectId||0==this.rObjectId)&&this.rObjectName){var params;if($(this),base64=base64?base64.split(",")[1]:null,("diskfile"===documentType.toLowerCase()||"diskfolder"===documentType.toLowerCase())&&!base64)return void flexygo.msg.warning("documentmanager.documentempty");params={ObjectName:this.rObjectName,ObjectId:this.rObjectId,DocumentName:documentName,DocumentType:documentType,Base64:base64,CloudId:cloudId,CloudLink:cloudLink,DownloadLink:downloadLink,DocAction:action},flexygo.ajax.post("~/api/DocumentManager","SetDocument",params,response=>{response&&!response.documentError?(this.renderDocument(response.docGuid,response.path,response.downloadLink,response.name,response.origin,response.iconClass,response.creationDate,response.category,response.categoryId,response.description,response.documentType,response.extension,!1),this.documentEvents(),flexygo.msg.success("documentmanager.saved")):response.permissionError?flexygo.msg.warning("documentmanager.permissionerror"):flexygo.msg.error("documentmanager.errorsaving")},null,()=>{this.closeLoading(multi)},()=>{this.showLoading(multi)})}}catch(ex){console.log(ex)}}downloadAllDocuments(objectName,objectId){try{var params;$(this),params={ObjectName:objectName,ObjectId:objectId},flexygo.ajax.post("~/api/DocumentManager","DownloadAllDocuments",params,response=>{response&&!response.imageError?flexygo.utils.execDynamicCode(response.javacode):response.permissionError?flexygo.msg.warning("imagemanager.permissionerror"):flexygo.msg.error("imagemanager.errordownload")})}catch(ex){console.log(ex)}}editStartDocument(docGuid){try{let me=$(this);var doc,result,categoryRender,defaultCategory;for(var cat in doc=me.find("div#"+docGuid),result=this.categories,categoryRender='<select class="dtc-category size-l form-control" firstvalue="'+doc.find("span.dtc-category").attr("value")+'" firsttext="'+doc.find("span.dtc-category").text()+'">',defaultCategory=doc.find("span.dtc-category").attr("value"),result)categoryRender+='<option value="'+result[cat].categoryId+'">'+result[cat].category+"</option>";categoryRender+="</select>",doc.find('i[method="edit"]').removeClass("icon-pencil txt-primary").addClass("txt-info icon-save-4").attr("method","saveedit").attr("title",flexygo.localization.translate("documentmanager.save")).tooltip("fixTitle"),doc.find('i[method="remove"]').removeClass("icon-delete-2 txt-danger").addClass("txt-primary icon-arrow-2 icon-flip-horizontal").attr("method","return").attr("title",flexygo.localization.translate("documentmanager.return")).tooltip("fixTitle"),doc.find("span.dtc-name").replaceWith('<input type="text" class="dtc-name form-control size-l" firstvalue="'+doc.find("span.dtc-name").text()+'" value="'+doc.find("span.dtc-name").text()+'">'),doc.find("span.dtc-category").replaceWith(categoryRender),doc.find("select.dtc-category").val(defaultCategory),doc.find("span.dtc-description").replaceWith('<textarea class="dtc-description form-control size-m" maxlength="250" rows="4" firstvalue="'+doc.find("span.dtc-description").text()+'">'+doc.find("span.dtc-description").text()+"</textarea>")}catch(ex){console.log(ex)}}editFinishDocument(docGuid){try{if(this.rObjectId||0==this.rObjectId){let me=$(this);var doc,name,categoryId,category,description,params;doc=me.find("div#"+docGuid),name=doc.find("input.dtc-name").val(),categoryId=doc.find("select.dtc-category").val()||0,category=doc.find('select.dtc-category option[value="'+categoryId+'"]').text(),description=doc.find("textarea.dtc-description").val(),params={DocGuid:docGuid,ObjectName:this.rObjectName,ObjectId:this.rObjectId,Name:name,Description:description,CategoryId:categoryId},flexygo.ajax.post("~/api/DocumentManager","UpdateDocument",params,response=>{response&&!response.documentError?flexygo.msg.success("documentmanager.saved"):(name=doc.find("input.dtc-name").attr("firstvalue"),categoryId=doc.find("select.dtc-category").attr("firstvalue"),category=doc.find("select.dtc-category").attr("firsttext"),description=doc.find("textarea.dtc-description").attr("firstvalue"),response.permissionError?flexygo.msg.warning("documentmanager.permissionerror"):flexygo.msg.error("documentmanager.errorsaving"))}),doc.find('i[method="saveedit"]').removeClass("txt-info icon-save-4").addClass("icon-pencil txt-primary").attr("method","edit").attr("title",flexygo.localization.translate("documentmanager.edit")).tooltip("fixTitle"),doc.find('i[method="return"]').removeClass("txt-primary icon-arrow-2 icon-flip-horizontal").addClass("icon-delete-2 txt-danger").attr("method","remove").attr("title",flexygo.localization.translate("documentmanager.remove")).tooltip("fixTitle"),doc.find("input.dtc-name").replaceWith('<span class="size-l dtc-name">'+name+"</span>"),doc.find("select.dtc-category").replaceWith('<span class="dtc-category size-m" value="'+categoryId+'">'+category+"</span>"),doc.find("textarea.dtc-description").replaceWith('<span class="dtc-description size-m">'+description+"</span>")}}catch(ex){console.log(ex)}}editReturn(docGuid){try{var doc,name,categoryId,category,description;name=(doc=$(this).find("div#"+docGuid)).find("input.dtc-name").attr("firstvalue"),categoryId=doc.find("select.dtc-category").attr("firstvalue"),category=doc.find("select.dtc-category").attr("firsttext"),description=doc.find("textarea.dtc-description").attr("firstvalue"),doc.find('i[method="saveedit"]').removeClass("txt-info icon-save-4").addClass("icon-pencil txt-primary").attr("method","edit").attr("title",flexygo.localization.translate("documentmanager.edit")).tooltip("fixTitle"),doc.find('i[method="return"]').removeClass("txt-primary icon-arrow-2 icon-flip-horizontal").addClass("icon-delete-2 txt-danger").attr("method","remove").attr("title",flexygo.localization.translate("documentmanager.remove")).tooltip("fixTitle"),doc.find("input.dtc-name").replaceWith('<span class="size-l dtc-name">'+name+"</span>"),doc.find("select.dtc-category").replaceWith('<span class="dtc-category size-m" value="'+categoryId+'">'+category+"</span>"),doc.find("textarea.dtc-description").replaceWith('<span class="dtc-description size-m">'+description+"</span>")}catch(ex){console.log(ex)}}getDocument(docGuid){try{if((this.rObjectId||0==this.rObjectId)&&this.rObjectName){let me=$(this);var params;params={ObjectId:this.rObjectId,ObjectName:this.rObjectName,DocGuid:docGuid,AdditionalWhere:this.additionalWhere},flexygo.ajax.post("~/api/DocumentManager","GetDocument",params,response=>{if(response[0]&&!response[0].documentError){for(var doc in response)this.renderDocument(response[doc].docGuid,response[doc].path,response[doc].downloadLink,response[doc].name,response[doc].origin,response[doc].iconClass,response[doc].creationDate,response[doc].category,response[doc].categoryId,response[doc].description,response[doc].documentType,response[doc].extension,response[doc].inProgress);this.documentEvents()}else response[0]&&response[0].permissionError?flexygo.msg.warning("documentmanager.permissionerror"):0==response.length&&"view"==this.type&&me.html('<div class="box-info"><i class="flx-icon icon-information-2 icon-lg icon-margin-right"></i><span><strong>Info!</strong> '+flexygo.localization.translate("flxlist.noentriesfound")+"</span></div>")})}}catch(ex){console.log(ex)}}getCategories(){try{$(this),flexygo.ajax.post("~/api/DocumentManager","GetCategories",{Mode:this.managerMode,ObjectName:this.rObjectName},response=>{response&&(this.categories=response)})}catch(ex){console.log(ex)}}getConfig(){try{var params;if(this.rObjectName)$(this),params={ObjectName:this.rObjectName},flexygo.ajax.post("~/api/DocumentManager","GetConfig",params,response=>{response&&(this.dropboxFolderCreate=response.dropboxFolderCreate,this.dropboxFolderLink=response.dropboxFolderLink,this.dropboxFileCreate=response.dropboxFileCreate,this.dropboxFileLink=response.dropboxFileLink,this.driveFolderCreate=response.driveFolderCreate,this.driveFolderLink=response.driveFolderLink,this.driveFileCreate=response.driveFileCreate,this.driveFileLink=response.driveFileLink,this.diskFolderCreate=response.diskFolderCreate,this.diskFolderLink=response.diskFolderLink,this.diskFileCreate=response.diskFileCreate,this.diskFileLink=response.diskFileLink,this.ERPObjectName=response.ERPObjectName,this.render())})}catch(ex){console.log(ex)}}loadPicker(method){gapi.load("picker",{callback:()=>{this.onPickerApiLoad(method)}})}onPickerApiLoad(method){flexygo.ajax.post("~/api/DocumentManager","GetDriveToken",null,response=>{response&&this.createPicker(method,response)})}createPicker(method,oauthToken){var view,folders,viewFolder;oauthToken&&(folders=!!this.driveFolderLink,viewFolder=this.driveFileLink?null:google.picker.ViewId.FOLDERS,"link"===method?view=new google.picker.DocsView(viewFolder).setIncludeFolders(!0).setSelectFolderEnabled(folders):"upload"===method&&(view=(new google.picker.DocsUploadView).setIncludeFolders(!0)),(new google.picker.PickerBuilder).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).enableFeature(google.picker.Feature.SIMPLE_UPLOAD_ENABLED).enableFeature(google.picker.Feature.NAV_HIDDEN).setLocale(flexygo.profiles.langKey.substring(0,2).toLowerCase()).setAppId(flexygo.utils.GoogleAppId).setOAuthToken(oauthToken).setDeveloperKey(flexygo.utils.GoogleDeveloperKey).addView(view).setCallback(data=>{this.pickerCallback(data,method)}).build().setVisible(!0))}pickerCallback(data,method){var name,downloadLink,previewLink,doctype;if(data.action==google.picker.Action.PICKED)for(var doc in data.docs)"folder"===data.docs[doc].type?(name=data.docs[doc].name+".folder",doctype="drivefolder",downloadLink=data.docs[doc].url,previewLink=data.docs[doc].embedUrl):(doctype="drivefile",data.docs[doc].isNew?(name=data.docs[doc].name,downloadLink=data.docs[doc].downloadUrl,previewLink=-1===data.docs[doc].url.search("view")?data.docs[doc].url:data.docs[doc].url.replace("view","preview")):(name="document"===data.docs[doc].type?data.docs[doc].name+"."+data.docs[doc].serviceId:data.docs[doc].name,downloadLink=data.docs[doc].url,previewLink=data.docs[doc].embedUrl)),this.setCloudDocument(null,name,doctype,data.docs[doc].id,previewLink,downloadLink,method,!1)}showLoading(multi){if(!this.progressBar){let onShowF,pTitle=flexygo.localization.translate("process.executing");multi?pTitle+=" "+(this.filesTotal-this.filesPending)+" / "+this.filesTotal:onShowF=(()=>{this.progressTimer=setInterval(()=>this.moveLoading(),500)}),this.progressBar=Lobibox.progress({title:pTitle,closeOnEsc:!1,closeButton:!1,onShow:onShowF})}}moveLoading(){if(this.progressBar){let actVal=this.progressBar.getProgress();actVal=actVal+1>=100?0:actVal+1,this.progressBar.setProgress(actVal)}}closeLoading(multi){if(multi&&this.filesPending--,!multi||this.filesPending<=0)this.progressBar&&(clearInterval(this.progressTimer),this.progressTimer=null,this.progressBar.destroy(),this.progressBar=null,this.filesPending=null,this.filesTotal=null);else if(this.progressBar){let actVal=100*(this.filesTotal-this.filesPending)/this.filesTotal;this.progressBar.setTitle(flexygo.localization.translate("process.executing")+" "+(this.filesTotal-this.filesPending)+" / "+this.filesTotal),this.progressBar.setProgress(actVal)}}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),function(flexygo){!function(io){io.DocumentUpload=class{constructor(file,objectname,objectid,type,action,manager){this.bufferSize=2097152,this.currentPosition=0,this.file=file,this.objectname=objectname,this.objectid=objectid,this.manager=manager,this.documentType=type,this.action=action}startUpload(){this.reader=new FileReader,this.reader.onloadend=(event=>{if(2===event.target.readyState){if(0==this.file.size)return""!=this.documentId&&this.removeDocument(),void this.documentContainer.find(".dtc-progresstext").html("Error uploading document.");if(this.file.size>this.bufferSize)if(0==this.currentPosition)this.setDocument(event.target.result,this.file.name,!0);else if(this.currentPosition<this.file.size){let lastAppend=!(this.currentPosition+this.bufferSize<this.file.size);this.appendToDocument(event.target.result,lastAppend)}else this.documentContainer.find(".dtc-inprogress").remove();else this.setDocument(event.target.result,this.file.name,!1)}}),this.upload_file()}percentDone(){return Math.floor(this.currentPosition/this.file.size*100)}upload_file(){var blob=this.file.slice(this.currentPosition,this.currentPosition+this.bufferSize);this.reader.readAsDataURL(blob)}appendToDocument(base64,lastAppend){try{var params;$(this),base64=base64?base64.split(",")[1]:null,params={ObjectName:this.objectname,ObjectId:this.objectid,DocumentId:this.documentId,Base64:base64,LastAppend:lastAppend},flexygo.ajax.post("~/api/DocumentManager","AppendToDocument",params,response=>{$("body").find(this.documentContainer)?(this.documentContainer.find(".dtc-progressbar").animate({width:this.percentDone()+"%"},200),this.documentContainer.find(".dtc-progresstext").html(this.percentDone()+"%"),this.currentPosition+=this.bufferSize,this.upload_file()):this.removeDocument()},()=>{this.removeDocument(),this.documentContainer.find(".dtc-progresstext").html("Error uploading document.")})}catch(ex){console.log(ex)}}setDocument(base64,documentName,multipart){try{if((this.objectid||"0"==this.objectid)&&this.objectname){var params;if($(this),base64=base64?base64.split(",")[1]:null,("diskfile"===this.documentType.toLowerCase()||"diskfolder"===this.documentType.toLowerCase())&&!base64)return void flexygo.msg.warning("documentmanager.documentempty");params={ObjectName:this.objectname,ObjectId:this.objectid,DocumentName:documentName,DocumentType:this.documentType,Base64:base64,CloudId:null,CloudLink:null,DownloadLink:null,DocAction:this.action,PartialUpload:multipart},flexygo.ajax.post("~/api/DocumentManager","SetDocument",params,response=>{multipart?(this.documentId=response.docGuid,this.manager.renderDocument(response.docGuid,response.path,response.downloadLink,response.name,response.origin,response.iconClass,response.creationDate,response.category,response.categoryId,response.description,response.documentType,response.extension,!1),this.manager.documentEvents(),this.documentContainer=$(this.manager).find("#"+response.docGuid),this.documentContainer.append('<div class="dtc-inprogress"><div class="dtc-progressbar" style="width:'+this.percentDone()+'%"></div><div class="dtc-progresstext">'+this.percentDone()+"%</div></div>"),this.currentPosition+=this.bufferSize,this.upload_file()):response&&!response.documentError?(this.manager.renderDocument(response.docGuid,response.path,response.downloadLink,response.name,response.origin,response.iconClass,response.creationDate,response.category,response.categoryId,response.description,response.documentType,response.extension,!1),this.manager.documentEvents(),flexygo.msg.success("documentmanager.saved")):response.permissionError?flexygo.msg.warning("documentmanager.permissionerror"):flexygo.msg.error("documentmanager.errorsaving")})}}catch(ex){console.log(ex)}}removeDocument(){try{var params;params={DocGuid:this.documentId,ObjectName:this.objectname,ObjectId:this.objectid},flexygo.ajax.post("~/api/DocumentManager","RemoveDocument",params,response=>{response.documentError&&(response.permissionError?flexygo.msg.warning("documentmanager.permissionerror"):flexygo.msg.error("documentmanager.errorremoving"))})}catch(ex){console.log(ex)}}}}(flexygo.io||(flexygo.io={}))}(flexygo||(flexygo={})),window.customElements.define("flx-documentmanager",flexygo.ui.wc.FlxDocumentManagerElement);