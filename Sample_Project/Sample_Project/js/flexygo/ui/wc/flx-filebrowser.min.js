var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxFileBrowserElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.currentDirPath="/"}static get observedAttributes(){return["ObjectName","ObjectWhere","ModuleName","asd"]}init(){this.render()}refresh(){this.render()}render(){this.getData(this.currentDirPath,"list")}renderHeader(){return`<div class="row fb-header">\n                    <div class="fb-download-overlay hidden"></div>\n                        <div class="row padding-top-0">\n                            <div class="col-1 col-l-1 col-m-1">\n                                <button type="button" class="btn _clickable btn-default bg-outstanding fb-up">\n                                    <i class="fa fa-level-up" flx-fw=""></i><span class="hidden-xs"> ${this.translate("goback")}</span>\n                                </button>\n                            </div>\n                            <div class="col-11 col-l-11 col-m-11 text-center">\n\n                                <button type="button" class="btn btn-default bg-outstanding fb-upload">\n                                    <i class="flx-icon icon-upload" flx-fw=""></i><span class="hidden-xs"> ${this.translate("uploadfiles")} </span>\n                                </button>\n                            <input class="fb-input-upload hide" method="upload" value="disk" type="file" multiple>\n                                <button type="button" method="opendialog" value="upload" class="btn btn-default bg-outstanding fb-add">\n                                    <i class="flx-icon icon-folder-add"></i><span class="hidden-xs"> ${this.translate("addfolder")}\n                                    </span>\n                                </button>\n                                <button type="button" class="btn btn-default bg-outstanding fb-download" disabled>\n                                    <i class="flx-icon icon-download"></i><span class="hidden-xs"> ${this.translate("download")}\n                                    </span>\n                                </button>\n                                \n                                <button type="button" class="btn btn-default bg-outstanding fb-delete" disabled>\n                                    <i class="flx-icon icon-delete-2"></i><span class="hidden-xs"> ${this.translate("delete")}\n                                    </span>\n                                </button>\n                                \n                                \n                            </div>\n                        </div>\n\n                        <div class="row fb-path-info" >\n                            <div class="col-12 col-l-12 col-m-12 text-center">\n                                <span> ${this.translate("currentfolder")}: ${this.currentDirPath} </span>\n\n                            </div>\n                        </div>\n                    </div>`}renderFooter(){return`<div class="fb-footer"><span class="fb-info-selected">0 ${this.translate("itemsselected")}</span></div>`}getData(path,actionType){let me=$(this),rendered='<div class="flx-filebrowser" style="height: 100%">',params={ObjectName:me.attr("ObjectName"),ObjectWhere:me.attr("ObjectWhere"),ModuleName:this.moduleName,Path:path,ActionType:actionType,SelectedEntries:this.selectedEntries,NewFolderName:this.newFolderName};flexygo.ajax.post("~/api/FileBrowser","getData",params,response=>{response&&(rendered+=this.renderHeader(),0==response.length?rendered+=`<div class="dir-entry dir-empty">\n                                            <div class="dir-icon">\n                                                <i class="transition-all dir flx-icon icon-folder icon-5x"></i>\n                                            </div>\n                                            <div class="dir-name">${this.translate("emptyfolder")}</div>\n                                        </div>`:response.sort((a,b)=>a.Type-b.Type).forEach(value=>{if(0==value.Type){let dirpath=this.currentDirPath+value.Name;rendered+=`\n                                        <div class="dir-entry animated fadeIn">\n                                            <div class="dir-icon">\n                                                <i data-path="${dirpath}"\n                                                    class="clickable transition-all dir flx-icon icon-folder icon-5x">\n                                                </i>\n                                            </div>\n                                            <div class="dir-name">${value.Name}</div>\n                                            <div class="fb-check"></div>\n                                        </div>`}else{let filepath=this.currentDirPath+value.Name;this.isImage(value.Name)?rendered+=`\n                                            <div class="dir-entry animated fadeIn">\n                                                <div class="dir-img shadow clickable transition-all image"><img data-path="${filepath}"\n                                                    src="${value.Url.split("/").splice(1).join("/")}"></div>\n                                                <div class="dir-name">${value.Name.toLowerCase()}</div>\n                                                <div class="fb-check"></div>\n                                            </div>`:rendered+=`\n                                    <div class="dir-entry animated fadeIn ${"flx-download.zip"==value.Name?"hidden":""}">\n                                        <div class="dir-icon"><a href="${value.Url.split("/").splice(1).join("/")}"><i data-path="${filepath}" class="clickable file transition-all ${flexygo.utils.getFileIcon(value.Name.split(".").pop())} icon-4x"></i></a>\n                                        </div>\n                                        <div class="dir-name">${value.Name}</div>\n                                        <div class="fb-check"></div>\n                                    </div>`}}),rendered+="</div>",rendered+=this.renderFooter(),me.html(rendered),this.setupEvents())})}translate(str){return flexygo.localization.translate(`flxfilebrowser.${str}`)}startFileUpload(files){let filesInDir=[],found=[];this.filesPending=files.length,this.filesTotal=this.filesPending,$(".clickable.file",this).each((i,element)=>{let filenameParts=$(element).data("path").split("/");filesInDir.push(filenameParts[filenameParts.length-1])}),$("img",this).each((i,element)=>{let filenameParts=$(element).data("path").split("/");filesInDir.push(filenameParts[filenameParts.length-1])});for(let i=0;i<files.length;i++){let filename=files[i].name;-1!=filesInDir.indexOf(filename)&&found.push(filename)}if(found.length>0){let msg=`\n                        <div>${this.translate("existingfiles")}</div>\n                        <div>${this.translate("overwritefiles")}</div>`;flexygo.msg.confirm(msg,shouldProceed=>{if(shouldProceed){this.disableEvents();for(let i=0;i<files.length;i++)new flexygo.io.FileUpload(files[i],"diskfile","upload",this).startUpload()}})}else{this.disableEvents();for(let i=0;i<files.length;i++)new flexygo.io.FileUpload(files[i],"diskfile","upload",this).startUpload()}}disableEvents(){let me=$(this);$(".fb-download-overlay",me).toggleClass("hidden"),$(".clickable",me).css("opacity","0.3"),$(".fb-delete",me).prop("disabled",!0),$(".fb-download",me).prop("disabled",!0),$(".fb-upload",me).prop("disabled",!0),$(".fb-add",me).prop("disabled",!0),$(".fb-up",me).prop("disabled",!0)}setupEvents(){let me=$(this);$(".clickable.dir",me).on("click",e=>{let dirpath=$(e.target).data("path");this.currentDirPath=dirpath+"/",this.getData(dirpath,"list")}),$(".clickable.image",me).on("click",e=>{let src=$(e.target).prop("src");$(`<div class=""><img class="img-responsive" src="${src}"></div>`).dialog({position:{my:"center top",at:"center top+70",of:$("body")},width:"auto",height:"auto",modal:!0,open:e=>{$(window).width()<600?$(this).parent().css("max-width","100%"):$(this).parent().css("max-width","auto")},close:e=>{$(e.target).dialog("destroy").remove()}}).dialogExtend({closable:!0,maximizable:!1,minimizable:!1,collapsable:!1,dblclick:!1,modal:!0,close:e=>{$(e.target).remove()}})}),$(".fb-delete",me).on("click",e=>{let msg=`<div>${this.translate("saving")} (${this.selectedEntries.length}) ${this.translate("items")}</div>\n                           <div>${this.translate("sure")}</div>`;flexygo.msg.confirm(msg,shouldDelete=>{shouldDelete&&this.getData(this.currentDirPath,"remove")})}),$(".fb-download",me).on("click",e=>{this.disableEvents();let downloadButton=$(".fb-download",me);downloadButton.fadeOut("fast",e=>{downloadButton.html(`<i class='dir flx-icon icon-sincronize icon-spin'></i><span class='hidden-xs'> ${this.translate("processingdownload")}</span>`),downloadButton.fadeIn("slow")}),this.getData(this.currentDirPath,"download")}),$(".fb-upload",me).on("click",e=>{$(".fb-input-upload",me).click()}),$(".fb-input-upload",me).on("change",e=>{let files=$(".fb-input-upload",me).prop("files");this.startFileUpload(files)}),$(".fb-up",me).on("click",e=>{this.currentDirPath=this.currentDirPath.split("/").slice(0,-2).join("/")+"/",this.getData(this.currentDirPath,"list")}),$(".fb-add",me).on("click",e=>{flexygo.msg.prompt("New folder","Name of new folder",input=>{this.newFolderName=input,flexygo.utils.isBlank(this.newFolderName)||this.getData(this.currentDirPath,"add")},"Name of new folder","")}),$(".fb-check",me).on("click",e=>{$(e.target).toggleClass("fb-check-selected"),this.selectedEntries=$.makeArray($(".fb-check-selected",me).map(function(){let parent=$(this).parent();return $("[data-path]",parent).data("path")}));let itemsSelectedTranslation=this.translate("itemsselected");$(".fb-info-selected",me).html(`${this.selectedEntries.length} ${itemsSelectedTranslation}`),this.selectedEntries.length>0?($(".fb-delete",me).prop("disabled",!1),$(".fb-download",me).prop("disabled",!1)):($(".fb-delete",me).prop("disabled",!0),$(".fb-download",me).prop("disabled",!0))});let dragDropZone=$(".flx-filebrowser",me);dragDropZone.on("dragover",e=>{dragDropZone.css("background-color","rgba(0,0,0,0.1)")}).on("dragleave",e=>{dragDropZone.css("background-color","")}).on("drop",e=>{e.preventDefault(),dragDropZone.css("background-color","");let files=e.originalEvent.dataTransfer.files;files.length>0&&this.startFileUpload(files)});let downloadFile=$('[data-path*="flx-download.zip"]',me).parent();downloadFile.prop("href")&&(location.href=downloadFile.prop("href")),"/"==this.currentDirPath?$(".fb-up",me).prop("disabled",!0):$(".fb-up",me).prop("disabled",!1)}isImage(file){switch(file.split(".").pop().toLowerCase()){case"png":case"jpg":case"jpeg":case"gif":return!0;default:return!1}}connectedCallback(){let element=$(this);this.connected=!0,this.objectName=element.attr("ObjectName"),this.objectWhere=element.attr("ObjectWhere"),this.moduleName=element.attr("ModuleName"),this.init()}attributeChangedCallback(attrName,oldVal,newVal){let needInit=!1;"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.moduleName=newVal,needInit=!0):"objectname"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectName=newVal,needInit=!0):"objectwhere"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.objectWhere=newVal,needInit=!0),this.connected&&needInit&&this.init()}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),function(flexygo){!function(io){io.FileUpload=class{constructor(file,type,action,manager){this.bufferSize=2097152,this.currentPosition=0,this.file=file,this.objectName=manager.objectName,this.objectWhere=manager.objectWhere,this.moduleName=manager.moduleName,this.manager=manager,this.documentType=type,this.action=action,this.currentDirPath=manager.currentDirPath}startUpload(){this.reader=new FileReader,this.reader.onloadend=(event=>{if(2===event.target.readyState)if(0!=this.file.size)if(this.file.size>this.bufferSize)if(0==this.currentPosition)this.setDocument(event.target.result,this.file.name,!0);else if(this.currentPosition<this.file.size){let lastAppend=!(this.currentPosition+this.bufferSize<this.file.size);this.appendToDocument(event.target.result,this.file.name,lastAppend)}else 0==this.manager.filesPending&&(this.manager.getData(this.manager.currentDirPath,"list"),flexygo.msg.success("flxfilebrowser.saved"));else this.setDocument(event.target.result,this.file.name,!1);else""!=this.documentId&&this.removeDocument()}),this.upload_file()}percentDone(){let percent=Math.floor(this.currentPosition/this.file.size*100);return percent>=100&&this.manager.filesPending--,percent>100?100:percent}upload_file(){let blob=this.file.slice(this.currentPosition,this.currentPosition+this.bufferSize);this.reader.readAsDataURL(blob)}appendToDocument(base64,documentName,lastAppend){try{let params;$(this),base64=base64?base64.split(",")[1]:null,params={ObjectName:this.objectName,ObjectWhere:this.objectWhere,ModuleName:this.moduleName,DocumentId:this.documentId,DocumentName:documentName,Base64:base64,LastAppend:lastAppend,CurrentPath:this.currentDirPath},flexygo.ajax.post("~/api/FileBrowser","AppendToDocument",params,response=>{this.currentPosition+=this.bufferSize,this.upload_file(),$(this.manager).find(`.fb-progress[data-progress="${documentName}"]`).html(`\n                            <flx-timeline-progressbar percentage="${this.percentDone()}"></flx-timeline-progressbar>`)},()=>{this.removeDocument()})}catch(ex){console.log(ex)}}setDocument(base64,documentName,multipart){try{let params;if($(this),base64=base64?base64.split(",")[1]:null,("diskfile"===this.documentType.toLowerCase()||"diskfolder"===this.documentType.toLowerCase())&&!base64)return void flexygo.msg.warning("flxfilebrowser.documentempty");params={ObjectName:this.objectName,ObjectWhere:this.objectWhere,ModuleName:this.moduleName,ObjectId:null,DocumentName:documentName,DocumentType:this.documentType,Base64:base64,CloudId:null,CloudLink:null,DownloadLink:null,DocAction:this.action,PartialUpload:multipart,CurrentPath:this.currentDirPath},this.manager.getElementsByClassName("fb-footer")[0].scrollIntoView({block:"end",behavior:"smooth"}),flexygo.ajax.post("~/api/FileBrowser","SetDocument",params,response=>{multipart?($(this.manager).find(".dir-entry").last().after(`\n                                    <div class="dir-entry animated bounceIn">\n                                        <div class="dir-icon dir-upload"></div>\n\t\t\t\t\t\t\t\t\t\t<div class="fb-progress" data-progress="${documentName}"><flx-timeline-progressbar _color="#0b5ba1" percentage="${this.percentDone()}"></flx-timeline-progressbar></div>\n                                        <div class="dir-name">${documentName}</div>\n                                    </div>`),this.currentPosition+=this.bufferSize,this.upload_file()):response&&!response.documentError?($(this.manager).find(".dir-entry").last().after(`\n                                    <div class="dir-entry animated bounceIn">\n                                        <div class="dir-icon dir-upload"></div>\n\t\t\t\t\t\t\t\t\t\t<div class="fb-progress" data-progress="${documentName}"><flx-timeline-progressbar _color="#0b5ba1" percentage="100"></flx-timeline-progressbar></div>\n                                        <div class="dir-name">${documentName}</div>\n                                    </div>`),this.manager.filesPending--,0==this.manager.filesPending&&(this.manager.getData(this.manager.currentDirPath,"list"),flexygo.msg.success("flxfilebrowser.saved"))):response.permissionError?flexygo.msg.warning("flxfilebrowser.permissionerror"):flexygo.msg.error("flxfilebrowser.errorsaving")})}catch(ex){console.log(ex)}}removeDocument(){try{let params;params={ObjectName:this.objectName,ObjectWhere:this.objectWhere,ModuleName:this.moduleName},flexygo.ajax.post("~/api/FileBrowser","RemoveDocument",params,response=>{response.documentError&&(response.permissionError?flexygo.msg.warning("flxfilebrowser.permissionerror"):flexygo.msg.error("flxfilebrowser.errorremoving"))})}catch(ex){console.log(ex)}}}}(flexygo.io||(flexygo.io={}))}(flexygo||(flexygo={})),window.customElements.define("flx-filebrowser",flexygo.ui.wc.FlxFileBrowserElement);