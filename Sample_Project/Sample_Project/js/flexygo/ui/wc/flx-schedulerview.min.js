var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxSchedulerViewElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.moduleName=null,this.options=null,this.me=$(this),this.today=moment(),this.additionalWhere=null}connectedCallback(){let element=$(this);this.connected=!0,this.moduleName=element.attr("modulename"),this.data=element.attr("value"),"true"!=element.attr("manualInit")&&this.init()}static get observedAttributes(){return["modulename","value"]}attributeChangedCallback(attrName,oldVal,newVal){this.connected&&("modulename"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.moduleName=newVal,this.moduleName&&this.refresh()),"value"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.data=newVal,this.data&&this.refresh()))}refresh(){"true"!=$(this).attr("manualInit")&&this.render(".schedulerView")}init(){let me=$(this);me.removeAttr("manualInit"),this.me.append('<div class="schedulerView" ></div>');let parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&wcModule.moduleLoaded(this),this.render(".schedulerView")}render(selector){this.me.el=$(this).find(selector)[0],this.me.current=moment().date(1),this.me.current.locale(flexygo.profiles.langKey.toLowerCase().slice(0,2)),this.changeEvents(this.additionalWhere)}changeEvents(additionalWhere){let ctx=this,me=$(this),datepicker=new Date(ctx.me.current),date=new Date(ctx.me.current.date(1)),start=ctx.formatDate(date,""+(date.getMonth()+1),"01",date.getFullYear()),end="";me.find("#datepicker").datepicker("setDate",datepicker.getMonth()+1+"/"+datepicker.getDate()+"/"+datepicker.getFullYear()),end=date.getMonth()+1==12?ctx.formatDate(date,"01","01",date.getFullYear()+1):ctx.formatDate(date,""+(date.getMonth()+2),"01",date.getFullYear());let paramsConfig={ModuleName:ctx.moduleName};flexygo.ajax.post("~/api/SchedulerView","GetSchedulerConfig",paramsConfig,response=>{if(response){ctx.me.conf=response;let params={ObjName:me.attr("objectname"),ObjectWhere:me.attr("objectwhere"),ModuleName:ctx.moduleName,Start:start,End:end,AdditionalWhere:additionalWhere,SchedulerConfig:response};flexygo.ajax.post("~/api/SchedulerView","GetSchedulerViewConfig",params,response=>{if(response){ctx.me.events=response,ctx.draw();var current=document.querySelector(".today");current&&window.setTimeout(function(){ctx.openDay(current)},500)}})}})}draw(){let ctx=this,me=$(this);ctx.drawHeader(),ctx.drawMonth(),$(".h1-datepicker").append('<div class="col-6 col-m-12"><div id="datepicker" style="display:none;position:absolute;z-index: 2;" class="cute-calendar"></div></div>');let dp1=me.find("#datepicker");$(".h1-datepicker").click(function(){dp1.show()}),dp1.datepicker({onSelect:function(dateText,inst){dp1.hide();var date=new Date(dateText);ctx.me.current=moment(date),ctx.me.current.locale(flexygo.profiles.langKey.toLowerCase().slice(0,2)),ctx.changeEvents(ctx.additionalWhere)},firstDay:1}),$("#mainContent").on("scroll",function(){dp1.hide()}),$(document).mouseup(function(e){dp1.is(e.target)||0!==dp1.has(e.target).length||dp1.hide()})}drawHeader(){let ctx=this;if(!ctx.me.header){ctx.me.header=ctx.createElement("div","header","",""),$(ctx.me.header).addClass("header"),ctx.me.datepicker=ctx.createElement("div","h1-datepicker","",""),ctx.me.title=ctx.createElement("h1","","","");var right=ctx.createElement("div","right","","");$(right).click(function(){ctx.nextMonth()});var left=ctx.createElement("div","left","","");$(left).click(function(){ctx.prevMonth()}),$(ctx.me.datepicker).append(ctx.me.title),$(ctx.me.header).append(ctx.me.datepicker),$(ctx.me.header).append(right),$(ctx.me.header).append(left),$(ctx.me.el).append(ctx.me.header)}$(ctx.me.title).html(ctx.me.current.format("MMMM YYYY"))}drawMonth(){let ctx=this,me=$(this);ctx.me.events.forEach(function(ev){ev.date=moment(ev.Date),ev.eventName=flexygo.utils.parser.recursiveCompile(ev.Row,ev.eventName)}),ctx.me.month?(ctx.me.oldMonth=ctx.me.month,$(ctx.me.oldMonth).addClass("month out "+(ctx.me.next?"next":"prev")),$(ctx.me.oldMonth).on("webkitAnimationEnd",function(){$(ctx.me.oldMonth).remove(),ctx.me.month=ctx.createElement("div","month","",""),ctx.backFill(),ctx.currentMonth(),ctx.fowardFill(),$(ctx.me.el).append(ctx.me.month),window.setTimeout(function(){$(ctx.me.month).addClass("month in "+(ctx.me.next?"next":"prev")),me.find(".month").not(".in").remove()},16)})):(ctx.me.month=ctx.createElement("div","month","",""),$(ctx.me.el).append(ctx.me.month),ctx.backFill(),ctx.currentMonth(),ctx.fowardFill(),$(ctx.me.month).addClass("month new"))}createElement(tagName,className,innerText,backgroundColor){var ele=document.createElement(tagName);return className&&$(ele).addClass(className),innerText&&$(ele).text(innerText),backgroundColor&&$(ele).css("background-color",backgroundColor),ele}backFill(){let ctx=this;var clone=ctx.me.current.clone(),dayOfWeek=clone.day();dayOfWeek||(dayOfWeek=6),clone.subtract("days",dayOfWeek+1);for(var i=dayOfWeek;i>0;i--)ctx.drawDay(clone.add("days",1))}getWeek(day){let ctx=this;1===day.day()&&(ctx.me.week=ctx.createElement("div","week","",""),$(ctx.me.month).append(ctx.me.week))}fowardFill(){let ctx=this;var clone=ctx.me.current.clone().add("months",1).subtract("days",1),dayOfWeek=clone.day();if(!(dayOfWeek>6))for(var i=dayOfWeek;i<=6;i++)ctx.drawDay(clone.add("days",1))}currentMonth(){let ctx=this;for(var clone=ctx.me.current.clone();clone.month()===ctx.me.current.month();)ctx.drawDay(clone),clone.add("days",1)}drawDay(day){let ctx=this;ctx.getWeek(day);var outer=ctx.createElement("div",ctx.getDayClass(day),"","");$(outer).attr("currentdate",day.format("YYYYMMDD")),"day other"!=$(outer).attr("class")?$(outer).click(function(){ctx.openDay(this);let ev={class:"module",type:"selected",sender:ctx,masterIdentity:$(this).attr("currentdate"),detailIdentity:null};flexygo.events.trigger(ev)}):$(outer).click(function(){let ev={class:"module",type:"selected",sender:ctx,masterIdentity:$(this).attr("currentdate"),detailIdentity:null};flexygo.events.trigger(ev)});var name=ctx.createElement("div","day-name",day.format("ddd"),""),number=ctx.createElement("div","day-number",day.format("DD"),""),events=ctx.createElement("div","day-events","","");ctx.drawEvents(day,events),$(outer).append(name),$(outer).append(number),$(outer).append(events),$(ctx.me.week).append(outer)}drawEvents(day,element){let ctx=this;day.month()===ctx.me.current.month()&&ctx.me.events.reduce(function(memo,ev){return ev.date.isSame(day,"day")&&memo.push(ev),memo},[]).forEach(function(ev){var evSpan=ctx.createElement("span","","",ev.color);$(element).append(evSpan)})}getDayClass(day){var classes;return classes=["day"],day.month()!==this.me.current.month()?classes.push("other"):this.today.isSame(day,"day")&&classes.push("today"),classes.join(" ")}openDay(el){let ctx=this;var details,arrow,defaultDate=$(el).attr("currentdate"),dayNumber=+$(el).find(".day-number").text(),day=ctx.me.current.clone().date(dayNumber),currentOpened=$(document).find(".details")[0];currentOpened&&$(currentOpened).parent()[0]===$(el).parent()[0]?(details=currentOpened,arrow=$(document).find(".arrow")[0]):(currentOpened&&($(currentOpened).on("webkitAnimationEnd",function(){$(currentOpened).remove()}),$(currentOpened).on("oanimationend",function(){$(currentOpened).remove()}),$(currentOpened).on("msAnimationEnd",function(){$(currentOpened).remove()}),$(currentOpened).on("animationend",function(){$(currentOpened).remove()}),$(currentOpened).addClass("details out")),details=ctx.createElement("div","details in","",""),arrow=ctx.createElement("div","arrow","",""),$(details).append(arrow),$(el).parent().append(details));var todaysEvents=ctx.me.events.reduce(function(memo,ev){return ev.date.isSame(day,"day")&&memo.push(ev),memo},[]);ctx.renderEvents(todaysEvents,details,defaultDate);var arrowWidth=50*$(el).width()/100+7;$(arrow).css("left",$(el).offset().left-$(el).parent().offset().left+arrowWidth+"px")}renderEvents(events,ele,defaultDate){let ctx=this;var currentWrapper=ele.querySelector(".events"),wrapper=ctx.createElement("div","events in"+(currentWrapper?" new":""),"",""),addNew=ctx.createElement("i","clickable padding-right-l addnew icon-15x flx-icon icon-add-icon txt-notify","","");if($(addNew).click(function(){if(ctx.me.conf.length>1){let myButtons=new Object,buttons="";for(var i=0;i<ctx.me.conf.length;i++)myButtons[ctx.me.conf[i].ObjectName]={ObjectName:ctx.me.conf[i].ObjectName,StartDateField:ctx.me.conf[i].StartDateField,Icon:ctx.me.conf[i].Icon,Target:ctx.me.conf[i].Target},ctx.me.conf[i].CanInsert&&(buttons+='<a style="padding: 0.7em;margin-right: 3%;margin-bottom: 3%;" class="btn btn-default bg-outstanding modalButton"><i style="margin-right:4px;" class="'+ctx.me.conf[i].Icon+'"></i>'+ctx.me.conf[i].ObjectName+"</a>");""!=buttons&&($.sweetModal({title:flexygo.localization.translate("flxscheduler.chooseobjects"),content:"<div>"+buttons+"</div>",theme:$.sweetModal.THEME_MIXED,width:"31%"}),$(".modalButton").click(function(){let object=myButtons[this.text],defaults={};defaults[ctx.me.conf[0].StartDateField]=defaultDate.substring(0,4)+"-"+defaultDate.substring(4,6)+"-"+defaultDate.substring(6,8),flexygo.nav.openPage("edit",object.ObjectName,null,JSON.stringify(defaults),object.Target,!1,$(this)),$(".sweet-modal-overlay").remove()}))}else if(ctx.me.conf[0].CanInsert){let defaults={};defaults[ctx.me.conf[0].StartDateField]=defaultDate.substring(0,4)+"-"+defaultDate.substring(4,6)+"-"+defaultDate.substring(6,8),flexygo.nav.openPage("edit",ctx.me.conf[0].ObjectName,null,JSON.stringify(defaults),ctx.me.conf[0].Target,!1,$(this))}}),$(wrapper).append(addNew),events.forEach(function(ev){var div=ctx.createElement("div","event","",""),square=ctx.createElement("div","event-category ","",ev.color),span=$("<span />").html(ev.eventName)[0];"edit"==ev.pageType&&ev.canEdit&&$(div).click(function(){flexygo.nav.openPage(ev.pageType,ev.calendar,ctx.getObjectWhere(ev.table,ev.key,ev.id),null,ev.target,!1,$(this))}),"view"==ev.pageType&&ev.canView&&$(div).click(function(){flexygo.nav.openPage(ev.pageType,ev.calendar,ctx.getObjectWhere(ev.table,ev.key,ev.id),null,ev.target,!1,$(this))}),$(div).append(square),$(div).append(span),$(wrapper).append(div)}),!events.length){var div=ctx.createElement("div","event empty","",""),span=ctx.createElement("span","","No Events","");$(div).append(span),$(wrapper).append(div)}currentWrapper?($(currentWrapper).addClass("events out"),$(currentWrapper).on("webkitAnimationEnd",function(){$(currentWrapper).remove(),$(ele).append(wrapper)}),$(currentWrapper).on("oanimationend",function(){$(currentWrapper).remove(),$(ele).append(wrapper)}),$(currentWrapper).on("msAnimationEnd",function(){$(currentWrapper).remove(),$(ele).append(wrapper)}),$(currentWrapper).on("animationend",function(){$(currentWrapper).remove(),$(ele).append(wrapper)})):$(ele).append(wrapper)}drawLegend(){let ctx=this;var legend=ctx.createElement("div","legend","","");ctx.me.events.map(function(e){return e.calendar+"|"+e.color}).reduce(function(memo,e){return-1===memo.indexOf(e)&&memo.push(e),memo},[]).forEach(function(e){var parts=e.split("|"),entry=ctx.createElement("span","entry",parts[0],""),evSpan=ctx.createElement("span","colorLegend","",parts[1]);$(entry).prepend(evSpan),$(legend).append(entry)}),$(ctx.me.el).append(legend)}getObjectWhere(table,key,id){let where="",last=0;for(var i=0;i<key.length;i++)where+=table+"."+key[i]+" = '"+id[i]+"'",++last<key.length&&(where+=" and ");return where}nextMonth(){this.me.current.add("months",1),this.me.next=!0,this.changeEvents(this.additionalWhere)}prevMonth(){this.me.current.subtract("months",1),this.me.next=!1,this.changeEvents(this.additionalWhere)}formatDate(date,month,day,year){return month.length<2&&(month="0"+month),day.length<2&&(day="0"+day),[year,month,day].join("")}translate(str){return flexygo.localization.translate(str)}startLoading(){$(this).parents("flx-module").length>0&&$(this).parents("flx-module")[0].startLoading()}stopLoading(){$(this).parents("flx-module").length>0&&$(this).parents("flx-module")[0].stopLoading()}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-schedulerview",flexygo.ui.wc.FlxSchedulerViewElement);