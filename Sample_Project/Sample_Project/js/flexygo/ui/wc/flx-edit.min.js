var flexygo;!function(flexygo){!function(ui){!function(wc_1){class FlxEditElement extends HTMLElement{constructor(){super(),this.connected=!1,this.moduleName=null,this.objectname=null,this.objectwhere=null,this.processName=null,this.reportName=null,this.mode=null,this.tHeader=null,this.tBody=null,this.tFooter=null,this.templateId=null,this.defaults=null,this.JSforParams=null,this.maxTabIndex=0,this.isClone=!1,this.dependenciesLoaded=!1,this.loadingDependencies=0,this.pendingSaveButton=null}connectedCallback(){this.connected=!0;let element=$(this);this.moduleName=element.attr("modulename"),this.reportName=element.attr("reportName"),this.processName=element.attr("processName");let mode="edit";this.reportName&&(mode="report"),this.processName&&(mode="process"),this.mode=mode,this.defaults=element.attr("defaults"),this.moduleName&&"true"!=element.attr("manualInit")&&this.init()}disconnectedCallback(){flexygo.events.off(this,"property","changed",this.onPropertyChanged);for(let i=0;i<$(this).find('flx-code[editor="monaco"]').length;i++){let monacoEditor=$(this).find('flx-code[editor="monaco"]')[i];monacoEditor.monaco&&monacoEditor.monaco.dispose(),flexygo.events.off(monacoEditor,"property","resized"),flexygo.events.off(monacoEditor,"module","resized"),flexygo.events.off(monacoEditor,"dialog","resized")}}attributeChangedCallback(attrName,oldVal,newVal){this.connected&&"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.moduleName=newVal,this.moduleName&&this.refresh())}init(){this.dependenciesLoaded=!1,flexygo.events.off(this,"property","changed",this.onPropertyChanged),flexygo.events.on(this,"property","changed",this.onPropertyChanged,!0),$(this).on("destroy",()=>{flexygo.events.off(this,"property","changed",this.onPropertyChanged)});let me=$(this);switch(me.removeAttr("manualInit"),$(this).closest("flx-module").find(".flx-noInitContent").remove(),this.templateId=null,me.attr("Mode")){case"process":this.initProcessMode();break;case"report":this.initReportMode();break;default:this.initEditMode()}$(this).off("keydown.tabcontrol").on("keydown.tabcontrol",ev=>{if("Tab"===ev.key){var target=$(ev.target).closest("[Property]");if(!target.is("flx-barcode")&&!target.is("flx-code")){var index=parseInt($(ev.target).attr("tabindex"));ev.shiftKey?index--:index++;var dependenciesLoad=setInterval(()=>{if(0===target.find(".item #flx-dependency-loader, .grid-stack-item #flx-dependency-loader").length){if(!target.find("> div").hasClass("has-error")){let control=$(this).find("[tabindex="+index+"]");if("thousandSeparator"===control.closest("flx-text").attr("type"))control.select().click();else if(0===control.closest("flx-multicombo").length)control.select().focus();else{let searchControl=$(this).find(`[tabindex="${index}"][type="search"]`);searchControl.is(":visible")?searchControl.focus():control.focus().click()}}clearInterval(dependenciesLoad)}},200)}}})}refresh(){for(let i=0;i<$(this).find('flx-code[editor="monaco"]').length;i++){let monacoEditor=$(this).find('flx-code[editor="monaco"]')[i];monacoEditor.monaco&&monacoEditor.monaco.dispose(),flexygo.events.off(monacoEditor,"property","resized"),flexygo.events.off(monacoEditor,"module","resized"),flexygo.events.off(monacoEditor,"dialog","resized")}"true"!=$(this).attr("manualInit")&&this.init()}initEditMode(){let me,objDef,selector;if(objDef=null,(me=$(this)).html(""),this.defaults)objDef="string"==typeof this.defaults?JSON.parse(this.defaults):this.defaults;else{let histObj=flexygo.history.get(me);if(void 0!==histObj&&histObj.defaults&&(objDef="string"==typeof histObj.defaults?JSON.parse(flexygo.utils.parser.replaceAll(histObj.defaults,"'",'"')):histObj.defaults),null==objDef){let wcMod=me.closest("flx-module")[0];wcMod&&(objDef=wcMod.objectdefaults)}}this.isClone="true"===me.attr("isClone");let params={ObjectName:me.attr("ObjectName"),ObjectWhere:me.attr("ObjectWhere"),ModuleName:this.moduleName,Defaults:flexygo.utils.dataToArray(objDef),TemplateId:this.templateId,Clone:"true"===me.attr("isClone")};flexygo.ajax.post("~/api/Edit","GetEditTemplate",params,response=>{if(response){let template=response.Template,parentModule=me.closest("flx-module"),wcModule=parentModule[0];if(!parentModule||!wcModule)return;if(response.Buttons){wcModule.setButtons(response.Buttons,response.ObjectName,response.ObjectWhere),this.setMaxTabindex(response.Properties),parentModule.find(".cntBodyFooter .moduleButtons div.btn-group span.submenuContainer button, .cntBodyFooter .moduleButtons div.btn-group button").each((i,btn)=>{this.maxTabIndex++,$(btn).attr("tabIndex",this.maxTabIndex)})}else wcModule.setButtons(null,response.ObjectName,response.ObjectWhere);wcModule.setObjectDescrip(response.Title),this.data=template.Data,this.tHeader=template.Header,this.tBody=template.Body,this.tFooter=template.Footer,this.properties=response.Properties,this.objectname=response.ObjectName,this.objectwhere=response.ObjectWhere,this.templateId=response.Template.Id,response.TemplateList&&(this.templateList=response.TemplateList),this.render(),this.initValidate()}selector=me.closest("div.ui-dialog").length?"div.ui-dialog":"div#mainContent",me.closest(selector).find("flx-module flx-edit").first().find("[property] select:enabled:visible, [property] input:enabled:visible, [property] textarea:enabled:visible").first().focus();let parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&(wcModule.moduleLoaded(this),wcModule.ModuleViewers&&""!==response.ObjectWhere&&(this.currentViewers=response.CurrentViewers,flexygo.utils.refreshModuleViewersInfo(wcModule,this.currentViewers),flexygo.utils.checkObserverModule(wcModule,2e4),flexygo.events.on(this,"push","notify",function(e){switch(e.masterIdentity){case"GetSetModuleViewers":(""==wcModule.moduleName?null:wcModule.moduleName)==(""==e.sender.ModuleName?null:e.sender.ModuleName)&&(""==wcModule.objectname?null:wcModule.objectname)==(""==e.sender.ObjectName?null:e.sender.ObjectName)&&(""==wcModule.objectwhere?null:wcModule.objectwhere)==(""==e.sender.ObjectWhere?null:e.sender.ObjectWhere)&&flexygo.utils.refreshModuleViewersInfo(wcModule,e.sender.ActiveUsers)}})))})}initReportMode(){let objDef,selector,me=$(this);if(this.defaults)objDef=JSON.parse(this.defaults);else{let histObj=flexygo.history.get(me);void 0!==histObj&&histObj.defaults&&""!=histObj.defaults&&(objDef=JSON.parse(flexygo.utils.parser.replaceAll(histObj.defaults,"'",'"')))}me.html("");let params={ObjectName:me.attr("ObjectName"),ObjectWhere:me.attr("ObjectWhere"),ModuleName:this.moduleName,ReportName:me.attr("ReportName"),Defaults:flexygo.utils.dataToArray(objDef)};flexygo.ajax.post("~/api/Edit","GetReportParamsTemplate",params,response=>{if(response){me.closest(".ui-dialog").find(".ui-dialog-title").length>0&&"{{ReportDescrip}}"==me.closest(".ui-dialog").find(".ui-dialog-title").html()&&me.closest(".ui-dialog").find(".ui-dialog-title").html(response.Title);let template=response.Template,parentModule=me.closest("flx-module"),wcModule=parentModule[0];if(parentModule&&wcModule){if(response.Buttons){wcModule.setButtons(response.Buttons,response.ObjectName,response.ObjectWhere,response.ReportName,null),this.setMaxTabindex(response.Properties),$(wcModule).find(".cntBodyFooter .moduleButtons div.btn-group span.submenuContainer button, .cntBodyFooter .moduleButtons div.btn-group button").each((i,btn)=>{this.maxTabIndex++,$(btn).attr("tabIndex",this.maxTabIndex)})}else wcModule.setButtons(null,response.ObjectName,response.ObjectWhere,response.ReportName,null);wcModule.setObjectDescrip(response.Title)}this.data=response.Properties,this.tHeader=template.Header,this.tBody=template.Body,this.tFooter=template.Footer,this.properties=response.Properties,this.render(),this.initValidate()}selector=me.closest("div.ui-dialog").length?"div.ui-dialog":"div#mainContent",me.closest(selector).find("flx-module flx-edit").first().find("[property] select:enabled:visible, [property] input:enabled:visible, [property] textarea:enabled:visible").first().focus();let parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&wcModule.moduleLoaded(this)})}setMaxTabindex(props){0===this.maxTabIndex&&(this.maxTabIndex=Object.keys(props).length+this.lastEditControlsCount())}lastEditControlsCount(){$(this).addClass("flx-currentExaminedEdit");let otherEdits=$("flx-edit:not(.flx-currentExaminedEdit)[ControlsNumber]"),totalControls=0;return otherEdits.length>0&&otherEdits.each((index,el)=>{let elementControls=parseInt(el.getAttribute("ControlsNumber"));totalControls=elementControls>totalControls?elementControls:totalControls}),$(this).removeClass("flx-currentExaminedEdit"),totalControls}initProcessMode(){let me=$(this);me.html("");let selector,objDef=null;if(this.defaults)objDef=JSON.parse(this.defaults);else{let histObj=flexygo.history.get(me);void 0!==histObj&&histObj.defaults&&""!=histObj.defaults&&(objDef=JSON.parse(flexygo.utils.parser.replaceAll(histObj.defaults,"'",'"')))}let params={ObjectName:me.attr("ObjectName"),ObjectWhere:me.attr("ObjectWhere"),ModuleName:this.moduleName,ProcessName:me.attr("ProcessName"),Defaults:flexygo.utils.dataToArray(objDef)};flexygo.ajax.post("~/api/Edit","GetProcessParamsTemplate",params,response=>{if(response){me.closest(".ui-dialog").find(".ui-dialog-title").length>0&&"{{ProcessDescrip}}"==me.closest(".ui-dialog").find(".ui-dialog-title").html()&&me.closest(".ui-dialog").find(".ui-dialog-title").html(response.Title);let template=response.Template,parentModule=me.closest("flx-module"),wcModule=parentModule[0];if(parentModule&&wcModule){if(response.Buttons){wcModule.setButtons(response.Buttons,response.ObjectName,response.ObjectWhere,null,response.ProcessName),this.setMaxTabindex(response.Properties),$(wcModule).find(".cntBodyFooter .moduleButtons div.btn-group span.submenuContainer button, .cntBodyFooter .moduleButtons div.btn-group button").each((i,btn)=>{this.maxTabIndex++,$(btn).attr("tabIndex",this.maxTabIndex)})}else wcModule.setButtons(null,response.ObjectName,response.ObjectWhere,null,response.ProcessName);wcModule.setObjectDescrip(response.Title)}this.data=response.Properties,this.tHeader=template.Header,this.tBody=template.Body,this.tFooter=template.Footer,this.properties=response.Properties,this.JSforParams=response.JSforParams,this.render(),this.initValidate(),response.RunButtonText&&me.closest("flx-module").find("button[data-type='runprocess']")&&me.closest("flx-module").find("button[data-type='runprocess']").children("span").html(response.RunButtonText),response.RunButtonIconName&&me.closest("flx-module").find("button[data-type='runprocess'] i")&&me.closest("flx-module").find("button[data-type='runprocess']").children("i").removeClass().addClass(response.RunButtonIconName+" margin-right-s")}selector=me.closest("div.ui-dialog").length?"div.ui-dialog":"div#mainContent",me.closest(selector).find("flx-module flx-edit").first().find("[property] select:enabled:visible, [property] input:enabled:visible, [property] textarea:enabled:visible").first().focus();let wcModule=me.closest("flx-module")[0];wcModule&&wcModule.moduleLoaded(this)})}initValidate(){$(this).find("form").validate({ignore:".hidProps input, .hidProps select, .hidProps textarea, .hidProps [contenteditable]",unhighlight:(element,errorClass,validClass)=>{$(element).parent().addClass("has-success").removeClass("has-error")},highlight:(element,errorClass,validClass)=>{$(element).parent().removeClass("has-success").addClass("has-error")},errorPlacement:(error,element)=>{$(element).closest("flx-radio").length>0?(error.css("display","block"),error.insertAfter($(element).parent().parent()[0])):error.insertAfter($(element).parent()[0])},errorClass:"txt-danger"})}addLock(){$(this).append('<div style="position:absolute;z-index:60;top:0px;bottom:0px;left:0px;right:0px;background-color:rgba(255,255,255,0.5);" class="lockDiv">&nbsp;</div>'),$(this).closest(".cntBody").css("position","relative")}removeLock(){$(this).closest(".cntBody").css("position",""),$(this).find(".lockDiv").remove()}render(){let me=$(this),rendered=flexygo.utils.parser.recursiveCompile(this.data,this.tBody,this);if(me.empty(),me.html(rendered),me.append('<div style="clear:both"></div>'),!this.moduleName){let btn=$('<button class="btn btn-default bg-info saveButton"> <i class="flx-icon icon-save-2" > </i> <span>'+flexygo.localization.translate("flxedit.save")+"</span> </button>");btn.on("click",ev=>{flexygo.ui.wc.FlxModuleElement.prototype.saveModule(this.objectname,this.objectwhere,$(this),null)}),me.append(btn)}this.setFormValues();let reduce=0;flexygo.utils.isSizeSmartphone()&&(reduce=20);let cellH=62-reduce,itm=me.closest(".size-xs,.size-s,.size-m,.size-l,.no-label");itm.length>0&&(itm.is(".size-xs")?cellH=54-reduce:itm.is(".size-s")?cellH=62-reduce:itm.is(".size-m")?cellH=70-reduce:itm.is(".size-l")&&(cellH=86-reduce),itm.is(".no-label")&&(cellH-=18)),this.processLoadDependencies();let options={cellHeight:cellH,verticalMargin:0,float:!1,disableDrag:!0,disableResize:!0,static_grid:!0};var hideControls=me.find(".resizable-row").find(".hideControlGridStack [property]");if(me.find(".resizable-row").gridstack(options),$(me[0]).find('flx-code[editor="monaco"]').length>0&&$(me[0]).find('flx-code[editor="monaco"]').is(":visible")){flexygo.events.trigger({class:"property",type:"resized",masterIdentity:"flx-edit"},$(this))}if(hideControls.each((index,elem)=>{this.removeStack($(elem))}),!me.attr("Mode")||"edit"==me.attr("Mode")){if(me.find("form").areYouSure(),me.closest(".ui-dialog").find(".ui-dialog-titlebar-close").length>0){let dlg=me.closest("main.pageContainer");dlg.off("dialogbeforeclose").on("dialogbeforeclose",()=>{if(!dlg.hasClass("closing")&&me.closest("flx-module").length>0)return me.closest("flx-module")[0].checkDirtyEdit()})}}this.setTabIndex()}configure(){let where;"report"==this.mode||"process"==this.mode||"generic"==this.templateId?this.openConfig():(where=""==this.templateId||null==this.templateId?"":"TemplateId='"+this.templateId+"'",flexygo.nav.openPage("edit","sysObjectTemplate",where,null,"popup",!0))}configureProcess(){let where;"process"==this.mode?(where="ProcessName='"+this.processName+"'",flexygo.nav.openPage("edit","sysProcess",where,null,"popup",!0)):"report"==this.mode?(where="ReportName='"+this.reportName+"'",flexygo.nav.openPage("edit","sysReport",where,null,"popup",!0)):alert("Not implemented")}configureObjectProcess(){let where;"process"==this.mode?(where="ProcessName='"+this.processName+"' and ObjectName='"+$(this).attr("ObjectName")+"'",flexygo.nav.openPage("edit","sysObjectProcess",where,null,"popup",!0)):alert("Not implemented")}openConfig(){let control,descrip,targetid="",histObj={targetid:targetid=flexygo.utils.isSizeMobile()?"current":"modal",userid:flexygo.context.currentUserId},pageContainer=flexygo.targets.createContainer(histObj,!0,null);if(!pageContainer)return;pageContainer.closest(".ui-dialog").find(".flx-icon.icon-select").remove(),"report"==this.mode?(control='<flx-propertymanager ReportName="'+this.reportName+'" ></flx-propertymanager>',descrip=this.reportName):"process"==this.mode?(control='<flx-propertymanager ProcessName="'+this.processName+'" ></flx-propertymanager>',descrip=this.processName):(control='<flx-propertymanager ObjectName="'+this.objectname+'" ></flx-propertymanager>',descrip=this.objectname);let navString="";navString+='<div class="col-9 col-m-6 col-s-12">',navString+='<flx-container type="emptyCnt">',navString+='<span class="sectitle"><i class="f-icon icon-new-email"> </i>'+descrip+"</span>",navString+="</flx-container>",navString+="</div>",navString+='<div class="col-12">',navString+='<flx-container type="emptyCnt">',navString+=control,navString+="</flx-container>",navString+="</div>",pageContainer.html(navString),$(pageContainer).closest(".ui-dialog").find(".ui-dialog-titlebar-buttonpane button.ui-dialog-titlebar-close").on("click.configure",()=>{this.refresh()})}processLoadDependencies(){if(0==$(document).find(this).length)return;let me=$(this),props=me.find("[property]");if(props.length>0){let Properties=new Array;for(let i=0;i<props.length;i++){let prop=$(props[i])[0];if(Properties.push({Key:prop.property,Value:prop.getValue()}),null==prop.property)return}var isNew=!1;this.processName&&""!=this.processName?isNew=!0:this.reportName&&""!=this.reportName?isNew=!0:me.attr("ObjectWhere")||(isNew=!0);let params={ObjectName:this.objectname,ProcessName:this.processName,ReportName:this.reportName,IsNew:isNew,IsView:!1,Properties};this.paintLoadingEdit(),flexygo.ajax.post("~/api/Edit","processAllDependencies",params,response=>{if(response){let orderStackExecution=!1;for(let i=0;i<response.length;i++){let itm=response[i],prop=me.find('[property="'+itm.PropertyName+'"]'),lblprop=me.find('[lblproperty="'+itm.PropertyName+'"]');prop.length>0&&(this.refreshProperty(itm,prop,lblprop,!0),(itm.changeVisibility||itm.changeEnabled)&&(orderStackExecution=!0))}flexygo.utils.isSizeSmartphone()&&orderStackExecution&&this.orderStack(),orderStackExecution&&this.setTabIndex()}this.dependenciesLoaded=!0,this.removeLoadingEdit();let selector="";selector=me.closest("div.ui-dialog").length?"div.ui-dialog":"div#mainContent",me.closest(selector).find("flx-module flx-edit").first().find("[property] select:enabled:visible, [property] input:enabled:visible, [property] textarea:enabled:visible").first().focus(),me.find("form").removeClass("dirty")})}}restartPosition(){let me=$(this);for(let key in this.properties){me.find('[property="'+this.properties[key].Name+'"]').closest("[data-gs-y]").attr("data-gs-y",this.properties[key].PositionY)}let gd=me.find(".grid-stack").data("gridstack"),nds=gd.grid.nodes;for(let i=0;i<nds.length;i++)nds[i].y=parseInt(nds[i].el.attr("data-gs-y"));let wg=$("<div/>");gd.addWidget(wg),gd.removeWidget(wg)}setFormValues(){let obj,controls=$(this).find("[property]");this.isClone&&(obj=new flexygo.obj.Entity(this.objectname)).read();for(let i=0;i<controls.length;i++){let propName=$(controls[i]).attr("property"),ctl=$(controls[i])[0];if(ctl&&ctl.setValue){let value=this.data[propName].DefaultValue;void 0!==this.data[propName].Value&&(value=this.data[propName].Value),obj&&obj.data&&obj.data[propName]?ctl.setValue(flexygo.utils.isBlank(value)?obj.data[propName].Value:value,this.data[propName].Text):ctl.setValue(value,this.data[propName].Text)}}}getValue(row,tag){if("control"==tag.toLowerCase()){return"<"+this.properties[row.name].WebComponent+' property="'+row.name+'" />'}{let value=row[tag],type=typeof value;switch(type=type.toLowerCase()){case"undefined":return"";case"boolean":return value?'<i class="flx-icon icon-checked-1"></i>':'<i class="flx-icon icon-non-check-2"></i>';default:return value}}}paintProperties(data,template){let str="",dataArray=$.map(data,(value,index)=>[value]);dataArray.sort((a,b)=>a.PositionY<b.PositionY?-1:a.PositionY>b.PositionY?1:a.PositionX<b.PositionX?-1:a.PositionX>b.PositionX?1:0),str+='<form onsubmit="return false"><div class="resizable-row grid-stack edit-form">';for(let i=0;i<dataArray.length;i++){let row=flexygo.utils.lowerKeys(dataArray[i]);if(this.properties[row.name].FormDisplay){let item=$('<div class="grid-stack-item-content" />').html(template),container=$('<div class="grid-stack-item" />').append(item),props=item.find("[data-tag]");for(let j=0;j<props.length;j++){let prop=$(props[j]),tag=prop.data("tag").toLowerCase();if("label"==tag.toLowerCase()){if("separator"!=this.properties[row.name].ControlType&&"placeholder"!=this.properties[row.name].ControlType){if(prop.prepend(this.getValue(row,tag)),this.properties[row.name].IsRequired&&prop.addClass("required"),""!=this.properties[row.name].LabelStyle&&prop.attr("style",this.properties[row.name].LabelStyle),""!=this.properties[row.name].LabelCssClass&&prop.addClass(this.properties[row.name].LabelCssClass),""!=this.properties[row.name].HelpId){let helpIcon=$('<span class="help-icon"><i/><flx-tooltip mode="popover" container="body" helpId="'+this.properties[row.name].HelpId+'"></flx-tooltip></span>');prop.append(helpIcon)}prop.attr("lblproperty",row.name)}else prop.empty();this.properties[row.name].Hide&&(prop.addClass("hideControl"),container.addClass("hideControlGridStack").css("display","none"))}else(row[tag]||"control"==tag.toLowerCase())&&prop.prepend(this.getValue(row,tag))}container.attr("data-gs-x",row.positionx),container.attr("data-gs-y",row.positiony),container.attr("data-gs-width",row.width),container.attr("data-gs-height",row.height),str+=container[0].outerHTML}}return str+="</div></form>"}parseEditString(str,ctx,property){let props=$(ctx).find("[property]"),obj=new Object;for(let i=0;i<props.length;i++){let prop=$(props[i])[0];obj[prop.property]=prop.getValue()}return flexygo.utils.parser.compile(obj,str,this)}flxTranslate(str){return flexygo.localization.translate(str)}refreshProperty(itm,prop,lblprop,loadDependency){if(itm.changeCustomProperty){this.properties[itm.PropertyName]=itm.newCustomProperty;let element=$(`<${itm.newCustomProperty.WebComponent}/>`),EType=element.attr("type"),attrs=prop[0].attributes;$.each(attrs,function(){element.attr(this.name,this.value)}),element.attr("type",EType);let cntl=prop[0],IObjectName=cntl.options.ObjectName,IName=cntl.options.Name,IPositionX=cntl.options.PositionX,IPositionY=cntl.options.PositionY;cntl.options.IconClass;if(cntl.options=itm.newCustomProperty,cntl.options.ObjectName=IObjectName,cntl.options.Name=IName,cntl.options.PositionX=IPositionX,cntl.options.PositionY=IPositionY,cntl.options.DropDownValues=itm.newSqlItems,cntl.options.IconClass=itm.newCustomProperty.IconClass,"flx-code"==prop[0].tagName.toLocaleLowerCase()){let value=prop.val();if("monaco"==prop.attr("editor")){let parentElement=prop[0].parentElement;flexygo.events.off(prop[0],"property","resized"),flexygo.events.off(prop[0],"module","resized"),flexygo.events.off(prop[0],"dialog","resized"),prop[0].monaco&&prop[0].monaco.dispose(),new MutationObserver((mutationsList,observer)=>{for(const mutation of mutationsList)if("childList"===mutation.type&&mutation.removedNodes.length>0){element[0].setCodeEditor(),observer.disconnect();break}}).observe(parentElement,{childList:!0})}prop.replaceWith(element),element[0].setValue(value)}else prop.replaceWith(element);prop=element}if(itm.JSCode){new Function("ObjectName","ProcessName","ReportName","itm","prop",itm.JSCode).call(this,this.objectname,this.processName,this.reportName,itm,prop[0])}if(itm.changeVisibility)if(itm.newVisibility){this.appendStack(prop),prop.removeClass("hideControl"),lblprop.removeClass("hideControl"),$(prop[0]).is('flx-code[editor="monaco"]')&&$(prop[0]).is(":visible")&&prop[0].setCodeEditor();let ctlClass=prop.attr("control-class");if(void 0!==ctlClass){prop.attr("control-class",ctlClass.replace("hideControl","")),prop.find(".hideControl").removeClass("hideControl");let cntl=prop[0];cntl.options.CssClass=cntl.options.CssClass.replace("hideControl","")}prop.parent().find(".hideControl").removeClass("hideControl")}else prop.addClass("hideControl"),lblprop.addClass("hideControl"),this.removeStack(prop);if(itm.changeSQL){let cntl=prop[0];cntl.changeSQLData&&(loadDependency||(cntl.setValue(null),itm.cascadeDependencies&&cntl.triggerDependencies()),cntl.changeSQLData(itm.newSQL,itm.newSqlItems))}if(itm.changeClass&&prop.removeAttr("class").addClass(itm.newClass),itm.changeEnabled&&(itm.newEnabled?prop.removeAttr("disabled"):prop.attr("disabled",1)),itm.changeRequired&&(itm.newRequired?(prop.attr("required",1),lblprop.addClass("required")):(prop.removeAttr("required"),lblprop.removeClass("required"))),itm.changeValue){prop[0].setValue(itm.newValue);let me=$(this),props=me.find("[property]"),propertyName=prop.attr("property");if(prop.closest("flx-edit").length>0&&props.length>0){let Properties=[];for(let i=0;i<props.length;i++){let prop=$(props[i])[0];Properties.push({Key:prop.property,Value:prop.getValue()})}let elm=me.find('[property="'+propertyName+'"]');"flx-radio"==elm[0].tagName.toLowerCase()?void 0!==elm.find('[name="'+propertyName+'"]:first').attr("data-msg-sqlvalidator")&&this.validateSQLProperty(propertyName,Properties):void 0!==elm.find('[name="'+propertyName+'"].form-control').attr("data-msg-sqlvalidator")&&this.validateSQLProperty(propertyName,Properties)}itm.cascadeDependencies&&prop[0].triggerDependencies()}if(itm.dependencyErrors.length>0){let dependencyType={0:[flexygo.localization.translate("dependecymanager.valuedep"),"flx-icon icon-tag"],1:[flexygo.localization.translate("dependecymanager.classdep"),"flx-icon icon-custom"],2:[flexygo.localization.translate("dependecymanager.combodep"),"flx-icon icon-listbox-2"],3:[flexygo.localization.translate("dependecymanager.enabledep"),"flx-icon icon-lock-1"],4:[flexygo.localization.translate("dependecymanager.visibledep"),"flx-icon icon-eye"],5:[flexygo.localization.translate("dependecymanager.requireddep"),"flx-icon icon-checked"],6:[flexygo.localization.translate("dependecymanager.CustomProperty"),"flx-icon icon-wizard-1"]},lblTriggerElement=$(this).find('[lblproperty="'+itm.TriggerPropertyName+'"]');for(let i=0;i<itm.dependencyErrors.length;i++){let depType=itm.dependencyErrors[i].Type,depLastExceptionMessage=itm.dependencyErrors[i].LastExceptionMessage,depSentence=itm.dependencyErrors[i].SqlSentence;if(0==lblTriggerElement.find(".danger-icon").length){let dangerIcon=$('<span class="danger-icon blink develop-only"><i/><flx-tooltip mode="popover" container="body"></flx-tooltip></span>');lblTriggerElement.append(dangerIcon)}let flxtool=lblTriggerElement.find(".danger-icon flx-tooltip")[0],newContent=flxtool.innerContent,templateContent=$(`<div>${newContent}</div>`)[0];0==$(templateContent).find(`#dep-${itm.PropertyName}-${itm.TriggerPropertyName}-${depType}`).length&&(lblTriggerElement.removeAttr("data-content"),newContent+=`<li id="dep-${itm.PropertyName}-${itm.TriggerPropertyName}-${depType}" class="nolist">\n                                            <i title="${dependencyType[depType][0]}" class="${dependencyType[depType][1]} margin-right-s"/>\n                                            <b>${itm.PropertyName} : </b>${depLastExceptionMessage}\n                                            <button class="btn padding-xs margin-bottom-xs margin-top-xs margin-left-s size-xs clickable" onclick="flexygo.utils.showDependencyError(this, '35%',)">\n                                                <i class="flx-icon icon-sql-letters icon-lg "/>\n                                                <span class="flx-sentence hidden">${depSentence}</span>\n                                            </button>\n                                        </li>`,flxtool.innerContent=newContent,flxtool.refresh())}}}removeStack(prop){let me=$(this);if((prop=prop.closest(".grid-stack-item")).length>0){let secProp=prop.find(".item"),dgW=prop.attr("data-w");if(null==dgW||""==dgW){let hidGD=me.find(".grid-stack").find(".hidProps");0==hidGD.length&&(hidGD=$('<div class="hidProps" style="display:none"></div>'),me.find(".grid-stack").append(hidGD)),secProp.attr("data-x",prop.attr("data-gs-x")),secProp.attr("data-y",prop.attr("data-gs-y")),secProp.attr("data-w",prop.attr("data-gs-width")),secProp.attr("data-h",prop.attr("data-gs-height")),secProp.detach();let codeEditor=secProp.find('[data-tag="control"]>flx-code[editor="monaco"]');codeEditor.length>0&&(flexygo.events.off(codeEditor[0],"property","resized"),flexygo.events.off(codeEditor[0],"module","resized"),flexygo.events.off(codeEditor[0],"dialog","resized"),codeEditor[0].monaco&&codeEditor[0].monaco.dispose()),hidGD.append(secProp),me.find(".grid-stack").data("gridstack").removeWidget(prop)}}}appendStack(prop){let me=$(this),dgW=(prop=prop.closest(".item")).attr("data-w");if(dgW&&""!=dgW){let gd=me.find(".grid-stack").data("gridstack");prop.detach(),gd.addWidget($("<div/>").append(prop),prop.attr("data-x"),prop.attr("data-y"),prop.attr("data-w"),prop.attr("data-h")),prop.attr("data-x",""),prop.attr("data-y",""),prop.attr("data-w",""),prop.attr("data-h","")}}orderStack(){let me=$(this),props=me.find(".grid-stack-item"),orderProps=[];for(let i=0;i<props.length;i++){let prop=$(props[i]);orderProps.push({Prop:prop,PositionX:this.properties[prop.find("[property]").attr("property")].PositionX,PositionY:this.properties[prop.find("[property]").attr("property")].PositionY})}orderProps.sort((a,b)=>a.PositionY<b.PositionY?-1:a.PositionY>b.PositionY?1:a.PositionX<b.PositionX?-1:a.PositionX>b.PositionX?1:0),props.detach();let prop_values={};props.find("[property]").each((_,el)=>{prop_values[el.property]=el.getValue()});for(let i=0;i<orderProps.length;i++){me.find(".grid-stack").append(orderProps[i].Prop);const prop=orderProps[i].Prop.find("[property]")[0];prop.setValue(prop_values[prop.property])}}getModuleFullId(){let me=$(this),page=flexygo.history.get(me);return page.objectname||(page.objectname=""),page.pagename+"|"+page.objectname+"|"+this.moduleName}validateSQLProperty(propertyName,Properties){let SQLValidatorparams={ObjectName:this.objectname,ProcessName:this.processName,ReportName:this.reportName,PropertyName:propertyName,Properties};flexygo.ajax.syncPost("~/api/Edit","ValidateProperty",SQLValidatorparams,response=>{let prop,element=$(this).find('[property="'+propertyName+'"]');prop="flx-radio"==element[0].tagName.toLowerCase()?element.find('[name="'+SQLValidatorparams.PropertyName+'"]:first'):element.find('[name="'+SQLValidatorparams.PropertyName+'"]'),response?prop.attr("sqlvalidator",1):prop.attr("sqlvalidator",0),"time"!=element.attr("type")&&"date"!=element.attr("type")&&"datetime-local"!=element.attr("type")&&"flx-tag"!=element[0].localName||prop.valid()||$(prop).focus().select(),"text"!=element.attr("type")&&"flx-tag"!=element[0].localName&&"flx-barcode"!=element[0].localName||$(prop).valid()||$(prop).focus().select()})}validateSQLProperties(){let props=$(this).find("[property]");if(props.length>0){let Properties=[],SQLPropertiesNames=[];for(let i=0;i<props.length;i++){let prop=$(props[i])[0];Properties.push({Key:prop.property,Value:prop.getValue()}),void 0!==$(prop).find('[name="'+prop.property+'"].form-control').attr("data-msg-sqlvalidator")&&SQLPropertiesNames.push(prop.property)}for(let i=0;i<SQLPropertiesNames.length;i++)this.validateSQLProperty(SQLPropertiesNames[i],Properties)}}paintLoadingEdit(){let containerItem=$(this).parent();containerItem.addClass("flx-relative"),containerItem.find("form").addClass("flx-opacity"),0==containerItem.find("#flx-dependency-loader").length&&containerItem.append('<div id="flx-dependency-loader"></div>')}removeLoadingEdit(){let containerItem=$(this).parent();containerItem.removeClass("flx-relative"),containerItem.find("form").removeClass("flx-opacity"),containerItem.find("#flx-dependency-loader").remove()}paintLoadingProperty(e){let containerItem=$(e.sender).closest(".item");containerItem.addClass("flx-relative flx-opacity"),0==containerItem.parent().find("#flx-dependency-loader").length&&containerItem.parent().append('<div id="flx-dependency-loader"></div>');let dependingProp=e.sender.options.DependingProperties;for(let i=0;i<dependingProp.length;i++){let itemDepending=$(e.sender).closest("flx-edit").find(`[property="${dependingProp[i].DependantPropertyName}"]`).closest(".item");0==itemDepending.parent().find("#flx-dependency-loader").length&&(itemDepending.parent().append('<div id="flx-dependency-loader"></div>'),itemDepending.addClass("flx-relative flx-opacity"))}}removeLoadingProperty(e){if(e&&e.sender&&e.sender){let containerItem=$(e.sender).closest(".item");containerItem.parent().find("#flx-dependency-loader").remove(),containerItem.removeClass("flx-relative flx-opacity")}if(e&&e.sender&&e.sender.options){let dependingProp=e.sender.options.DependingProperties;for(let i=0;i<dependingProp.length;i++){let itemDepending=$(e.sender).closest("flx-edit").find(`[property="${dependingProp[i].DependantPropertyName}"]`).closest(".item");itemDepending.parent().find("#flx-dependency-loader").remove(),itemDepending.removeClass("flx-relative flx-opacity")}}}onPropertyChanged(e){if(this.dependenciesLoaded){let wc,me=$(this),props=me.find("[property]"),propertyName=e.masterIdentity;if(wc=$(e.sender),me.find(wc).length>0&&props.length>0){this.paintLoadingProperty(e);let Properties=[];for(let i=0;i<props.length;i++){let prop=$(props[i])[0];Properties.push({Key:prop.property,Value:prop.getValue()})}let elm=me.find('[property="'+propertyName+'"]');if("flx-radio"==elm[0].tagName.toLowerCase()?void 0!==elm.find('[name="'+propertyName+'"]:first').attr("data-msg-sqlvalidator")&&this.validateSQLProperty(propertyName,Properties):void 0!==elm.find('[name="'+propertyName+'"].form-control').attr("data-msg-sqlvalidator")&&this.validateSQLProperty(propertyName,Properties),!this.properties[propertyName].ThrowDependenciesOnInvalid){let prop;if(prop="flx-radio"==elm[0].tagName.toLowerCase()?elm.find('[name="'+propertyName+'"]:first'):elm.find('[name="'+propertyName+'"]'),"flx-dbcombo"==elm[0].tagName.toLowerCase()){if("0"==elm.find('[name="'+propertyName+'"]').attr("sqlvalidator"))return void this.removeLoadingProperty(e)}else if(prop.length>0&&!prop.valid())return void this.removeLoadingProperty(e)}let params={ObjectName:this.objectname,ProcessName:this.processName,ReportName:this.reportName,PropertyName:propertyName,Properties};this.loadingDependencies+=1,flexygo.ajax.post("~/api/Edit","ProcessDependencies",params,response=>{try{if(response){let orderStackExecution=!1;for(let i=0;i<response.length;i++){let itm=response[i],prop=me.find('[property="'+itm.PropertyName+'"]'),lblprop=me.find('[lblproperty="'+itm.PropertyName+'"]');prop.length>0&&(this.refreshProperty(itm,prop,lblprop,!1),(itm.changeVisibility||itm.changeEnabled)&&(orderStackExecution=!0))}flexygo.utils.isSizeSmartphone()&&orderStackExecution&&(this.orderStack(),me.find("form").validate(),this.validateSQLProperties()),this.restartPosition(),orderStackExecution&&this.setTabIndex(),this.loadingDependencies-=1,this.pendingSaveButton&&this.loadingDependencies<=0&&(this.pendingSaveButton.click(),this.removeLock(),this.pendingSaveButton=null)}this.removeLoadingProperty(e)}catch(e){flexygo.exceptions.httpShow(e),this.loadingDependencies-=1,this.removeLoadingProperty(e),this.pendingSaveButton&&this.loadingDependencies<=0&&(this.removeLock(),this.pendingSaveButton=null)}})}}}setTabIndex(){let me=$(this),props=me.find(".grid-stack-item"),orderControls=[];for(let i=0;i<props.length;i++){let prop=$(props[i]),elem=prop.find('[data-tag="control"]').children().not('flx-separator,.hideControl,[disabled="disabled"]');elem.length>0&&orderControls.push({Elem:elem,PositionX:parseInt(prop.attr("data-gs-x")),PositionY:parseInt(prop.attr("data-gs-y"))})}if(orderControls.sort((a,b)=>a.PositionY<b.PositionY?-1:a.PositionY>b.PositionY?1:a.PositionX<b.PositionX?-1:a.PositionX>b.PositionX?1:0),me.attr("ControlsNumber",this.maxTabIndex),orderControls.length>0){let z=1+this.lastEditControlsCount();for(let i=0;i<orderControls.length;i++){switch(orderControls[i].Elem[0].tagName.toLowerCase()){case"flx-textarea":orderControls[i].Elem.find("textarea").attr("tabindex",z);break;case"flx-dbcombo":orderControls[i].Elem.find("input").first().attr("tabindex",z);break;case"flx-combo":orderControls[i].Elem.find("select").attr("tabindex",z);break;default:orderControls[i].Elem.find("input").attr("tabindex",z)}z++}}}}FlxEditElement.observedAttributes=["modulename"],wc_1.FlxEditElement=FlxEditElement}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-edit",flexygo.ui.wc.FlxEditElement);