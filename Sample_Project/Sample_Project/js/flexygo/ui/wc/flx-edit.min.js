var flexygo;!function(flexygo){!function(ui){!function(wc_1){(ui.wc||(ui.wc={})).FlxEditElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.moduleName=null,this.objectname=null,this.objectwhere=null,this.processName=null,this.reportName=null,this.mode=null,this.tHeader=null,this.tBody=null,this.tFooter=null,this.templateId=null,this.defaults=null,this.JSforParams=null,this.dependenciesLoaded=!1}connectedCallback(){this.connected=!0;let element=$(this);this.moduleName=element.attr("modulename"),this.reportName=element.attr("reportName"),this.processName=element.attr("processName");let mode="edit";this.reportName&&(mode="report"),this.processName&&(mode="process"),this.mode=mode,this.defaults=element.attr("defaults"),this.moduleName&&"true"!=element.attr("manualInit")&&this.init()}disconnectedCallback(){flexygo.events.off(this,"property","changed",this.onPropertyChanged)}static get observedAttributes(){return["modulename"]}attributeChangedCallback(attrName,oldVal,newVal){this.connected&&"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.moduleName=newVal,this.moduleName&&this.refresh())}init(){this.dependenciesLoaded=!1,flexygo.events.off(this,"property","changed",this.onPropertyChanged),flexygo.events.on(this,"property","changed",this.onPropertyChanged),$(this).on("destroy",()=>{flexygo.events.off(this,"property","changed",this.onPropertyChanged)});let me=$(this);switch(me.removeAttr("manualInit"),this.templateId=null,me.attr("Mode")){case"process":this.initProcessMode();break;case"report":this.initReportMode();break;default:this.initEditMode()}}refresh(){"true"!=$(this).attr("manualInit")&&this.init()}initEditMode(){let me,objDef,selector;if(objDef=null,(me=$(this)).html(""),this.defaults)objDef="string"==typeof this.defaults?JSON.parse(this.defaults):this.defaults;else{let histObj=flexygo.history.get(me);if(void 0!==histObj&&histObj.defaults&&""!=histObj.defaults&&(objDef=JSON.parse(flexygo.utils.parser.replaceAll(histObj.defaults,"'",'"'))),null==objDef){let wcMod=me.closest("flx-module")[0];wcMod&&(objDef=wcMod.objectdefaults)}}let params={ObjectName:me.attr("ObjectName"),ObjectWhere:me.attr("ObjectWhere"),ModuleName:this.moduleName,Defaults:flexygo.utils.dataToArray(objDef),TemplateId:this.templateId,Clone:"true"===me.attr("isClone")};flexygo.ajax.post("~/api/Edit","GetEditTemplate",params,response=>{if(response){let template=response.Template,parentModule=me.closest("flx-module"),wcModule=parentModule[0];if(!parentModule||!wcModule)return;response.Buttons&&(wcModule.setButtons(response.Buttons,response.ObjectName,response.ObjectWhere),parentModule.find(".cntBodyFooter .moduleButtons .saveButton").attr("tabIndex",this.getMaxTabindex(response.Properties))),wcModule.setObjectDescrip(response.Title),this.data=template.Data,this.tHeader=template.Header,this.tBody=template.Body,this.tFooter=template.Footer,this.properties=response.Properties,this.objectname=response.ObjectName,this.objectwhere=response.ObjectWhere,this.templateId=response.Template.Id,response.TemplateList&&(this.templateList=response.TemplateList),this.render(),this.initValidate()}selector=me.closest("div.ui-dialog").length?"div.ui-dialog":"div#mainContent",me.closest(selector).find("flx-module flx-edit").first().find("[property] select:enabled:visible, [property] input:enabled:visible, [property] textarea:enabled:visible").first().focus();let parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&wcModule.moduleLoaded(this)})}initReportMode(){let objDef,me=$(this);if(this.defaults)objDef=JSON.parse(this.defaults);else{let histObj=flexygo.history.get(me);void 0!==histObj&&histObj.defaults&&""!=histObj.defaults&&(objDef=JSON.parse(flexygo.utils.parser.replaceAll(histObj.defaults,"'",'"')))}me.html("");let params={ObjectName:me.attr("ObjectName"),ObjectWhere:me.attr("ObjectWhere"),ModuleName:this.moduleName,ReportName:me.attr("ReportName"),Defaults:flexygo.utils.dataToArray(objDef)};flexygo.ajax.post("~/api/Edit","GetReportParamsTemplate",params,response=>{if(response){me.closest(".ui-dialog").find(".ui-dialog-title").length>0&&"{{ReportDescrip}}"==me.closest(".ui-dialog").find(".ui-dialog-title").html()&&me.closest(".ui-dialog").find(".ui-dialog-title").html(response.Title);let template=response.Template,parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&(response.Buttons&&wcModule.setButtons(response.Buttons,response.ObjectName,response.ObjectWhere,response.ReportName,null),wcModule.setObjectDescrip(response.Title)),this.data=response.Properties,this.tHeader=template.Header,this.tBody=template.Body,this.tFooter=template.Footer,this.properties=response.Properties,this.render(),this.initValidate()}let parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&wcModule.moduleLoaded(this)})}getMaxTabindex(props){let posX=0,posY=0;for(let key in props)props[key].PositionX>posX&&(posX=props[key].PositionX),props[key].PositionY>posY&&(posY=props[key].PositionY);return posY.toString()+posX.toString()}initProcessMode(){let me=$(this);me.html("");let objDef=null;if(this.defaults)objDef=JSON.parse(this.defaults);else{let histObj=flexygo.history.get(me);void 0!==histObj&&histObj.defaults&&""!=histObj.defaults&&(objDef=JSON.parse(flexygo.utils.parser.replaceAll(histObj.defaults,"'",'"')))}let params={ObjectName:me.attr("ObjectName"),ObjectWhere:me.attr("ObjectWhere"),ModuleName:this.moduleName,ProcessName:me.attr("ProcessName"),Defaults:flexygo.utils.dataToArray(objDef)};flexygo.ajax.post("~/api/Edit","GetProcessParamsTemplate",params,response=>{if(response){me.closest(".ui-dialog").find(".ui-dialog-title").length>0&&"{{ProcessDescrip}}"==me.closest(".ui-dialog").find(".ui-dialog-title").html()&&me.closest(".ui-dialog").find(".ui-dialog-title").html(response.Title);let template=response.Template,parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&(response.Buttons&&wcModule.setButtons(response.Buttons,response.ObjectName,response.ObjectWhere,null,response.ProcessName),wcModule.setObjectDescrip(response.Title)),this.data=response.Properties,this.tHeader=template.Header,this.tBody=template.Body,this.tFooter=template.Footer,this.properties=response.Properties,this.JSforParams=response.JSforParams,this.render(),this.initValidate(),response.RunButtonText&&me.closest("flx-module").find("button[data-type='runprocess']")&&me.closest("flx-module").find("button[data-type='runprocess']").children("span").html(response.RunButtonText)}let wcModule=me.closest("flx-module")[0];wcModule&&wcModule.moduleLoaded(this)})}initValidate(){$(this).find("form").validate({ignore:"",unhighlight:(element,errorClass,validClass)=>{$(element).parent().addClass("has-success").removeClass("has-error")},highlight:(element,errorClass,validClass)=>{$(element).parent().removeClass("has-success").addClass("has-error")},errorPlacement:(error,element)=>{$(element).closest("flx-radio").length>0?(error.css("display","block"),error.insertAfter($(element).parent().parent()[0])):error.insertAfter($(element).parent()[0])},errorClass:"txt-danger"})}render(){let me=$(this),rendered=flexygo.utils.parser.recursiveCompile(this.data,this.tBody,this);if(me.empty(),me.html(rendered),me.append('<div style="clear:both"></div>'),!this.moduleName){let btn=$('<button class="btn btn-default bg-info saveButton"> <i class="flx-icon icon-save-2" > </i> <span>'+flexygo.localization.translate("flxedit.save")+"</span> </button>");btn.on("click",ev=>{flexygo.ui.wc.FlxModuleElement.prototype.saveModule(this.objectname,this.objectwhere,$(this),null)}),me.append(btn)}this.setFormValues();let reduce=0;flexygo.utils.isSizeSmartphone()&&(reduce=20);let cellH=62-reduce,itm=me.closest(".size-xs,.size-s,.size-m,.size-l,.no-label");itm.length>0&&(itm.is(".size-xs")?cellH=54-reduce:itm.is(".size-s")?cellH=62-reduce:itm.is(".size-m")?cellH=70-reduce:itm.is(".size-l")&&(cellH=86-reduce),itm.is(".no-label")&&(cellH-=18)),this.processLoadDependencies();let options={cellHeight:cellH,verticalMargin:0,float:!1,disableDrag:!0,disableResize:!0,static_grid:!0};var hideControls=me.find(".resizable-row").find(".hideControlGridStack [property]");me.find(".resizable-row").gridstack(options),hideControls.each((index,elem)=>{this.removeStack($(elem))}),me.attr("Mode")&&"edit"!=me.attr("Mode")||(me.find("form").areYouSure(),me.closest(".ui-dialog").find(".ui-dialog-titlebar-close").length>0&&me.closest("main.pageContainer").off("dialogbeforeclose").on("dialogbeforeclose",()=>this.checkDirtyEdit()))}checkDirtyEdit(){let me=$(this),dlg=me.closest("main.pageContainer");if(0!=me.find("form").filter(".dirty").length&&document.body.contains(this))return Lobibox.confirm({title:flexygo.localization.translate("flxedit.areyousuretitle"),msg:flexygo.localization.translate("flxedit.areyousuremsg"),buttons:{yes:{class:"lobibox-btn lobibox-btn-yes",text:flexygo.localization.translate("flxedit.areyousuremsgyes"),closeOnClick:!0},no:{class:"lobibox-btn lobibox-btn-no",text:flexygo.localization.translate("flxedit.areyousuremsgno"),closeOnClick:!0}},iconClass:"",callback:(dialog,type,ev)=>{if("yes"==type){let ev={class:"dialog",type:"closed",sender:dlg.data("context")};flexygo.events.trigger(ev),dlg.dialog("destroy").remove()}}}),!1}configure(){let where;"report"==this.mode||"process"==this.mode||"generic"==this.templateId?this.openConfig():(where=""==this.templateId||null==this.templateId?"":"TemplateId='"+this.templateId+"'",flexygo.nav.openPage("edit","sysObjectTemplate",where,null,"popup",!0))}configureProcess(){let where;"process"==this.mode?(where="ProcessName='"+this.processName+"'",flexygo.nav.openPage("edit","sysProcess",where,null,"popup",!0)):"report"==this.mode?(where="ReportName='"+this.reportName+"'",flexygo.nav.openPage("edit","sysReport",where,null,"popup",!0)):alert("Not implemented")}configureObjectProcess(){let where;"process"==this.mode?(where="ProcessName='"+this.processName+"' and ObjectName='"+$(this).attr("ObjectName")+"'",flexygo.nav.openPage("edit","sysObjectProcess",where,null,"popup",!0)):alert("Not implemented")}openConfig(){let control,descrip,targetid="",histObj={targetid:targetid=flexygo.utils.isSizeMobile()?"current":"modal"},pageContainer=flexygo.targets.createContainer(histObj,!0,null);pageContainer.closest(".ui-dialog").find(".flx-icon.icon-select").remove(),"report"==this.mode?(control='<flx-propertymanager ReportName="'+this.reportName+'" ></flx-propertymanager>',descrip=this.reportName):"process"==this.mode?(control='<flx-propertymanager ProcessName="'+this.processName+'" ></flx-propertymanager>',descrip=this.processName):(control='<flx-propertymanager ObjectName="'+this.objectname+'" ></flx-propertymanager>',descrip=this.objectname);let navString="";navString+='<div class="col-9 col-m-6 col-s-12">',navString+='<flx-container type="emptyCnt">',navString+='<span class="sectitle"><i class="f-icon icon-new-email"> </i>'+descrip+"</span>",navString+="</flx-container>",navString+="</div>",navString+='<div class="col-12">',navString+='<flx-container type="emptyCnt">',navString+=control,navString+="</flx-container>",navString+="</div>",pageContainer.html(navString),$(pageContainer).closest(".ui-dialog").find(".ui-dialog-titlebar-buttonpane button.ui-dialog-titlebar-close").on("click.configure",()=>{this.refresh()})}processLoadDependencies(){if(0==$(document).find(this).length)return;let me=$(this),props=me.find("[property]");if(props.length>0){let Properties=new Array;for(let i=0;i<props.length;i++){let prop=$(props[i])[0];if(Properties.push({Key:prop.property,Value:prop.getValue()}),null==prop.property)return}var isNew=!1;this.processName&&""!=this.processName?isNew=!0:this.reportName&&""!=this.reportName?isNew=!0:me.attr("ObjectWhere")||(isNew=!0);let params={ObjectName:this.objectname,ProcessName:this.processName,ReportName:this.reportName,IsNew:isNew,IsView:!1,Properties};flexygo.ajax.post("~/api/Edit","processAllDependencies",params,response=>{if(response)for(let i=0;i<response.length;i++){let itm=response[i],prop=me.find('[property="'+itm.PropertyName+'"]'),lblprop=me.find('[lblproperty="'+itm.PropertyName+'"]');prop.length>0&&this.refreshProperty(itm,prop,lblprop,!0)}this.dependenciesLoaded=!0})}}restartPosition(){let me=$(this);for(let key in this.properties)me.find("[property="+this.properties[key].Name+"]").closest("[data-gs-y]").attr("data-gs-y",this.properties[key].PositionY);let gd=me.find(".grid-stack").data("gridstack"),nds=gd.grid.nodes;for(let i=0;i<nds.length;i++)nds[i].y=parseInt(nds[i].el.attr("data-gs-y"));let wg=$("<div/>");gd.addWidget(wg),gd.removeWidget(wg)}setFormValues(){let controls=$(this).find("[property]");for(let i=0;i<controls.length;i++){let propName=$(controls[i]).attr("property"),ctl=$(controls[i])[0];if(ctl&&ctl.setValue){let value=this.data[propName].DefaultValue;void 0!==this.data[propName].Value&&(value=this.data[propName].Value),ctl.setValue(value,this.data[propName].Text)}}}getValue(row,tag){if("control"==tag.toLowerCase())return"<"+this.properties[row.name].WebComponent+' property="'+row.name+'" />';{let value=row[tag],type=typeof value;switch(type=type.toLowerCase()){case"undefined":return"";case"boolean":return value?'<i class="flx-icon icon-checked-1"></i>':'<i class="flx-icon icon-non-check-2"></i>';default:return value}}}paintProperties(data,template){let str="",dataArray=$.map(data,(value,index)=>[value]);dataArray.sort((a,b)=>a.PositionY<b.PositionY?-1:a.PositionY>b.PositionY?1:a.PositionX<b.PositionX?-1:a.PositionX>b.PositionX?1:0),str+='<form><div class="resizable-row grid-stack edit-form">';for(let i=0;i<dataArray.length;i++){let row=flexygo.utils.lowerKeys(dataArray[i]);if(this.properties[row.name].FormDisplay){let item=$('<div class="grid-stack-item-content" />').html(template),container=$('<div class="grid-stack-item" />').append(item),props=item.find("[data-tag]");for(let j=0;j<props.length;j++){let prop=$(props[j]),tag=prop.data("tag").toLowerCase();if("label"==tag.toLowerCase()){if("separator"!=this.properties[row.name].ControlType&&"placeholder"!=this.properties[row.name].ControlType){if(prop.prepend(this.getValue(row,tag)),this.properties[row.name].IsRequired&&prop.addClass("required"),""!=this.properties[row.name].LabelStyle&&prop.attr("style",this.properties[row.name].LabelStyle),""!=this.properties[row.name].LabelCssClass&&prop.addClass(this.properties[row.name].LabelCssClass),""!=this.properties[row.name].HelpId){let helpIcon=$('<span class="help-icon"><i/></span><flx-tooltip mode="popover" container="body" helpId="'+this.properties[row.name].HelpId+'"></flx-tooltip>');prop.append(helpIcon)}prop.attr("lblproperty",row.name)}else prop.empty();this.properties[row.name].Hide&&(prop.addClass("hideControl"),container.addClass("hideControlGridStack").css("display","none"))}else if((row[tag]||"control"==tag.toLowerCase())&&(prop.prepend(this.getValue(row,tag)),-1!=this.properties[row.name].ControlType.indexOf("code")||"multiline"==this.properties[row.name].ControlType)){let lblHeight=25;prop.css("height","calc(100% - "+lblHeight+"px)")}}container.attr("data-gs-x",row.positionx),container.attr("data-gs-y",row.positiony),container.attr("data-gs-width",row.width),container.attr("data-gs-height",row.height),str+=container[0].outerHTML}}return str+="</div></form>"}parseEditString(str,ctx,property){let props=$(ctx).find("[property]"),obj=new Object;for(let i=0;i<props.length;i++){let prop=$(props[i])[0];obj[prop.property]=prop.getValue()}return flexygo.utils.parser.compile(obj,str,this)}translate(str){return flexygo.localization.translate(str)}refreshProperty(itm,prop,lblprop,loadDependency){if(itm.changeCustomProperty){this.properties[itm.PropertyName]=itm.newCustomProperty;let element=$(`<${itm.newCustomProperty.WebComponent}/>`),EType=element.attr("type"),attrs=prop[0].attributes;$.each(attrs,function(){element.attr(this.name,this.value)}),element.attr("type",EType);let cntl=prop[0],IObjectName=cntl.options.ObjectName,IName=cntl.options.Name,IPositionX=cntl.options.PositionX,IPositionY=cntl.options.PositionY;cntl.options=itm.newCustomProperty,cntl.options.ObjectName=IObjectName,cntl.options.Name=IName,cntl.options.PositionX=IPositionX,cntl.options.PositionY=IPositionY,cntl.options.DropDownValues=itm.newSqlItems,prop.replaceWith(element),prop=element}if(itm.JSCode&&new Function("ObjectName","ProcessName","ReportName","itm","prop",itm.JSCode).call(this,this.objectname,this.processName,this.reportName,itm,prop[0]),itm.changeVisibility)if(itm.newVisibility){this.appendStack(prop),prop.removeClass("hideControl"),lblprop.removeClass("hideControl");let ctlClass=prop.attr("control-class");void 0!==ctlClass&&(prop.attr("control-class",ctlClass.replace("hideControl","")),prop.find(".hideControl").removeClass("hideControl"))}else prop.addClass("hideControl"),lblprop.addClass("hideControl"),this.removeStack(prop);if(itm.changeSQL){let cntl=prop[0];cntl.changeSQLData&&(loadDependency||(cntl.setValue(null),itm.cascadeDependencies&&cntl.triggerDependencies()),cntl.changeSQLData(itm.newSQL,itm.newSqlItems))}if(itm.changeClass&&prop.removeAttr("class").addClass(itm.newClass),itm.changeEnabled&&(itm.newEnabled?prop.removeAttr("disabled"):prop.attr("disabled",1)),itm.changeRequired&&(itm.newRequired?prop.attr("required",1):prop.removeAttr("required")),itm.changeValue){prop[0].setValue(itm.newValue);let me=$(this),props=me.find("[property]"),propertyName=prop.attr("property");if(prop.closest("flx-edit").length>0&&props.length>0){let Properties=[];for(let i=0;i<props.length;i++){let prop=$(props[i])[0];Properties.push({Key:prop.property,Value:prop.getValue()})}let elm=me.find("[property="+propertyName+"]");"flx-radio"==elm[0].tagName.toLowerCase()?void 0!==elm.find("[name="+propertyName+"]:first").attr("data-msg-sqlvalidator")&&this.validateSQLProperty(propertyName,Properties):void 0!==elm.find("[name="+propertyName+"].form-control").attr("data-msg-sqlvalidator")&&this.validateSQLProperty(propertyName,Properties)}itm.cascadeDependencies&&prop[0].triggerDependencies()}}removeStack(prop){let me=$(this);if((prop=prop.closest(".grid-stack-item")).length>0){let secProp=prop.find(".item"),dgW=prop.attr("data-w");if(null==dgW||""==dgW){let hidGD=me.find(".grid-stack").find(".hidProps");0==hidGD.length&&(hidGD=$('<div class="hidProps" style="display:none"></div>'),me.find(".grid-stack").append(hidGD)),secProp.attr("data-x",prop.attr("data-gs-x")),secProp.attr("data-y",prop.attr("data-gs-y")),secProp.attr("data-w",prop.attr("data-gs-width")),secProp.attr("data-h",prop.attr("data-gs-height")),secProp.detach(),hidGD.append(secProp),me.find(".grid-stack").data("gridstack").removeWidget(prop)}}}appendStack(prop){let me=$(this),dgW=(prop=prop.closest(".item")).attr("data-w");if(dgW&&""!=dgW){let gd=me.find(".grid-stack").data("gridstack");prop.detach(),gd.addWidget($("<div/>").append(prop),prop.attr("data-x"),prop.attr("data-y"),prop.attr("data-w"),prop.attr("data-h")),prop.attr("data-x",""),prop.attr("data-y",""),prop.attr("data-w",""),prop.attr("data-h","")}}getModuleFullId(){let me=$(this),page=flexygo.history.get(me);return page.objectname||(page.objectname=""),page.pagename+"|"+page.objectname+"|"+this.moduleName}validateSQLProperty(propertyName,Properties){let SQLValidatorparams={ObjectName:this.objectname,ProcessName:this.processName,ReportName:this.reportName,PropertyName:propertyName,Properties};flexygo.ajax.syncPost("~/api/Edit","ValidateProperty",SQLValidatorparams,response=>{let prop,element=$(this).find("[property="+propertyName+"]");prop="flx-radio"==element[0].tagName.toLowerCase()?element.find("[name="+SQLValidatorparams.PropertyName+"]:first"):element.find("[name="+SQLValidatorparams.PropertyName+"]"),response?prop.attr("sqlvalidator",1):prop.attr("sqlvalidator",0),"time"!=element.attr("type")&&"date"!=element.attr("type")&&"datetime-local"!=element.attr("type")||prop.valid()})}onPropertyChanged(e){if(this.dependenciesLoaded){let wc,me=$(this),props=me.find("[property]"),propertyName=e.masterIdentity;if(wc=$(e.sender),me.find(wc).length>0&&props.length>0){let Properties=[];for(let i=0;i<props.length;i++){let prop=$(props[i])[0];Properties.push({Key:prop.property,Value:prop.getValue()})}let elm=me.find("[property="+propertyName+"]");"flx-radio"==elm[0].tagName.toLowerCase()?void 0!==elm.find("[name="+propertyName+"]:first").attr("data-msg-sqlvalidator")&&this.validateSQLProperty(propertyName,Properties):void 0!==elm.find("[name="+propertyName+"].form-control").attr("data-msg-sqlvalidator")&&this.validateSQLProperty(propertyName,Properties);let params={ObjectName:this.objectname,ProcessName:this.processName,ReportName:this.reportName,PropertyName:propertyName,Properties};flexygo.ajax.post("~/api/Edit","ProcessDependencies",params,response=>{if(response){for(let i=0;i<response.length;i++){let itm=response[i],prop=me.find('[property="'+itm.PropertyName+'"]'),lblprop=me.find('[lblproperty="'+itm.PropertyName+'"]');prop.length>0&&this.refreshProperty(itm,prop,lblprop,!1)}this.restartPosition()}})}}}}}()}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-edit",flexygo.ui.wc.FlxEditElement);