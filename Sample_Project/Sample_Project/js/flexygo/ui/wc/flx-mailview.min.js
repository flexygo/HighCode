var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxMailView=class extends HTMLElement{constructor(){super(),this.connected=!1,this.mode="imap",this.viewtemplate='\n<div class="mail-viewer">\n   \n            <ul class="list-unstyled">\n            <li class="messageid hidden">{{MessageId}}</li>\n            <li class="from">{{FromName|isnull:{{FromAddress}}}}</li>\n            <li><small class="date">{{MailDate|date:DD/MM/YYYY hh:mm}}</small></li>\n            <li><span class="subject">{{Subject}}</span></li>\n            </ul>\n   \n    <div style="display:flex;flex-wrap: wrap;" class="attachments"></div>\n    <hr/>\n   <iframe scrolling="no"></iframe>    \n  </div>\n  <div class="iframe hidden">\n    {{BodyHTML}}\n  </div>'}static get observedAttributes(){return["mode","mailid","objectName","objectId"]}init(){$(this).empty(),this.load(),flexygo.events.on(this,"process","executed",e=>{"sysImapDeleteMail"==e.sender.processName&&$(e.context).closest(".ui-dialog").find(".ui-dialog-titlebar-close").click()})}load(){let me=this,params={MessageId:this.messageid,Mode:this.mode};"imap"==this.mode?flexygo.ajax.post("~/api/Mail","GetMail",params,response=>{if(response)if(response.Mail){let defaultsToolbar={};defaultsToolbar.MessageIds=this.messageid,defaultsToolbar.To=response.Mail.FromAddress,defaultsToolbar.Subject=response.Mail.Subject,defaultsToolbar.ToAll=response.Mail.MailTo,defaultsToolbar.CC=response.Mail.MailCC,defaultsToolbar.Mode="imap",defaultsToolbar.ObjectName=this.objectName,defaultsToolbar.ObjectId=this.objectId,$(this).html('<div class="toolbar" ></div><div class="mailItem"></div>'),this.toolbar=response.Toolbar,this.renderToolbar(JSON.stringify(defaultsToolbar)),this.render(response.Mail)}else{let mailList=$(me).closest("body").find("flx-maillist");$(this).html(flexygo.localization.translate("flxmail.nomail")),flexygo.msg.alert(flexygo.localization.translate("flxmail.nomailalert")),$(me).closest(".ui-dialog").find(".ui-dialog-titlebar-close").click(),mailList[0].refresh()}else $(this).html(flexygo.localization.translate("flxmail.nomail"));this.stopLoading()},error=>{flexygo.exceptions.httpShow(error),this.stopLoading()},null,()=>{this.startLoading()}):flexygo.ajax.post("~/api/Mail","GetMail",params,response=>{if(response){let defaultsToolbar={};defaultsToolbar.MessageIds=this.messageid,defaultsToolbar.To=response.Mail.FromAddress,defaultsToolbar.Subject=response.Mail.Subject,defaultsToolbar.ToAll=response.Mail.MailTo,defaultsToolbar.CC=response.Mail.MailCC,defaultsToolbar.Mode="bd",defaultsToolbar.ObjectName=this.objectName,defaultsToolbar.ObjectId=this.objectId,$(this).html('<div class="toolbar" ></div><div class="mailItem"></div>'),this.toolbar=response.Toolbar,this.renderToolbar(JSON.stringify(defaultsToolbar)),this.render(response.Mail)}else $(this).html("Mail not found");this.stopLoading()},error=>{flexygo.exceptions.httpShow(error),this.stopLoading()},null,()=>{this.startLoading()})}render(ret){let me=$(this);ret.BodyText=flexygo.utils.parser.replaceAll(ret.BodyText,",","&#44;"),me.find(".mailItem").html(flexygo.utils.parser.recursiveCompile(ret,this.viewtemplate));let frameContent=me.find(".iframe");for(let i=0;i<ret.Images.length;i++){let imgAtt=ret.Images[i];frameContent.find('[src="cid:'+imgAtt.AttachmentId+'"]').attr("src","data:"+imgAtt.ContentType+";base64,"+imgAtt.B64)}let attachments=me.find(".attachments");for(let i=0;i<ret.Attachments.length;i++){let att=ret.Attachments[i];attachments.append('<div class="mail-viewer-attachment"><div> <i class="size-l fa '+flexygo.utils.getFileIcon(att.ContentType.split("/")[1])+'"/><small>'+att.SafeFileName+"</small></div><div><i onclick=\"flexygo.nav.execProcess('sysImapDownloadAttachment', null, null,'{\\'MessageId\\':\\'"+this.messageid+"\\',\\'SafeFileName\\':\\'"+att.SafeFileName+"\\',\\'Mode\\':\\'"+this.mode+"\\'}', null, 'modal800x600', false, $(this))\" class=\"flx-icon icon-download-1 mail-viewer-download\"></i></div>")}this.observe(me.find("iframe").contents().find("body")),me.find("iframe").contents().find("body").html(me.find(".iframe").html()),me.find(".iframe").remove()}renderToolbar(defaults){""===defaults&&(defaults=null);let btnGroup,arrBtn=flexygo.utils.sortObject(this.toolbar,"PositionId","Order"),toolbar=$(this).find(".toolbar");if(toolbar.empty(),arrBtn.length>0){let lastPosition=arrBtn[0].PositionId;for(let i=0;i<arrBtn.length;i++){let btn=arrBtn[i],type=btn.TypeId;type&&(type=type.toLowerCase()),btnGroup||(btnGroup=$('<div class="btn-group" />')),btn.PositionId!=lastPosition&&(toolbar.append(btnGroup),btnGroup=$('<div class="btn-group" />')),"separator"==type||"placeholder"==type?(toolbar.append(btnGroup),btnGroup=null):btnGroup.append((new flexygo.ui.wc.FlxModuleElement).getButton(btn,null,null,defaults,null,null,null)),lastPosition=btn.PositionId}btnGroup&&toolbar.append(btnGroup)}}observe(iframe){this.observer=new MutationObserver(mutations=>{$(this).find("iframe").contents().find("body a").attr("target","blank"),$(this).find("iframe").contents().find("body img").on("load",ev=>{this.resizeIframe(),$(ev.currentTarget).off("load")}),this.resizeIframe(),this.observer.disconnect()}),this.observer.observe(iframe[0],{childList:!0,characterData:!0})}resizeIframe(){$(this).find("iframe").height(""),$(this).find("iframe").height($(this).find("iframe").contents().find("body")[0].scrollHeight)}startLoading(){$(this).parents("flx-module").length>0?$(this).parents("flx-module")[0].startLoading():$(this).closest(".mailViewer").addClass("loading")}stopLoading(){$(this).parents("flx-module").length>0?$(this).parents("flx-module")[0].stopLoading():$(this).closest(".mailViewer").removeClass("loading")}refresh(ret){"true"!=$(this).attr("manualInit")&&this.load()}connectedCallback(){let element=$(this);this.connected=!0,this.mode=element.attr("mode"),this.messageid=element.attr("MessageId"),this.objectName=element.attr("objectName"),this.objectId=element.attr("objectId"),"true"!=element.attr("manualInit")&&this.init()}disconnectedCallback(){flexygo.events.off(this,"process","executed")}attributeChangedCallback(attrName,oldVal,newVal){let needInit=!1;"MessageId"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.messageid=newVal,needInit=!0):"mode"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.mode=newVal,needInit=!0):"objectName"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectName=newVal,needInit=!0):"objectId"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.objectId=newVal,needInit=!0),this.connected&&needInit&&this.init()}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-mailview",flexygo.ui.wc.FlxMailView);