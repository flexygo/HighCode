var flexygo;!function(flexygo){!function(ui){!function(wc_1){(ui.wc||(ui.wc={})).FlxViewElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.moduleName=null,this.objectname=null,this.templateKey="",this.templateId=null,this.viewId=null,this.tHeader=null,this.tBody=null,this.tFooter=null,this.tEmpty=null,this.tCSSText=null,this.tScriptText=null,this.TemplateToolbarCollection=null}connectedCallback(){this.connected=!0;let element=$(this);this.moduleName=element.attr("modulename"),this.moduleName&&"true"!=element.attr("manualInit")&&this.init()}static get observedAttributes(){return["modulename"]}attributeChangedCallback(attrName,oldVal,newVal){this.connected&&"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.moduleName=newVal,this.moduleName&&this.refresh())}refresh(){"true"!=$(this).attr("manualInit")&&(this.templateId=null,this.init())}init(){let me=$(this);me.removeAttr("manualInit"),$(this).closest("flx-module").find(".flx-noInitContent").remove(),me.html(""),flexygo.ui.templates.setDefaultTemplate(this);let params={ObjectName:me.attr("ObjectName"),ObjectWhere:me.attr("ObjectWhere"),ModuleName:this.moduleName,PageName:flexygo.history.getPageName(me),TemplateId:this.templateId};flexygo.ajax.post("~/api/View","GetViewTemplate",params,response=>{if(response){this.data=response.Template.Data,this.objectname=response.Template.ObjectName,this.properties=response.Properties,this.tHeader=response.Template.Header,this.tBody=response.Template.Body,this.tFooter=response.Template.Footer,this.tEmpty=response.Template.Empty,this.tScriptText=response.Template.ScriptText,this.tCSSText=response.Template.CSSText,this.templateId=response.Template.Id,this.isNew=response.IsNew,this.TemplateToolbarCollection=response.TemplateToolbarCollection,response.TemplateList&&(this.templateList=response.TemplateList),this.render();let parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&(response.Buttons?wcModule.setButtons(response.Buttons,response.ObjectName,response.ObjectWhere):wcModule.setButtons(null,response.ObjectName,response.ObjectWhere),wcModule.setObjectDescrip(response.Title),wcModule.ModuleViewers&&(this.currentViewers=response.CurrentViewers,flexygo.utils.refreshModuleViewersInfo(wcModule,this.currentViewers),flexygo.utils.checkObserverModule(wcModule,2e4),flexygo.events.on(this,"push","notify",function(e){switch(e.masterIdentity){case"GetSetModuleViewers":(""==wcModule.moduleName?null:wcModule.moduleName)==(""==e.sender.ModuleName?null:e.sender.ModuleName)&&(""==wcModule.objectname?null:wcModule.objectname)==(""==e.sender.ObjectName?null:e.sender.ObjectName)&&(""==wcModule.objectwhere?null:wcModule.objectwhere)==(""==e.sender.ObjectWhere?null:e.sender.ObjectWhere)&&flexygo.utils.refreshModuleViewersInfo(wcModule,e.sender.ActiveUsers)}})))}})}render(){let rendered,me=$(this),defString=flexygo.history.getDefaults(this.objectname,me),wcMod=me.closest("flx-module")[0],def=null;wcMod&&(def=wcMod.objectdefaults),!def&&defString&&""!=defString&&(def=JSON.parse(flexygo.utils.parser.replaceAll(defString,"'",'"'))),this.isNew?rendered=flexygo.utils.parser.recursiveCompile(def,this.tEmpty,this):(rendered=flexygo.utils.parser.recursiveCompile(def,flexygo.utils.parser.recursiveCompile(this.data,this.tHeader,this),this),rendered+=flexygo.utils.parser.recursiveCompile(def,flexygo.utils.parser.recursiveCompile(this.data,this.tBody,this),this),rendered+=flexygo.utils.parser.recursiveCompile(def,flexygo.utils.parser.recursiveCompile(this.data,this.tFooter,this),this)),this.tCSSText&&""!==this.tCSSText&&(rendered+="<style>"+flexygo.utils.parser.recursiveCompile(def,flexygo.utils.parser.recursiveCompile(this.data,this.tCSSText,this),this)+"</style>"),this.tScriptText&&""!==this.tScriptText&&(rendered+="<script>"+flexygo.utils.parser.recursiveCompile(def,flexygo.utils.parser.recursiveCompile(this.data,this.tScriptText,this),this)+"<\/script>"),"sysOfflineApp"===this.objectname&&(rendered+=`<div id="monete" class="clickable" onclick="flexygo.nav.openHelpId('syshelp-AppOflineAccess','current',false,$(this))">${flexygo.localization.translate("develop.help").toUpperCase()} ðŸ™Š</div>`),me.html(rendered),me.append('<div style="clear:both"></div>'),this.setFormValues();let reduce=0;flexygo.utils.isSizeSmartphone()&&(reduce=20);let cellH=62-reduce,itm=me.closest(".size-xs,.size-s,.size-m,.size-l");itm.length>0&&(itm.is(".size-xs")?cellH=54-reduce:itm.is(".size-s")?cellH=62-reduce:itm.is(".size-m")?cellH=70-reduce:itm.is(".size-l")&&(cellH=86-reduce));let options={cellHeight:cellH,verticalMargin:0,float:!1,disableDrag:!0,disableResize:!0,static_grid:!0};this.processLoadDependencies();var hideControls=me.find(".resizable-row").find(".hideControlGridStack [property]");me.find(".resizable-row").gridstack(options),hideControls.each((index,elem)=>{this.removeStack($(elem))});let parentModule=me.closest("flx-module"),wcModule=parentModule[0];parentModule&&wcModule&&wcModule.moduleLoaded(this)}processLoadDependencies(){if(0==$(document).find(this).length)return;let me=$(this),props=$(this).find("[property]");if(props.length>0){let Properties=new Array;for(let i=0;i<props.length;i++){let prop=$(props[i])[0];if(null!=this.data[prop.property].Value&&-1!=this.data[prop.property].Value.toString().indexOf("/Date(")?Properties.push({Key:prop.property,Value:moment(this.data[prop.property].Value).toDate()}):Properties.push({Key:prop.property,Value:this.data[prop.property].Value}),null==prop.property)return}let params={ObjectName:this.objectname?this.objectname:me.attr("ObjectName"),IsNew:!1,IsView:!0,Properties};flexygo.ajax.post("~/api/Edit","processAllDependencies",params,response=>{if(response)for(let i=0;i<response.length;i++){let itm=response[i],prop=me.find('[property="'+itm.PropertyName+'"]'),lblprop=me.find('[lblproperty="'+itm.PropertyName+'"]');prop.length>0&&this.refreshProperty(itm,prop,lblprop,!0)}})}}refreshProperty(itm,prop,lblprop,loadDependency){let me=$(this),wc=prop[0];if(itm.changeClass&&prop.removeAttr("class").addClass(itm.newClass),itm.changeValue&&(wc.setValue(itm.newValue),itm.cascadeDependencies&&wc.triggerDependencies()),itm.changeVisibility)if(itm.newVisibility){this.appendStack(prop),prop.removeClass("hideControl"),lblprop.removeClass("hideControl");let ctlClass=prop.attr("control-class");void 0!==ctlClass&&(prop.attr("control-class",ctlClass.replace("hideControl","")),prop.find(".hideControl").removeClass("hideControl"))}else me.find(".grid-stack").data("gridstack").removeWidget(prop.closest(".grid-stack-item"))}removeStack(prop){let me=$(this);if((prop=prop.closest(".grid-stack-item")).length>0){let secProp=prop.find(".item"),dgW=prop.attr("data-w");if(null==dgW||""==dgW){let hidGD=me.find(".grid-stack").find(".hidProps");0==hidGD.length&&(hidGD=$('<div class="hidProps" style="display:none"></div>'),me.find(".grid-stack").append(hidGD)),secProp.attr("data-x",prop.attr("data-gs-x")),secProp.attr("data-y",prop.attr("data-gs-y")),secProp.attr("data-w",prop.attr("data-gs-width")),secProp.attr("data-h",prop.attr("data-gs-height")),secProp.detach(),hidGD.append(secProp),me.find(".grid-stack").data("gridstack").removeWidget(prop)}}}appendStack(prop){let me=$(this),dgW=(prop=prop.closest(".item")).attr("data-w");if(dgW&&""!=dgW){let gd=me.find(".grid-stack").data("gridstack");prop.detach(),gd.addWidget($("<div/>").append(prop),prop.attr("data-x"),prop.attr("data-y"),prop.attr("data-w"),prop.attr("data-h")),prop.attr("data-x",""),prop.attr("data-y",""),prop.attr("data-w",""),prop.attr("data-h","")}}setFormValues(){let controls=$(this).find("[property]");for(let i=0;i<controls.length;i++){let propName=$(controls[i]).attr("property"),ctl=$(controls[i])[0];ctl&&ctl.setValue&&("flx-dbcombo"==this.data[propName].WebComponent||this.data[propName].WebComponent.includes("flx-radio")?ctl.setValue(this.data[propName].Value,this.data[propName].Text):!$(ctl).attr("type")||"datetime-local"!==$(ctl).attr("type").toLowerCase()&&"date"!==$(ctl).attr("type").toLowerCase()&&"number"!==$(ctl).attr("type").toLowerCase()?$(ctl).attr("type")&&"password"===$(ctl).attr("type").toLowerCase()?ctl.setValue(this.data[propName].Text.replace(/./g,"*")):ctl.setValue(this.data[propName].Text):ctl.setValue(this.data[propName].Value))}}getValue(row,tag){if("control"==tag.toLowerCase())return"<"+row.webcomponent+' mode="view" property="'+row.name+'" />';{let value=row[tag],type=typeof value;switch(type=type.toLowerCase()){case"undefined":return"";case"boolean":return value?'<i class="flx-icon icon-checked-1"></i>':'<i class="flx-icon icon-non-check-2"></i>';default:return value}}}configure(){let where;where=""==this.templateId||null==this.templateId?"":"TemplateId='"+this.templateId+"'",flexygo.nav.openPage("edit","sysObjectTemplate",where,null,"popup",!0)}paintProperties(data,template){let str="",dataArray=$.map(data,(value,index)=>[value]);dataArray=dataArray.sort((a,b)=>a.PositionY<b.PositionY?-1:a.PositionY>b.PositionY?1:a.PositionX<b.PositionX?-1:a.PositionX>b.PositionX?1:0),str+='<form><div class="resizable-row grid-stack edit-form">';for(let i=0;i<dataArray.length;i++){let row=flexygo.utils.lowerKeys(dataArray[i]);if(1==this.properties[row.name].FormDisplay){let item=$('<div class="grid-stack-item-content" />').html(template),container=$('<div class="grid-stack-item" />').append(item),props=item.find("[data-tag]");for(let j=0;j<props.length;j++){let prop=$(props[j]),tag=prop.data("tag").toLowerCase();if("label"==tag.toLowerCase())"separator"!=this.properties[row.name].ControlType&&"placeholder"!=this.properties[row.name].ControlType?(prop.prepend(this.getValue(row,tag)),this.properties[row.name].IsRequired&&prop.addClass("required"),""!=this.properties[row.name].LabelStyle&&prop.attr("style",this.properties[row.name].LabelStyle),""!=this.properties[row.name].LabelCssClass&&prop.addClass(this.properties[row.name].LabelCssClass),prop.attr("lblproperty",row.name)):prop.empty(),this.properties[row.name].Hide&&1==this.properties[row.name].Hide&&(prop.addClass("hideControl"),container.addClass("hideControlGridStack").css("display","none"));else if("property-toolbar"==tag.toLowerCase())prop.attr("data-propertyName",row.name);else if((row[tag]||"control"==tag.toLowerCase())&&(prop.prepend(this.getValue(row,tag)),-1!=this.properties[row.name].ControlType.indexOf("code")||"multiline"==this.properties[row.name].ControlType)){let lblHeight=25;prop.css("height","calc(100% - "+lblHeight+"px)")}}container.attr("data-gs-x",row.positionx),container.attr("data-gs-y",row.positiony),container.attr("data-gs-width",row.width),container.attr("data-gs-height",row.height),str+=container[0].outerHTML}}return str+="</div></form>"}parseEditString(str){let props=$(this).find("[property]"),obj=new Object;for(let i=0;i<props.length;i++){let prop=$(props[i])[0];obj[prop.property]=this.data[prop.property].Value}return flexygo.utils.parser.compile(obj,str,this)}translate(str){return flexygo.localization.translate(str)}getModuleFullId(){let page=flexygo.history.get($(this));return page?(page.objectname||(page.objectname=""),page.pagename+"|"+page.objectname+"|"+this.moduleName):this.moduleName}}}()}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-view",flexygo.ui.wc.FlxViewElement);