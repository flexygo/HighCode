var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxMailList=class extends HTMLElement{constructor(){super(),this.connected=!1,this.uid=0,this.pageSize=50,this.noMailTemplate='\n<div class="nomail">\n  <div class="nomail-data"></div>\n  <div class="nomail-text">'+flexygo.localization.translate("flxmail.nomails")+"</div>\n</div>",this.noSettingsTemplate='\n<div class="nosettings">\n  <div class="nosettings-data"></div>\n  <div class="nosettings-text clickable">'+flexygo.localization.translate("flxmail.nosettings")+"</div></div>",this.template='\n<div messageId="{{MessageId}}" uid="{{Uid}}" class="row row-line box-mail {{seen|bool:seen}} pull-right">\n  <div class="box-mail-bagbutton">\n    <button class="btn btn-default bagButton" title="Bag" data-type="bag"><i class="flx-icon icon-non-check-2"></i> </button>\n  </div>\n  <div class="box-mail-data clickable">\n    <div class="col-10 col-l-9 col-m-8 col-s-5"><span class="from">{{FromName|isnull:{{FromAddress}}}}</span><span class="mailto">{{MailTo}}</span>&nbsp;</div>\n    <div class="col-2 col-l-3 col-m-4 col-s-5 text-right"><span class="icons"><i class="{{IsForward|bool:flx-icon icon-email-send ,hidden}} txt-notify" title="Forward"></i><i class="{{IsReply|bool:flx-icon icon-email-send icon-flip-horizontal,hidden}} txt-outstanding" title="Reply"></i> <i class="{{HasAttachments|bool:flx-icon icon-clip,hidden}}" title="attachments"></i> <i class="{{IsLink|bool:flx-icon icon-link,hidden}}" title="Link"></i></span></div>\n    <div class="col-10 col-l-10 col-m-10 col-s-5"><span class="subject">{{Subject}}&nbsp;</span></div>\n    <div class="col-2 col-l-2 col-m-2 col-s-5 text-right"><span class="date">{{MailDate|date:LLLL}}</span></div>\n    <div class="col-12"><span class="message">{{BodyText}}&nbsp;</span></div>\n  </div>\n</div>',this.structure='\n<div class="toolbar mailToolbar"></div>\n<div class="col-2 mailFilters">\n<h3><i class="flx-icon icon-funnel-1 icon-margin-right"></i>Filters</h3>\n<flx-text name="MailAddress" placeholder="'+flexygo.localization.translate("flxmail.address")+'"></flx-text>\n<flx-text name="Subject" placeholder="'+flexygo.localization.translate("flxmail.subject")+'"></flx-text>\n<flx-text name="Body" placeholder="'+flexygo.localization.translate("flxmail.body")+'"></flx-text>\n<flx-text name="MailDateMin" type="date" placeholder="'+flexygo.localization.translate("flxmail.mindate")+'"></flx-text>\n<flx-text name="MailDateMax" type="date" placeholder="'+flexygo.localization.translate("flxmail.maxdate")+'"></flx-text>\n<div><flx-check name="Seen" class="size-s" label="only unseen"></flx-check><label class="control-label" >'+flexygo.localization.translate("flxmail.unseen")+'</label><button class="btn btn-outstanding searchbtn pull-right"><i class="flx-icon icon-search icon-margin-right"></i>Search</btn></div>\n<hr/>  \n<h3><i class="flx-icon icon-folder-add-2 icon-margin-right newFolder clickable"></i>'+flexygo.localization.translate("flxmail.folders")+'<span class="pull-right nosettings clickable"><i class="flx-icon icon-email-settings icon-margin-right"></i></span></h3>\n<div class="mailFolders"></div>\n</div>\n<div class="col-10">\n    <div class="mailList"></div>\n    <div class="row row-line box-mail pull-right seen loadMoreRow" style="display:none">\n       <div class="box-mail-data ">\n        <div class="col-12"><div class="loadMore clickable"><i class="flx-icon icon-reload icon-margin-right"></i>'+flexygo.localization.translate("flxmail.loadmore")+"</div></div>\n      </div>\n    </div>\n</div>"}static get observedAttributes(){return["ObjectName","ObjectWhere","ModuleName"]}init(){var me=$(this);me.removeAttr("manualInit"),me.empty(),me.append(this.structure),me.find(".searchbtn").on("click",()=>{$(this).find(".mailList").find(".box-mail-sync").length>0?flexygo.msg.warning(flexygo.localization.translate("flxmail.waitsync")):(this.uid=0,this.load(!1))}),me.find(".loadMore").on("click",ev=>{$(this).find(".mailList").find(".box-mail-sync").length>0?flexygo.msg.warning(flexygo.localization.translate("flxmail.waitsync")):($(ev.currentTarget).parent().find("i").addClass("icon-spin"),this.startLoading(),this.loadMore())}),flexygo.nav.hideNavBar(),this.loadConfig(),flexygo.events.on(this,"process","executed",e=>{"sysImapNewFolders"==e.sender.processName&&flexygo.ajax.post("~/api/Mail","GetMailFolders",null,response=>{response&&(response.sort(function(a,b){return b.IsInbox-a.IsInbox}),$(this).find(".mailFolders").html(this.renderFolders(response,null)),this.folder?$(this).find('[folderid="'+this.folder+'"]').addClass("selected"):$(this).find('[isinbox="true"]:first').addClass("selected"),$(this).find("[folderid]").on("click",evt=>{this.folderClick($(evt.currentTarget))}))})})}load(sync){let Filters=this.getFilters(),firstSync=!1;flexygo.ajax.post("~/api/Mail","GetMails",Filters,response=>{let mails=this.render(response,!1),mailItems=$(this).find(".mailList");mails&&mails.children().length>0?0==this.uid?mailItems.html(mails.children()):mailItems.append(mails.children()):0==this.uid&&(firstSync=!0,mailItems.html(this.noMailTemplate)),this.stopLoading(),sync&&(mailItems.prepend('<div class="row-line box-mail-sync"><div class="sync-content"><div class="sync"><p>'+flexygo.localization.translate("flxmail.sync")+"</p><span></span></div></div></div>"),flexygo.ajax.post("~/api/Mail","DownloadMails",{Folder:Filters.Folder,PageSize:Filters.PageSize},response=>{if(response.length>0)if(firstSync)this.uid=0,this.load(!1),$(this).find('[folderid="'+Filters.Folder+'"]').find("i").removeClass("hide");else{let mails=this.render(response,!0);mails&&mails.children().length>0&&mailItems.prepend(mails.children())}$(this).find(".mailList").find(".box-mail-sync").remove()},error=>{flexygo.exceptions.httpShow(error),$(this).find(".mailList").find(".box-mail-sync").remove()}))},error=>{flexygo.exceptions.httpShow(error),this.stopLoading()},null,()=>{this.startLoading()})}loadMore(){this.uid=parseInt($(this).find(".mailList [uid]").last().attr("uid")),this.load(!1)}loadConfig(){let me=$(this),params=new Object;params.ModuleName=this.moduleName,params.PageName=flexygo.history.getPageName(me),params.ObjectName=this.objectName,params.ObjectWhere=this.objectWhere,flexygo.ajax.post("~/api/Mail","GetMailConfig",params,response=>{response&&(response.ShowSettingsOption?($(this).find(".mailList").html(this.noSettingsTemplate),$(this).find(".nosettings").on("click",evt=>{this.settingsClick($(evt.currentTarget))})):(response.Folders.sort(function(a,b){return b.IsInbox-a.IsInbox}),this.linkObj=response.ObjectName,this.linkKey=response.ObjectId,this.toolbar=response.Toolbar,this.renderToolbar(JSON.stringify({ObjectName:this.linkObj,ObjectId:this.linkKey})),me.find('[name="MailAddress"]').val(response.EmailFilter),$(this).find(".mailFolders").html(this.renderFolders(response.Folders,null)),$(this).find('[isinbox="true"]:first').addClass("selected"),$(this).find("[folderid]").on("click",evt=>{this.folderClick($(evt.currentTarget))}),$(this).find(".nosettings").on("click",evt=>{this.settingsClick($(evt.currentTarget))}),$(this).find(".newFolder").on("click",evt=>{this.newFolderClick($(evt.currentTarget))}),this.load(!0)))},error=>{flexygo.exceptions.httpShow(error),$(this).find(".mailList").html(this.noSettingsTemplate),$(this).find(".nosettings").on("click",evt=>{this.settingsClick($(evt.currentTarget))})})}renderToolbar(defaults){""===defaults&&(defaults=null);let btnGroup,arrBtn=flexygo.utils.sortObject(this.toolbar,"PositionId","Order"),toolbar=$(this).find(".toolbar");if(toolbar.empty(),arrBtn.length>0){let lastPosition=arrBtn[0].PositionId;for(let i=0;i<arrBtn.length;i++){let btn=arrBtn[i],type=btn.TypeId;type&&(type=type.toLowerCase()),btnGroup||(btnGroup=$('<div class="btn-group" />')),btn.PositionId!=lastPosition&&(toolbar.append(btnGroup),btnGroup=$('<div class="btn-group" />')),"separator"==type||"placeholder"==type?(toolbar.append(btnGroup),btnGroup=null):btnGroup.append((new flexygo.ui.wc.FlxModuleElement).getButton(btn,null,null,defaults,null,null,null)),lastPosition=btn.PositionId}btnGroup&&toolbar.append(btnGroup)}}folderClick(itm){$(this).find(".mailList").find(".box-mail-sync").length>0?flexygo.msg.warning(flexygo.localization.translate("flxmail.waitsync")):($(this).find("[folderid]").removeClass("selected"),itm.addClass("selected"),this.folder=$(itm).attr("folderid"),this.load(!0))}settingsClick(itm){$(this).find(".mailList").find(".box-mail-sync").length>0?flexygo.msg.warning(flexygo.localization.translate("flxmail.waitsync")):flexygo.nav.execProcess("SetUserMailAccount","sysUser",null,null,null,"modal800x600",!0,itm)}newFolderClick(itm){$(this).find(".mailList").find(".box-mail-sync").length>0?flexygo.msg.warning(flexygo.localization.translate("flxmail.waitsync")):flexygo.nav.execProcess("sysImapNewFolders","sysUser",null,null,null,"modal800x600",!0,itm)}viewMail(mailID,subject){let itm=$("<flx-mailview></flx-mailview>");itm.attr("messageid",mailID),itm.attr("mode","imap"),itm.attr("ObjectName",this.linkObj),itm.attr("ObjectId",this.linkKey);let cont=flexygo.targets.createContainer({targetid:"popup1280x1024"},!1,$(this));cont.closest(".ui-dialog").find(".ui-dialog-title").html(subject),cont.addClass("mailViewer"),cont.html(itm)}renderFolders(obj,parent){let ul;ul=parent?$('<div class="collapse" id="'+flexygo.utils.parser.replaceAll(parent," ","")+'" aria-expanded="true" ><div class="childNodes"></div></div>'):$("<div />");for(let i=0;i<obj.length;i++){let li,spin="flx-icon icon-sincronize-1 icon-spin txt-outstanding";obj[i].Sync||(spin+=" hide"),obj[i].SyncError&&(spin="flx-icon icon-error1 txt-danger"),li=obj[i].CanSelect?$('<div><a class="collapsed" data-toggle="collapse" data-target="#'+flexygo.utils.parser.replaceAll(obj[i].Name," ","")+'" aria-expanded="false"><i class="flx-icon '+(obj[i].Folders&&obj[i].Folders.length>0?"tree-icon-toggle":"")+'"></i></a><span class="clickable" isinbox="'+obj[i].IsInbox+'" folderid="'+obj[i].ImapName+'">'+obj[i].Name+' <i class="'+spin+'"></i></span></div>'):$('<div><a class="collapsed" data-toggle="collapse" data-target="#'+flexygo.utils.parser.replaceAll(obj[i].Name," ","")+'" aria-expanded="false"><i class="flx-icon '+(obj[i].Folders&&obj[i].Folders.length>0?"tree-icon-toggle":"")+'"></i></a><span>'+obj[i].Name+"</span></div>"),obj[i].Folders&&obj[i].Folders.length>0?li.append(this.renderFolders(obj[i].Folders,obj[i].Name)):li.addClass("nochildren"),parent?ul.find(".childNodes").append(li):ul.append(li)}return ul}getFilters(){let me=$(this),ret=new flexygo.api.mail.MailFilters;ret.Uid=this.uid,ret.PageSize=this.pageSize,ret.Folder="inbox",ret.Seen=0==me.find('[name="Seen"]').val()?"true":"false",ret.MailAddress=me.find('[name="MailAddress"]').val(),ret.Subject=me.find('[name="Subject"]').val(),ret.Body=me.find('[name="Body"]').val(),ret.MailDateMin=me.find('[name="MailDateMin"]').val(),ret.MailDateMax=me.find('[name="MailDateMax"]').val();let selectedFolder=me.find("[folderid].selected");return selectedFolder.length>0&&(ret.Folder=selectedFolder.attr("folderid")),ret}selectAll(){let itms=$(this).find(".mailList [messageId]");itms.find(".box-mail-bagbutton i").removeClass("icon-non-check-2").addClass("icon-checked-1"),itms.addClass("selected"),this.refreshDefauts()}selectNone(){let itms=$(this).find(".mailList [messageId]");itms.find(".box-mail-bagbutton i").addClass("icon-non-check-2").removeClass("icon-checked-1"),itms.removeClass("selected"),this.refreshDefauts()}refreshDefauts(){let msgs=$(this).find(".mailList [messageId].selected"),msgsIds=new Array;msgs.length>0?(msgs.each((i,itm)=>{msgsIds.push($(itm).attr("messageId"))}),this.renderToolbar(JSON.stringify({ObjectName:this.linkObj,ObjectId:this.linkKey,MessageIds:msgsIds.join("|")}))):this.renderToolbar(JSON.stringify({ObjectName:this.linkObj,ObjectId:this.linkKey}))}startLoading(){$(this).parents("flx-module").length>0&&$(this).parents("flx-module")[0].startLoading()}stopLoading(){$(this).parents("flx-module").length>0&&$(this).parents("flx-module")[0].stopLoading()}refresh(){"true"!=$(this).attr("manualInit")&&this.load(!0)}render(ret,sync){if(ret){let mailItems=$("<div></div>");for(var i=0;i<ret.length;i++)mailItems.append(flexygo.utils.parser.recursiveCompile(ret[i],this.template,null,null,!0));if(!sync){let loadMore=$(this).find(".loadMoreRow");ret.length<this.pageSize?loadMore.hide():(loadMore.find(".icon-spin").removeClass("icon-spin"),loadMore.show())}return"true"==$(this).find("[folderid].selected").attr("isinbox")?mailItems.find(".mailto").addClass("hidden"):mailItems.find(".from").addClass("hidden"),mailItems.find(".box-mail-bagbutton").on("click",ev=>{$(ev.currentTarget).find("i").toggleClass("icon-checked-1 icon-non-check-2"),$(ev.currentTarget).closest("[messageId]").toggleClass("selected"),this.refreshDefauts()}),mailItems.find(".box-mail-data").on("click",ev=>{"flx-icon icon-link"==ev.target.className?flexygo.nav.openPageName("syspage-list-maillinks","sysMails_Object","MessageId = '"+$(ev.currentTarget).closest("[messageId]").attr("messageId")+"' ",null,"new",!1,$(this)):($(ev.currentTarget).parent().addClass("seen"),this.viewMail($(ev.currentTarget).closest("[messageId]").attr("messageId"),$(ev.currentTarget).closest("[messageId]").find(".subject").text()))}),mailItems}return null}configure(){}connectedCallback(){let element=$(this);this.connected=!0,this.objectName=element.attr("ObjectName"),this.objectWhere=element.attr("ObjectWhere"),this.moduleName=element.attr("ModuleName"),"true"!=element.attr("manualInit")&&this.init()}disconnectedCallback(){}attributeChangedCallback(attrName,oldVal,newVal){let needInit=!1;"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.moduleName=newVal,needInit=!0):"objectname"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectName=newVal,needInit=!0):"objectwhere"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.objectWhere=newVal,needInit=!0),this.connected&&needInit&&this.init()}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-maillist",flexygo.ui.wc.FlxMailList);