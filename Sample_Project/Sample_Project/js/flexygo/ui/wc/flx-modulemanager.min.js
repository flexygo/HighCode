var flexygo;!function(flexygo){var ui_1;((ui_1=flexygo.ui||(flexygo.ui={})).wc||(ui_1.wc={})).FlxModuleManagerElement=class extends HTMLElement{constructor(){super(),this.connected=!0,this.pagename=null,this.objectname=null,this.layoutname=null,this.modTemplate=null,this.targetItem=null}connectedCallback(){let element=$(this);this.connected=!0,this.pagename=element.attr("PageName"),this.objectname=element.attr("ObjectName"),flexygo.events.on(this,"entity","all",this.onModuleChanged),this.init()}static get observedAttributes(){return[]}disconnectedCallback(){flexygo.events.off(this,"entity","all",this.onModuleChanged)}attributeChangedCallback(attrName,oldVal,newVal){}init(){this.refresh()}onModuleChanged(e){if("inserted"==e.type||"updated"==e.type){let entity=e.sender,me=$(this);if("sysmodule"===entity.objectName.toLowerCase()||"syspagemodule"===entity.objectName.toLowerCase()){if("syspagemodule"==entity.objectName.toLowerCase()){let val=entity.data.RelationWhere.Value;null==val||""==val?me.find('li[data-id="'+entity.data.ModuleName.Value+'"]').find(".relationwhere").removeClass("selected"):me.find('li[data-id="'+entity.data.ModuleName.Value+'"]').find(".relationwhere").addClass("selected")}else"sysmodule"==entity.objectName.toLowerCase()&&this.updateModule(entity);$(document).find('flx-edit[objectname="'+entity.objectName+'"]').closest(".ui-dialog").remove()}}}refresh(){let me=$(this),obj=new flexygo.obj.Entity("sysLayouts");this.layouts=obj.getView();let container=$('<div class="moduleManager" />');me.html(container),container.append('<div id="layoutList" class="col-12 nopadding"/>'),container.append('<div class="layoutPanelOutside col-8"><div id="layoutPanel"></div></div>'),container.append('<div id="modulePanel" class="col-4"><div class="searchPanel"><flx-text class="searchInput" placeholder="'+flexygo.localization.translate("modulemanager.searchmodules")+'" iconclass="flx-icon icon-search" allowNewObject="sysModule" /></div><div style="clear:both"></div><div id="moduleList"><ul class="connectedSortable"></ul></div></div>'),container.append('<div id="bottomToolbar"><button class="btn btn-default bg-info saveButton"><i class="flx-icon icon-save"></i> '+flexygo.localization.translate("modulemanager.save")+'</button> <button class="btn btn-default bg-danger closeButton"><i class="flx-icon icon-remove"></i> '+flexygo.localization.translate("modulemanager.cancel")+"</button></div>"),this.loadLayoutPanel(),this.loadNodes(),this.loadCurrentPage();let btn=$('<button class="btn btn-default" type="button"><i class="flx-icon icon-open-in-new-window"></i></button>');container.find(".searchInput .input-group-btn").prepend(btn),btn.on("click",e=>{this.addTabModule()}),me.find(".searchPanel flx-text").on("keyup",e=>{var allModules=me.find("#moduleList li[data-descrip]");if(null==$(e.currentTarget).val()||""==$(e.currentTarget).val())allModules.show();else{allModules.hide();var filterValue=$(e.currentTarget).val().toLowerCase();allModules.filter(function(){return $(this).attr("data-descrip").toLowerCase().indexOf(filterValue)>-1}).show()}}),me.find("#bottomToolbar .saveButton").on("click",e=>{this.saveModuleConfig()}),me.find("#bottomToolbar .closeButton").on("click",e=>{$(e.currentTarget).closest(".ui-dialog").remove()}),setTimeout('$("#layoutList").mCustomScrollbar({axis:"x", theme: "dark", autoHideScrollbar: true});$("#moduleList").mCustomScrollbar({autoHideScrollbar: true})',500)}addTabModule(){let moduleContent=$('<form class="tabForm"/>');moduleContent.append('<div><flx-text prop="Identifier" type="ident" required placeholder="'+flexygo.localization.translate("modulemanager.tabid")+'"></flx-text></div>'),moduleContent.append('<div><flx-text prop="Title" type="text" required placeholder="'+flexygo.localization.translate("modulemanager.tabtitle")+'"></flx-text></div>'),moduleContent.append('<div><flx-text prop="Descrip" type="text" required placeholder="'+flexygo.localization.translate("modulemanager.tabdescrip")+'"></flx-text></div>'),moduleContent.append('<div><flx-dbcombo class="item-float" prop="IconName" objectname="sysObject" required prop="pageIcon" placeholder="'+flexygo.localization.translate("modulemanager.selecttabicon")+'" viewname="iconsView"  PageSize="50" sqlvaluefield="IconName" sqldisplayfield="IconName" ><template><i class=" txt-outstanding {{CSSClass}} icon-2x icon-margin" title="{{IconName}}" style="widht: 20px"></i></template></flx-dbcombo></div>'),moduleContent.append('<div><flx-dbcombo prop="ClassId" objectname="sysModule" required viewname="sysModuleClasses" sqlvaluefield="ClassId" sqldisplayfield="Descrip" placeholder="'+flexygo.localization.translate("modulemanager.classification")+'"></flx-dbcombo></div>'),moduleContent.append('<div><flx-dbcombo prop="TabMode" objectname="sysModule" required viewname="sysTabModes" sqlvaluefield="TypeId" sqldisplayfield="Descrip" placeholder="'+flexygo.localization.translate("modulemanager.tabMode")+'"></flx-dbcombo></div>'),moduleContent.append('<button required class="SaveTabModule btn btn-default bg-info saveButton"><i class="flx-icon icon-save"></i> '+flexygo.localization.translate("modulemanager.save")+"</button>"),Lobibox.window({title:flexygo.localization.translate("modulemanager.addnewtabmodule"),content:moduleContent}),$(".tabForm").validate({ignore:"",unhighlight:(element,errorClass,validClass)=>{$(element).parent().addClass("has-success").removeClass("has-error")},highlight:(element,errorClass,validClass)=>{$(element).parent().removeClass("has-success").addClass("has-error")},errorPlacement:(error,element)=>{error.insertAfter($(element).parent()[0])},errorClass:"txt-danger"}),$(".SaveTabModule").on("click",event=>{if($(".tabForm").valid()){event.stopPropagation(),event.preventDefault();let newTab=new flexygo.obj.Entity("sysModule");newTab.read(),newTab.data.TypeId.Value=$('.tabForm [prop="TabMode"]').val(),newTab.data.ModuleName.Value=$('.tabForm [prop="Identifier"]').val(),newTab.data.ClassId.Value=$('.tabForm [prop="ClassId"]').val(),newTab.data.Descrip.Value=$('.tabForm [prop="Descrip"]').val(),newTab.data.Title.Value=$('.tabForm [prop="Title"]').val(),newTab.data.IconName.Value=$('.tabForm [prop="IconName"]').val(),newTab.data.ContainerId.Value="default",newTab.data.CollapsibleButton.Value=!0,newTab.data.FullscreenButton.Value=!0,newTab.data.RefreshButton.Value=!0,newTab.insert()&&($(event.currentTarget).closest(".lobibox-window").find(".btn-close").click(),this.updateModule(newTab))}})}updateModule(module,form){let me=$(this),mod=me.find('li[data-id="'+module.data.ModuleName.Value+'"]'),list=me.find("#moduleList ul:first");if(0==mod.length){let newMod=$(flexygo.utils.parser.compile(module.data,this.modTemplate,flexygo));newMod.hide().find(".box-primary").addClass("new"),list.prepend(newMod),this.setActionButtons(newMod),newMod.is(".tabItem")&&this.setSorting(newMod.find(".connectedSortable")),newMod.show(500)}}saveModuleConfig(){let me=$(this),layoutPositons=me.find(".module-placeholder"),pageModules=new Array;$(".moduleTab>ul").each((i,e)=>{$(e).children("li").each((index,listel)=>{$(listel).attr("tabOrder",index)})});for(let jL=0;jL<layoutPositons.length;jL++){let modules=$(layoutPositons[jL]).find(".moduleItem"),order=0;for(let i=0;i<modules.length;i++){let myMod=$(modules[i]),tabName=null,tabOrder=null;myMod.parent().closest(".tabItem").length>0&&(tabName=myMod.parent().closest(".tabItem").attr("data-id"),tabOrder=myMod.attr("tabOrder")),pageModules.push({ModuleName:myMod.attr("data-id"),LayoutPositionId:this.getModulePosition(myMod),RelationWhere:myMod.find(".relwhere").html(),Order:order,TabName:tabName,TabOrder:tabOrder}),order++}}let params=new flexygo.api.pages.savePageConfigParams;params.PageName=this.pagename,params.ObjectName=this.objectname||null,params.LayoutName=this.layoutname,params.Modules=pageModules,flexygo.ajax.post("~/api/Page","SavePageConfig",params,ret=>{me.closest(".ui-dialog").remove(),$("#mainSidePanel")[0].hidePanels(),flexygo.history.refresh(this.targetItem)})}loadCurrentPage(){let me=$(this),params={pageName:this.pagename};flexygo.ajax.post("~/api/Page","GetModuleManagerModules",params,ret=>{me.find('#layoutList img[data-id="'+ret.LayoutName+'"]').click();let arrOrdered=flexygo.utils.sortObject(ret.Modules,"Order");for(let key in arrOrdered){let mod=arrOrdered[key],item=me.find('#moduleList li[data-id="'+mod.ModuleName+'"]');item.detach(),item.find(".box-primary").removeClass("box-primary").addClass("bg-primary"),item.find(".relwhere").html(mod.RelationWhere),mod.Events&&Object.keys(mod.Events).length>0&&item.find(".events").addClass("selected"),mod.RelationWhere&&""!=mod.RelationWhere&&item.find(".relationwhere").addClass("selected"),""!=mod.TabName?(item.attr("tabOrder",mod.TabOrder),me.find('[data-id="'+mod.TabName+'"]>div>.moduleTab>ul').append(item)):me.find("."+mod.LayoutPositionId+">ul").append(item)}$(".moduleTab>ul").each((i,e)=>{let mylist=$(e),listitems=mylist.children("li").get();listitems.sort((a,b)=>{let compA=parseInt($(a).attr("tabOrder")),compB=parseInt($(b).attr("tabOrder"));return compA<compB?-1:compA>compB?1:0}),$.each(listitems,(idx,itm)=>{mylist.append(itm)})})})}loadLayoutPanel(){let me=$(this),pageLayout=me.find("#layoutPanel"),layoutList=me.find("#layoutList");for(let i=0;i<this.layouts.length;i++)layoutList.append(flexygo.utils.parser.compile(this.layouts[i],'<img src="{{utils.resolveUrl(ImagePath)}}" data-id="{{LayoutName}}" title="{{LayoutDescrip}}" />',flexygo));layoutList.find("img").on("click",e=>{let newTemplate,img=$(e.currentTarget);layoutList.find("img").removeClass("selected"),img.addClass("selected");for(let i=0;i<this.layouts.length;i++)if(this.layouts[i].LayoutName==img.attr("data-id")){newTemplate=$("<div/>").append(this.layouts[i].LayoutTemplate),this.layoutname=this.layouts[i].LayoutName;break}newTemplate.find(".module-placeholder").append('<ul style="" class="connectedSortable" />');let modules=me.find(".module-placeholder>ul>li");for(let i=0;i<modules.length;i++){let myMod=$(modules[i]),modulePosition=this.getModulePosition(myMod);myMod.detach(),newTemplate.find("."+modulePosition).length>0?newTemplate.find("."+modulePosition+" ul:not(.connectedTab)").append(myMod):newTemplate.find(".TopPosition ul:not(.connectedTab)").append(myMod)}pageLayout.html(newTemplate.html()),pageLayout.append('<div style="clear:both"></div>'),this.setActionButtons(pageLayout.find("li")),this.setSorting(me.find(".connectedSortable"))})}loadNodes(){let me=$(this),obj=new flexygo.obj.Entity("sysModules");this.modTemplate='<li data-id="{{ModuleName}}" data-descrip="{{Descrip|string:lower}}" class="moduleItem nolist {{TypeId|switch:[flx-moduletab:tabItem,flx-buttontab:tabItem,else:null]}}">',this.modTemplate+='<div class="box-primary">',this.modTemplate+='<div class="buttonList">{{TypeId|switch:[flx-moduletab:<i title="Expand tab content" class="flx-icon icon-open-in-new-window tabButton"></i>,flx-buttontab:<i title="Expand tab content" class="flx-icon icon-open-in-new-window tabButton"></i>,else:null]}}',this.modTemplate+='<i title="'+flexygo.localization.translate("modulemanager.security")+'" class="flx-icon icon-group-security security"></i>',this.modTemplate+='<i title="'+flexygo.localization.translate("modulemanager.events")+'" class="flx-icon icon-wifi events"></i>',this.modTemplate+='<i title="'+flexygo.localization.translate("modulemanager.changepagerelation")+'" class="flx-icon icon-project relationwhere"></i>',this.modTemplate+='<i title="'+flexygo.localization.translate("modulemanager.configmodule")+'" class="flx-icon icon-settings configure"></i>',this.modTemplate+='<i title="'+flexygo.localization.translate("modulemanager.removemodule")+'" class="flx-icon icon-remove remove"></i>',this.modTemplate+="</div>",this.modTemplate+='<div class="listDescrip"><i title="{{TypeDescrip}}" class="{{TypeIconClass}} icon-lg"></i> <span class="modDesc">{{Descrip}}</span><span class="hidden relwhere"></span></div>{{TypeId|switch:[flx-moduletab:<div class="moduleTab" ><ul class="connectedTab connectedSortable"></ul></div>,flx-buttontab:<div class="moduleTab" ><ul class="connectedTab connectedSortable"></ul></div>,else:null]}}',this.modTemplate+="</li>",this.modules=obj.getView("sysModuleExtended");let list=me.find("#moduleList ul");list.empty();for(let i=0;i<this.modules.length;i++)list.append(flexygo.utils.parser.compile(this.modules[i],this.modTemplate,flexygo));this.setActionButtons(list.find("li")),this.setSorting(me.find(".moduleTab>ul.connectedSortable"))}setSorting(itms){let me=$(this);itms.sortable({appendTo:"BODY",zIndex:999999,helper:"clone",connectWith:".connectedSortable",stop:(event,ui)=>{let itm=$(ui.item);itm.closest("#layoutPanel").length>0?itm.find(".box-primary,.box-warning").removeClass("box-primary").removeClass("box-warning").addClass("bg-primary"):(itm.find(".bg-primary").removeClass("bg-primary").addClass("box-warning"),itm.is(".tabItem")&&itm.find(".moduleItem").each((i,e)=>{let inItem=$(e);inItem.detach(),me.find("#moduleList ul:first").prepend(inItem)}))},start:(event,ui)=>{let itm=$(ui.item);itm.is(".tabItem")&&(itm.find(".moduleTab").hide(),setTimeout(()=>{$(".ui-sortable-helper").find(".moduleTab").hide()},100))}}).disableSelection()}setActionButtons(items){let me=$(this);items.find(".buttonList .remove").on("click",e=>{let itm=$(e.currentTarget).closest("li");itm.hide(),itm.detach(),itm.find(".bg-primary").removeClass("bg-primary").addClass("box-warning"),me.find("#moduleList ul").prepend(itm),itm.is(".tabItem")&&itm.find(".moduleItem").each((i,el)=>{let inItem=$(el);inItem.detach(),me.find("#moduleList ul:first").prepend(inItem)}),itm.show(500)}),items.find(".buttonList .configure").on("click",e=>{flexygo.nav.openPage("edit","sysModule","Modules.moduleName='"+$(e.currentTarget).closest("li").attr("data-id")+"'",null,"popup",!0)}),items.find(".buttonList .events").on("click",e=>{let modulename=$(e.currentTarget).closest("li").attr("data-id");flexygo.nav.openPage("list","sysModuleEvents","Modules_Events.moduleName='"+modulename+"'","{'ModuleName':'"+modulename+"'}","popup",!0)}),items.find(".buttonList .security").on("click",e=>{flexygo.nav.openPageName("syspage-generic-modulesecurity","sysModule","Modules.moduleName='"+$(e.currentTarget).closest("li").attr("data-id")+"'","null","popup",!1,$(e.currentTarget))}),items.find(".buttonList .relationwhere").on("click",e=>{flexygo.nav.openPage("edit","sysPageModule","moduleName='"+$(e.currentTarget).closest("li").attr("data-id")+"' and PageName='"+this.pagename+"'",null,"popup",!0)}),items.find(".buttonList>.tabButton").on("click",e=>{$(e.currentTarget).closest("li").find("div>.moduleTab:first").toggle(500)})}getModulePosition(module){let classes=module.closest(".module-placeholder")[0].className.split(/\s+/);for(let i=0;i<classes.length;i++)if(-1!=classes[i].toLowerCase().indexOf("position"))return classes[i];return"TopPosition"}}}(flexygo||(flexygo={})),window.customElements.define("flx-modulemanager",flexygo.ui.wc.FlxModuleManagerElement);