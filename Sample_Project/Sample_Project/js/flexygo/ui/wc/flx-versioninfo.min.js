var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxVersionInfoElement=class extends HTMLElement{constructor(){super(),this.msToRestart=3e4,this.lastSuccessResponse=null}connectedCallback(){let mode=$(this).attr("mode");this.mode=mode,this.init()}init(){let template,force;this.settings={CurrentVersion:"",LastVersion:"",IsUpdated:!0,ErrorMessage:""},"icon"===this.mode?(template='<i class="fa fa-refresh icon-spin" />',force=!1):(template="",force=!0),$(this).append(template),this.responseShown=!1,this.refresh(force)}refresh(force=!1){if(flexygo.debug&&flexygo.debug.isDevelopMode&&flexygo.debug.isDevelopMode()){let params={Force:force};$(this).show(),flexygo.ajax.post("~/api/Sys","getVersion",params,response=>{"icon"===this.mode&&""!=response.ErrorMessage?flexygo.msg.info(response.ErrorMessage):(this.settings=response,this.render())})}else $(this).hide()}render(){"icon"===this.mode?this.renderIcon():this.renderPage()}renderIcon(){let info,me=$(this),ico=me.find("i"),menu=me.closest("li");menu.off("click"),this.settings.IsUpdated?(ico.removeClass("fa-info-circle txt-warning txt-danger fa-refresh icon-spin").addClass("fa-check-circle txt-outstanding"),info=flexygo.utils.parser.compile(this.settings,flexygo.localization.translate("flxversioninfo.currentversion"))+flexygo.localization.translate("flxversioninfo.updatedversion")):this.settings.ErrorMessage&&this.settings.ErrorMessage.length>0?(ico.removeClass("fa-check-circle txt-outstanding txt-warning fa-refresh icon-spin").addClass("fa-info-circle txt-danger"),info=this.settings.ErrorMessage):(ico.removeClass("fa-check-circle txt-outstanding txt-danger fa-refresh icon-spin").addClass("fa-info-circle txt-warning"),info=flexygo.utils.parser.compile(this.settings,flexygo.localization.translate("flxversioninfo.currentversion"))+flexygo.utils.parser.compile(this.settings,flexygo.localization.translate("flxversioninfo.newupdate"))),menu.on("click",()=>{flexygo.nav.openPageName("syspage-generic-versioninfo","","","","current",!1,$(this),!1),this.refresh(!0)}),menu.removeAttr("title").attr("title",info)}renderPage(){let me=$(this);me.html(flexygo.utils.loadingMsg()),flexygo.ajax.post("~/api/Sys","getInstalledVersions",null,response=>{let pendingReview;me.html(""),this.settings=response.current,this.versions=response.versions,this.changes=response.pendingReviewChanges,this.changes&&this.changes.length>0&&(pendingReview=!0),$.each(this.versions,(i,v)=>{if(v.IsCurrent){let info="";info=flexygo.utils.parser.compile(this.settings,flexygo.localization.translate("flxversioninfo.currentversion"));let updated="";this.settings.IsUpdated&&(updated+='<span class="l-size">'+flexygo.localization.translate("flxversioninfo.updatedversion")+"</span>"),pendingReview&&(updated+='<spanclass="l-size">'+flexygo.localization.translate("flxversioninfo.pendingchanges")+"</span>"),me.append('<div class="box-info">');let box=me.find(".box-info").first(),btnInfo=box.append('<button name="btn-info" class="btn bg-info"><i class="flx-icon icon-information-3"></i></button>').find('[name="btn-info"]');btnInfo.attr("title",flexygo.localization.translate("flxversioninfo.info")),btnInfo.off("click").on("click",()=>{this.infoVersion(v)});let btnTest=box.append('<button name="btn-test" class="btn bg-info"><i class="flx-icon icon-task-manager-2" > </i></button>').find('[name="btn-test"]');if(btnTest.attr("title",flexygo.localization.translate("flxversioninfo.test")),btnTest.off("click").on("click",()=>{flexygo.debug.test.show()}),pendingReview){let btnChanges=box.append('<button name="btn-changes" class="btn bg-info"><i class="flx-icon icon-audit"></i></button>').find('[name="btn-changes"]');btnChanges.attr("title",flexygo.localization.translate("flxversioninfo.reviewchanges")),btnChanges.off("click").on("click",()=>{this.showChanges(box)})}return box.append('<span class="l-size">'+info+"</span>"+updated),!1}}),$.each(this.versions,(i,v)=>{if(v.IsUpdate){let info=flexygo.utils.parser.compile(this.settings,flexygo.localization.translate("flxversioninfo.lastversion"));me.append('<div class="box-success"></div>');let box=me.find(".box-success").first();box.append('<button name="btn-info" class="btn bg-success"><i class="flx-icon icon-information-3"></i></button><button name="btn-update" class="btn bg-success"><i class="flx-icon icon-download"></i></button><span class="l-size">'+info+"</span>");let btnUpdate=box.find('[name="btn-update"]');btnUpdate.attr("title",flexygo.localization.translate("flxversioninfo.update")),btnUpdate.off("click").on("click",()=>{flexygo.msg.confirm(flexygo.localization.translate("flxversioninfo.confirmupdate"),result=>{result&&this.updateNewVersion(!1)})});let btnInfo=box.find('[name="btn-info"]');return btnInfo.attr("title",flexygo.localization.translate("flxversioninfo.info")),btnInfo.off("click").on("click",()=>{this.infoVersion(v)}),!1}}),$.each(this.versions,(i,v)=>{if(v.IsOld){let info=null,box=null;info=flexygo.utils.parser.compile(v,flexygo.localization.translate("flxversioninfo.oldversion")),me.append('<div class="box-primary"></div>'),(box=me.find(".box-primary").last()).append('<button name="btn-switch" class="btn bg-primary"><i class="flx-icon icon-update"></i></button><button name="btn-delete" class="btn bg-primary"><i class="flx-icon icon-delete"></i></button><span class="l-size">'+info+"</span>");let btnDelete=box.find('[name="btn-delete"]');btnDelete.attr("title",flexygo.localization.translate("flxversioninfo.delete")),btnDelete.off("click").on("click",v,e=>{let ver=e.data;flexygo.msg.confirm(flexygo.localization.translate("flxversioninfo.confirmdelete"),result=>{result&&this.deleteVersion(ver)})});let btnSwitch=box.find('[name="btn-switch"]');btnSwitch.attr("title",flexygo.localization.translate("flxversioninfo.switch")),btnSwitch.off("click").on("click",v,e=>{let ver=e.data;flexygo.msg.confirm(flexygo.localization.translate("flxversioninfo.confirmswitch"),result=>{result&&this.setActiveVersion(ver)})})}else if(v.IsNew){let info=null,box=null;info=flexygo.utils.parser.compile(v,flexygo.localization.translate("flxversioninfo.newversion")),me.append('<div class="box-warning"></div>'),(box=me.find(".box-warning").last()).append('<button name="btn-switch" class="btn bg-warning"><i class="flx-icon icon-update"></i></button><button name="btn-delete" class="btn bg-warning"><i class="flx-icon icon-delete"></i></button><span class="l-size">'+info+"</span>");let btnDelete=box.find('[name="btn-delete"]');btnDelete.attr("title",flexygo.localization.translate("flxversioninfo.delete")),btnDelete.off("click").on("click",v,e=>{let ver=e.data;flexygo.msg.confirm(flexygo.localization.translate("flxversioninfo.confirmdelete"),result=>{result&&this.deleteVersion(ver)})});let btnSwitch=box.find('[name="btn-switch"]');btnSwitch.attr("title",flexygo.localization.translate("flxversioninfo.switch")),btnSwitch.off("click").on("click",v,e=>{let ver=e.data;flexygo.msg.confirm(flexygo.localization.translate("flxversioninfo.confirmswitch"),result=>{result&&this.setActiveVersion(ver)})})}})})}infoVersion(v){let content="";v.IsUpdate?content="<div><strong>"+flexygo.localization.translate("flxversioninfo.releasenotes")+'</strong></div><span class="size-s">'+v.ReleaseNotes.replace(/(?:\r\n|\r|\n)/g,"<br />")+"</span></div>":(content="<div><strong>"+flexygo.localization.translate("flxversioninfo.infoversion")+"</strong><span>"+v.VersionNumber+"</span></div>",content+="<div><strong>"+flexygo.localization.translate("flxversioninfo.infopath")+"</strong><span>"+v.VirtualPath+"</span></div>",content+="<div><strong>"+flexygo.localization.translate("flxversioninfo.infodatabase")+"</strong><span>"+v.DatabaseName+"</span></div>"),Lobibox.alert("info",{title:flexygo.localization.translate("flxversioninfo.infotitle"),msg:content,iconClass:"fa fa-info-circle"})}showChanges(parent){let div=parent.find("div.versioninfo-changebox");div&&div.remove();let ov=flexygo.localization.translate("flxversioninfo.oldversionvalue"),cv=flexygo.localization.translate("flxversioninfo.customvalue"),nv=flexygo.localization.translate("flxversioninfo.newversionvalue"),mv=flexygo.localization.translate("flxversioninfo.manualvalue"),msg_apply=flexygo.localization.translate("flxversioninfo.applychanges"),msg_nochanges=flexygo.localization.translate("flxversioninfo.nochanges"),msg_changecount=flexygo.localization.translate("flxversioninfo.changecount"),itemtemplate='<div class="changebox" data-difid="{{DifId}}"><div class="row changebox-title"><div class="col-3"><i class="fa fa-table icon-margin-right"></i><strong>{{TableName}}</strong></div><div class="col-3"><i class="fa fa-columns icon-margin-right"></i><strong>{{FieldName}}</strong></div><div class="col-6"><i class="fa fa-arrow-right icon-margin-right"></i><strong>{{RowKey}}</strong></div></div><div class="row changebox-values"><div class="row"><div>'+ov+'</div><div><flx-text   iconclass="flx-icon icon-minus" value="{{OldValue|html}}"></flx-text></div></div><div class="row"><div><input type="radio" name="select-{{DifId}}" value="1">'+cv+'</div><div><flx-text   iconclass="flx-icon icon-minus" value="{{UserValue|html}}"></flx-text></div></div><div class="row"><div><input type="radio" name="select-{{DifId}}" value="0">'+nv+'</div><div><flx-text  iconclass="flx-icon icon-plus" value="{{NewValue|html}}"></flx-text></div></div><div class="row"><div><input type="radio" name="select-{{DifId}}" value="2">'+mv+'</div><div><flx-text iconclass="flx-icon icon-choose-hand" name="manualvalue-{{DifId}}" placeholder= "'+mv+'"/></flx-text></div></div></div></div>',items="";$.each(this.changes,(i,v)=>{items+=flexygo.utils.parser.compile(v,itemtemplate)}),(div=parent.append('<div class="versioninfo-changebox"></div>').children("div")).append(items),div.append('<button name="btn-apply" class="btn bg-notify">'+msg_apply+"</button>").find('[name="btn-apply"]').off("click").on("click",e=>{let count=0;if($.each(this.changes,(i,v)=>{let select=parent.find('input[name^="select-'+v.DifId+'"]:checked');if(select&&select.length>0&&(count++,v.ActionId=select.val(),v.Revised=!0,2==v.ActionId)){let text=parent.find('flx-text[name^="manualvalue-'+v.DifId+'"]');text&&text.val()&&(v.ManualValue=text.val())}}),0===count)Lobibox.alert("info",{title:flexygo.localization.translate("flxversioninfo.infotitle"),msg:msg_nochanges,iconClass:"fa fa-info-circle"});else{let obj={count};msg_changecount=flexygo.utils.parser.compile(obj,msg_changecount),flexygo.msg.confirm(msg_changecount,result=>{if(result){let params={version:this.settings.CurrentVersion,changes:this.changes};flexygo.ajax.post("~/api/Sys","updateChanges",params,response=>{this.refresh(),flexygo.msg.success(flexygo.localization.translate("flxversioninfo.applychangessuccesful"),null,null)})}})}})}deleteVersion(v){this.progressBar=Lobibox.progress({title:flexygo.localization.translate("flxversioninfo.deleting"),closeOnEsc:!1,closeButton:!1}),flexygo.ajax.post("~/api/Sys","deleteVersion",{version:v.VersionNumber},response=>{this.progressBar.destroy(),this.refresh(),flexygo.msg.success(flexygo.localization.translate("flxversioninfo.deletesuccessful"),null,null)})}setActiveVersion(v,force=!1){let params={version:v.VersionNumber,force};this.updateMode="partial",this.currentSetActiveVersion=v,flexygo.ajax.post("~/api/Sys","setActiveVersion",params,response=>{response&&(this.progressBar=Lobibox.progress({title:flexygo.localization.translate("flxversioninfo.updating"),label:flexygo.localization.translate("flxversioninfo.initupdate"),closeOnEsc:!1,closeButton:!1,onShow:()=>{this.responseShown=!1,this.updateProgress()}}))})}onSuccessUpdateProgress(response,inter){let title,i=response.Progress,label=this.progressBar.$el.find("label");switch(this.lastSuccessResponse=response,label.css("overflow-x","hidden"),response.CurrentState){case flexygo.api.sys.eAutoUpdaterState.eStateWaitingForResponse:if(!this.responseShown){this.responseShown=!0;let status=response.StatusText.replace(/\n/g,"<br />"),msg="<strong>"+flexygo.localization.translate("flxversioninfo.confirmwarninglabel")+"</strong><br />"+status;Lobibox.alert("warning",{msg,title:flexygo.localization.translate("flxversioninfo.confirmwarningtitle"),iconClass:"fa fa-warning",buttons:["ok","cancel"],callback:($this,type,ev)=>{"ok"===type&&("full"===this.updateMode?this.updateNewVersion(!0):this.setActiveVersion(this.currentSetActiveVersion,!0))}})}i=100;break;case flexygo.api.sys.eAutoUpdaterState.eStateFinishedError:if(!this.responseShown){this.responseShown=!0;let error=response.ErrorMessage.replace(/\n/g,"<br />");Lobibox.alert("error",{msg:error,iconSource:"fontAwesome",width:600,title:"Error"})}i=100;break;case flexygo.api.sys.eAutoUpdaterState.eStateFinishedOk:this.responseShown||(this.showUpdateSuccessful(),this.responseShown=!0),i=100;break;case flexygo.api.sys.eAutoUpdaterState.eStateWorking:switch(response.CurrentStatus){case flexygo.api.sys.eAutoUpdaterStatus.eStatusUpdatingService:title=flexygo.localization.translate("flxversioninfo.estatusupdatingservice");break;case flexygo.api.sys.eAutoUpdaterStatus.eStatusCheckingPackages:title=flexygo.localization.translate("flxversioninfo.estatuscheckingpackages");break;case flexygo.api.sys.eAutoUpdaterStatus.eStatusDownloadingVersion:title=flexygo.localization.translate("flxversioninfo.estatusdownloadingversion");break;case flexygo.api.sys.eAutoUpdaterStatus.eStatusFinished:title=flexygo.localization.translate("flxversioninfo.estatusfinished");break;case flexygo.api.sys.eAutoUpdaterStatus.eStatusUpdateDatabase:title=flexygo.localization.translate("flxversioninfo.estatusupdatedatabase");break;case flexygo.api.sys.eAutoUpdaterStatus.eStatusUpdateIIS:title=flexygo.localization.translate("flxversioninfo.estatusupdateiis")}}this.progressBar&&(response.StatusText&&response.StatusText.length>0&&label.html(response.StatusText),this.progressBar.setTitle(title),this.progressBar.setProgress(response.Progress)),i>=100&&(clearInterval(inter),this.progressBar.destroy(),response.CurrentState===flexygo.api.sys.eAutoUpdaterState.eStateFinishedOk&&window.location.reload(!0))}onFailureUpdateProgress(error,inter){if(console.log("flxversioninfo.onFailureUpdateProgress",error),error&&error.status&&(500===error.status||404===error.status||503===error.status)){let last=this.lastSuccessResponse;if(last&&last.CurrentState===flexygo.api.sys.eAutoUpdaterState.eStateWorking&&last.CurrentStatus===flexygo.api.sys.eAutoUpdaterStatus.eStatusUpdateIIS&&this.progressBar){let p=this.progressBar.getProgress();this.progressBar.setProgress(p+.5)}}else clearInterval(inter),this.progressBar.destroy(),flexygo.exceptions.httpShow(error)}showUpdateSuccessful(){Lobibox.alert("success",{msg:flexygo.localization.translate("flxversioninfo.applicationwillreset"),iconSource:"fontAwesome",title:flexygo.localization.translate("flxversioninfo.updatesuccessful"),closeOnEsc:!1,closeButton:!1,closable:!1,delay:this.msToRestart,buttons:null})}updateProgress(){this.lastSuccessResponse=null;let inter=setInterval(()=>{flexygo.ajax.post("~/api/Sys","checkUpdateProgress",null,response=>{this.onSuccessUpdateProgress(response,inter)},error=>{this.onFailureUpdateProgress(error,inter)})},1e3)}updateNewVersion(force){let params={Version:this.settings.LastVersion,Force:force};this.updateMode="full",this.currentSetActiveVersion=null,flexygo.ajax.post("~/api/Sys","updateNewVersion",params,response=>{response&&(this.progressBar=Lobibox.progress({title:flexygo.localization.translate("flxversioninfo.updating"),label:flexygo.localization.translate("flxversioninfo.initupdate"),closeOnEsc:!1,closeButton:!1,onShow:()=>{this.responseShown=!1,this.updateProgress()}}))})}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-versioninfo",flexygo.ui.wc.FlxVersionInfoElement);