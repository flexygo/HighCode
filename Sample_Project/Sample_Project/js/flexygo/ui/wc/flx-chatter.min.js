var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxChatterElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.composerAttachments=[],this.startInfoTemplate=(()=>`<div class="start_info txt-muted">\n                                                        <span>\n                                                            ${flexygo.localization.translate("chatter.startinfo")}\n                                                        </span>\n                                                        <i class="flx-icon icon-settings"/>\n                                                     </div>`),this.chatterTemplate=(()=>`<div class="chatter">\n                                                      <div class="DEVELOPING chatter_topbar">\n\n                                                        <span style="MARGIN: 0 AUTO;COLOR: #858585;">BARRA SUPERIOR PARA MAS OPCIONES</span>\n\n                                                      </div>\n                                                      <div class="chatter_composer">\n                                                        <div class="chatter_composer_container">\n                                                          <img class="chatter_avatar img-circle hidden-sm hidden-xs" src="${flexygo.utils.resolveUrl(flexygo.profiles.avatar)}"/>\n                                                          <div class="chatter_composer_section">\n                                                            <div class="chatter_composer_input">\n                                                              <textarea class="chatter_composer_textarea" tabindex="2" placeholder="${flexygo.localization.translate("chatter.composerplaceholder")}"></textarea>\n                                                              <div class="chatter_composer_tools">\n                                                                <img class="chatter_avatar_mini img-circle hidden-lg hidden-md" src="${flexygo.utils.resolveUrl(flexygo.profiles.avatar)}"/>\n                                                                <button disabled class="hide btn fa fa-smile-o chatter_composer_button_emoji" data-toggle="popover" tabindex="4" type="button"/>\n                                                                <button class="btn fa fa-paperclip chatter_composer_button_add_attachment" tabindex="5" type="button"/>\n                                                                <button disabled class="btn btn-icon fa fa-paper-plane-o chatter_composer_button_send hidden-lg hidden-md" tabindex="3" type="button"/>\n                                                                <button disabled class="hide btn fa fa-expand chatter_composer_button_full_composer" tabindex="6" type="button"/>\n                                                              </div>\n                                                              <div class="chatter_composer_attachments"/>\n                                                            </div>\n                                                          </div>\n                                                        </div>\n                                                        <div class="chatter_composer_send">\n                                                          <button disabled class="btn chatter_composer_button_send hidden-sm hidden-xs" tabindex="3" type="button">${flexygo.localization.translate("chatter.sendbutton")}</button>\n                                                        </div>\n                                                      </div>\n                                                      <div class="chatter_thread"/>\n                                                    </div>`),this.composerAttachmentTemplate=(composerAttachmentData=>`<div class="chatter_composer_attachment" chatter-attachment-id="${composerAttachmentData.id}">\n                                                                                                                                    <div>\n                                                                                                                                        <i class="size-l fa ${flexygo.utils.getFileIcon(composerAttachmentData.name.split(".").pop())}"/>\n                                                                                                                                        <small>${composerAttachmentData.name.split(".").slice(0,-1).join(".")}</small>\n                                                                                                                                    </div>\n                                                                                                                                    <div>\n                                                                                                                                        <i class="flx-icon icon-close-2 chatter_composer_attachment_delete"></i>\n                                                                                                                                    </div>\n                                                                                                                                 </div>`),this.parentMessageTemplate=(parentMessageData=>`<div class="chatter_composer_parent_message" chatter-parent-message-id="${parentMessageData.id}">\n                                                                                                                    <div>\n                                                                                                                        <small>\n                                                                                                                            <strong class="txt-outstanding">${parentMessageData.author}</strong>\n                                                                                                                            <p>${parentMessageData.content}</p>\n                                                                                                                        </small>\n                                                                                                                    </div>\n                                                                                                                    <div>\n                                                                                                                        <i class="chatter_composer_parent_message_delete size-l flx-icon icon-close-2"/>\n                                                                                                                    </div>\n                                                                                                                </div>`),this.separatorTemplate=(date=>`<div class="chatter_thread_date_separator">\n                                                                    <span class="chatter_thread_date">${moment(date).locale(flexygo.profiles.culture).format("LL")}</span>\n                                                                </div>`),this.messageTemplate=((messageData,isNew)=>`<div class="chatter_thread_message ${isNew?"new_message":""}" chatter-message-id="${messageData.messageId}">\n                                                                                                    <div class="chatter_thread_message_sidebar">\n                                                                                                    <img src="${flexygo.utils.resolveUrl(messageData.avatar)}" class="chatter_thread_message_avatar img-circle"/>\n                                                                                                    </div>\n                                                                                                    <div class="chatter_thread_message_core">\n                                                                                                        <p class="chatter_thread_message_info">\n                                                                                                            <strong class="chatter_thread_author">${messageData.author}</strong><span class="chatter_thread_info_separator"/><small class="chatter_mail_timestamp" chatter-message-timestamp="${messageData.insertionDate}" title="${moment(messageData.insertionDate).locale(flexygo.profiles.culture).format("DD/MM/YYYY HH:mm:ss")}">${moment(messageData.insertionDate).locale(flexygo.profiles.culture).fromNow()}</small>\n                                                                                                            <span class="chatter_thread_icons">\n                                                                                                                ${messageData.parentMessage?"":'<i class="fa-lg chatter_thread_icon chatter_thread_message_reply  flx-icon icon-arrow-2"/>'}\n                                                                                                                <i disabled class="hide fa fa-lg chatter_thread_icon chatter_thread_message_favorite fa-star-o" chatter-message-favorite="false"/>\n                                                                                                                ${messageData.attachmentsCount?`<span class="chatter_thread_icon chatter_thread_message_attachments" chatter-message-documents-loaded="false"><i class="fa fa-lg fa-paperclip"/>${messageData.attachmentsCount}</span>`:""}\n                                                                                                            </span>\n                                                                                                        </p>\n                                                                                                        <div class="chatter_thread_message_content">\n                                                                                                            <p>${messageData.content}</p>\n                                                                                                        </div>\n                                                                                                    </div>\n                                                                                                    ${messageData.parentMessage?"":'<div class="chatter_thread_message_children" />'}\n                                                                                                </div>`),this.messageDocumentTemplate=(document=>`<div class="chatter_message_document" chatter-message-document-id="${document.docGuid}">\n                                                                                                                                    <div>\n                                                                                                                                        <i class="size-l fa ${document.iconClass}"/>\n                                                                                                                                        <small>${document.name}</small>\n                                                                                                                                    </div>\n                                                                                                                                    <div>\n                                                                                                                                        <a href="${flexygo.utils.resolveUrl(document.downloadLink)}" download="${document.name+document.extension}">\n                                                                                                                                            <i class="flx-icon icon-download-1 chatter_message_download"></i>\n                                                                                                                                        </a>\n                                                                                                                                    </div>\n                                                                                                                                 </div>`)}static get observedAttributes(){return["ModuleName","ObjectName","ObjectWhere","objectId"]}init(){try{let me,defObject,wcModule;(me=$(this)).removeAttr("manualInit"),defObject=JSON.parse(flexygo.utils.parser.replaceAll(flexygo.history.getDefaults(this.objectName,me),"'",'"')),wcModule=me.closest("flx-module")[0],this.destinationObjectName=this.objectName&&this.objectId?this.objectName:defObject?defObject.DestinationObjectName:wcModule.objectdefaults?wcModule.objectdefaults.DestinationObjectName:"",this.destinationObjectId=this.objectName&&this.objectId?this.objectId:defObject?defObject.DestinationObjectId:wcModule.objectdefaults?wcModule.objectdefaults.DestinationObjectId:"",this.render()}catch(ex){console.log(ex)}}refresh(){if("true"!=$(this).attr("manualInit"))try{this.removeExternalEvents(),this.init()}catch(ex){console.log(ex)}}render(){try{let me;me=$(this),this.destinationObjectName&&this.destinationObjectId?(me.html(this.chatterTemplate()),this.setMainEvents(),this.getMessages()):(me.html(this.startInfoTemplate()),this.setStartInfoEvents())}catch(ex){console.log(ex)}}setStartInfoEvents(){try{let me=$(this);me.find(".start_info i").off("click.chatter").on("click.chatter",function(){me[0].configure()})}catch(ex){console.log(ex)}}setMainEvents(){try{let me=$(this),composerTextareaMinHeight=me.find(".chatter_composer_textarea").outerHeight()||50,sillyTextArea=$("<textarea disabled>").css({position:"absolute",opacity:0,height:0,borderTopWidth:0,borderBottomWidth:0,padding:0,top:-1e4});me.find(".chatter_composer_textarea").off("input.chatter focus.chatter change.chatter").on("input.chatter focus.chatter change.chatter",function(){let temporarySillyTextAreaHeight,composerTextareaHeightOffset=0,textareaStyle=window.getComputedStyle(this,null),temporarySillyTextArea=sillyTextArea.insertAfter(this);if(temporarySillyTextArea.width($(this).width()),temporarySillyTextArea.val($(this).val()),temporarySillyTextAreaHeight=temporarySillyTextArea[0].scrollHeight,temporarySillyTextArea.remove(),"border-box"===textareaStyle.boxSizing){let paddingHeight=parseFloat(textareaStyle.paddingTop)+parseFloat(textareaStyle.paddingBottom);composerTextareaHeightOffset=parseFloat(textareaStyle.borderTopWidth)+parseFloat(textareaStyle.borderBottomWidth)+paddingHeight}$(this).css({height:Math.max(temporarySillyTextAreaHeight+composerTextareaHeightOffset,composerTextareaMinHeight)}),""!=$(this).val()?me.find(".chatter_composer_button_send ").prop("disabled",!1):me.find(".chatter_composer_button_send ").prop("disabled",!0)}),me.find(".chatter_composer_button_add_attachment").off("click.chatter").on("click.chatter",function(){$(document.createElement("input")).attr({type:"file",multiple:"multiple"}).off("change.chatter").on("change.chatter",function(e){for(let file of e.currentTarget.files){let reader=new FileReader;reader.onload=(e=>{let composerAttachmentData={id:flexygo.utils.uniqueId(),name:file.name};me[0].composerAttachments.push({id:composerAttachmentData.id,name:composerAttachmentData.name,base64:e.target.result.split(",")[1]});let attachment=$(me[0].composerAttachmentTemplate(composerAttachmentData)).prependTo(me.find(".chatter_composer_attachments"));setTimeout(function(){attachment.css({opacity:1,height:36,padding:"0 10px",margin:"10px 0"})},25),attachment.find(".chatter_composer_attachment_delete").off("click.chatter").on("click.chatter",function(){me[0].composerAttachments.splice(me[0].composerAttachments.map(attachment=>attachment.id).indexOf(attachment.attr("chatter-attachment-id")),1),attachment.css({opacity:0,height:0,padding:0,margin:0}),setTimeout(()=>{attachment.remove()},150)})}),reader.readAsDataURL(file)}}).click()}),me.find(".chatter_composer_button_send").off("click.chatter").on("click.chatter",function(){me[0].setMessage()}),setInterval(()=>{me.find(".chatter_mail_timestamp").each(function(){$(this).text(moment($(this).attr("chatter-message-timestamp")).locale(flexygo.profiles.culture).fromNow())})},6e4)}catch(ex){console.log(ex)}}setMessageEvents(message){try{let me=$(this);message?setTimeout(()=>{message.removeClass("new_message")},25):message=me,message.find(".chatter_thread_message_reply").off("click.chatter").on("click.chatter",function(){let message=$(this).closest(".chatter_thread_message"),parentMessage=me.find(".chatter_composer_parent_message");if(flexygo.utils.isInMainContent($(this).closest(".chatter").find(".chatter_composer")[0],200)||$(this).closest(".chatter").find(".chatter_composer")[0].scrollIntoView({block:"center",behavior:"smooth"}),parentMessage.attr("chatter-parent-message-id")!=message.attr("chatter-message-id")){parentMessage.remove();let parentMessageData={id:message.attr("chatter-message-id"),author:message.find(".chatter_thread_author:first").text(),content:message.find(".chatter_thread_message_content:first").text()};parentMessage=$(me[0].parentMessageTemplate(parentMessageData)).prependTo(me.find(".chatter_composer_input")),setTimeout(function(){parentMessage.css({opacity:1,height:56,padding:10,"margin-bottom":5})},0),parentMessage.find(".chatter_composer_parent_message_delete").off("click.chatter").on("click.chatter",function(){parentMessage.css({opacity:0,height:0,padding:0,"margin-bottom":0}),setTimeout(()=>{parentMessage.remove()},150)})}$(this).closest(".chatter").find("textarea.chatter_composer_textarea")[0].focus({preventScroll:!0})}),message.find(".chatter_thread_message_attachments").off("click.chatter").on("click.chatter",function(){if("false"===$(this).attr("chatter-message-documents-loaded")){$(this).attr("chatter-message-documents-loaded","true");let params={ObjectId:$(this).closest(".chatter_thread_message").attr("chatter-message-id"),ObjectName:"sysChatter"};flexygo.ajax.post("~/api/DocumentManager","GetDocument",params,response=>{if(response){let contenct="";for(var doc of response)contenct+=me[0].messageDocumentTemplate(doc);$("#mainContent, main.pageContainer").on("scroll.chatter",e=>{$(this).popover("hide")}),$(window,me.closest("div.ui-dialog")).on("resize.chatter",e=>{$(this).popover("hide")}),$(document).on("mouseup.chatter",e=>{$(this).data("bs.popover").$tip.is(e.target)||0!==$(this).data("bs.popover").$tip.has(e.target).length||$(this).is(e.target)||0!==$(this).has(e.target).length||$(this).popover("hide")}),flexygo.events.on(this,"navbar","toggled",e=>{$(this).popover("hide")}),$(this).on("show.bs.popover",()=>{$(this).attr("chatter-message-documents-visible","true")}),$(this).on("hidden.bs.popover",()=>{$(this).attr("chatter-message-documents-visible","false")}),$(this).popover({container:"body",content:contenct,html:!0,placement:"top",template:'<div class="popover flx-chatter chatter-popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',trigger:"manual"}).popover("show")}})}else"false"===$(this).attr("chatter-message-documents-visible")?$(this).popover("show"):$(this).popover("hide")})}catch(ex){console.log(ex)}}getMessages(){try{let params,me=$(this);params={ObjectName:this.destinationObjectName,ObjectId:this.destinationObjectId},flexygo.ajax.post("~/api/Chatter","GetMessages",params,response=>{response.forEach(message=>{me.find(message.parentMessage?`[chatter-message-id="${message.parentMessage}"] .chatter_thread_message_children:first`:".chatter_thread").append(this.messageTemplate(message))}),this.setMessageEvents()})}catch(ex){console.log(ex)}}setMessage(){try{let me,params;me=$(this),params={DestinationObjectName:this.destinationObjectName,DestinationObjectId:this.destinationObjectId,DestinationParentMessage:me.find(".chatter_composer_parent_message").attr("chatter-parent-message-id"),Content:me.find("textarea.chatter_composer_textarea").val().trim(),Attachments:this.composerAttachments},flexygo.ajax.post("~/api/Chatter","SetMessage",params,response=>{this.setMessageEvents($(this.messageTemplate(response,!0)).prependTo(me.find(response.parentMessage?`[chatter-message-id="${response.parentMessage}"] .chatter_thread_message_children:first`:".chatter_thread"))),flexygo.utils.isInMainContent(me.find(`[chatter-message-id="${response.messageId}"]`)[0],100)||$(this).find(`[chatter-message-id="${response.messageId}"]`)[0].scrollIntoView({block:"center",behavior:"smooth"})}),this.cleanComposer()}catch(ex){console.log(ex)}}cleanComposer(){try{$(this).find("textarea.chatter_composer_textarea").val(""),$(this).find(".chatter_composer_parent_message_delete").click(),$(this).find(".chatter_composer_attachment_delete").click(),$(this).find(".chatter_composer_button_send ").prop("disabled",!0)}catch(ex){console.log(ex)}}removeExternalEvents(){try{flexygo.events.off(this,"entity","all"),flexygo.events.off(this,"dialog","closed"),flexygo.events.off(this,"navbar","toggled"),$("#mainContent, main.pageContainer").off("scroll.chatter"),$(window,$(this).closest("div.ui-dialog")).off("resize.chatter"),$(document).off("mouseup.chatter"),$(".flx-chatter.chatter-popover").remove()}catch(ex){console.log(ex)}}configure(){let me=$(this),pageContext=flexygo.history.get(me.closest(".pageContainer")),obj=new flexygo.obj.Entity(pageContext.objectname);if(void 0!==pageContext.objectname){let cnf=obj.objectName?obj.getConfig():null,defaults={ObjectName:cnf?cnf.ObjectName:"",ObjectPK:cnf&&1===cnf.KeyFields.length?cnf.KeyFields[0]:""};flexygo.nav.openPage("edit","sysChatter_Config",cnf?"ObjectName = '"+cnf.ObjectName+"'":null,defaults,"modal900x400",!1,$(this)),flexygo.events.on(this,"entity","all",e=>{this===e.context&&"sysChatter_Config"===e.sender.objectName&&(flexygo.events.off(this,"entity","all"),flexygo.events.off(this,"dialog","closed"),new flexygo.Process("ReloadCache",null,null).run(null,()=>{flexygo.history.go(pageContext)}),flexygo.nav.closePage($('flx-edit[objectname="sysChatter_Config"]')))}),flexygo.events.on(this,"dialog","closed",e=>{this===e.context&&"sysChatter_Config"===e.sender.objectname&&(flexygo.events.off(this,"entity","all"),flexygo.events.off(this,"dialog","closed"))})}else flexygo.msg.warning(flexygo.localization.translate("develop.selectobject"))}connectedCallback(){let element=$(this);this.connected=!0,this.moduleName=element.attr("ModuleName"),this.objectName=element.attr("ObjectName"),this.objectWhere=element.attr("ObjectWhere"),this.objectId=element.attr("ObjectId"),"true"!=element.attr("manualInit")&&this.init()}disconnectedCallback(){this.removeExternalEvents()}attributeChangedCallback(attrName,oldVal,newVal){let needInit=!1;"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.moduleName=newVal,needInit=!0):"objectname"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectName=newVal,needInit=!0):"objectwhere"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectWhere=newVal,needInit=!0):"ObjectId"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.objectId=newVal,needInit=!0),this.connected&&needInit&&this.init()}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-chatter",flexygo.ui.wc.FlxChatterElement);