var flexygo,__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};!function(flexygo){!function(ui){!function(wc_1){class FlxListElement extends HTMLElement{constructor(){super(),this.connected=!1,this.mode=null,this.isFocused=!1,this.objectname=null,this.childname=null,this.collectionname=null,this.objectwhere=null,this.processwhere=null,this.data=null,this.tHeader=null,this.tBody=null,this.tFooter=null,this.tCSSText=null,this.tScriptText=null,this.currentRow=null,this.prevRow=null,this.isRowDirty=!1,this.pager=null,this.pagerConfig=null,this.additionalWhere="",this.cryptedSql=null,this.removeKeys=!1,this.page=0,this.pageSize=null,this.pageSizeDefault=null,this.pagesButtons=3,this.maxRows=0,this.maxPages=0,this.moduleName=null,this.groups=null,this.groupList=null,this.userDefinedGroups=!1,this.sortColumn=null,this.sortAsc=!1,this.orderObj=null,this.viewId=null,this.templateId=null,this.presetId=null,this.presetText=null,this.presetIcon=null,this.removePreset=!1,this.defaults=null,this.canDelete=null,this.canInsert=null,this.canUpdate=null,this.filter=null,this.filters=null,this.filterValues=null,this.activeFilter=null,this.buttons=null,this.moduleButtons=null,this.propArr=null,this.templateKey="",this.searcher=null,this.refreshing=null,this.TemplateToolbarCollection=null,this.loadingDependencies=0,this.pendingSaveButton=null}connectedCallback(){let element=$(this);this.connected=!0,element.attr("modulename")&&""!=element.attr("modulename")?this.moduleName=element.attr("modulename"):this.moduleName="sysmod-list-generic",element.attr("templateid")&&""!=element.attr("templateid")&&(this.templateId=element.attr("templateid")),this.defaults=element.attr("defaults"),this.moduleName&&"true"!=element.attr("manualInit")&&this.init()}disconnectedCallback(){flexygo.events.off(this,"entity","all",this.onEntityChanged),flexygo.events.off(this,"property","changed",this.onPropertyChanged);let activeFilter=$(this).closest("flx-module").find("flx-filter")[0];activeFilter&&flexygo.events.off(activeFilter,"property","changed",activeFilter.onPropertyChanged)}attributeChangedCallback(attrName,oldVal,newVal){let isDirty=!1;this.connected&&(this&&"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.moduleName=newVal,this.moduleName&&(isDirty=!0)),this&&"objectname"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.objectname=newVal,this.objectname&&(isDirty=!0)),this&&"objectwhere"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.objectwhere=newVal,this.objectwhere&&(isDirty=!0)),this&&"presetname"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.presetId=newVal,this.objectwhere&&(isDirty=!0)),!0===this.connected&&!0===isDirty&&"true"!=$(this).attr("manualInit")&&this.init())}refresh(){let activeFilter=$(this).closest("flx-module").find("flx-filter")[0];if(activeFilter&&flexygo.events.off(activeFilter,"property","changed",activeFilter.onPropertyChanged),"true"!=$(this).attr("manualInit"))return this.initGrid(!0,!0,this.page)}init(){$(this).removeAttr("manualInit"),$(this).closest("flx-module").find(".flx-noInitContent").remove(),flexygo.events.off(this,"entity","all",this.onEntityChanged),flexygo.events.on(this,"entity","all",this.onEntityChanged),flexygo.events.off(this,"property","changed",this.onPropertyChanged),flexygo.events.on(this,"property","changed",this.onPropertyChanged,!0),$(this).on("destroy",()=>{flexygo.events.off(this,"entity","all",this.onEntityChanged),flexygo.events.off(this,"property","changed",this.onPropertyChanged)});let me=$(this),module=me.closest("flx-module")[0],history=flexygo.history.get(me),page=0;if(this.filterValues=null,this.activeFilter=null,this.orderObj=null,history&&history.presetsValues&&(history.presetsValues[this.moduleName]||history.presetsValues["*"])){let preset=history.presetsValues[this.moduleName]?history.presetsValues[this.moduleName]:history.presetsValues["*"];preset.presetId&&(this.presetId=preset.presetId,this.presetIcon=preset.presetIcon,this.presetText=preset.presetText,this.removePreset=preset.removePreset)}if($(module).attr("presetname")&&(this.presetId=$(module).attr("presetname"),this.presetText=$(module).attr("presettext"),this.presetIcon=$(module).attr("preseticon"),this.removePreset="true"==$(module).attr("removepreset")),history&&history.filtersValues&&history.filtersValues[this.moduleName]){let state=history.filtersValues[this.moduleName];state.activeFilter&&(this.activeFilter=state.activeFilter),state.properties&&(this.filterValues=state.properties),state.activePage&&(page=state.activePage)}return flexygo.ui.templates.setDefaultTemplate(this),this.setDefaultOrder(),this.setDefaultGroup(),this.initGrid(!0,!0,page)}setDefaultOrder(){let activeTemplatesOrder=flexygo.storage.local.get("activeTemplatesOrder");if(activeTemplatesOrder){let key=this.getModuleFullId()+"|"+this.templateKey;void 0!==activeTemplatesOrder[key]?this.orderObj=activeTemplatesOrder[key]:this.orderObj=null}}saveDefaultOrder(){let activeTemplatesOrder=flexygo.storage.local.get("activeTemplatesOrder"),key=this.getModuleFullId()+"|"+this.templateKey;null==activeTemplatesOrder&&(activeTemplatesOrder=new Object),activeTemplatesOrder[key]=this.orderObj,flexygo.storage.local.add("activeTemplatesOrder",activeTemplatesOrder)}setDefaultGroup(){let activeTemplatesGroup=flexygo.storage.local.get("activeTemplatesGroup");if(activeTemplatesGroup){let key=this.getModuleFullId()+"|"+this.templateKey;void 0!==activeTemplatesGroup[key]?this.groups=activeTemplatesGroup[key]:this.groups=null}}saveDefaultGroup(){if(this.groups){let activeTemplatesGroup=flexygo.storage.local.get("activeTemplatesGroup"),key=this.getModuleFullId()+"|"+this.templateKey;null==activeTemplatesGroup&&(activeTemplatesGroup=new Object),activeTemplatesGroup[key]=this.groups,flexygo.storage.local.add("activeTemplatesGroup",activeTemplatesGroup)}}hasGroup(groupField){let found=!1;if(this.groups&&Object.keys(this.groups).length>0)for(let key in this.groups)key.toLowerCase()==groupField.toLowerCase()&&(found=!0,groupField=key);return found}toggleGroup(groupField){this.hasGroup(groupField)?this.removeGroup(groupField):this.addGroup(groupField)}addGroup(groupField){for(let key in this.groupList)key.toLowerCase()==groupField.toLowerCase()&&(this.groups[key]=this.groupList[key],this.groups[key].Order=Object.keys(this.groups).length);this.saveDefaultGroup(),this.refresh()}removeGroup(groupField){delete this.groups[groupField];let i=0;for(let key in this.groups)this.groups[key].Order=i,i+=1;this.saveDefaultGroup(),this.refresh()}onEntityChanged(e){("inserted"===e.type&&"edit"!=$(this).attr("mode")||"updated"===e.type&&"edit"!=$(this).attr("mode")||"deleted"===e.type)&&this.objectname&&flexygo.utils.areParents(e.masterIdentity.toLowerCase(),this.objectname.toLowerCase())&&this.refresh()}setPreset(presetName,presetText,presetIcon){this.presetId=presetName,this.presetText=presetText,this.presetIcon=presetIcon,this.removePreset=!1,this.initGrid(!1,!1);let ev={class:"module",type:"filtered",sender:$(this).closest("flx-module")[0],masterIdentity:this.presetId?this.presets[this.presetId].ObjectName:this.objectname,detailIdentity:this.presetId};this.savePresetValueHistory(),flexygo.events.trigger(ev,$(this))}changePresetText(){let me=$(this),bt=me.closest("flx-module").find('[data-type="presets"] span:first');bt&&bt.html(this.presetText+" "),me.closest("flx-module").find('[data-type="presets"] i:first').attr("class",this.presetIcon)}checkPresetDisplay(){void 0===this.presets&&$(this).closest("flx-module").find('[data-type="presets"]').remove()}setFilter(){this.presetId&&1==this.removePreset&&(this.removePreset=!1,this.presetId=null,this.presetText=null,this.presetIcon=null),this.initGrid(!1,!1)}initGrid(refreshButtons,refreshFilters,newPage){return new Promise((resolve,_)=>__awaiter(this,void 0,void 0,function*(){let objDef,me=$(this);if(this.page=newPage||0,this.mode=me.attr("mode"),this.mode&&""!==this.mode||(this.mode="list"),this.defaults)objDef="string"==typeof this.defaults?JSON.parse(this.defaults):this.defaults;else{let histObj=flexygo.history.get(me);if(void 0!==histObj&&histObj.defaults&&(objDef="string"==typeof histObj.defaults?JSON.parse(flexygo.utils.parser.replaceAll(histObj.defaults,"'",'"')):histObj.defaults),null==objDef){let wcMod=me.closest("flx-module")[0];wcMod&&(objDef=wcMod.objectdefaults)}}let params={ObjectName:me.attr("ObjectName"),ObjectWhere:me.attr("ObjectWhere"),Defaults:flexygo.utils.dataToArray(objDef),ModuleName:this.moduleName,PageName:flexygo.history.getPageName(me),Page:this.page,AdditionalWhere:this.additionalWhere,OrderInfo:this.orderObj,Mode:this.mode,SearchId:this.activeFilter,FilterValues:this.filterValues,TemplateId:this.templateId,ViewId:this.viewId,PageSize:this.pageSize,PresetId:this.presetId,GroupsInfo:this.groups?this.groups:{nogroup:null}};flexygo.ajax.post("~/api/List","GetList",params,response=>{if(response){if(this.collectionname=response.ObjectName,response.Template){let template=response.Template;this.fields=template.TableColumns,this.templateId=template.Id,this.templatetype=template.TemplateType,this.data=template.TableData,this.tHeader=template.Header,this.tBody=template.Body,this.tFooter=template.Footer,this.tEmpty=template.Empty,this.tScriptText=template.ScriptText,this.tCSSText=template.CSSText,this.tModuleClass=template.ModuleClass,this.objectname=template.ObjectName,this.childname=response.ChildObjectName,this.cryptedSql=template.TableSQL,this.removeKeys=template.RemoveKeys,this.pageSize=template.PageSize,this.pageSizeDefault=this.pageSizeDefault?this.pageSizeDefault:template.PageSize,this.groups=template.Groups,this.groupList=template.GroupList,this.viewId=template.DataViewName,this.userDefinedGroups=template.UserDefinedGroups}this.canInsert=response.CanInsert,this.canUpdate=response.CanUpdate,this.canDelete=response.CanDelete,this.processwhere=response.ObjectWhere,this.properties=response.Properties;for(let key in this.properties)this.properties[key].PlaceHolder||(this.properties[key].PlaceHolder=this.properties[key].Label);this.propArr=flexygo.utils.sortObject(this.properties,"PositionY","PositionX");let parentModule=me.closest("flx-module"),wcModule=parentModule[0];if(parentModule.length>0){let parentModuleClass=wcModule.moduleClass;if(wcModule.moduleInitClass&&""!=wcModule.moduleInitClass&&(parentModule.hasClass("fullscreen")?(parentModule.attr("class",wcModule.moduleInitClass),parentModule.addClass("fullscreen")):parentModule.attr("class",wcModule.moduleInitClass)),parentModuleClass&&""!=parentModuleClass&&parentModule.addClass(parentModuleClass),this.tModuleClass&&""!==this.tModuleClass&&parentModule.addClass(this.tModuleClass),parentModule&&wcModule)if(refreshButtons){let colWhere=this.processwhere;response.Buttons?(this.moduleButtons=response.Buttons,flexygo.selection.getArray(this.childname).length>0&&(colWhere=flexygo.selection.getFilterString(this.childname)),wcModule.setButtons(response.Buttons,response.ObjectName,colWhere)):wcModule.setButtons(null,response.ObjectName,colWhere),wcModule.setObjectDescrip(response.Title)}else{let colWhere=this.processwhere;response.Buttons?(this.moduleButtons=response.Buttons,flexygo.selection.getArray(this.childname).length>0&&(colWhere=flexygo.selection.getFilterString(this.childname)),wcModule.refreshButtons(response.Buttons,response.ObjectName,colWhere)):wcModule.setButtons(null,response.ObjectName,colWhere)}wcModule.ModuleViewers&&(this.currentViewers=response.CurrentViewers,flexygo.utils.refreshModuleViewersInfo(wcModule,this.currentViewers),flexygo.utils.checkObserverModule(wcModule,2e4),flexygo.events.off(wcModule,"push","notify"),flexygo.events.on(wcModule,"push","notify",function(e){if($(wcModule).closest("html").length>0)switch(e.masterIdentity){case"GetSetModuleViewers":(""==wcModule.moduleName?null:wcModule.moduleName)==(""==e.sender.ModuleName?null:e.sender.ModuleName)&&(""==wcModule.objectname?null:wcModule.objectname)==(""==e.sender.ObjectName?null:e.sender.ObjectName)&&(""==wcModule.objectwhere?null:wcModule.objectwhere)==(""==e.sender.ObjectWhere?null:e.sender.ObjectWhere)&&flexygo.utils.refreshModuleViewersInfo(wcModule,e.sender.ActiveUsers)}else flexygo.events.off(wcModule,"push","notify")})),flexygo.utils.isBlank(flexygo.debug)||(flexygo.events.off(wcModule,"push","updated"),flexygo.events.on(wcModule,"push","updated",function(e){if($(wcModule).closest("html").length>0)switch(e.masterIdentity){case"sysObjectTemplate":me[0].templateId==e.sender&&(flexygo.events.off(wcModule,"push","updated"),wcModule.refresh());break}else flexygo.events.off(wcModule,"push","updated")}))}response.RowButtons&&(this.buttons=response.RowButtons),response.TemplateList&&(this.templateList=response.TemplateList),response.ViewList&&(this.viewList=response.ViewList),response.Pager&&(this.pagerConfig=response.Pager),response.Presets&&(this.presets=response.Presets,this.presetId&&response.Presets[this.presetId]?(this.presetText=response.Presets[this.presetId].Title,this.presetIcon=response.Presets[this.presetId].IconName,this.savePresetValueHistory()):this.presetId&&null==response.Presets[this.presetId]&&(this.presetId=null,this.presetText=null,this.presetIcon=null)),this.hasSearcher=response.Searcher,this.TemplateToolbarCollection=response.TemplateToolbarCollection,this.render(),this.loadSearcher(),this.loadPager(),this.pagerConfig&&this.loadCount(),this.savedSearches=response.SavedSearches,this.searchSettings=response.SearchSettings,refreshFilters&&response.SearchSettings&&this.loadFilters(response.SearchSettings),resolve()}},err=>{flexygo.utils.modules.loadingErrorFunction(this.closest("flx-module"),err),resolve()},()=>{this.stopLoading()},()=>{this.startLoading()})}))}startLoading(){$(this).parents("flx-module").length>0&&$(this).parents("flx-module")[0].startLoading()}stopLoading(){$(this).parents("flx-module").length>0&&$(this).parents("flx-module")[0].stopLoading()}startInfoTemplate(){return`<div class="start_info txt-muted">\n                        <span>${flexygo.localization.translate("flxeditgrid.startinfo")}</span>\n                        <i class="flx-icon icon-settings"/>\n                    </div>`}setStartInfoEvents(){try{let me=$(this);me.find(".start_info i").off("click.editgridconf").on("click.editgridconf",function(){me[0].configure()})}catch(ex){console.log(ex)}}hasProperties(){let foundProperties=[];for(let i=0;i<this.propArr.length;i++){let prop=this.propArr[i];prop.WebComponent&&!prop.Hide&&foundProperties.push(prop)}return foundProperties.length>0}setRowEvents(){$(this).find("tbody tr td:visible [property], tfoot tr td:visible [property]").each((i,el)=>{this.setRowEvent(el)})}setRowEvent(el){$(el).off("change.dirty").on("change.dirty",e=>{this.isFocused&&(this.isRowDirty=!0)}),$(el).off("focusin.dirty").on("focusin.dirty",e=>{this.currentRow=$(e.currentTarget).closest("tr"),this.prevRow&&!this.currentRow.is(this.prevRow)&&this.isRowDirty&&(this.prevRow.find(".saveRowButton").click(),this.isRowDirty=!1)}),$(el).off("focusout.dirty").on("focusout.dirty",e=>{this.prevRow=$(e.currentTarget).closest("tr"),null==$(e.currentTarget).closest("td").nextAll(":visible")[0]&&this.isRowDirty&&$(e.currentTarget).closest("tr").closest("tfoot").length>0&&($(e.currentTarget).closest("tr").find(".saveRowButton").click(),this.isRowDirty=!1)})}render(){let me=$(this),rendered="",pageDef=null,defString=flexygo.history.getDefaults(this.objectname,me),wcMod=me.closest("flx-module")[0],def=null,isPageDef=!1;if(wcMod&&(def=wcMod.objectdefaults,pageDef=flexygo.history.get($(wcMod))?flexygo.history.get($(wcMod)).defaults:""),!def&&defString&&""!=defString&&(def=JSON.parse(flexygo.utils.parser.replaceAll(defString,"'",'"'))),!def&&pageDef&&""!=pageDef&&(isPageDef=!0,def=JSON.parse(flexygo.utils.parser.replaceAll(pageDef,"'",'"'))),def&&!isPageDef&&("string"==typeof def&&(def=JSON.parse(flexygo.utils.parser.replaceAll(def,"'",'"'))),pageDef&&""!=pageDef?"string"==typeof pageDef&&(pageDef=JSON.parse(flexygo.utils.parser.replaceAll(pageDef,"'",'"'))):pageDef=[],Object.assign(def,pageDef)),this.checkPresetDisplay(),this.presetId&&this.changePresetText(),"edit"===this.mode&&!this.hasProperties())return rendered+=this.startInfoTemplate(),me.html(rendered),this.setStartInfoEvents(),void wcMod.moduleLoaded(this);if(this.data.length>0||"edit"===this.mode){if(this.tHeader&&""!==this.tHeader){let render=flexygo.utils.parser.recursiveCompile(this.data[0],this.tHeader,this);rendered+=render=flexygo.utils.parser.recursiveCompile(def,render,this)}if(this.tBody&&""!==this.tBody){let lastItem=null;if(this.data.length>0){for(let i=0;i<this.data.length;i++){let notExclude=!1;if(this.filter&&""!==this.filter){for(let key in this.data[i])if(-1!==String(this.data[i][key]).toLocaleLowerCase().indexOf(this.filter.toLocaleLowerCase())){notExclude=!0;break}}else notExclude=!0;if(notExclude){if(lastItem||(rendered+=flexygo.utils.parser.paintGroupHeader(this.data[i],this.groups,this),rendered=flexygo.utils.parser.recursiveCompile(def,rendered,this)),rendered+=flexygo.utils.parser.controlGroup(lastItem,this.data[i],this.groups,this),"edit"===this.mode){let render=flexygo.utils.parser.compile(this.data[i],this.tBody,this);rendered+=render=flexygo.utils.parser.compile(def,render,this)}else{let render=flexygo.utils.parser.recursiveCompile(this.data[i],this.tBody,this);rendered+=render=flexygo.utils.parser.recursiveCompile(def,render,this)}lastItem=this.data[i]}}lastItem&&(rendered+=flexygo.utils.parser.paintGroupFooter(this.data[this.data.length-1],this.groups,this),rendered=flexygo.utils.parser.recursiveCompile(def,rendered,this))}}if(this.tFooter&&""!==this.tFooter){let render=flexygo.utils.parser.recursiveCompile(this.data[0],this.tFooter,this);rendered+=render=flexygo.utils.parser.recursiveCompile(def,render,this)}}else this.tEmpty?rendered+=flexygo.utils.parser.recursiveCompile(def,this.tEmpty,this):rendered+='<div class="box-info"><i class="flx-icon icon-information-2 icon-lg icon-margin-right"></i><span><strong>Info!</strong> '+flexygo.localization.translate("flxlist.noentriesfound")+"</span></div>";if(this.tCSSText&&""!==this.tCSSText){let render=flexygo.utils.parser.recursiveCompile(this.data[0],this.tCSSText,this);rendered+="<style>"+(render=flexygo.utils.parser.recursiveCompile(def,render,this))+"</style>"}if(this.tScriptText&&""!==this.tScriptText){let render=flexygo.utils.parser.recursiveCompile(this.data[0],this.tScriptText,this);rendered+="<script>"+(render=flexygo.utils.parser.recursiveCompile(def,render,this))+"<\/script>"}if(me.html(rendered),me.find("[data-sort]").on("click",e=>{let field=$(e.currentTarget).data("sort");this.sort(e.currentTarget,field)}),this.orderObj)for(var i=0;i<this.orderObj.length;i++)this.orderObj[i].Asc?me.find('[data-sort="'+this.orderObj[i].PropertyName.toLowerCase()+'"]').addClass("sortAsc"):me.find('[data-sort="'+this.orderObj[i].PropertyName.toLowerCase()+'"]').addClass("sortDsc");let parentModule=me.closest("flx-module"),wcModule=parentModule[0];if(parentModule&&wcModule&&wcModule.moduleLoaded(this),this.childname){let bagField=new flexygo.obj.Entity(this.childname).getConfig().UniqueIdentifier,buttons=me.find("button.bagButton");if(bagField){if(this.data.length>0)for(let i=0;i<buttons.length;i++){let bagValue=this.data[i]._guid;if(flexygo.utils.isBlank(bagValue)&&(bagValue=this.data[i][bagField],flexygo.utils.isBlank(bagValue))){let textError=flexygo.localization.translate("flxmodule.nofieldBagError").replace("{0}",bagField);flexygo.msg.warning(textError),buttons.hide();break}flexygo.selection.contains(this.childname,bagValue)&&($(buttons[i]).addClass("active"),$(buttons[i]).closest("tr").addClass("selected"))}let mod=me.closest("flx-module"),selectionLength=flexygo.selection.getArray(this.childname).length;selectionLength>0?(mod[0].activeBagButtons(mod),mod.find('.moduleToolbar [data-type="objectmenu"] .badge').html(selectionLength.toString()),mod.find('.moduleToolbar [data-type="objectmenu"] .caret').hide()):(mod.find('.moduleToolbar [data-type="objectmenu"] .badge').remove(),mod.find('.moduleToolbar [data-type="objectmenu"] .caret').show())}else buttons.hide()}if("edit"==this.mode&&(this.canUpdate||this.canInsert)){this.propArr.length>1&&this.setRowEvents();let jquerySelector="tbody tr";this.canInsert&&(jquerySelector+=", tfoot tr"),me.find(jquerySelector).each((i,e)=>{$(e).attr("id",flexygo.utils.uniqueId()).addClass("form"),this.canUpdate&&($(e).areYouSure(),$(e).validate({ignore:"",unhighlight:(element,errorClass,validClass)=>{$(element).parent().addClass("has-success").removeClass("has-error")},highlight:(element,errorClass,validClass)=>{$(element).parent().removeClass("has-success").addClass("has-error")},errorPlacement:(error,element)=>{$(element).parent().length>0&&("email"===$(element)[0].getAttribute("type")?$(element).parent().closest("flx-text").length>0&&1===$(element).parent()[0].closest("flx-text").children.length&&error.insertAfter($(element).parent()[0]):error.insertAfter($(element).parent()[0]))},errorClass:"txt-danger"}))}),this.processLoadDependencies()}let tbl=me.find("table.flxRszTbl");if(1==tbl.length){-1!=flexygo.history.get(me).targetid.indexOf("slide")?(flexygo.events.off(this,"page","slideComplete"),flexygo.events.on(this,"page","slideComplete",()=>{this.setColResizable(tbl)})):this.setColResizable(tbl)}}setColResizable(tbl){tbl.colResizable({resizeMode:"overflow",disabledColumns:[0],liveDrag:1,onResize:ev=>{this._resizeGridProps()},onDrag:ev=>{let tbl=$(ev.currentTarget),cols=tbl.find("thead > tr > th");for(var i=0;i<cols.length;i++)tbl.find("tbody > tr > td:nth-child("+(i+1)+")").css("max-width",$(cols[i]).width()+"px")}})}processLoadDependencies(listRows){let me=$(this);if(0==$("body").find(this).length)return;let rows=listRows||me.find("tr:not(.rowHeader)"),paramsArray=[];for(let j=0;j<rows.length;j++){let props=$(rows[j]).find("[property]"),Properties=null;if(props.length>0){Properties=[];for(let i=0;i<props.length;i++){let prop=$(props[i])[0];Properties.push({Key:prop.property,Value:prop.getValue()})}}let params={RowId:$(rows[j]).attr("id"),ObjectName:this.objectname,IsNew:$(rows[j]).is(".rowInsert"),Properties};paramsArray.push(params)}paramsArray.length>0&&flexygo.ajax.post("~/api/Edit","ProcessAllListDependencies",paramsArray,response=>{if(response)for(let j=0;j<Object.keys(response).length;j++){let rowKey=Object.keys(response)[j],rowItem=response[rowKey];for(let i=0;i<rowItem.length;i++){let itm=rowItem[i],prop=me.find("#"+rowKey+' [property="'+itm.PropertyName+'"]');prop.length>0&&this.refreshProperty(itm,prop,!0)}}})}refreshProperty(itm,prop,loadDependency){let cntl=prop[0];if(itm.changeCustomProperty){this.properties[itm.PropertyName]=itm.newCustomProperty;let element=$(`<${itm.newCustomProperty.WebComponent}/>`),EType=element.attr("type"),attrs=prop[0].attributes;$.each(attrs,function(){element.attr(this.name,this.value)}),element.attr("type",EType);let cntl=prop[0],IObjectName=cntl.options.ObjectName,IName=cntl.options.Name,IPositionX=cntl.options.PositionX,IPositionY=cntl.options.PositionY;cntl.options=itm.newCustomProperty,cntl.options.ObjectName=IObjectName,cntl.options.Name=IName,cntl.options.PositionX=IPositionX,cntl.options.PositionY=IPositionY,cntl.options.DropDownValues=itm.newSqlItems,prop.replaceWith(element),prop=element,this.setRowEvent(element[0])}if(itm.JSCode){new Function("ObjectName","itm","prop",itm.JSCode).call(this,this.objectname,itm,prop[0])}if(itm.changeSQL&&cntl.changeSQLData&&(loadDependency||(cntl.setValue(null),itm.cascadeDependencies&&cntl.triggerDependencies()),cntl.changeSQLData(itm.newSQL,itm.newSqlItems)),itm.changeClass&&prop.removeAttr("class").addClass(itm.newClass),itm.changeEnabled&&(itm.newEnabled?prop.removeAttr("disabled"):prop.attr("disabled",1)),itm.changeRequired&&(itm.newRequired?prop.attr("required",1):prop.removeAttr("required")),itm.changeValue&&(cntl.setValue(itm.newValue),itm.cascadeDependencies&&cntl.triggerDependencies()),itm.changeVisibility)if(itm.newVisibility){prop.removeClass("hideControl");let ctlClass=prop.attr("control-class");void 0!==ctlClass&&(prop.attr("control-class",ctlClass.replace("hideControl","")),prop.find(".hideControl").removeClass("hideControl"))}else prop.addClass("hideControl")}parseEditString(str,ctx,property){let props,obj=new Object;props=$(property).closest("tr").find("[property]");for(let i=0;i<props.length;i++){let prop=$(props[i])[0];obj[prop.property]=prop.getValue()}return flexygo.utils.parser.compile(obj,str,ctx.mode)}onPropertyChanged(e){let wc;wc=$(e.sender);let me=$(this),props=wc.closest("tr").find("[property]"),propertyName=e.masterIdentity;if(me.find(wc).length>0&&props.length>0){let Properties=[];for(let i=0;i<props.length;i++){let prop=$(props[i])[0];prop.getValue&&Properties.push({Key:prop.property,Value:prop.getValue()})}let elm=me.find('[property="'+propertyName+'"]');"flx-radio"==elm[0].tagName.toLowerCase()?void 0!==elm.find('[name="'+propertyName+'"]:first').attr("data-msg-sqlvalidator")&&this.validateSQLProperty(propertyName,Properties):void 0!==elm.find('[name="'+propertyName+'"].form-control').attr("data-msg-sqlvalidator")&&this.validateSQLProperty(propertyName,Properties);let params={ObjectName:this.objectname,ProcessName:null,ReportName:null,PropertyName:propertyName,Properties};this.loadingDependencies+=1,flexygo.ajax.post("~/api/Edit","ProcessDependencies",params,response=>{if(response)for(let i=0;i<response.length;i++){let itm=response[i],prop=props.filter('[property="'+itm.PropertyName+'"]');prop.length>0&&this.refreshProperty(itm,prop,!1)}this.loadingDependencies-=1,this.pendingSaveButton&&this.loadingDependencies<=0&&(this.pendingSaveButton.click(),this.removeLock(),this.pendingSaveButton=null)})}}validateSQLProperty(propertyName,Properties){let SQLValidatorparams={ObjectName:this.objectname,ProcessName:null,ReportName:null,PropertyName:propertyName,Properties};flexygo.ajax.syncPost("~/api/Edit","ValidateProperty",SQLValidatorparams,response=>{let prop,element=$(this).find('[property="'+propertyName+'"]');prop="flx-radio"==element[0].tagName.toLowerCase()?element.find('[name="'+SQLValidatorparams.PropertyName+'"]:first'):element.find('[name="'+SQLValidatorparams.PropertyName+'"]'),response?prop.attr("sqlvalidator",1):prop.attr("sqlvalidator",0),"time"!=element.attr("type")&&"date"!=element.attr("type")&&"datetime-local"!=element.attr("type")&&"flx-tag"!=element[0].localName||prop.valid(),"text"!=element.attr("type")&&"flx-tag"!=element[0].localName||$(prop).valid()})}addLock(){$(this).append('<div style="position:absolute;z-index:60;top:0px;bottom:0px;left:0px;right:0px;background-color:rgba(255,255,255,0.5);" class="lockDiv">&nbsp;</div>'),$(this).closest(".cntBody").css("position","relative")}removeLock(){$(this).closest(".cntBody").css("position",""),$(this).find(".lockDiv").remove()}_resizeGridProps(){let me=$(this),items=me.find("thead > tr > th[data-sort]"),myProps=new Object;for(let i=0;i<items.length;i++)myProps[$(items[i]).attr("data-sort")]=$(items[i]).width();let ident=flexygo.history.get(me).pagename+"-"+this.moduleName,gridSizes=flexygo.storage.local.get("gridSizes");null==gridSizes&&(gridSizes=new Object),gridSizes[ident]=myProps,flexygo.storage.local.add("gridSizes",gridSizes)}configure(){let where;"htmlmodule"==this.templatetype?(flexygo.msg.warning(flexygo.localization.translate("flxlist.warning")),flexygo.nav.openPage("edit","sysModule","ModuleName='"+this.moduleName+"'",null,"popup",!0)):(where=""==this.templateId||null==this.templateId?"":"TemplateId='"+this.templateId+"'","generic"==this.templateId?"edit"==this.mode?flexygo.nav.openPageName("syspage-generic-editgridsettings","sysObject","ObjectName='"+this.objectname+"'","null","popup",!1,$(this)):flexygo.nav.openPageName("syspage-generic-gridsettings","sysObjectView","ObjectName='"+this.childname+"' and ViewName='"+this.viewId+"'","null","popup",!1,$(this)):flexygo.nav.openPage("edit","sysObjectTemplate",where,null,"popup",!0))}sortByObj(orderInfo,groupsInfo){this.sortColumn=null,this.orderObj=orderInfo,this.groups=groupsInfo,this.saveDefaultOrder(),this.saveDefaultGroup(),this.refresh()}sort(columnItem,property,ascMode){ascMode?this.sortAsc=ascMode:this.sortColumn==property?this.sortAsc=!this.sortAsc:this.sortAsc=!0,this.sortColumn=property;let orderProp={ObjectName:this.objectname,PropertyName:property,Asc:this.sortAsc};this.orderObj=[orderProp],this.saveDefaultOrder(),this.refresh()}loadPager(){let me=$(this);this.pagerConfig&&(flexygo.utils.isSizeMobile()?this.pagesButtons=5:this.pagesButtons=this.pagerConfig.NumButtons);let template='<span class="firstPage"></span><span class="prevPage"></span><span class="pageButtons"></span><span class="nextPage"></span><span class="lastPage"></span><span class="pageInfo"><span class="activePage"></span>/<span class="numPages"></span>(<span class="numRows"></span>)</span>';if(this.pagerConfig&&this.pagerConfig.Template&&""!=this.pagerConfig.Template){template=this.pagerConfig.Template;let pagerInfo=flexygo.localization.translate("flxlist.pagerInfo").split("-");template.match(/class="[^"]*?\bpageInfo\b[^"]*?"/)?template=template.replace("{page}",pagerInfo[0]).replace("{of}",pagerInfo[1]).replace("{total}",pagerInfo[2]):template+=`<span class="hidden pageInfo"><span class="titlePage">${pagerInfo[0]} </span><span class="activePage"></span><span class="titleOf"> ${pagerInfo[1]} </span><span class="numPages"></span> <b class="numTotal"> ${pagerInfo[2]}: </b/> <span class="numRows"></span></span>`}if(void 0===this.pager||null==this.pager){let pagerExist=me.closest("flx-module").find(".pager:first");if(pagerExist.length>0)this.pager=pagerExist;else if(this.pager=$('<div class="pager" />'),this.pagerConfig){let pagerLocation;switch(this.pagerConfig.Position.toLowerCase()){case"moduleheader":pagerLocation=me.parents("flx-module").find(".cntButtons");break;case"listheader":pagerLocation=me.parents("flx-module").find(".cntBodyHeader");break;case"listfooter":pagerLocation=me.parents("flx-module").find(".cntBodyFooter"),this.pager.addClass("onlyPageInfo");break;case"listboth":pagerLocation=me.parents("flx-module").find(".cntBodyHeader, .cntBodyFooter")}this.pager=this.pager.appendTo(pagerLocation)}}if(this.pager.empty(),this.pager.append(template),this.pager.find(".activePage").html(String(this.page+1)),this.pager.find(".numPages").html(String(this.maxPages)),this.pager.find(".numRows").html(String(this.maxRows)),this.pageSizeDefault&&0==this.pager.find('.pagination option[value="'+String(this.pageSizeDefault)+'"]').length){this.pager.find(".pagination").append('<option value="'+String(this.pageSizeDefault)+'">'+String(this.pageSizeDefault)+"</option>");let options=$(this.pager.find(".pagination")[0]).find("option").sort(function(a,b){return parseInt(a.value)>parseInt(b.value)?1:-1});this.pager.find(".pagination").html(options)}this.pager.find(".pagination").val(String(this.pageSize)),this.pager.find(".pagination").on("change",e=>{let currentCombo=e.currentTarget;this.pageSize=parseInt($(currentCombo).val()),this.pager.find(".pagination").not($(currentCombo)).val(String(this.pageSize)),this.loadCount(),this.page=0,this.loadPage(this.page)}),this.pager.find(".prevPage").on("click",()=>{this.previousPage()}),this.pager.find(".nextPage").on("click",()=>{this.nextPage()}),this.pager.find(".firstPage").on("click",()=>{this.firstPage()}),this.pager.find(".lastPage").on("click",()=>{this.lastPage()}),this.pager.attr("title",this.pager.find(".pageInfo").first().text()),this.refreshPager()}refreshPager(){this.pager.find(".activePage").html(String(this.page+1)),this.pager.find(".numRows").html(String(this.maxRows)),this.pager.find(".numPages").html(String(this.maxPages));let iniBtn=Number((this.page-this.pagesButtons/2).toFixed());iniBtn<0||this.maxPages<=this.pagesButtons?iniBtn=0:iniBtn>this.maxPages-this.pagesButtons&&(iniBtn=this.maxPages-this.pagesButtons+1);let btns=this.pager.find(".pageButtons");btns.html("");for(let i=0;i<this.pagesButtons&&iniBtn+i<this.maxPages;i++)this.addButtons(btns,iniBtn+i);0==this.page?(this.pager.find(".prevPage").hide(),this.pager.find(".firstPage").hide()):(this.pager.find(".prevPage").show(),this.pager.find(".firstPage").show()),this.data.length<this.pageSize||this.maxPages==this.page+1?(this.pager.find(".nextPage").hide(),this.pager.find(".lastPage").hide()):(this.pager.find(".nextPage").show(),this.pager.find(".lastPage").show()),0==this.data.length?this.pager.hide():this.pager.show(),this.pager.attr("title",this.pager.find(".pageInfo").first().text())}addButtons(btns,pageNum){let btn=$('<span class="pBtn">'+(pageNum+1)+"</span>");pageNum==this.page&&btn.addClass("active"),btn.on("click",()=>{this.loadPage(pageNum)}),btns.append(btn)}nextPage(){this.loadPage(this.page+1)}previousPage(){this.loadPage(this.page-1)}firstPage(){this.loadPage(0)}lastPage(){this.loadPage(this.maxPages-1)}loadPage(newPage){let selector,params;this.page=newPage,params={ObjectName:this.objectname,CryptedSql:this.cryptedSql,Page:this.page,PageSize:this.pageSize,RemoveKeys:this.removeKeys,Filter:this.filters,ModuleName:this.moduleName,PageName:flexygo.history.getPageName($(this))},flexygo.ajax.post("~/api/List","GetPageList",params,response=>{response&&(this.data=response,this.render(),this.refreshPager(),selector=$(this).closest("div.ui-dialog").length?"main.pageContainer":"div#mainContent")},null,()=>{this.stopLoading()},()=>{this.startLoading()}),this.savePageValueHistory()}savePageValueHistory(){let me=$(this),history=flexygo.history.get(me),page=this.page;history||(history=new flexygo.nav.FlexygoHistory),history.filtersValues||(history.filtersValues=new flexygo.nav.ModuleFilterHistory),history.filtersValues[this.moduleName]||(history.filtersValues[this.moduleName]=new flexygo.nav.FilterHistoryValue),history.filtersValues[this.moduleName].activePage=page,flexygo.history.replace(history,me,!1)}savePresetValueHistory(){let me=$(this),history=flexygo.history.get(me);history||(history=new flexygo.nav.FlexygoHistory),history.presetsValues||(history.presetsValues=new flexygo.nav.ModulePresetHistory),history.presetsValues[this.moduleName]||(history.presetsValues[this.moduleName]=new flexygo.nav.PresetHistoryValue),history.presetsValues[this.moduleName].presetId=this.presetId,history.presetsValues[this.moduleName].presetText=this.presetText,history.presetsValues[this.moduleName].presetIcon=this.presetIcon,flexygo.history.replace(history,me,!1)}loadSearcher(){let me=$(this);if(!0===this.hasSearcher){let template='<flx-genericsearch gridid="'+this.moduleName+'"  class="moduleSearcher"></flx-genericsearch>';this.searcher=$('<div class="listSearcher" />'),me.parents("flx-module").find(".cntBodyHeader").append(this.searcher),this.searcher.empty(),this.searcher.append(template)}}loadFilters(settings){let me=$(this);settings&&(this.searchSettings=settings);let module=me.closest("flx-module"),pane=module.find(".cntBodyHeader .filterPanel");0==pane.length&&(pane=$('<div class="filterPanel" />'),module.find(".cntBodyHeader").append(pane));let flt=$("<flx-filter></flx-filter>");pane.html(flt);let fClt=flt[0];fClt&&(fClt.settings=settings,fClt.key=this.collectionname+"-"+this.moduleName,fClt.grid=this,fClt.init())}paintHeader(row){let me=$(this),thead=$("<thead />"),tr=$('<tr class="rowHeader"/>'),ident=flexygo.history.get(me).pagename+"-"+this.moduleName,gridSizes=flexygo.storage.local.get("gridSizes");if(this.buttons&&Object.keys(this.buttons).length>2?tr.append('<th style="width:200px" />'):tr.append('<th style="width:75px" />'),"edit"==this.mode){for(let i=0;i<this.propArr.length;i++)if(this.propArr[i].WebComponent){let key=this.propArr[i].Name.toLowerCase(),width=this.propArr[i].Width;gridSizes&&gridSizes[ident]&&gridSizes[ident][key]&&(width=gridSizes[ident][key]);let sortname=key;"flx-combo"!=this.propArr[i].WebComponent.toLowerCase()&&"flx-dbcombo"!=this.propArr[i].WebComponent.toLowerCase()||(sortname+="_flxtext");let td=$("<th />").html(this.propArr[i].Label).attr("data-sort",sortname).css("width",width+"px");if(""!=this.propArr[i].HelpId){let helpIcon=$('<span class="help-icon"><i/><flx-tooltip mode="popover" container="body" helpId="'+this.propArr[i].HelpId+'"></flx-tooltip></span>');td.append(helpIcon)}tr.append(td),this.propArr[i].Hide&&td.hide()}}else for(let key in row)if("_objectname"!=key&&"_objectwhere"!=key&&"_guid"!=key&&"_ot"!=key){let td=$("<th />").html(key).attr("data-sort",key);gridSizes&&gridSizes[ident]&&gridSizes[ident][key]&&td.css("width",gridSizes[ident][key]+"px"),tr.append(td)}return thead.html(tr),'<table class="flxRszTbl" ><thead>'+thead.html()+"</thead><tbody>"}paintFooter(row){let me=$(this),tfoot=$("<tfoot />");if("edit"==this.mode&&this.canInsert){let tr=$('<tr class="rowInsert"/>'),td=$("<td/>"),defString=flexygo.history.getDefaults(this.objectname,me),btnSave={ButtonId:"-111",Disabled:!1,HideText:!0,IconClass:"flx-icon icon-save-2",Order:1,PositionId:"Toolbar",Text:"Save",ToolTip:"Save",TypeId:"SaveRow"},btnClear={ButtonId:"-112",Disabled:!1,HideText:!0,IconClass:"flx-icon  icon-clean",Order:2,PositionId:"Toolbar",Text:"Clear",ToolTip:"Clear",TypeId:"ClearRow"},btnGroup=$('<div class="btn-group" />');btnGroup.append(this._getButton(btnSave,this.childname,"",defString)),btnGroup.append(this._getButton(btnClear,this.childname,"",defString)),td.html(btnGroup),tr.append(td);let wcModule=me.closest("flx-module")[0],def=null;wcModule&&(def=wcModule.objectdefaults),!def&&defString&&""!=defString&&(def=JSON.parse(flexygo.utils.parser.replaceAll(defString,"'",'"')));var ent=new flexygo.obj.Entity(this.objectname);ent.read();for(let i=0;i<this.propArr.length;i++)if(this.propArr[i].WebComponent){td=$("<td/>");let input=$("<"+this.propArr[i].WebComponent+' property="'+this.propArr[i].Name+'" tab="'+flexygo.utils.uniqueTabIndex()+'" />');if(ent&&void 0!==ent.data[this.propArr[i].Name]){let val="datetime"!==this.propArr[i].ControlType?ent.data[this.propArr[i].Name].Value:moment.utc(ent.data[this.propArr[i].Name].Value).format("YYYY-MM-DD[T]HH:mm");input.attr("Value",val),td.attr("def-value",val)}if(def&&void 0!==def[this.propArr[i].Name]&&!this.properties[this.propArr[i].Name].PersistDefaultValue){let defVal=def[this.propArr[i].Name];null!=defVal&&-1!=defVal.toString().indexOf("/Date(")&&(defVal=moment.utc(defVal).toDate()),input.attr("Value",defVal),td.attr("def-value",defVal)}td.html(input),tr.append(td),this.propArr[i].Hide&&td.hide()}tfoot.html(tr)}return"</tbody><tfoot>"+tfoot.html()+"</tfoot></table>"}paintBody(row){let me=$(this);me.closest(".cntBody").addClass("nopadding");let tbody=$("<tbody />"),tr=$("<tr/>"),defString=flexygo.history.getDefaults(row._objectname,me),ident=flexygo.history.get(me).pagename+"-"+this.moduleName,gridSizes=flexygo.storage.local.get("gridSizes"),regExp=/[&<>"'`=\/]/im;if("edit"==this.mode&&this.canUpdate&&(tr.attr("objectname",row._objectname),tr.attr("objectwhere",row._objectwhere),this.buttons||(this.buttons={}),this.buttons.editButton={ButtonId:"-111",Disabled:!1,HideText:!0,IconClass:"flx-icon icon-save-2",Order:-1,PositionId:"Toolbar",Text:"Save",ToolTip:"Save",TypeId:"SaveRow"}),this.buttons&&row._objectname&&row._objectwhere){let td=$("<td/>"),arrBtn=flexygo.utils.sortObject(this.buttons,"PositionId","Order");if(arrBtn.length>0){let btnGroup=$('<div class="btn-group" />');for(let i=0;i<arrBtn.length;i++)btnGroup.append(this._getButton(arrBtn[i],row._objectname,row._objectwhere,defString));td.html(btnGroup)}tr.append(td)}else tr.append("<td/>");if("edit"==this.mode){for(let i=0;i<this.propArr.length;i++)if(this.propArr[i].WebComponent){let td=$("<td/>"),key=this.propArr[i].Name.toLowerCase(),val=this.getValue(row[key]);null!=val&&"null"!=val||(val="");let input=$("<"+this.propArr[i].WebComponent+' property="'+this.propArr[i].Name+'" tab="'+flexygo.utils.uniqueTabIndex()+'"  />');this.canUpdate||input.attr("disabled","true"),this.propArr[i].WebComponent.startsWith("flx-check")||"flx-switch"==this.propArr[i].WebComponent?1==row[key]||"true"==row[key]?(input.attr("checked","checked"),input.attr("value","true")):0==row[key]||"false"==row[key]?input.attr("value","false"):input.attr("value",""):("date"===input.attr("type")&&""!=val?val=moment.utc(row[key]).format("YYYY-MM-DD"):"datetime-local"===input.attr("type")&&""!=val?val=moment.utc(row[key]).format("YYYY-MM-DD[T]HH:mm"):"time"===input.attr("type")&&""!=val&&(val=moment.utc(row[key],"HH:mm").isValid()?moment.utc(row[key],"HH:mm").format("HH:mm"):moment.utc(row[key]).format("HH:mm")),input.attr("Value",val)),row[key+"_flxtext"]?input.attr("text",row[key+"_flxtext"]):row["flxpath|"+this.objectname.toLowerCase()+"|"+key]&&input.attr("text",row["flxpath|"+this.objectname.toLowerCase()+"|"+key]),td.html(input),tr.append(td),this.propArr[i].Hide&&td.hide()}}else for(let key in row)if("_objectname"!=key&&"_objectwhere"!=key&&"_guid"!=key&&"_ot"!=key){let td=$("<td/>"),val=this.getValue(row[key]);if(gridSizes&&gridSizes[ident]&&gridSizes[ident][key]&&td.css("max-width",gridSizes[ident][key]+"px"),"number"==typeof val&&(val="es-es"==flexygo.profiles.culture.toLowerCase()?val.toLocaleString("ca-ES"):val.toLocaleString(flexygo.profiles.culture),td.css("text-align","right")),"string"==typeof val&&null!==val&&regExp.test(val)&&"boolean"!=typeof row[key]&&(val=flexygo.string.escapeHTML(val)),"string"==typeof val&&val.includes("|")){let values=val.split("|");val="",values.forEach(el=>{val+=`<div class="tag label label-info margin-right-xs">${el}</div>`})}let title=$("<b/>").html(key);td.html(title).append(val),tr.append(td)}return tbody.html(tr),tbody.html()}flxTranslate(str){return flexygo.localization.translate(str)}_getButton(btn,objectname,objectwhere,objectdefaults){return flexygo.ui.wc.FlxModuleElement.prototype.getButton(btn,objectname,objectwhere,objectdefaults)}_getTemplateButton(json,typeId,IconClass,Text,TargetId,buttonId){let me=$(this),defString=flexygo.history.getDefaults(json._objectname,me);return json._objectdefaults=defString,flexygo.utils.isBlank(buttonId)?flexygo.environment._getTemplateButton(json,typeId,IconClass,Text,TargetId):flexygo.environment._getTemplateButton(json,typeId,IconClass,Text,TargetId,buttonId)}_setButtonVisibilityByLicense(buttonId,modulelicense,context,inTemplate){return flexygo.environment._setButtonVisibilityByLicense(buttonId,modulelicense,context,inTemplate)}getValue(value){let type=typeof value;switch(type=type.toLowerCase(),value&&-1!=value.toString().indexOf("/Date(")||value&&"function"==typeof value.getMonth?type="00:00"!=moment(value).utc().format("HH:mm")?"datetime":"date":"object"==type&&null!=value&&value.Hours&&(type="time"),type){case"undefined":return"";case"boolean":return value?'<i class="flx-icon icon-check-2"></i>':'<i class="flx-icon icon-non-check-2 "></i>';case"date":return moment(value).utc().format("L");case"datetime":return moment(value).utc().format("L")+" "+moment(value).utc().format("LTS");case"time":return moment(value).utc().format("LTS");default:return value}}loadCount(){let params={ObjectName:this.objectname,CryptedSql:this.cryptedSql,Filter:this.filters,ModuleName:this.moduleName,PageName:flexygo.history.getPageName($(this))};flexygo.ajax.post("~/api/List","GetCount",params,response=>{if(response){this.maxRows=response;let numPages=0;0==this.pageSize?numPages=this.maxRows:(numPages=Math.floor(this.maxRows/this.pageSize),this.maxRows%this.pageSize>0&&numPages++),this.maxPages=numPages,this.refreshPager()}else{this.maxRows=0;let numPages=0;this.maxPages=numPages,this.page=0,this.refreshPager()}})}getModuleFullId(){let page=flexygo.history.get($(this));return page?(page.objectname||(page.objectname=""),page.pagename+"|"+page.objectname+"|"+this.moduleName):" | |"+this.moduleName}setFocus(me,listItem,e){this.isFocused=!0,!me.find("table").is(e.target)&&me.find("table").length>0&&!$.contains(me.find("table")[0],e.target)?(listItem.isRowDirty&&listItem.prevRow&&(listItem.isRowDirty=!1,listItem.isFocused=!1,listItem.prevRow.find(".saveRowButton").click()),listItem.isFocused=!1):listItem.isFocused=!0}}function validateRowSQLProperty(propertyName,Properties,objectName,row){let SQLValidatorparams={ObjectName:objectName,ProcessName:null,ReportName:null,PropertyName:propertyName,Properties};flexygo.ajax.syncPost("~/api/Edit","ValidateProperty",SQLValidatorparams,response=>{let prop,element=row.find('[property="'+propertyName+'"]');prop="flx-radio"==element[0].tagName.toLowerCase()?element.find('[name="'+SQLValidatorparams.PropertyName+'"]:first'):element.find('[name="'+SQLValidatorparams.PropertyName+'"]'),response?prop.attr("sqlvalidator",1):prop.attr("sqlvalidator",0),"time"!=element.attr("type")&&"date"!=element.attr("type")&&"datetime-local"!=element.attr("type")&&"flx-tag"!=element[0].localName||prop.valid()||$(prop).focus().select(),"text"!=element.attr("type")&&"flx-tag"!=element[0].localName&&"flx-barcode"!=element[0].localName||$(prop).valid()||$(prop).focus().select()})}FlxListElement.observedAttributes=["modulename","objectname","objectwhere"],wc_1.FlxListElement=FlxListElement,wc_1.clearRow=function(list,btn){let input,listEl=list[0],cells=list.find("tfoot > tr > td"),focus=!1;var obj=new flexygo.obj.Entity(listEl.objectname);obj.read(),cells.each((i,e)=>{let cell=$(e),ctl=cell.find("[property]")[0];if(ctl){if("FLX-IMAGE"!==ctl.nodeName&&"FLX-TEXTAREA"!==ctl.nodeName||$(ctl).val(""),ctl.init(),!flexygo.utils.isBlank(cell.attr("def-value"))||!flexygo.utils.isBlank(cell.attr("def-text"))){let newValue,propName=cell.children().attr("property"),def=listEl.closest("flx-module").objectdefaults;if(def&&void 0!==def[propName]&&!listEl.properties[propName].PersistDefaultValue?null!=(newValue=def[propName])&&-1!=newValue.toString().indexOf("/Date(")&&(newValue=moment.utc(newValue).toDate()):newValue=listEl.properties[propName]&&listEl.properties[propName].IgnoreDBDefaultValue?cell.attr("def-value"):(newValue=obj.data[propName]?obj.data[propName].Value:null)||cell.attr("def-value")||null,newValue){let def=JSON.parse(flexygo.utils.parser.replaceAll(flexygo.history.getDefaults(listEl.objectname,$(listEl)),"'",'"'));newValue=flexygo.utils.parser.compile(def,newValue.toString(),null,null)}ctl.setValue(newValue,cell.attr("def-text")||null)}$(ctl).hasClass("hideControl")||focus||($(ctl).is("flx-combo")?(input=$(ctl).find("select"))&&!$(input).prop("disabled")&&($(input).focus(),focus=!0):$(ctl).is("flx-textarea")?(input=$(ctl).find("textarea"))&&!$(input).prop("disabled")&&($(input).focus(),focus=!0):(input=$(ctl).find("input"))&&!$(input).prop("disabled")&&($(input).focus(),focus=!0))}}),(list.is("flx-list")?list:list.find("flx-list"))[0].processLoadDependencies(list.find("tfoot > tr")),list.find(".rowInsert").validate().resetForm()},wc_1.saveRow=function(objectName,objectWhere,list,btn,msg=!0,lastProcessName,lastAfterProcessName){if(list[0].loadingDependencies>0)return list[0].pendingSaveButton=btn,void list[0].addLock();let tr=btn.closest("tr");if(function(objectName,row){let props=row.find("[property]");if(props.length>0){let Properties=[],SQLPropertiesNames=[];for(let i=0;i<props.length;i++){let prop=$(props[i])[0];Properties.push({Key:prop.property,Value:prop.getValue()}),void 0!==$(prop).find('[name="'+prop.property+'"].form-control').attr("data-msg-sqlvalidator")&&SQLPropertiesNames.push(prop.property)}for(let i=0;i<SQLPropertiesNames.length;i++)validateRowSQLProperty(SQLPropertiesNames[i],Properties,objectName,row)}}(objectName,tr),tr.valid())if(objectName){let tr=btn.closest("tr"),props=tr.find("[property]");if(props.length>0){tr.closest("flx-module")[0].checkAndSaveNewComboValues(tr);let ret,obj=new flexygo.obj.Entity(objectName,objectWhere);obj.read();for(let i=0;i<props.length;i++){let prop=$(props[i])[0];obj.data[prop.property]&&(obj.data[prop.property].Value=prop.getValue())}if(ret=objectWhere&&""!=objectWhere?obj.update(lastProcessName,lastAfterProcessName):obj.insert(lastProcessName,lastAfterProcessName)){if(obj.objectWhere&&objectWhere&&obj.objectWhere!=objectWhere){tr.attr("objectWhere",obj.objectWhere);let parentModule=tr.closest("flx-module"),wcList=list[0],oldBtnGroup=tr.find(".btn-group:first");if(wcList.buttons&&obj.objectName&&obj.objectWhere){let arrBtn=flexygo.utils.sortObject(wcList.buttons,"PositionId","Order");if(arrBtn.length>0){let btnGroup=$('<div class="btn-group" />');for(let i=0;i<arrBtn.length;i++)btnGroup.append(wcList._getButton(arrBtn[i],obj.objectName,obj.objectWhere,parentModule[0].objectdefaults));oldBtnGroup.replaceWith(btnGroup)}}}if(obj.jsCode)return(()=>__awaiter(this,void 0,void 0,function*(){if(obj.lastProcessName||obj.lastAfterProcessName){var proc=new flexygo.obj.Entity("SysProcesses",`ProcessName='${obj.lastProcessName||obj.lastAfterProcessName}'`);if(proc.read(),proc.data&&proc.data.ConfirmText&&proc.data.ConfirmText.Value&&!(yield flexygo.msg.confirm(proc.data.ConfirmText.Value)))return}!this.newObjectWhere&&obj.objectWhere&&(this.newObjectWhere=obj.objectWhere);let save_button=tr.find(".saveRowButton");flexygo.utils.execAsyncFunction(obj.jsCode,["sysObj","triggerElement"],[obj,save_button]).then(res=>{!1!==res&&this.saveRow(objectName,objectWhere,list,save_button,msg,obj.lastProcessName,obj.lastAfterProcessName)}).catch(err=>{flexygo.msg.error(flexygo.utils.getErrorMessage(err))})}))(),!0;if(msg&&obj.getConfig().ConfirmOkText&&(obj.warningMessage?flexygo.msg.warning(obj.warningMessage):flexygo.msg.success(flexygo.localization.translate("Saved :)"))),list[0].isRowDirty=!1,tr.removeClass("dirty"),objectWhere&&""!=objectWhere){for(let i=0;i<props.length;i++){let prop=$(props[i])[0];prop.options.DetachedFromDB||prop.setValue(obj.data[prop.property].Value)}tr.animate({backgroundColor:flexygo.colors.success},700,()=>{tr.animate({backgroundColor:"none"},700,function(){$(this).css("background-color","")})})}else{let row=flexygo.utils.lowerKeys(obj.toValuesArray());row._objectname=obj.objectName,row._objectwhere=obj.objectWhere;let wcList=list[0],newTr=$(wcList.paintBody(row));newTr.hide(),list.find("tbody").append(newTr),newTr.show(250),newTr.attr("id",flexygo.utils.uniqueId()).addClass("form"),newTr.validate({ignore:[],unhighlight:(element,errorClass,validClass)=>{$(element).parent().addClass("has-success").removeClass("has-error")},highlight:(element,errorClass,validClass)=>{$(element).parent().removeClass("has-success").addClass("has-error")},errorPlacement:(error,element)=>{error.insertAfter($(element).parent()[0])},errorClass:"txt-danger"}),flexygo.ui.wc.clearRow(list,btn),tr=newTr,wcList.setRowEvents()}list[0].processLoadDependencies(tr)}else tr.animate({backgroundColor:flexygo.colors.danger},700)}else flexygo.msg.success("Row without properties.")}else flexygo.msg.success("Can't find object name");else flexygo.msg.warning("Complete all required fields before saving. like :"+tr.validate().errorList[0].element.name)}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),$(document).on("click.dirty",ev=>{let lists=$('flx-list[mode="edit"]');for(let i=0;i<lists.length;i++){let me=$(lists[i]),listItem=me[0];listItem.setFocus(me,listItem,ev)}}),$(document).keydown(e=>{if(9===(e.keyCode||e.which)){let lists=$('flx-list[mode="edit"]');for(let i=0;i<lists.length;i++){let me=$(lists[i]),listItem=me[0];listItem.setFocus(me,listItem,e)}}}),window.customElements.define("flx-list",flexygo.ui.wc.FlxListElement);