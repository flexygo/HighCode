var flexygo;!function(flexygo){!function(ui){!function(wc){wc.LoadMenusParams=class{};wc.NavigationMenu=class{};wc.HierarchicalMenu=class{};wc.FlxMenuManagerElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.method=null,this.deleteMethod="DeleteMenu",this.relocateMethod="RelocateMenu",this.getMetod="GetAppMenus",this.openMenus=null,this.scrollY=0,this.sortableList=null,this.template=`<li id="fgnsli_{{MenuId}}" strType="{{TypeId}}">\n                <div>\n                    <div>\n                        <i class="flx-icon {{IconClass|isnull:icon-menu,{{IconClass}}}}"/>\n                        <span>{{Title}} <small>({{strType}})</small></span>\n                    </div>\n                    <div class="btn-panel reduced">\n                        <i class="flx-icon icon-plus {{strType}}" data-action="add" data-toggle="tooltip" title="${flexygo.localization.translate("menumanager.newsubmenu")}"/>\n                        <i class="flx-icon icon-order-down-2 {{strType}}" data-action="toggle" data-toggle="tooltip" title="${flexygo.localization.translate("menumanager.submenus")}"/>\n                        <i class="flx-icon icon-pencil" data-action="edit" data-toggle="tooltip" title="${flexygo.localization.translate("menumanager.edit")}"/>\n                        <i class="flx-icon icon-delete-2" data-action="del" data-toggle="tooltip" title="${flexygo.localization.translate("menumanager.delete")}"/>\n                        <i class="flx-icon icon-more" data-action="more" data-toggle="tooltip" title="${flexygo.localization.translate("menumanager.moreoptions")}"/>\n                    </div>\n                </div>\n                <div class="row editMenu collapse" id="Menu{{MenuId}}" MenuId="{{MenuId}}"/>\n                \x3c!--{{getChildMenus(json)}}--\x3e\n            </li>`,this.emptyTemplate=`<div class="empty-info">\n            <span>${flexygo.localization.translate("menumanager.empty")}</span>\n            <i class="flx-icon icon-arrow-3"></i>\n         </div>`}connectedCallback(){let element=$(this);this.connected=!0;let AppName=element.attr("AppName");AppName&&(this.method=this.getMetod,this.methodParams={AppName},this.appName=AppName),this.init()}init(){this.loadMenus()}refresh(){this.loadMenus()}loadMenus(){$(this).find('[data-toggle="tooltip"]').tooltip("destroy"),$(this).empty(),flexygo.ajax.post("~/api/MenuManager",this.method,this.methodParams,response=>{let arrOrdered=this.sortMenus(flexygo.utils.lowerKeys(response,!0),"order");$(this).html('<div class="managerpanel"></div>'),this.loadMenusRet(arrOrdered)})}renderNode(id,ret){let nodes=$('<ul class="sortable"></ul>');for(let i=0;i<ret.length;i++)if(id==ret[i].parentmenuid){let node;node=$(flexygo.utils.parser.recursiveCompile(ret[i],this.template));let childNodes=this.renderNode(ret[i].menuid,ret);childNodes&&node.append(childNodes),nodes.append(node)}return nodes.children().length>0?nodes:null}loadMenusRet(ret){let timeout,nodes=this.renderNode(null,ret),me=$(this),newbutton=`<div class="managerbuttons">\n                                        <span><i class="flx-icon icon-clear"/>${flexygo.localization.translate("menumanager.menus")}</span>\n                                        <div>\n                                        <i data-action="refresh" class="flx-icon icon-refresh"  data-toggle="tooltip" title="${flexygo.localization.translate("menumanager.refresh")}"/>\n                                        <i data-action="addnew" class="flx-icon icon-plus-1"  data-toggle="tooltip" title="${flexygo.localization.translate("menumanager.new")}"/>\n                                        </div>\n                                    </div>`;me.find(".managerpanel").append(newbutton),me.find(".managerpanel").append(nodes),me.find(".managerpanel").append(this.emptyTemplate),this.sortableList=me.find(".sortable"),this.sortableList.nestedSortable({forcePlaceholderSize:!0,listType:"ul",handle:"div",helper:"clone",items:"li",opacity:.6,placeholder:"placeholder",revert:250,tabSize:25,tolerance:"pointer",toleranceElement:"> div",maxLevels:0,isTree:!1,expandOnHover:700,startCollapsed:!1,protectRoot:!0,relocate:(e,f)=>{let Menus=this.sortableList.nestedSortable("toHierarchy",{expression:/(.+)[_](.+)/}),Menuid=f.item.attr("id");Menuid=Menuid.substring(Menuid.indexOf("_")+1);let params=this.findMenu(Menus,Menuid);params&&flexygo.ajax.post("~/api/MenuManager",this.relocateMethod,params,response=>{})}}).disableSelection(),me.find('[data-action="edit"]').on("click",e=>{$(e.currentTarget).hasClass("active")?$(e.currentTarget).removeClass("active"):($(e.currentTarget).addClass("active"),me.find('[data-action="add"]').removeClass("active")),this.showEdit($(e.target).closest("li").children(".editMenu"),!1)}),me.find('[data-action="refresh"]').on("click",e=>{this.loadMenus()}),me.find('[data-action="addnew"]').on("click",e=>{let param={appname:this.appName};flexygo.ajax.post("~/api/MenuManager","AddNew",param,response=>{this.loadMenus()})}),me.find('[data-action="add"]').on("click",e=>{$(e.currentTarget).hasClass("active")?$(e.currentTarget).removeClass("active"):($(e.currentTarget).addClass("active"),me.find('[data-action="edit"]').removeClass("active")),this.showEdit($(e.target).closest("li").children(".editMenu"),!0)}),me.find('[data-action="toggle"]').on("click",e=>{let icon=$(e.currentTarget),opened=icon.hasClass("icon-order-up-2"),content=$(e.currentTarget).closest("li").children("ul").first();opened?(content.hide(),icon.removeClass("icon-order-up-2 active").addClass("icon-order-down-2")):(content.show(),icon.removeClass("icon-order-down-2").addClass("icon-order-up-2 active")),this.saveMenusState()}),me.find('[data-action="del"]').on("click",e=>{let Menu=$(e.currentTarget).closest("li").children(".editMenu")[0].id;Lobibox.confirm({title:flexygo.localization.translate("menumanager.deleteMenu"),msg:flexygo.localization.translate("menumanager.deleteMenuquestion"),iconClass:"",callback:(dlg,type,ev)=>{"yes"==type&&this.deleteMenu(Menu)}})}),me.find('[data-action="more"]').on("click",e=>{let subMenuButtons=$(e.currentTarget).closest("div").find("i.Text");$(e.currentTarget).hasClass("active")?($(e.currentTarget).removeClass("active"),subMenuButtons.length>0?$(e.currentTarget).closest(".btn-panel").removeClass("show-all"):$(e.currentTarget).closest(".btn-panel").removeClass("show-half"),clearTimeout(timeout)):($(e.currentTarget).addClass("active"),subMenuButtons.length>0?$(e.currentTarget).closest(".btn-panel").addClass("show-all"):$(e.currentTarget).closest(".btn-panel").addClass("show-half"),timeout=setTimeout(function(){$(e.currentTarget).removeClass("active"),$(e.currentTarget).closest(".btn-panel").removeClass("show-all")},8e3))}),$(this).find('[data-toggle="tooltip"]').tooltip({container:"body",trigger:"hover",delay:{show:600,hide:0}})}showEdit(placeHolder,isNewMenu){if(placeHolder.hasClass("in")&&placeHolder.attr("isnewmenu")===isNewMenu.toString())placeHolder.collapse("hide"),placeHolder.closest("li").find("> div:first-child").removeClass("active"),this.sortableList.sortable("enable"),placeHolder.empty(),placeHolder.removeAttr("isnewmenu"),placeHolder.closest(".ui-dialog").find(".ui-dialog-titlebar-close").length>0&&placeHolder.closest("main.pageContainer").off("dialogbeforeclose");else{placeHolder.closest("li").find("> div:first-child").addClass("active"),placeHolder.collapse("hide"),flexygo.events.off(placeHolder,"module","loaded"),flexygo.events.on(placeHolder,"module","loaded",e=>{(e.context=placeHolder)&&(setTimeout(()=>{placeHolder.collapse("show")},100),flexygo.events.off(placeHolder,"module","loaded"))}),this.sortableList.sortable("disable");let editModuleName="sysmod-edit-generic",containerTemplate='<div class="cntBody nopadding size-xs"></div><div class="cntBodyFooter"></div>',container=$('<flx-module class="MenuEdit"/>').html(containerTemplate).attr("modulename",editModuleName).attr("type","flx-edit").addClass("empty");placeHolder.attr("isnewmenu",isNewMenu.toString()),placeHolder.empty(),placeHolder.append(container);let module=null,parent=placeHolder.attr("Menuid");if(!0===isNewMenu){let objDef={parentmenuid:parent,appname:this.appName},strobjDef=JSON.stringify(objDef);module=$("<flx-edit />").attr("ObjectName","sysOfflineMenu").attr("defaults",strobjDef).attr("modulename",editModuleName),flexygo.events.on(this,"entity","all",e=>{flexygo.events.off(this,"entity","all"),"inserted"===e.type&&(this.saveMenusState(),placeHolder.closest(".ui-dialog").find(".ui-dialog-titlebar-close").length>0&&placeHolder.closest("main.pageContainer").off("dialogbeforeclose"),flexygo.ajax.post("~/api/MenuManager",this.getMetod,null,response=>{this.loadMenus()}))})}else module=$("<flx-edit />").attr("ObjectName","sysOfflineMenu").attr("ObjectWhere","Menuid='"+placeHolder.attr("Menuid")+"'").attr("modulename",editModuleName);container.find(".cntBody").append(module);let ctrl=container[0];ctrl.moduleName=editModuleName,ctrl.canCollapse=!0,ctrl.canEnlarge=!0,ctrl.canRefresh=!0,ctrl.canConfig=!1,ctrl.init()}}findMenu(Menus,Menuid,parentid){let res=null;return $.each(Menus,(i,e)=>e.id===Menuid?(res={id:e.id,parentid,order:i},!1):(!e.children||!(res=this.findMenu(e.children,Menuid,e.id)))&&void 0),res}sortMenus(Menus,orderby){return flexygo.utils.sortObject(Menus,orderby)}deleteMenu(Menu){let params={MenuId:Menu.toLowerCase().replace("menu","")};flexygo.ajax.post("~/api/MenuManager",this.deleteMethod,params,response=>{$(this).find("#fgnsli_"+Menu.toLowerCase().replace("menu","")).remove()})}saveOpenMenu(btn){if(btn.hasClass("icon-order-up-2")){let parent=btn.closest("li");this.openMenus.push(parent.attr("id"));let ul=parent.children("ul [data-navMenu]");$.each(ul.children(),(i,e)=>{let childbtn=$(e).children().first().find('[data-action="toggle"]');childbtn.length>0&&this.saveOpenMenu(childbtn)})}}saveMenusState(){this.openMenus=[];let me=$(this),btn=me.find(".sortable").children("li").children().first().find('[data-action="toggle"]');this.saveOpenMenu(btn),this.scrollY=me.find(".sortable").parent().scrollTop()}restoreMenusState(){let list=$(this).find(".sortable");this.openMenus&&$.each(this.openMenus,(i,e)=>{let Menu=$("#"+e);if(Menu){let btn=Menu.children().first().find('[data-action="toggle"]');btn.find("i").first().hasClass("icon-order-down-2")&&btn.trigger("click")}}),this.openMenus=[],list.parent().scrollTop(this.scrollY)}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-menumanager",flexygo.ui.wc.FlxMenuManagerElement);