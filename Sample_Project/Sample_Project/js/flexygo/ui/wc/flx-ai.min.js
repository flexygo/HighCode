var flexygo;!function(flexygo){!function(ui){!function(wc){class FlxAIElement extends HTMLElement{constructor(){super(),this.initTemplate='\n<div class="chat_window">\n    <div class="top_menu">\n        <div class="buttons">\n            <div class="fa fa-close chat_ai_close"></div>\n        </div>\n        <div class="title">Chat</div>\n    </div>\n    <ul class="messages">\n    </ul>\n    <div class="bottom_wrapper">\n        <div class="message_input_wrapper">\n            <textarea class="message_input" tabindex="2" placeholder="Ask for something..."></textarea>\n            <button class="send_message btn flx-icon icon-order-right" disabled></button>\n        </div>\n        <div class="chat_tools btn-group"></div>\n    </div>\n</div>',this.messageTemplate='\n      <li class="message {{positionClass}}">\n  <div class="avatar">\n    <img is="flx-img" alt="{{avatar}}" src="{{srcavatar}}" class="chatter_thread_message_avatar img-circle">\n    <div class="chat_ai_timestamp">{{time}}</div>\n  </div>\n  <div class="text_wrapper">\n    <div class="chat_ai_author">\n        <span>{{author}}</span>\n        \n    </div>\n    <div class="chat_ai_text">{{message}}</div>\n  </div>\n</li>',this.connected=!1,this.messages=[]}init(){flexygo.ajax.post("~/api/AI","GetChatGPTSetting",{SettingId:$(this).attr("SettingId")},response=>{response&&response.SettingId==$(this).attr("SettingId")?(this.settings=response,this.render()):($(this).closest(".ui-dialog").find("button.ui-dialog-titlebar-close").click(),flexygo.msg.error(flexygo.localization.translate("flxai.settingNotFound").replace("{0}",$(this).attr("SettingId"))))},error=>{$("flx-ai").length>0&&$("flx-ai").closest(".ui-dialog").find("button.ui-dialog-titlebar-close").click(),flexygo.exceptions.httpShow(error)})}refresh(){this.messages=[],this.render()}render(){let me=this;$(this).empty(),$(this).html(this.initTemplate),this.input=$(this).find(".message_input_wrapper .message_input")[0],this.sendButton=$(this).find(".send_message"),$(this).find(".chat_ai_close").off("click.closeAI").on("click.closeAI",()=>{me.close()}),this.sendButton.off("click.send_message_AI").on("click.send_message_AI",e=>{if(!e.currentTarget.hasAttribute("disabled"))if(flexygo.utils.isBlank(this.settings.BearerToken)){let btnLink='<a class="btn fa fa-external-link" onclick="flexygo.nav.openHelpId(\'syshelp-OpenAI\',\'new\',false,$(this))" target="_blank"/a>';flexygo.msg.alert(`<div><span>${flexygo.localization.translate("flxai.alertInfoMessage")}</span> ${btnLink}</div>`)}else this.sendToAI(this.input.value)}),$(this).closest('.ui-dialog[role="dialog"]').off("click.close_chat_ai").on("click.close_chat_ai",e=>{0!=$(e.target.closest("flx-ai")).length||$(e.target).is("button.ui-dialog-titlebar-close")||me.close()}),$(this.input).keydown(function(event){13!==event.keyCode||event.shiftKey||(event.preventDefault(),me.sendButton.click())}),$(this.input).off("input").on("input",()=>{me.input.value&&!me.sendButton.hasClass("waitingResponse")?me.sendButton.removeAttr("disabled"):me.sendButton[0].setAttribute("disabled","disabled")}),this.getButtons(),this.writeMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),flexygo.localization.translate("flxai.beginMessage"),!1,"left_message")}getButtons(){try{let me=this;this.settings.PromptsBar.forEach(button=>{let btn=$(`<button id="${button.ButtonId}" class="btn btn-default ${button.IconName}" tabindex="5" type="button" title="${button.Title}"/>`);button.Prompt=button.Prompt.replace(/{{Value}}/g,`{{${me.targetItem.attr("property")}}}`),btn.off(`click.${button.ButtonId}`).on(`click.${button.ButtonId}`,()=>{this.sendButton.removeAttr("disabled"),this.input.value=button.Prompt,this.sendButton.focus()}),$(this).find(".chat_tools").append(btn)})}catch(ex){console.log(ex)}}sendToAI(message){let json=new Object,plainJson=new Object,module=this.targetItem.closest("flx-module")[0];$(module).find("[property]").each(function(){if(plainJson[$(this).attr("property")]=this.getValue(),$(this).is("flx-code")){let value="html"==$(this).attr("type")?flexygo.string.escapeHTML(this.getValue()):this.getValue();json[$(this).attr("property")]=`<flx-code forcecodemirror="true" help mode="view" type="${$(this).attr("type")}" value="${value}"/>`}else json[$(this).attr("property")]=this.getValue()});let originalMessage=flexygo.utils.parser.recursiveCompile(plainJson,message);message=flexygo.utils.parser.recursiveCompile(json,message),this.writeMessage("user",flexygo.context.currentUserLogin.toUpperCase(),"",flexygo.context.currentUserFullName,moment().format("LT"),message,!1,"right_message",originalMessage);let contextMessages=this.messages.length>=this.settings.MaxLevel?this.messages.slice(-this.settings.MaxLevel):this.messages,params={ApiUrl:this.settings.ApiUrl,Messages:JSON.stringify(contextMessages),BearerToken:this.settings.BearerToken,Model:this.settings.Model,SystemPrompt:this.settings.SystemPrompt};this.writeMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),'<i class="flx-icon icon-load icon-pulse"></i>',!1,"left_message"),this.input.value="",this.sendButton.addClass("waitingResponse"),this.sendButton[0].setAttribute("disabled","disabled"),flexygo.ajax.post("~/api/AI","RequestChatGPT",params,response=>{if(response){let resp=JSON.parse(response);if(resp.error)this.updateLastMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),resp.error.message,!1,"left_message");else if(resp.choices&&resp.choices[0]&&resp.choices[0].message.content){let originalResponse=resp.choices[0].message.content,response=this.parseMessage(originalResponse);this.updateLastMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),response,!0,"left_message",originalResponse)}else this.updateLastMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),"ERROR",!1,"left_message")}this.sendButton.removeClass("waitingResponse"),this.input.value&&this.sendButton.removeAttr("disabled")})}writeMessage(role,avatar,srcavatar,author,time,message,enableReturn,positionClass,originalMessage=null){this.messages.push({role,content:originalMessage||message}),originalMessage=originalMessage||message;let msg=this.messageTemplate;msg=flexygo.utils.parser.compile({avatar,srcavatar,author,time,message,positionClass},msg),msg=$(msg),$(this).find(".messages").append(msg),$(this).find(".messages").scrollTop($(this).find(".message:last")[0].offsetTop),msg.addClass("appeared"),setTimeout(()=>{$(this).find(".messages").scrollTop($(this).find(".message:last")[0].offsetTop)},500),enableReturn&&this.setReturnButton(msg,originalMessage)}updateLastMessage(role,avatar,srcavatar,author,time,message,enableReturn,positionClass,originalMessage=null){this.messages[this.messages.length-1]={role,content:originalMessage||message},originalMessage=originalMessage||message;let msg=this.messageTemplate;msg=flexygo.utils.parser.compile({avatar,srcavatar,author,time,message,positionClass},msg),msg=$(msg),$(this).find(".messages .message:last").replaceWith(msg),msg.addClass("appeared"),setTimeout(()=>{$(this).find(".messages").scrollTop($(this).find(".message:last")[0].offsetTop)},500),enableReturn&&this.setReturnButton(msg,originalMessage)}setReturnButton(msgElement,originalMessage){this.targetItem.is("flx-htmledit")&&(originalMessage=flexygo.utils.parser.replaceAll(originalMessage,"\n","<br/>")),msgElement.find("flx-code").length>0?flexygo.events.on(this,"codeProperty","returnAction",this.returnCode):(msgElement.find(".chat_ai_author").append($('<button class="flx-icon icon-return-2 copy_response icon-zoom-115" type="button"/>')),msgElement.find(".chat_ai_author .copy_response").on("click",()=>{this.targetItem.is("flx-code")?this.targetItem[0].setValueWithHistory(originalMessage):this.targetItem.val(originalMessage),$(this).find(".chat_ai_close").click()}))}returnCode(ev){flexygo.events.off(this,"codeProperty","returnAction");let message=$(ev.sender).closest("flx-code")[0].getValue();this.targetItem.is("flx-code")?this.targetItem[0].setValueWithHistory(message):this.targetItem.val(message),$(this).find(".chat_ai_close").click()}parseMessage(message){let codeBlocks=message.match(/```(\w+)?([\s\S]*?)```/g);return codeBlocks?codeBlocks.forEach(codeBlock=>{let language="plaintext",content=codeBlock,matchLanguage=codeBlock.match(/```(\w+)/);matchLanguage&&(language=matchLanguage[1],content=codeBlock.replace(/```(\w+)/,"")),content=content.replace(/```/gim,"").trim(),content=(content=flexygo.string.escapeHTML(content)).replace(/\n/gim,"&#10"),message=message.replace(codeBlock,`<flx-code forcecodemirror="true" returnEnabled="true" help mode="view" type="${language}" value="${content}"></flx-code>`)}):message=flexygo.string.escapeHTML(message),message=(message=(message=`<p>${message}</p>`).replace(/\n\n/gim,"</p><p>")).replace(/\n/gim,"<br>")}open(e){let histObj=new flexygo.nav.FlexygoHistory;histObj.targetid="slideright";let modal=flexygo.targets.createContainer(histObj,!0,null,!0);if(!modal)return;modal.empty(),modal.closest(".ui-dialog").find(".ui-dialog-title").html("Lowdy");let vm=$(`<flx-ai SettingId="${e[0].options.ChatGPTSettingId}" mode="template"></flx-ai>`)[0];vm.targetItem=e,modal.append(vm)}close(e){flexygo.events.off(this,"dialog","closing");let closeButton=$(this).closest(".ui-dialog").find("button.ui-dialog-titlebar-close");closeButton.length>0&&($(this).find(".chat_window").addClass("closing"),closeButton.trigger("click"))}connectedCallback(){$(this);this.connected=!0,flexygo.events.on(this,"dialog","closing",this.close),this.init()}attributeChangedCallback(attrName,oldVal,newVal){let needInit=!1;"settings"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.settings=newVal,needInit=!0),this.connected&&needInit&&this.init()}}FlxAIElement.observedAttributes=["settings"],wc.FlxAIElement=FlxAIElement}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-ai",flexygo.ui.wc.FlxAIElement);