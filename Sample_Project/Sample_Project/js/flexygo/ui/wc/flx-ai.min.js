var flexygo;!function(flexygo){!function(ui){!function(wc){class FlxAIElement extends HTMLElement{constructor(){super(),this.initTemplate='\n<div class="chat_window">\n    <div class="top_menu">\n        <div class="buttons">\n            <div class="fa fa-close chat_ai_close"></div>\n        </div>\n        <div class="title">Chat</div>\n    </div>\n    <ul class="messages">\n    </ul>\n    <div class="bottom_wrapper">\n        <div class="message_input_wrapper">\n            <div class="textarea_container">\n                <textarea class="message_input" tabindex="2" placeholder="Ask for something..."></textarea>\n            </div>\n            <button id="send_voice_message" class="send_message btn flx-icon icon-mic"></button>\n            <button id="send_text_message" class="send_message btn flx-icon icon-order-right" disabled></button>\n        </div>\n        <div class="chat_tools btn-group"></div>\n    </div>\n</div>',this.messageTemplate='\n      <li class="message {{positionClass}}">\n  <div class="avatar">\n    <img is="flx-img" alt="{{avatar}}" src="{{srcavatar}}" class="chatter_thread_message_avatar img-circle">\n    <div class="chat_ai_timestamp">{{time}}</div>\n  </div>\n  <div class="text_wrapper">\n    <div class="chat_ai_author">\n        <span>{{author}}</span>\n        \n    </div>\n    <div class="chat_ai_text">{{message}}</div>\n  </div>\n</li>',this.connected=!1,this.messages=[]}init(){this.render(),flexygo.ajax.post("~/api/AI","GetChatGPTSetting",{SettingId:this.settingId},response=>{if(response&&response.SettingId==this.settingId){this.settings=response,this.getButtons();let beginMessage=flexygo.utils.isBlank(this.settings.IntroMessage)?flexygo.localization.translate("flxai.beginMessage"):this.settings.IntroMessage;this.writeMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),beginMessage,!1,"left_message")}else $(this).closest(".ui-dialog").find("button.ui-dialog-titlebar-close").click(),flexygo.msg.error(flexygo.localization.translate("flxai.settingNotFound").replace("{0}",this.settingId))},error=>{$("flx-ai").length>0&&$("flx-ai").closest(".ui-dialog").find("button.ui-dialog-titlebar-close").click(),flexygo.exceptions.httpShow(error)})}refresh(){this.messages=[],this.render(),this.getButtons();let beginMessage=flexygo.utils.isBlank(this.settings.IntroMessage)?flexygo.localization.translate("flxai.beginMessage"):this.settings.IntroMessage;this.writeMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),beginMessage,!1,"left_message")}render(){let me=this;$(this).empty(),$(this).html(this.initTemplate),this.input=$(this).find(".message_input_wrapper .message_input")[0],this.sendButton=$(this).find("#send_text_message"),this.voiceButton=$(this).find("#send_voice_message"),"chat"==$(this).attr("typeId")&&($(this).find(".chat_ai_close").off("click.closeAI").on("click.closeAI",()=>{me.close()}),$(this).closest('.ui-dialog[role="dialog"]').off("click.close_chat_ai").on("click.close_chat_ai",e=>{0!=$(e.target.closest("flx-ai")).length||$(e.target).is("button.ui-dialog-titlebar-close")||me.close()})),this.sendButton.off("click.send_message_AI").on("click.send_message_AI",e=>{if(!e.currentTarget.hasAttribute("disabled"))if(flexygo.utils.isBlank(this.settings.BearerToken)){let btnLink='<a class="btn fa fa-external-link" onclick="flexygo.nav.openHelpId(\'syshelp-OpenAI\',\'new\',false,$(this))" target="_blank"/a>';flexygo.msg.alert(`<div><span>${flexygo.localization.translate("flxai.alertInfoMessage")}</span> ${btnLink}</div>`)}else this.sendToAI(this.input.value)}),this.voiceButton.on("click",e=>{if(this.voiceButton.hasClass("listening"))this.recognition.stop();else{let speechOk=!1;try{webkitSpeechRecognition&&(speechOk=!0)}catch(ex){speechOk=!1}if(speechOk){this.recognition=new webkitSpeechRecognition,this.recognition.interimResults=!0,this.recognition.continuous=!0,this.recognition.start();const pastInput=this.input.value;this.recognition.onstart=(()=>{this.sendButton.prop("disabled",!0),this.input.placeholder=flexygo.localization.translate("flxsearch.speak"),this.voiceButton.addClass("listening")}),this.recognition.onresult=(event=>{pastInput.trim().length>0?this.input.value=pastInput+" "+event.results[0][0].transcript:this.input.value=event.results[0][0].transcript,me.resizeInput(),event.results[0].isFinal&&this.recognition.stop()}),this.recognition.onspeechend=(()=>{this.recognition.stop()}),this.recognition.onend=(()=>{this.voiceButton.removeClass("listening"),this.input.placeholder="Ask for something...",this.input.focus(),this.input.value.trim().length>0&&this.sendButton.removeAttr("disabled")})}else $("#send_voice_button").remove()}}),$(this.input).keydown(function(event){13!==event.keyCode||event.shiftKey||(event.preventDefault(),me.sendButton.click())}),$(this.input).off("input").on("input",()=>{me.input.value&&!me.sendButton.hasClass("waitingResponse")?me.sendButton.removeAttr("disabled"):me.sendButton[0].setAttribute("disabled","disabled"),me.resizeInput()})}getButtons(){try{let me=this;this.settings.PromptsBar.forEach(button=>{let btn=$(`<button id="${button.ButtonId}" class="btn btn-default ${button.IconName}" tabindex="5" type="button" title="${button.Title}"/>`);if(!flexygo.utils.isBlank(me.targetItem)&&me.targetItem.length>0){let value=$(me.targetItem).attr("property");flexygo.utils.isBlank(value)||(button.Prompt=button.Prompt.replace(/{{Value}}/g,`{{${value}}}`))}btn.off(`click.${button.ButtonId}`).on(`click.${button.ButtonId}`,()=>{this.sendButton.removeAttr("disabled"),this.input.value=button.Prompt,this.sendButton.focus(),me.resizeInput()}),$(this).find(".chat_tools").append(btn)})}catch(ex){console.log(ex)}}sendToAI(message){var _a;let json=new Object,plainJson=new Object;if(!flexygo.utils.isBlank(this.targetItem)&&this.targetItem.length>0&&$(null===(_a=this.targetItem)||void 0===_a?void 0:_a.context).is("button")){let module=this.targetItem.closest("flx-module")[0];$(module).find("[property]").each(function(){if(plainJson[$(this).attr("property")]=this.getValue(),$(this).is("flx-code")){let value="html"==$(this).attr("type")?flexygo.string.escapeHTML(this.getValue()):this.getValue();json[$(this).attr("property")]=`<flx-code forcecodemirror="true" help mode="view" type="${$(this).attr("type")}" value="${value}"/>`}else json[$(this).attr("property")]=this.getValue()})}message=flexygo.utils.parseAIMessage(message);let contextMessages,originalMessage=flexygo.utils.parser.recursiveCompile(plainJson,message);if(message=flexygo.utils.parser.recursiveCompile(json,message),this.writeMessage("user",flexygo.context.currentUserLogin.toUpperCase(),"",flexygo.context.currentUserFullName,moment().format("LT"),message,!1,"right_message",originalMessage),this.messages.length>=this.settings.MaxLevel){let indexMessages=this.messages.map(function(message,index){if(null==message.tool_call_id)return index}).filter(index=>void 0!==index);indexMessages=indexMessages.slice(-this.settings.MaxLevel),contextMessages=this.messages.slice(indexMessages[0])}else contextMessages=this.messages;let params={Chat:this.settings,Messages:JSON.stringify(contextMessages)};this.writeMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),'<i class="flx-icon icon-load icon-pulse"></i>',!1,"left_message"),this.input.value="",this.input.style.height="40px",this.sendButton.addClass("waitingResponse"),this.sendButton[0].setAttribute("disabled","disabled"),flexygo.ajax.post("~/api/AI","RequestChatGPT",params,response=>{if(response){let resp=JSON.parse(response);if(resp.error)this.updateLastMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),resp.error.message,!1,"left_message");else if(resp.choices&&resp.choices[0])if(resp.choices[0].message.content){let originalMessage=resp.choices[0].message.content,message=flexygo.utils.parseAIMessage(originalMessage);this.updateLastMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),message,!0,"left_message",originalMessage)}else this.updateLastMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),"ERROR",!1,"left_message");else this.updateLastMessage("assistant","AI","./img/lowdy.png","Lowdy",moment().format("LT"),"ERROR",!1,"left_message")}this.sendButton.removeClass("waitingResponse"),this.input.value&&this.sendButton.removeAttr("disabled")})}writeMessage(role,avatar,srcavatar,author,time,message,enableReturn,positionClass,originalMessage=null){this.messages.push({role,content:originalMessage||message}),originalMessage=originalMessage||message;let msg=this.messageTemplate;msg=flexygo.utils.parser.compile({avatar,srcavatar,author,time,message,positionClass},msg),msg=$(msg),$(this).find(".messages").append(msg),$(this).find(".messages").scrollTop($(this).find(".message:last")[0].offsetTop),msg.addClass("appeared"),setTimeout(()=>{$(this).find(".messages").scrollTop($(this).find(".message:last")[0].offsetTop)},500),enableReturn&&this.setReturnButton(msg,originalMessage)}parseToMarkdown(message){if("undefined"!=typeof marked){const codeBlocks=message.match(/<flx-code [\s\S]*?<\/flx-code>/g)||[];let newMessage=message;return codeBlocks.forEach((codeBlock,index)=>{newMessage=message.replace(codeBlock,`__CODE_BLOCK_${index}__`)}),newMessage=(newMessage=(newMessage=newMessage.replace(/<\/?p>/gi,"\n")).replace(/<br\s*\/?>/gi,"\n")).replace(/__CODE_BLOCK_(\d+)__/g,(match,index)=>codeBlocks[index]),marked.parse(newMessage)}return message}updateLastMessage(role,avatar,srcavatar,author,time,message,enableReturn,positionClass,originalMessage=null){let msg;this.messages[this.messages.length-1]={role,content:originalMessage||message},originalMessage=originalMessage||message;try{msg=this.messageTemplate,msg=flexygo.utils.parser.compile({avatar,srcavatar,author,time,message:this.parseToMarkdown(message),positionClass},msg),msg=$(msg),$(this).find(".messages .message:last").replaceWith(msg)}catch(_a){msg=this.messageTemplate,msg=flexygo.utils.parser.compile({avatar,srcavatar,author,time,message:"Error representing the information. Try again. If the problem persists, consider changing to a better model.",positionClass},msg),msg=$(msg),$(this).find(".messages .message:last").replaceWith(msg)}msg.addClass("appeared"),setTimeout(()=>{$(this).find(".messages").scrollTop($(this).find(".message:last")[0].offsetTop)},500),enableReturn&&this.setReturnButton(msg,originalMessage)}updateLastFunctionMessage(avatar,srcavatar,author,time,message,enableReturn,positionClass,originalMessage){let msg=this.messageTemplate;msg=flexygo.utils.parser.compile({avatar,srcavatar,author,time,message,positionClass},msg),msg=$(msg),$(this).find(".messages .message:last").replaceWith(msg),msg.addClass("appeared"),setTimeout(()=>{$(this).find(".messages").scrollTop($(this).find(".message:last")[0].offsetTop)},500),enableReturn&&this.setReturnButton(msg,originalMessage)}setReturnButton(msgElement,originalMessage){var _a;!flexygo.utils.isBlank(this.targetItem)&&this.targetItem.length>0&&$(null===(_a=this.targetItem)||void 0===_a?void 0:_a.context).is("button")&&(this.targetItem.is("flx-htmledit")&&(originalMessage=flexygo.utils.parser.replaceAll(originalMessage,"\n","<br/>")),msgElement.find("flx-code").length<=0&&(msgElement.find(".chat_ai_author").append($('<button class="flx-icon icon-return-2 copy_response icon-zoom-115" type="button"/>')),msgElement.find(".chat_ai_author .copy_response").on("click",()=>{this.targetItem.is("flx-code")?this.targetItem[0].setValueWithHistory(originalMessage):this.targetItem.val(originalMessage),$(this).find(".chat_ai_close").click()})))}open(options){if(!flexygo.utils.isBlank(options.TargetItem)&&options.TargetItem.length>0||!flexygo.utils.isBlank(options.SettingId)){let histObj=new flexygo.nav.FlexygoHistory;histObj.targetid="slideright";let modal=flexygo.targets.createContainer(histObj,!0,null,!0);if(!modal)return;modal.empty(),modal.closest(".ui-dialog").find(".ui-dialog-title").html("Lowdy");let id=options.TargetItem?options.TargetItem[0].options.ChatGPTSettingId:options.SettingId,vm=$(`<flx-ai SettingId="${id}" mode="template"></flx-ai>`)[0];vm.targetItem=options.TargetItem,modal.append(vm)}}open_from_toolbar(settingId,module){let histObj=new flexygo.nav.FlexygoHistory;histObj.targetid="slideright";let modal=flexygo.targets.createContainer(histObj,!0,null,!0);if(!modal)return;modal.empty(),modal.closest(".ui-dialog").find(".ui-dialog-title").html("Lowdy");let vm=$(`<flx-ai SettingId="${settingId}" mode="template"></flx-ai>`)[0];vm.targetItem=module,modal.append(vm)}close(e){flexygo.events.off(this,"dialog","closing");let closeButton=$(this).closest(".ui-dialog").find("button.ui-dialog-titlebar-close");closeButton.length>0&&($(this).find(".chat_window").addClass("closing"),closeButton.trigger("click"))}resizeInput(){this.input.style.height="40px";$(this).find(".chat_window").height();const numberOfLines=Math.ceil(this.input.scrollHeight/24)-1,newHeight=1==numberOfLines?40:40+24*numberOfLines;$(this.input).height()<newHeight&&(this.input.style.height=`${newHeight}px`)}connectedCallback(){$(this);if(flexygo.utils.isBlank($(this).attr("SettingId"))){let objectwhere=$(this).attr("objectwhere");this.settingId=objectwhere?objectwhere.split("=")[1].replaceAll("'",""):null}else this.settingId=$(this).attr("SettingId");if(flexygo.utils.isBlank($(this).attr("typeId"))&&$(this).attr("typeId","chat"),this.connected=!0,"chat"==$(this).attr("typeId")&&flexygo.events.on(this,"dialog","closing",this.close),0===$(document.head).find('script[class="ai"]').length){const script=document.createElement("script");script.setAttribute("class","ai"),script.setAttribute("type","text/javascript"),script.innerHTML=`import('${flexygo.utils.resolveUrl("~/js/plugins/marked/marked.min.js")}').then((module) => {\n                    $('flx-ai')[0].init();\n                }).catch((error) => {\n                    console.error('Error loading the module:', error);\n                });`,document.head.appendChild(script)}else this.init()}attributeChangedCallback(attrName,oldVal,newVal){let needInit=!1;"settings"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.settings=newVal,needInit=!0),this.connected&&needInit&&this.init()}disconnectedCallback(){this.voiceButton.hasClass("listening")&&this.recognition.stop()}}FlxAIElement.observedAttributes=["settings"],wc.FlxAIElement=FlxAIElement}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-ai",flexygo.ui.wc.FlxAIElement);