var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxDbComboElement=class extends HTMLElement{constructor(){super(),this.property=null,this.mode="object",this.type="dbcombo",this.options=null,this.input=null,this.mobileInput=null,this.inputval=null,this.datalist=null,this.open=!1,this.value=null,this.page=null,this.connected=!1,this.additionalWhere=null,this.cnnString=null,this.timer=null,this.scrollTopPosition=null}connectedCallback(){let element=$(this),propName=element.attr("property");if(propName&&flexygo.utils.isBlank(this.options)){let parentCtl=element.closest("flx-edit,flx-list,flx-propertymanager,flx-view,flx-filter");if(parentCtl&&parentCtl.length>0){let wcParent=parentCtl[0];if(parentCtl.is("flx-filter")){let objName=element.attr("object");this.options=jQuery.extend(!0,{},wcParent.properties[objName+"-"+propName])}else this.options=jQuery.extend(!0,{},wcParent.properties[propName]);parentCtl&&wcParent.mode&&(this.mode=wcParent.mode)}this.property=propName}let ObjectName=element.attr("ObjectName");ObjectName&&""!==ObjectName&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.ObjectName=ObjectName);let ViewName=element.attr("ViewName");ViewName&&""!==ViewName&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.ViewName=ViewName);let SQLValueField=element.attr("SQLValueField");SQLValueField&&""!==SQLValueField&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SQLValueField=SQLValueField);let SQLDisplayField=element.attr("SQLDisplayField");SQLDisplayField&&""!==SQLDisplayField&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SQLDisplayField=SQLDisplayField);let AllowNewObject=element.attr("AllowNewObject");AllowNewObject&&""!==AllowNewObject&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.AllowNewObject=AllowNewObject);let AllowNewReturnFields=element.attr("AllowNewReturnFields");AllowNewReturnFields&&""!==AllowNewReturnFields&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.AllowNewReturnFields=AllowNewReturnFields);let AllowNewFunction=element.attr("AllowNewFunction");AllowNewFunction&&""!==AllowNewFunction&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.AllowNewFunction=AllowNewFunction);let AllowNewDefaults=element.attr("AllowNewDefaults");AllowNewDefaults&&""!==AllowNewDefaults&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.AllowNewDefaults=AllowNewDefaults);let ObjNameLink=element.attr("ObjNameLink");ObjNameLink&&""!==ObjNameLink&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.ObjNameLink=ObjNameLink);let ObjWhereLink=element.attr("ObjWhereLink");ObjWhereLink&&""!==ObjWhereLink&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.ObjWhereLink=ObjWhereLink);let ObjModeLink=element.attr("ObjModeLink");ObjModeLink&&""!==ObjModeLink&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.ObjModeLink=ObjModeLink);let PageNameLink=element.attr("PageNameLink");PageNameLink&&""!==PageNameLink&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PageNameLink=PageNameLink);let TargetIdLink=element.attr("TargetIdLink");TargetIdLink&&""!==TargetIdLink&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.TargetIdLink=TargetIdLink);let SearchCollection=element.attr("SearchCollection");SearchCollection&&""!==SearchCollection&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SearchCollection=SearchCollection);let SearchReturnFields=element.attr("SearchReturnFields");SearchReturnFields&&""!==SearchReturnFields&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SearchReturnFields=SearchReturnFields);let SearchWhere=element.attr("SearchWhere");SearchWhere&&""!==SearchWhere&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SearchWhere=SearchWhere);let SearchFunction=element.attr("SearchFunction");SearchFunction&&""!==SearchFunction&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SearchFunction=SearchFunction),void 0!==element.attr("Required")&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequired=!0),void 0!==element.attr("Disabled")&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Locked=!0);let RequiredMessage=element.attr("RequiredMessage");RequiredMessage&&""!==RequiredMessage&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequiredMessage=RequiredMessage);let Style=element.attr("Style");Style&&""!==Style&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Style=Style,element.attr("Control-Style",this.options.Style),element.attr("Style",""));let Class=element.attr("Class");Class&&""!==Class&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=Class,element.attr("Control-Class",this.options.CssClass),element.attr("Class",""));let PlaceHolder=element.attr("PlaceHolder");PlaceHolder&&""!==PlaceHolder&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PlaceHolder=PlaceHolder);let IconClass=element.attr("IconClass");IconClass&&""!==IconClass&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IconClass=IconClass);let Template=element.find("Template");Template.length>0&&""!==Template.html()&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Template=Template.html(),Template.remove());let Items=element.find("option");if(Items.length>0){let arr=[];for(let opt=0;opt<Items.length;opt++){let obj={};$(Items[opt]).attr("value")&&(obj[element.attr("SQLValueField")]=$(Items[opt]).attr("value")),obj[element.attr("SQLDisplayField")]=$(Items[opt]).html(),arr.push(obj)}this.options||(this.options=new flexygo.api.ObjectProperty),this.options.DropDownValues=arr,Items.remove()}let HelpId=element.attr("HelpId");HelpId&&""!==HelpId&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.HelpId=HelpId);let ctlClass=element.attr("Control-Class");ctlClass&&""!==ctlClass&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=ctlClass);let ctlStyle=element.attr("Control-Style");ctlStyle&&""!==ctlStyle&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Style=ctlStyle);let Hide=element.attr("Hide");Hide&&""!==Hide&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Hide="true"==Hide);let cnnString=element.attr("CnnString");cnnString&&""!==cnnString&&(this.cnnString=cnnString);let additionalWhere=element.attr("additionalwhere");additionalWhere&&""!==additionalWhere&&(this.additionalWhere=additionalWhere);let SQLFilter=element.attr("SQLFilter");SQLFilter&&""!==SQLFilter&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SQLFilter=SQLFilter);let PageSize=element.attr("PageSize");PageSize&&""!==PageSize&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PageSize=Number(PageSize));let ValidatorMessage=element.attr("ValidatorMessage");ValidatorMessage&&""!==ValidatorMessage&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.ValidatorMessage=ValidatorMessage),this.init();let Value=element.attr("Value"),Text=element.attr("Text");Value&&""!==Value&&this.setValue(Value,Text),this.connected=!0}disconnectedCallback(){let element=$(this);element.find("*").remove(),this.options&&this.options.Template&&(element.html("<template/>"),element.find("template").html(this.options.Template))}static get observedAttributes(){return["type","property","objectname","viewname","sqlvaluefield","sqldisplayfield","required","disabled","requiredmessage","style","class","placeholder","iconclass","template","helpid","hide","additionalwhere","sqlfilter","pagesize","validatormessage","cnnstring"]}attributeChangedCallback(attrName,oldVal,newVal){if(!this.connected)return;let element=$(this);if("type"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.type=newVal,this.refresh()),"property"===attrName.toLowerCase()&&newVal&&""!==newVal){let propName=newVal,parentCtl=element.closest("flx-edit, flx-list,flx-propertymanager");if(parentCtl&&parentCtl.length>0){let wcParent=parentCtl[0];this.options=jQuery.extend(!0,{},wcParent.properties[propName])}this.property=newVal,this.refresh()}"objectname"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.ObjectName=newVal,this.refresh()),"viewname"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.ViewName=newVal,this.refresh()),"sqlvaluefield"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SQLValueField=newVal,this.refresh()),"sqldisplayfield"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SQLDisplayField=newVal,this.refresh()),"required"===attrName.toLowerCase()&&(this.options||(this.options=new flexygo.api.ObjectProperty),void 0!==element.attr("required")?this.options.IsRequired=!0:this.options.IsRequired=!1,element.find('input[type="text"]').prop("required",this.options.IsRequired)),"disabled"===attrName.toLowerCase()&&(this.options||(this.options=new flexygo.api.ObjectProperty),void 0!==element.attr("disabled")?(this.options.Locked=!0,this.input.prop("disabled",this.options.Locked),element.find("div.input-group-btn .flx-caret").hide(),element.find("div.input-group-btn .flxallownew").hide(),element.find("div.input-group-btn .flx-icon.icon-search").parent().hide(),0==element.find("div.input-group-btn .btn:visible").length&&(element.find("span.input-group-addon").length||element.find("div").first().removeClass("input-group"))):(this.options.Locked=!1,element.find("div.input-group-btn .flx-caret").show(),element.find("div.input-group-btn .flxallownew").show(),element.find("div.input-group-btn .flx-icon.icon-search").parent().show(),element.find("div").first().addClass("input-group"),this.input.css({"border-top-right-radius":"","border-bottom-right-radius":""})),element.find("input").prop("disabled",this.options.Locked)),"requiredmessage"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequiredMessage=newVal,this.refresh()),"style"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Style=newVal,element.attr("Control-Style")!==this.options.Style&&(element.attr("Control-Style",this.options.Style),element.attr("Style",""),this.refresh())),"class"===attrName.toLowerCase()&&element.attr("Control-Class")!==newVal&&newVal!=oldVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=newVal,element.attr("Control-Class")!==this.options.CssClass&&(""!=newVal&&(element.attr("Control-Class",this.options.CssClass),element.attr("Class",this.options.CssClass)),this.refresh())),"placeholder"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PlaceHolder=newVal,this.refresh()),"iconclass"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IconClass=newVal,this.refresh()),"template"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Template=newVal,this.refresh()),"helpid"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.HelpId=newVal,this.refresh()),"hide"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Hide=newVal,this.refresh()),"additionalwhere"===attrName.toLowerCase()&&newVal&&(this.additionalWhere=newVal,this.refresh()),"sqlfilter"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SQLFilter=newVal,this.refresh()),"pagesize"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PageSize=newVal,this.refresh()),"cnnstring"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.cnnString=newVal,this.refresh())}refresh(){let val=this.getValue(),txt=this.getText();this.init(),val&&""!==val&&this.setValue(val,txt)}init(){$(this).attr("mode")&&"view"===$(this).attr("mode").toLowerCase()?this.initViewMode():this.initEditMode()}initViewMode(){let iconsLeft,iconsRight,me=$(this);if(this.options&&this.options.ObjNameLink&&this.options.ObjWhereLink){let editCtl=me.closest("flx-view")[0];iconsRight=$('<div class="input-group-btn" />');let icon1=$('<button class="btn btn-default" type="button"><i class="flx-icon icon-link" /></button>').on("click",()=>{if(this.getValue()){let propObjNameLink=this.options.ObjNameLink,propObjWhereLink=this.options.ObjWhereLink;if(editCtl){if(propObjNameLink)propObjNameLink=editCtl.parseEditString(this.options.ObjNameLink),propObjWhereLink&&(propObjWhereLink=editCtl.parseEditString(this.options.ObjWhereLink));else{let obj=new Object;obj[this.options.SQLValueField]=this.getValue(),obj[this.options.SQLDisplayField]=this.getText(),propObjNameLink&&(propObjNameLink=flexygo.utils.parser.compile(obj,propObjNameLink)),propObjWhereLink&&(propObjWhereLink=flexygo.utils.parser.compile(obj,propObjWhereLink))}"Other"==this.options.ObjModeLink?flexygo.nav.openPageName(this.options.PageNameLink,propObjNameLink,propObjWhereLink,null,this.options.TargetIdLink,!0):flexygo.nav.openPage(this.options.ObjModeLink,propObjNameLink,propObjWhereLink,null,this.options.TargetIdLink)}else flexygo.msg.warning("flxedit.emptyproperty")}});iconsRight.append(icon1)}let control=$("<div>");me.html(control);let input=$('<label class="form-control input-view" />');this.options&&this.options.IconClass&&""!==this.options.IconClass&&(iconsLeft=$('<span class="input-group-addon" ><i class="'+this.options.IconClass+'" /></span>'),control.append(iconsLeft)),control.append(input),iconsRight&&control.append(iconsRight),(iconsLeft||iconsRight)&&control.addClass("input-group"),this.options&&this.options.Style&&me.children("div").attr("style",this.options.Style),this.options&&this.options.CssClass&&me.children("div").addClass(this.options.CssClass),this.options&&this.options.Hide&&me.addClass("hideControl")}initEditMode(){let me=$(this);if(this.open=!1,this.options){let iconsLeft,iconsRight=this.getIconButtons(),control=$('<div class="input-group">'),input=$('<input type="search" class="form-control" />'),inputval=$('<input type="text" style="display:none" />');/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&input.css("-webkit-appearance","none");let datalist=$('<ul style="display:none" class="comboOptions" />');if(flexygo.utils.isSizeMobile()||flexygo.utils.isTactilModeActive()){datalist.addClass("mobile");let mobileInputDiv=$('<div class="mobileinputdiv input-group"/>').appendTo(datalist);this.mobileInput=$('<input type="search" class="mobileinputdiv form-control mobileinput" autocomplete="off" />').appendTo(mobileInputDiv),$(`<label class="mobileinputdiv input-group-btn">\n                          <label class="mobileinputdiv btn">\n                            <i title="${flexygo.localization.translate("msg.confirm")}" class="mobileinputdiv flx-icon icon-checked" />\n                          </label>\n                       </label>`).appendTo(mobileInputDiv),this.mobileInput.off("keyup").on("keyup",e=>{38!=e.keyCode&&40!=e.keyCode&&9!=e.keyCode&&(this.input.val(this.mobileInput.val()),this.input.trigger("keyup")),"Enter"===e.key&&this.hideMobileInput()}).off("search").on("search",e=>{this.input.val($(e.currentTarget).val()),this.input.trigger("search")}).off("blur").on("blur",()=>{this.hideMobileInput()})}this.input=input,this.inputval=inputval,this.datalist=datalist,this.datalist.off("scroll.dbcombo").on("scroll.dbcombo",e=>{this.datalist[0].offsetHeight+this.datalist[0].scrollTop>=this.datalist[0].scrollHeight&&this.loadValues(this.page+1,!1,!1,null,!0)}),input.off("focus").on("click",ev=>{this.open||this.showOptions()}).off("blur").on("blur",()=>{if(this.open){var itms=this.datalist.children(".selected");itms.length>0&&itms.attr("data-value")!=this.inputval.val()&&itms.trigger("mousedown"),this.hideOptions()}}).off("keydown").on("keydown",e=>{if(40==e.keyCode){if(this.open){if(this.datalist.children("li").length>0)if(0==this.datalist.children(".selected").length)this.datalist.children("li:first").addClass("selected");else{let itm=this.datalist.children(".selected"),nxtItm=itm.next();0===nxtItm.length&&(nxtItm=this.datalist.children("li:first")),itm.removeClass("selected"),nxtItm.addClass("selected")}}else this.showOptions();return e.stopPropagation(),e.preventDefault(),!1}if(38==e.keyCode){if(this.open){if(this.datalist.children("li").length>0)if(0==this.datalist.children(".selected").length)this.datalist.children("li:last").addClass("selected");else{let itm=this.datalist.children(".selected"),prevItm=itm.prev();0===prevItm.length&&(prevItm=this.datalist.children("li:last")),itm.removeClass("selected"),prevItm.addClass("selected")}}else this.showOptions();return e.stopPropagation(),e.preventDefault(),!1}if((13==e.keyCode||9==e.keyCode)&&this.open){var itms=this.datalist.children(".selected");itms.length>0&&itms.attr("data-value")!=this.inputval.val()&&itms.trigger("mousedown"),this.hideOptions()}}).off("change").on("change",e=>{me.attr("value",this.getValue()),e.stopPropagation(),e.preventDefault()}),flexygo.utils.isSizeMobile()||flexygo.utils.isTactilModeActive()||$("#mainContent, main.pageContainer").on("scroll.dbcombo",e=>{this.hideOptions()}),input.on("keyup",e=>{38!=e.keyCode&&40!=e.keyCode&&9!=e.keyCode&&13!=e.keyCode&&(this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(()=>{$(e.currentTarget).attr("data-text",""),this.inputval.val(""),this.loadValues(0,!0)},200),this.showOptions())}),input.on("search",e=>{""===$(e.currentTarget).val()&&($(e.currentTarget).attr("data-text",""),this.inputval.val(""),this.showOptions(),this.loadValues(0,!1),this.triggerDependencies())}),this.options.IconClass&&""!==this.options.IconClass&&(iconsLeft=$('<span class="input-group-addon" ><i class="'+this.options.IconClass+'" /></span>')),(iconsLeft||iconsRight)&&control.addClass("input-group"),iconsLeft&&control.append(iconsLeft),control.append(input),control.append(inputval),iconsRight&&iconsRight.length>0&&control.append(iconsRight),me.html(control),me.append(datalist),this.setOptions(),this.options&&this.options.DropDownValues&&this.options.DropDownValues.length>0?this.addComboItems(this.options.DropDownValues,!1):this.loadValues(0,!1);let parentAttr=me.parent().attr("data-tag"),padIzq=me.find(".input-group").first().css("padding-left");void 0!==parentAttr&&parentAttr&&"control"===parentAttr||(me.wrap("<div data-tag='control' class='fixdbcombo' style='position:relative'></div>"),this.datalist.css({left:padIzq}))}}showOptions(){let me=$(this);if(!this.open&&!this.input.prop("readonly")){if(this.mobileInput){const isIphone=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;this.scrollTopPosition=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,this.datalist.css({position:"fixed",top:3,left:5,width:"calc(100% - 10px)","max-height":isIphone?"48%":flexygo.utils.isTactilModeActive?"50%":"98%","padding-top":30,"box-shadow":"0 -6px 20px 4px rgba(0, 0, 0, 0.15), 0 -2px 10px 0px rgba(0, 0, 0, 0.20)"}),isIphone&&$(document).scrollTop(-innerHeight),this.mobileInput.val(this.input.val()),me.append('<div class="mobilebackground"/>'),this.datalist.fadeIn(250),this.mobileInput.focus()}else{let winHeight,dialogTop,headerHeight,padBottom=me.find(".input-group").first().css("padding-bottom");me.closest("div.ui-dialog").length?(winHeight=me.closest("div.ui-dialog").height(),dialogTop=me.closest("div.ui-dialog").offset().top,headerHeight=$("div.ui-dialog-titlebar").height()+7):(winHeight=$(window).height(),dialogTop=0,headerHeight=$("#mainMenu").height()+7),parseInt((this.input.offset().top-dialogTop+this.input.outerHeight()/2-headerHeight/2).toFixed())>parseInt((winHeight/2).toFixed())?(this.datalist.css({bottom:parseInt((this.input.outerHeight()+1).toFixed()),width:parseInt(me.children("div").width().toFixed()),"max-height":parseInt((this.input.offset().top-dialogTop-headerHeight).toFixed()),"box-shadow":"0 -6px 20px 4px rgba(0, 0, 0, 0.15), 0 -2px 10px 0px rgba(0, 0, 0, 0.20)"}),me.parent().hasClass("fixdbcombo")&&this.datalist.css("margin-bottom",padBottom)):(this.datalist.css({bottom:"auto",width:parseInt(me.children("div").width().toFixed()),"max-height":parseInt((winHeight-(this.input.offset().top-dialogTop)-60).toFixed()),"box-shadow":"0 6px 20px 4px rgba(0, 0, 0, 0.15), 0 2px 10px 0px rgba(0, 0, 0, 0.20)"}),me.parent().hasClass("fixdbcombo")&&this.datalist.css("transform","translateY(-"+padBottom+")")),this.datalist.slideDown(250)}this.open=!0}}hideOptions(){this.open&&(this.open=!1,this.mobileInput?(this.datalist.fadeOut(250),$(this).find("div.mobilebackground").remove(),$(this.mobileInput).is(":focus")&&this.mobileInput.blur()):(this.datalist.slideUp(250),$(this.input).is(":focus")&&this.input.blur()),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&window.scrollTo(0,this.scrollTopPosition))}hideMobileInput(){if(this.open){var itms=this.datalist.children(".selected");itms.length>0&&itms.attr("data-value")!=this.inputval.val()&&itms.trigger("mousedown"),this.input.trigger("blur"),this.hideOptions()}}loadValues(page,autoselect,fromvalue,value,append){let params,method=null;if(this.page=page,this.options.ViewName&&""!==this.options.ViewName)params={ObjectName:this.options.ObjectName,ViewName:this.options.ViewName,DisplayField:this.options.SQLDisplayField,Value:this.input.val(),Page:page,PageSize:this.options.PageSize,AdditionalWhere:this.additionalWhere,SQLFilter:this.options.SQLFilter,CnnString:this.cnnString},method="GetComboDataView";else if(this.options.SQLEditSentence||this.options.SQLSentence)!0===fromvalue?(params={Mode:this.mode,ObjectName:this.options.ProcessName||this.options.ReportName||this.options.ObjectName,PropertyName:this.options.Name,CryptedSql:this.options.SQLEditSentence||this.options.SQLSentence,CryptedFilter:this.options.SQLFilter,Value:value,Page:page,AdditionalWhere:this.additionalWhere},method="GetComboText"):(params={Mode:this.mode,ObjectName:this.options.ProcessName||this.options.ReportName||this.options.ObjectName,PropertyName:this.options.Name,CryptedSql:this.options.SQLEditSentence||this.options.SQLSentence,CryptedFilter:this.options.SQLFilter,Value:this.input.val(),Page:page,AdditionalWhere:this.additionalWhere},method="GetComboData");else{let filterValue=(fromvalue?value:this.input.val()).toLowerCase();this.datalist.find("li").filter(function(){$(this).toggle($(this).text().toLowerCase().indexOf(filterValue)>-1)})}method&&flexygo.ajax.syncPost("~/api/Edit",method,params,response=>{response&&this.addComboItems(response,autoselect,append)})}addComboItems(data,autoselect,append){if(append?this.datalist.find("> div.load-more").remove():this.datalist.find("*").not(".mobileinputdiv").remove(),data){for(let i=0;i<data.length;i++){let elm;elm=this.options.Template&&""!==this.options.Template?this.getListItem(data[i][this.options.SQLValueField],data[i][this.options.SQLDisplayField],flexygo.utils.parser.recursiveCompile(data[i],this.options.Template,this)):this.getListItem(data[i][this.options.SQLValueField],data[i][this.options.SQLDisplayField],data[i][this.options.SQLDisplayField]),flexygo.utils.isBlank(this.input.val())||0!=i||elm.addClass("selected"),this.datalist.append(elm)}this.datalist.find(" > li").length>=(this.options.PageSize||flexygo.profiles.defaultDropDownRows)&&data.length>0&&(this.datalist.append(`<div class="load-more txt-muted clickable"><span>${flexygo.localization.translate("flxedit.loadmore")}</span><i class="fa fa-angle-down"></div>`),$(".load-more").on("mousedown.load-more",e=>{e.stopPropagation(),e.preventDefault(),this.datalist[0].offsetHeight<=this.datalist[0].scrollHeight&&this.loadValues(this.page+1,!1,!1,null,!0)}))}if(1==this.datalist.children("li").length&&this.input.val().toString().toLowerCase()==this.datalist.children("li").text().toString().toLowerCase().trim()&&autoselect){let itm=$(this.datalist.children("li")[0]);this.setValue(itm.attr("data-value"),itm.attr("data-text")),this.datalist.find(".selected").removeClass("selected"),itm.addClass("selected"),this.triggerDependencies()}}getTextByValue(value){if(this.options.SQLValueField!==this.options.SQLDisplayField)if(this.options.ViewName&&""!==this.options.ViewName){let params={ObjectName:this.options.ObjectName,ViewName:this.options.ViewName,ValueField:this.options.SQLValueField,Value:value};flexygo.ajax.syncPost("~/api/Edit","GetComboTextByView",params,response=>{response&&(value=response[0][this.options.SQLDisplayField])})}else{let params={Mode:this.mode,ObjectName:this.options.ProcessName||this.options.ReportName||this.options.ObjectName,PropertyName:this.options.Name,CryptedSql:this.options.SQLEditSentence||this.options.SQLSentence,CryptedFilter:this.options.SQLFilter,Value:value,Page:0,AdditionalWhere:this.additionalWhere,SQLValueField:this.options.SQLValueField};flexygo.ajax.syncPost("~/api/Edit","GetComboText",params,response=>{response&&(value=response[0][this.options.SQLDisplayField])})}return value}getListItem(value,text,template){return value&&value.toString().indexOf("/Date(")>-1&&(value=moment.utc(value).format("YYYY-MM-DD[T]HH:mm")),text&&text.toString().indexOf("/Date(")>-1&&(text=moment.utc(text).format("YYYY-MM-DD[T]HH:mm")),template&&template.toString().indexOf("/Date(")>-1&&(template=moment.utc(template).format("YYYY-MM-DD[T]HH:mm")),text||"0"==text||(text=value),template||(template=text),$("<li/>").html(template).attr("data-value",value).attr("data-text",text).on("mousedown",e=>{this.setValue($(e.currentTarget).attr("data-value"),$(e.currentTarget).attr("data-text")),this.datalist.find(".selected").removeClass("selected"),$(e.currentTarget).addClass("selected"),this.triggerDependencies()})}getIconButtons(){let icon1,me=$(this),ret=$('<div class="input-group-btn" />'),arrow=$('<button class="btn btn-default flx-caret" type="button" tabindex="-1"><span class="caret"></span></button>');ret.append(arrow),arrow.off("mousedown").on("mousedown",ev=>(this.open?this.hideOptions():(this.input.focus(),this.showOptions()),ev.stopPropagation(),ev.preventDefault(),!1));let editCtl=me.closest("flx-edit, flx-list")[0];return this.options&&(this.options.SearchCollection||this.options.SearchFunction)&&!this.options.Locked&&(icon1=$('<button class="btn btn-default" type="button"><i class="flx-icon icon-search" /></button>').on("click",()=>{if(this.options.SearchFunction){let propSearchFunction=this.options.SearchFunction;if(editCtl)flexygo.utils.execDynamicCode.call(this,editCtl.parseEditString(this.options.SearchFunction,editCtl,this));else{let obj=new Object;obj[this.options.SQLValueField]=this.getValue(),obj[this.options.SQLDisplayField]=this.getText(),propSearchFunction&&(propSearchFunction=flexygo.utils.parser.compile(obj,propSearchFunction)),flexygo.utils.execDynamicCode.call(this,propSearchFunction)}}if(this.options.SearchCollection&&""!==this.options.SearchCollection){flexygo.events.on(this,"entity","selected",e=>{flexygo.events.off(this,"entity","selected");let entity=e.sender,config=entity.getConfig(),value=entity.data[config.KeyFields[0]].Value;this.options.SearchReturnFields&&""!==this.options.SearchReturnFields&&(value=entity.data[this.options.SearchReturnFields].Value),this.loadValues(0,!1,!0,value),this.setValue(value),this.triggerDependencies(),$(document).find('flx-search[objectname="'+this.options.SearchCollection+'"]').closest(".ui-dialog").remove()});let PropSearchCollection=this.options.SearchCollection,PropSearchWhere=this.options.SearchWhere;if(editCtl)flexygo.nav.openPage("search",editCtl.parseEditString(this.options.SearchCollection,editCtl,this),editCtl.parseEditString(this.options.SearchWhere,editCtl,this),null,"modal");else{let obj=new Object;obj[this.options.SQLValueField]=this.getValue(),obj[this.options.SQLDisplayField]=this.getText(),PropSearchCollection&&(PropSearchCollection=flexygo.utils.parser.compile(obj,PropSearchCollection)),PropSearchWhere&&(PropSearchWhere=flexygo.utils.parser.compile(obj,PropSearchWhere)),flexygo.nav.openPage("search",PropSearchCollection,PropSearchWhere,null,"modal")}let propSearchFunction=this.options.SearchFunction;if(editCtl)propSearchFunction&&(propSearchFunction=editCtl.parseEditString(this.options.SearchFunction,editCtl,this));else{let obj=new Object;obj[this.options.SQLValueField]=this.getValue(),obj[this.options.SQLDisplayField]=this.getText(),propSearchFunction&&(propSearchFunction=flexygo.utils.parser.compile(obj,propSearchFunction))}}}),ret.append(icon1)),this.options&&this.options.ObjNameLink&&this.options.ObjWhereLink&&(icon1=$('<button class="btn btn-default" type="button"><i class="flx-icon icon-link" /></button>').on("click",()=>{if(this.getValue()){let propObjNameLink=this.options.ObjNameLink,propObjWhereLink=this.options.ObjWhereLink;if(editCtl)propObjNameLink&&(propObjNameLink=editCtl.parseEditString(this.options.ObjNameLink,editCtl,this)),propObjWhereLink&&(propObjWhereLink=editCtl.parseEditString(this.options.ObjWhereLink,editCtl,this));else{let obj=new Object;obj[this.options.SQLValueField]=this.getValue(),obj[this.options.SQLDisplayField]=this.getText(),propObjWhereLink&&(propObjNameLink=flexygo.utils.parser.compile(obj,propObjNameLink)),propObjWhereLink&&(propObjWhereLink=flexygo.utils.parser.compile(obj,propObjWhereLink))}"Other"==this.options.ObjModeLink?flexygo.nav.openPageName(this.options.PageNameLink,propObjNameLink,propObjWhereLink,null,this.options.TargetIdLink,!0):(this.options.ObjModeLink||(this.options.ObjModeLink="view"),this.options.TargetIdLink||(this.options.TargetIdLink="popup"),flexygo.nav.openPage(this.options.ObjModeLink,propObjNameLink,propObjWhereLink,null,this.options.TargetIdLink))}else flexygo.msg.warning("flxedit.emptyproperty")}),ret.append(icon1)),this.options&&(this.options.AllowNewFunction||this.options.AllowNewObject)&&!this.options.Locked&&(icon1=$('<button class="btn btn-default flxallownew" type="button"><i class="fa fa-plus" /></button>').on("click",()=>{if(this.options.AllowNewFunction){let propAllowNewFunction=this.options.AllowNewFunction;if(editCtl)propAllowNewFunction&&(propAllowNewFunction=editCtl.parseEditString(this.options.AllowNewFunction,editCtl,this));else{let obj=new Object;obj[this.options.SQLValueField]=this.getValue(),obj[this.options.SQLDisplayField]=this.getText(),propAllowNewFunction&&(propAllowNewFunction=flexygo.utils.parser.compile(obj,propAllowNewFunction))}flexygo.utils.execDynamicCode.call(this,propAllowNewFunction)}else if(this.options.AllowNewObject&&""!==this.options.AllowNewObject){flexygo.events.on(this,"entity","inserted",e=>{if(this.options.AllowNewObject===e.masterIdentity){flexygo.events.off(this,"entity","inserted");let value,entity=e.sender;if(this.options.AllowNewReturnFields&&""!=this.options.AllowNewReturnFields)value=entity.data[this.options.AllowNewReturnFields].Value;else{let config=entity.getConfig();value=entity.data[config.KeyFields[0]].Value}this.loadValues(0,!1,!0,value),this.setValue(value),this.triggerDependencies(),$(document).find('flx-edit[objectname="'+this.options.AllowNewObject+'"]').closest(".ui-dialog").remove()}});let propAllowNewObject=this.options.AllowNewObject,propAllowNewDefaults=this.options.AllowNewDefaults;if(editCtl)propAllowNewObject&&(propAllowNewObject=editCtl.parseEditString(this.options.AllowNewObject,editCtl,this)),propAllowNewDefaults&&(propAllowNewDefaults=editCtl.parseEditString(this.options.AllowNewDefaults,editCtl,this));else{let obj=new Object;obj[this.options.SQLValueField]=this.getValue(),obj[this.options.SQLDisplayField]=this.getText(),propAllowNewObject&&(propAllowNewObject=flexygo.utils.parser.compile(obj,propAllowNewObject)),propAllowNewDefaults&&(propAllowNewDefaults=flexygo.utils.parser.compile(obj,propAllowNewDefaults))}flexygo.nav.openPage("edit",propAllowNewObject,null,propAllowNewDefaults,"modal")}}),ret.append(icon1)),""===ret.html()?null:ret}setOptions(){let me=$(this);this.options&&this.options.Name&&""!==this.options.Name?this.input.attr("name",this.options.Name):this.input.attr("name",flexygo.utils.uniqueName()),this.inputval.attr("name",this.input.attr("name")),this.options&&this.options.Locked&&(this.input.prop("disabled",this.options.Locked),this.options.Locked?(me.find("div.input-group-btn .flx-caret").hide(),0==me.find("div.input-group-btn .btn:visible").length&&(me.find("span.input-group-addon").length||me.find("div").first().removeClass("input-group"))):(me.find("div.input-group-btn .flx-caret").show(),me.find("div").first().addClass("input-group"),this.input.css({"border-top-right-radius":"","border-bottom-right-radius":""}))),me.attr("tab")&&""!==me.attr("tab")&&this.input.attr("tabindex",me.attr("tab")),this.options.PlaceHolder&&this.input.attr("PlaceHolder",this.options.PlaceHolder),this.options.Style&&me.children("div").attr("style",this.options.Style),this.options.CssClass&&me.children("div").addClass(this.options.CssClass),this.options&&this.options.IsRequired&&this.inputval.prop("required",this.options.IsRequired),this.options&&this.options.IsRequiredMessage&&this.inputval.attr("data-msg-required",this.options.IsRequiredMessage),this.options&&this.options.ValidatorMessage&&""!==this.options.ValidatorMessage&&this.input.attr("data-msg-sqlvalidator",this.options.ValidatorMessage);const module=me.closest("flx-module")[0];(this.options&&(this.options.CauseRefresh||this.options.SQLValidator)||module&&module.moduleConfig&&module.moduleConfig.PropsEventDependant&&module.moduleConfig.PropsEventDependant.includes(this.property))&&this.inputval.on("change",()=>{let ev={class:"property",type:"changed",sender:this,masterIdentity:this.property};flexygo.events.trigger(ev)}),this.options&&this.options.Hide&&me.addClass("hideControl"),this.input.attr("autocomplete","off")}changeSQLData(newSQL,newOptions){this.options.SQLSentence=newSQL,this.options.SQLEditSentence=newSQL,this.options.DropDownValues=newOptions,this.options.SQLSentence||this.options.SQLEditSentence?this.loadValues(0,!1):this.addComboItems(this.options.DropDownValues,!1)}setValue(value,text,template){value&&value.toString().indexOf("/Date(")>-1&&(value=moment.utc(value).format("YYYY-MM-DD[T]HH:mm"));let me=$(this);if(me.attr("mode")&&"view"===me.attr("mode").toLowerCase())"null"===value||null===value||text||""===value||(text=this.getTextByValue(value)),this.setValueView(text),me.attr("value",value),me.attr("text",text);else{if("null"!==value&&null!==value&&""!==value)if(this.datalist&&0===this.datalist.find('li[data-value="'+value+'"]').length){text||(text=this.getTextByValue(value));let itm=this.getListItem(value,text,template);this.datalist.append(itm),this.datalist.find(".selected").removeClass("selected"),itm.addClass("selected"),text||(text=value)}else text||(text=this.datalist.find('li[data-value="'+value+'"]').attr("data-text"));void 0===text&&(text=value),this.input&&this.input.val(text),this.inputval&&this.inputval.val(value),me.attr("value",value),me.attr("text",text)}}setValueView(value){this.value=value,$(this).find("label").text(value)}getValue(){let me=$(this);return me.attr("mode")&&"view"===me.attr("mode").toLowerCase()?this.value:this.inputval?""===this.inputval.val()||"null"===this.inputval.val().toLowerCase()?null:this.inputval.val():null}getText(){return $(this).attr("Text")}triggerDependencies(){this.inputval.trigger("change")}show(){return $(this).css({display:"",opacity:""}).find("div:first").css({display:"",opacity:""}),$(this)}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-dbcombo",flexygo.ui.wc.FlxDbComboElement);