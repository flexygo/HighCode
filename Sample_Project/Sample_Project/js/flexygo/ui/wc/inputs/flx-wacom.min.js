var flexygo;!function(flexygo){!function(ui){!function(wc){class FlxWacomElement extends HTMLElement{constructor(){super(),this.connected=!1,this.type="wacom",this.property=null,this.options=null,this.moduleName=null,this.timeout=null,this.mode="wacom",this.readonly=!1,this.myCM=null,this.control=null,this.value=null}connectedCallback(){let element=$(this);this.type=element.attr("type")||"html";let propName=element.attr("property");if(propName&&flexygo.utils.isBlank(this.options)){let parentCtl=element.closest("flx-edit,flx-list,flx-propertymanager,flx-view,flx-filter");if(parentCtl&&parentCtl.length>0){let wcParent=parentCtl[0];if(parentCtl.is("flx-filter")){let objName=element.attr("object");this.options=jQuery.extend(!0,{},wcParent.properties[objName+"-"+propName])}else this.options=jQuery.extend(!0,{},wcParent.properties[propName])}this.property=propName}void 0!==element.attr("Required")&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequired=!0),void 0!==element.attr("Disabled")&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Locked=!0);let RequiredMessage=element.attr("RequiredMessage");RequiredMessage&&""!==RequiredMessage&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequiredMessage=RequiredMessage);let Class=element.attr("Class");Class&&""!==Class&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=Class,element.attr("Control-Class",this.options.CssClass),element.attr("Class",""));let PlaceHolder=element.attr("PlaceHolder");PlaceHolder&&""!==PlaceHolder&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PlaceHolder=PlaceHolder);let IconClass=element.attr("IconClass");IconClass&&""!==IconClass&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IconClass=IconClass);let HelpId=element.attr("HelpId");HelpId&&""!==HelpId&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.HelpId=HelpId);let ctlClass=element.attr("Control-Class");ctlClass&&""!==ctlClass&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=ctlClass);let ctlStyle=element.attr("Control-Style");ctlStyle&&""!==ctlStyle&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Style=ctlStyle);let Hide=element.attr("Hide");Hide&&""!==Hide&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Hide="true"==Hide),this.init();let Value=element.attr("Value");Value&&""!==Value&&this.setValue(Value),this.connected=!0}attributeChangedCallback(attrName,oldVal,newVal){let element=$(this);if(this.connected&&this.connected){if("type"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.type=newVal,this.refresh()),"property"===attrName.toLowerCase()&&newVal&&""!==newVal){let propName=newVal,parentCtl=element.closest("flx-edit, flx-list,flx-propertymanager");if(parentCtl&&parentCtl.length>0){let wcParent=parentCtl[0];this.options=jQuery.extend(!0,{},wcParent.properties[propName])}this.property=newVal,this.refresh()}"required"===attrName.toLowerCase()&&(this.options||(this.options=new flexygo.api.ObjectProperty),void 0!==element.attr("required")?this.options.IsRequired=!0:this.options.IsRequired=!1,element.find("textarea").prop("required",this.options.IsRequired)),"disabled"===attrName.toLowerCase()&&(this.options||(this.options=new flexygo.api.ObjectProperty),void 0!==element.attr("disabled")?this.options.Locked=!0:this.options.Locked=!1,element.find("textarea, input, button").prop("disabled",this.options.Locked),this.options.Locked?element.find(".note-editable").attr("contenteditable","false"):element.find(".note-editable").attr("contenteditable","true"),this.refresh()),"requiredmessage"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequiredMessage=newVal,this.refresh()),"class"===attrName.toLowerCase()&&element.attr("Control-Class")!==newVal&&newVal!=oldVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=newVal,element.attr("Control-Class")!==this.options.CssClass&&(""!=newVal&&(element.attr("Control-Class",this.options.CssClass),element.attr("Class",this.options.CssClass)),this.refresh())),"placeholder"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PlaceHolder=newVal,this.refresh()),"iconclass"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IconClass=newVal,this.refresh()),"helpid"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.HelpId=newVal,this.refresh()),"hide"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Hide=newVal,this.init())}}refresh(){let val=this.getValue();this.init(),val&&""!==val&&this.setValue(val)}init(){let script,me=$(this);0==$(".wacomApiFunctions").length&&((script=document.createElement("script")).type="text/javascript",script.classList.add("wacomApiFunctions"),script.src="./js/plugins/wacomSignature/wgssSigCaptX.js",document.body.appendChild(script),(script=document.createElement("script")).type="text/javascript",script.classList.add("wacomApiFunctions"),script.src="./js/plugins/wacomSignature/SigCaptX-Globals.js",document.body.appendChild(script)),me.attr("mode")&&"view"===me.attr("mode").toLowerCase()?this.initViewMode():this.initEditMode()}initViewMode(){let me=$(this);this.initEditMode(),me.parent('div[data-tag="control"]').attr("style","height:inherit;"),me.find("i").remove(),me.find("div.ctl-container").removeClass().addClass("cpr-view-container"),me.off(),this.options&&this.options.Style&&me.children("div.cpr-view-container img.img-responsive").attr("style",this.options.Style),this.options&&this.options.CssClass&&me.children("div").addClass(this.options.CssClass),this.options&&this.options.Hide&&me.addClass("hideControl")}initEditMode(){let input,img,icon,me=$(this);me.parent('div[data-tag="control"]').attr("style","height:94%;"),this.control=$('<div class="ctl-container ctl-cpr-transition ctl-hover">'),input=$('<input src=""  type="hidden"/>'),icon=$('<i class="flx-icon icon-pencil ctl-icon ctl-cpr-transition" ></i> '),img=$('<img src="" class="img-responsive ctl-image ctl-cpr-transition"/>'),this.control.append(input),this.control.append(icon),this.control.append(img),me.html(this.control),me.off("click").on("click",()=>{this.initWacom()}),this.options&&this.options.Locked&&(this.readonly=this.options.Locked),this.options&&this.options.PlaceHolder&&me.attr("placeholder",this.options.PlaceHolder),this.setOptions()}setOptions(){let me=$(this),input=me.find("input"),img=me.find("img");input.on("change.refreshvalue",()=>{me.attr("value",input.val())}),this.options&&this.options.Name&&""!==this.options.Name?input.attr("name",this.options.Name):input.attr("name",flexygo.utils.uniqueName()),me.attr("tab")&&""!==me.attr("tab")&&input.attr("tabindex",me.attr("tab")),this.options&&this.options.Locked&&(input.prop("disabled",this.options.Locked),me.off(),me.find("div.ctl-container").removeClass("ctl-hover").addClass("ctl-container-locked"),img.addClass("ctl-image-locked")),this.options&&this.options.ClientReadOnly&&me.find("i").removeClass("icon-pencil").addClass("icon-eye"),this.options&&this.options.Style&&me.find("img").attr("style",this.options.Style),this.options&&this.options.CssClass&&me.children("div").addClass(this.options.CssClass),this.options&&this.options.Hide&&me.addClass("hideControl"),this.options&&this.options.IsRequired&&input.prop("required",!0);const module=me.closest("flx-module")[0];(this.options&&this.options.CauseRefresh||module&&module.moduleConfig&&module.moduleConfig.PropsEventDependant&&module.moduleConfig.PropsEventDependant.includes(this.property))&&input.on("change",e=>{let ev={class:"property",type:"changed",sender:this,masterIdentity:this.property};flexygo.events.trigger(ev,me)})}getValue(){return $(this).find("input").val()}setValue(value){$(this).find("input").val(value),value&&$(this).find("img").attr("src",value),$(this).attr("value",value)}setValueView(value){this.value=value,$(this).find("input").html(flexygo.string.escapeHTML(value)),$(this).attr("value",value)}initWacom(){this.property;let inputControlToSave,imgControlToSave,itm=$(this);new Image;inputControlToSave=itm.find("input"),imgControlToSave=itm.find("img"),inputControlToSave=itm.find("input"),imgControlToSave=itm.find("img"),wgssSignatureSDK=new WacomGSS_SignatureSDK(()=>{this.onDetectRunning(itm[0])},SERVICEPORT),this.timeout=setTimeout(this.timedDetect,1500)}timedDetect(){wgssSignatureSDK.running||flexygo.msg.error(flexygo.localization.translate("flxWacom.serviceNotDetected"))}onDetectRunning(itm){clearTimeout(itm.timeout),itm.captureSignature()}restartSession(onRestartSession){wgssSignatureSDK=new WacomGSS_SignatureSDK(onRestartSession,SERVICEPORT)}showError(method,status){let message="";switch(status){case 100:message=flexygo.localization.translate("flxWacom.error100");break;case 101:message=flexygo.localization.translate("flxWacom.error101");break;case 103:message=flexygo.localization.translate("flxWacom.error100");break;case 200:message=flexygo.localization.translate("flxWacom.error200");break;default:switch(method){case"onGetSigText":message=`${flexygo.localization.translate("flxWacom.sigDataError")}, error ${status}`;break;case"onGetAdditionalData":message=`${flexygo.localization.translate("flxWacom.additionalDataError")}, error ${status}`;break;case"onRenderBitmap":message=`${flexygo.localization.translate("flxWacom.renderBitmapError")}, error ${status}`;break;case"onPutExtraData":message=`${flexygo.localization.translate("flxWacom.extraDataError")}, error ${status}`;break;case"onDynCaptCapture":message=`${flexygo.localization.translate("flxWacom.sigCtrlCaptureError")}, error ${status}`;break;case"onSigCtlPutLicence":case"onSigCtlConstructor":message=`${flexygo.localization.translate("flxWacom.sigCtrlConstructorError")}, error ${status}`;break;case"onDynCaptConstructor":message=`${flexygo.localization.translate("flxWacom.DynCaptureError")}, error ${status}`}}flexygo.msg.error(`${method}(): ${message}`,null,flexygo.localization.translate("flxWacom.titleError"))}captureSignature(){let sigObj,sigCtl,dynCapt,itm=$(this)[0],property=this.property,inputControlToSave=$(this).find("input"),imgControlToSave=$(this).find("img"),jsonTag=null;if(itm.options&&!flexygo.utils.isBlank(itm.options.Tag))try{jsonTag=JSON.parse(itm.options.Tag)}catch(ex){flexygo.msg.warning(`error parsing Tag of ${property} to JSON`)}function onGetSigText(sigObjV,data,status){if(wgssSignatureSDK.ResponseStatus.OK==status){if(jsonTag&&jsonTag.biometric){let biometricField=$(itm).closest("flx-edit").find(`[property = ${jsonTag.biometric}]`);biometricField[0]&&biometricField.val(data)}var vData=wgssSignatureSDK.Variant;vData.type=wgssSignatureSDK.VariantType.VARIANT_BASE64,vData.base64=data}else itm.showError("onGetSigText",status)}function onGetAdditionalData(sigObjV,additionalData,status){wgssSignatureSDK.ResponseStatus.OK==status?sigObjV.GetSigText(onGetSigText):itm.showError("onGetAdditionalData",status)}function onRenderBitmap(sigObjV,bmpObj,status){wgssSignatureSDK.ResponseStatus.OK==status?(bmpObj.isBase64&&(inputControlToSave.attr("value",bmpObj.image.src),imgControlToSave.attr("src",bmpObj.image.src)),sigObjV.GetAdditionalData(wgssSignatureSDK.CaptData.CaptMachineOS,onGetAdditionalData),inputControlToSave.trigger("change"),imgControlToSave.trigger("change")):itm.showError("onRenderBitmap",status)}function onPutExtraData(sigObjV,status){if(wgssSignatureSDK.ResponseStatus.OK==status){var flags=wgssSignatureSDK.RBFlags.RenderOutputPicture|wgssSignatureSDK.RBFlags.RenderColor24BPP;let inkColor=jsonTag&&jsonTag.style&&jsonTag.style.inkColor&&itm.checkRGBStructure(jsonTag.style.inkColor)?itm.convertRGBToOLEColor(jsonTag.style.inkColor):0,bgColor=jsonTag&&jsonTag.style&&jsonTag.style.backgroundColor&&itm.checkRGBStructure(jsonTag.style.backgroundColor)?itm.convertRGBToOLEColor(jsonTag.style.backgroundColor):16777215;sigObjV.RenderBitmap("bmp",$(itm)[0].offsetWidth-20,$(itm)[0].offsetHeight-20,.7,inkColor,bgColor,flags,0,0,onRenderBitmap),sigObj=sigObjV}else itm.showError("onPutExtraData",status)}function onDynCaptCapture(dynCaptV,sigObjV,status){wgssSignatureSDK.ResponseStatus.OK==status?sigObjV.PutExtraData("extra key","extra value",onPutExtraData):1!=status&&itm.showError("onDynCaptCapture",status)}function onSigCtlPutLicence(sigCtlV,status){if(wgssSignatureSDK.ResponseStatus.OK==status){let who=jsonTag&&jsonTag.nameText?jsonTag.nameText:" ",why=jsonTag&&jsonTag.titleText?jsonTag.titleText:" ";if(jsonTag&&jsonTag.titleProperty){let titleField=$(itm).closest("flx-edit").find(`[property = ${jsonTag.titleProperty}]`);titleField[0]&&(why=titleField.val())}if(jsonTag&&jsonTag.nameProperty){let nameField=$(itm).closest("flx-edit").find(`[property = ${jsonTag.nameProperty}]`);nameField[0]&&(who=nameField.val())}dynCapt.Capture(sigCtlV,itm.removeAccents(who),itm.removeAccents(why),null,null,onDynCaptCapture)}else itm.showError("onSigCtlPutLicence",status)}function onSigCtlConstructor(sigCtlV,status){wgssSignatureSDK.ResponseStatus.OK==status?sigCtlV.PutLicence(LICENCEKEY,onSigCtlPutLicence):itm.showError("onSigCtlConstructor",status)}dynCapt=new wgssSignatureSDK.DynamicCapture(function(dynCaptV,status){wgssSignatureSDK.ResponseStatus.OK==status?sigCtl=new wgssSignatureSDK.SigCtl(onSigCtlConstructor):(itm.showError("onDynCaptConstructor",status),wgssSignatureSDK.ResponseStatus.INVALID_SESSION==status&&this.restartSession(this.captureSignature))})}checkRGBStructure(RGBColor){return/^\(\d+,\d+,\d+\)$/.test(RGBColor)}convertRGBToOLEColor(RGBColor){let parsedString=RGBColor.replace("(","").replace(")",""),red=parseInt(parsedString.split(",")[0]),green=parseInt(parsedString.split(",")[1]),blue=parseInt(parsedString.split(",")[2]);const validatedRed=Math.max(0,Math.min(255,red)),validatedGreen=Math.max(0,Math.min(255,green));return(Math.max(0,Math.min(255,blue))<<16)+(validatedGreen<<8)+validatedRed}removeAccents(texto){const mapaAcentos={"á":"a","é":"e","í":"i","ó":"o","ú":"u","Á":"A","É":"E","Í":"I","Ó":"O","Ú":"U","ñ":"n","Ñ":"N","ü":"u","Ü":"U"};return flexygo.utils.isBlank(texto)?" ":texto.replace(/[áéíóúÁÉÍÓÚñÑüÜ]/g,function(match){return mapaAcentos[match]})}triggerDependencies(){let me,input;(input=(me=$(this)).find("input")).trigger("change")}}FlxWacomElement.observedAttributes=["type","property","required","disabled","requiredmessage","class","placeholder","iconclass","helpid","hide"],wc.FlxWacomElement=FlxWacomElement}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-wacom",flexygo.ui.wc.FlxWacomElement);