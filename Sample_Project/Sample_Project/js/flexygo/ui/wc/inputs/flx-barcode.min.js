var flexygo;!function(flexygo){!function(ui){!function(wc){class FlxBarcodeElement extends HTMLElement{constructor(){super(),this.connected=!1,this.type="text",this.property=null,this.options=null,this.value=null}connectedCallback(){let element=$(this),propName=element.attr("property");if(propName&&flexygo.utils.isBlank(this.options)){let parentCtl=element.closest("flx-edit,flx-list,flx-propertymanager,flx-view");if(parentCtl&&parentCtl.length>0){let wcParent=parentCtl[0];this.options=jQuery.extend(!0,{},wcParent.properties[propName])}this.property=propName}void 0!==element.attr("Required")&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequired=!0),void 0!==element.attr("Disabled")&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Locked=!0);let RequiredMessage=element.attr("RequiredMessage");RequiredMessage&&""!==RequiredMessage&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequiredMessage=RequiredMessage);let Style=element.attr("Style");Style&&""!==Style&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Style=Style,element.attr("Control-Style",this.options.Style),element.attr("Style",""));let Class=element.attr("Class");Class&&""!==Class&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=Class,element.attr("Control-Class",this.options.CssClass),element.attr("Class",""));let RegExp=element.attr("RegExp");RegExp&&""!==RegExp&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.RegExp=RegExp);let RegExpText=element.attr("RegExpText");RegExpText&&""!==RegExpText&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.RegExpText=RegExpText);let ValidatorMessage=element.attr("ValidatorMessage");ValidatorMessage&&""!==ValidatorMessage&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.ValidatorMessage=ValidatorMessage);let IconClass=element.attr("IconClass");IconClass&&""!==IconClass&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IconClass=IconClass);let HelpId=element.attr("HelpId");HelpId&&""!==HelpId&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.HelpId=HelpId);let ctlClass=element.attr("Control-Class");ctlClass&&""!==ctlClass&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=ctlClass);let ctlStyle=element.attr("Control-Style");ctlStyle&&""!==ctlStyle&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Style=ctlStyle);let Hide=element.attr("Hide");Hide&&""!==Hide&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Hide="true"==Hide);let BarcodeReaders=element.attr("BarcodeReaders");BarcodeReaders&&""!==BarcodeReaders&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.BarcodeReaders=BarcodeReaders),this.init();let Value=element.attr("Value");Value&&""!==Value&&this.setValue(Value),this.connected=!0}attributeChangedCallback(attrName,oldVal,newVal){let element=$(this);if(this.connected){if("property"===attrName.toLowerCase()&&newVal&&""!==newVal){let propName=newVal,parentCtl=element.closest("flx-edit, flx-filter, flx-list,flx-propertymanager");if(parentCtl&&parentCtl.length>0){let wcParent=parentCtl[0];if(parentCtl.is("flx-filter")){let objName=element.attr("object");this.options=jQuery.extend(!0,{},wcParent.properties[objName+"-"+propName])}else this.options=jQuery.extend(!0,{},wcParent.properties[propName])}this.property=newVal,this.refresh()}"required"===attrName.toLowerCase()&&(this.options||(this.options=new flexygo.api.ObjectProperty),void 0!==element.attr("required")?this.options.IsRequired=!0:this.options.IsRequired=!1,element.find("input[type=text]").prop("required",this.options.IsRequired)),"disabled"===attrName.toLowerCase()&&(this.options||(this.options=new flexygo.api.ObjectProperty),void 0!==element.attr("disabled")?this.options.Locked=!0:this.options.Locked=!1,element.find("input[type=text]").prop("disabled",this.options.Locked)),"requiredmessage"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequiredMessage=newVal,this.refresh()),"style"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Style=newVal,element.attr("Control-Style")!==this.options.Style&&(element.attr("Control-Style",this.options.Style),element.attr("Style",""),this.refresh())),"class"===attrName.toLowerCase()&&element.attr("Control-Class")!==newVal&&newVal!=oldVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=newVal,element.attr("Control-Class")!==this.options.CssClass&&(element.attr("Control-Class",this.options.CssClass),element.attr("Class",this.options.CssClass),this.refresh())),"regexp"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.RegExp=newVal,this.refresh()),"regexptext"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.RegExpText=newVal,this.refresh()),"placeholder"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PlaceHolder=newVal,this.refresh()),"iconclass"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IconClass=newVal,this.refresh()),"helpid"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.HelpId=newVal,this.refresh()),"hide"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Hide=newVal,this.refresh()),"tag"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Tag=newVal,this.refresh()),"barcodereaders"===attrName.toLowerCase()&&newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.BarcodeReaders=newVal)}}refresh(){let val=this.getValue();this.init(),val&&""!==val&&this.setValue(val)}init(){let me=$(this);me.attr("mode")&&"view"===me.attr("mode").toLowerCase()?this.initViewMode():(this.initEditMode(),$(this).find("input[type=text]").off("keydown.tabcontrol").on("keydown.tabcontrol",ev=>{"Tab"!==ev.key&&"Enter"!==ev.key||this.waitToTab($(this))}))}initScanCodeUI(){if(/iPad|iPhone|iPod/.test(navigator.platform))return void flexygo.msg.warning(flexygo.localization.translate("flxBarcode.IOSerr"));let body=$("body");if(body.find(".barcode-scanner").length>0)return;let scannerUI=$(`<div id="barcode-${this.property}" class="barcode-scanner hidden"/>`),scannerBackdrop=$('<div class="barcode-backdrop hidden"/>'),closeBtn=$('<span class="flx-icon icon-close-2 clickable"/>'),scannerLine=$('<div class="scannerLine"/>');body.append(scannerBackdrop),body.append(scannerUI),scannerUI.append("<canvas/>"),scannerUI.append(closeBtn),scannerUI.append(scannerLine),closeBtn.click(()=>{this.closeScanUI()}),scannerBackdrop.click(()=>{this.closeScanUI()}),this.initScanMode()}getOptions(){let readers;return{decoder:{readers:readers=this.options&&this.options.BarcodeReaders?this.options.BarcodeReaders.split("|").map(element=>({format:element,config:{}})):[{format:"code_128_reader",config:{}},{format:"ean_reader",config:{}},{format:"ean_8_reader",config:{}},{format:"code_39_reader",config:{}},{format:"code_39_vin_reader",config:{}},{format:"codabar_reader",config:{}},{format:"upc_reader",config:{}},{format:"upc_e_reader",config:{}},{format:"i2of5_reader",config:{}},{format:"2of5_reader",config:{}},{format:"code_93_reader",config:{}}]},frequency:10,inputStream:{constraints:{aspectRatio:{min:1,max:100},facingMode:"environment",height:{min:480},width:{min:640}},type:"ImageStream"},lastResult:null,locate:!0,locator:{halfSample:!0,patchSize:"medium"},numOfWorkers:2}}initScanMode(){Quagga.init(this.getOptions(),err=>{if(err)return $(".barcode-scanner").remove(),$(".barcode-backdrop").remove(),void flexygo.msg.warning(flexygo.localization.translate("flxBarcode.noCamera"));$("body").addClass("barcodeLock"),$(".barcode-backdrop").removeClass("hidden"),$(`#barcode-${this.property}`).removeClass("hidden"),Quagga.start()});let lastValue="";Quagga.offDetected(),Quagga.onDetected(result=>{var code=result.codeResult.code;code===lastValue?(this.setValue(code),this.closeScanUI(),$(this).find("input[type=text]").trigger("change"),this.waitToTab($(this))):lastValue=code})}waitToTab(div){let flxEdit=$(this).closest("flx-edit");var dependenciesLoad=setInterval(()=>{0===flxEdit.find(".item #flx-dependency-loader, .grid-stack-item #flx-dependency-loader").length&&($(this).find("> div").hasClass("has-error")||this.tabToNext(div,flxEdit),clearInterval(dependenciesLoad))},200)}tabToNext(div,flxEdit){let posX,posY;div.hasClass("grid-stack-item")||(div=div.closest(".grid-stack-item")),posX=div.attr("data-gs-x"),posY=div.attr("data-gs-y");let items=flxEdit.find(".grid-stack-item"),greaterPositions=items.map(index=>{let itemXPos=items[index].getAttribute("data-gs-x"),itemYPos=items[index].getAttribute("data-gs-y");if(itemYPos>posY||itemYPos===posY&&itemXPos>posX)return{x:itemXPos,y:itemYPos}}).sort(this.orderStackItems);if(0===greaterPositions.length)return void flxEdit.closest("flx-module").find(".cntBodyFooter  .saveButton").focus();let container=$(`[data-gs-x="${greaterPositions[0].x}"][data-gs-y="${greaterPositions[0].y}"]`),input=container.find(':not(flx-dbcombo > div, flx-dbcombo > ul > div) > input:not(.hiddden, [disabled], .onoffswitch-checkbox), flx-dbcombo:not([disabled]) :not( ul > div) > input[type="search"]:not(.hiddden, [disabled], .onoffswitch-checkbox), select:not(.hiddden), textarea:not(.hiddden, [disabled])');input.length>0?input.focus().select():this.tabToNext(container,flxEdit)}orderStackItems(a,b){return a.y>b.y||a.y===b.y&&a.x>b.x?1:-1}closeScanUI(){$(".barcode-scanner").remove(),$(".barcode-backdrop").remove(),$("body").removeClass("barcodeLock"),Quagga.stop()}initViewMode(){let iconsLeft,me=$(this),control=$("<div>");me.html(control);let input=$('<label class="form-control input-view" />');this.options&&this.options.IconClass&&""!==this.options.IconClass&&(iconsLeft=$('<span class="input-group-addon" ><i class="'+this.options.IconClass+'" /></span>'),control.append(iconsLeft)),control.append(input),iconsLeft&&control.addClass("input-group"),this.options&&this.options.Style&&me.children("div").attr("style",this.options.Style),this.options&&this.options.CssClass&&me.children("div").addClass(this.options.CssClass),this.options&&this.options.Hide&&me.addClass("hideControl")}initEditMode(){let iconsLeft,me=$(this),iconsRight=this.getIconButtons(),control=$("<div>"),input=$('<input type="text" class="form-control" />');input.on("blur",e=>{me.trigger("blur")}),this.options&&this.options.IconClass&&""!==this.options.IconClass&&(iconsLeft=$('<span class="input-group-addon" ><i class="'+this.options.IconClass+'" /></span>')),iconsLeft&&control.append(iconsLeft),control.append(input),iconsRight&&iconsRight.length>0&&control.append(iconsRight),(iconsLeft||iconsRight&&iconsRight.length>0)&&control.addClass("input-group"),me.html(control),this.setOptions(),$(this).find("input[type=file]").on("change",e=>{if(e.target.files&&e.target.files.length){let options=this.getOptions(),config=$.extend({},options,{src:URL.createObjectURL(e.target.files[0])});Quagga.decodeSingle(config,result=>{if(result&&result.codeResult&&result.codeResult.code){var code=result.codeResult.code;this.setValue(code),$(this).find("input[type=text]").trigger("change"),this.waitToTab($(this))}else flexygo.msg.warning(flexygo.localization.translate("flxBarcode.noCode"))})}})}getIconButtons(){let ret=$('<div class="input-group-btn" />'),editCtl=$(this).closest("flx-edit, flx-list")[0],parseEdit=function(val,ctx,property){return val};editCtl&&editCtl.parseEditString&&editCtl.parseEditString;let scanIcon=$('<button class="btn btn-default" type="button"><i class="flx-icon icon-barcode-1" /></button>').on("click",e=>{this.initScanCodeUI()});return scanIcon=$('<label class="btn upload-btn">\n                <i class="flx-icon icon-barcode-1"></i><input type="file" accept="image/*;capture=camera" capture class="hide" multiple/>\n            </label>'),ret.append(scanIcon),""===ret.html()?null:ret}setOptions(){let me=$(this),input=me.find("input[type=text]");input.on("change.refreshvalue",e=>{me.attr("value",input.val())}),this.options&&this.options.Name&&""!==this.options.Name?input.attr("name",this.options.Name):input.attr("name",flexygo.utils.uniqueName()),me.attr("tab")&&""!==me.attr("tab")&&input.attr("tabindex",me.attr("tab")),this.options&&this.options.Locked&&(input.prop("disabled",this.options.Locked),me.attr("disabled","disabled")),this.options&&this.options.PlaceHolder&&input.attr("PlaceHolder",this.options.PlaceHolder),this.options&&this.options.Style&&me.children("div").attr("style",this.options.Style),this.options&&this.options.CssClass&&me.children("div").addClass(this.options.CssClass),this.options&&this.options.IsRequired&&input.prop("required",this.options.IsRequired),this.options&&this.options.IsRequiredMessage&&input.attr("data-msg-required",this.options.IsRequiredMessage);const module=me.closest("flx-module")[0];(this.options&&(this.options.CauseRefresh||this.options.SQLValidator)||module&&module.moduleConfig&&module.moduleConfig.PropsEventDependant&&module.moduleConfig.PropsEventDependant.includes(this.property))&&input.on("change",e=>{if(this.options&&"decimal"==this.options.ControlType&&this.getValue()){let oldValue=input[0].value;input.val(""),input.val(parseFloat(oldValue))}let ev={class:"property",type:"changed",sender:this,masterIdentity:this.property};flexygo.events.trigger(ev,me),$(this).find("input[type=text].error").length>0&&($(this).find("> div").addClass("has-error"),$(this).find("> div > label").addClass("has-error txt-danger"))}),this.options&&this.options.RegExp&&""!==this.options.RegExp&&input.attr("regex",this.options.RegExp),this.options&&this.options.RegExpText&&""!==this.options.RegExpText&&input.attr("data-msg-regex",this.options.RegExpText),this.options&&this.options.ValidatorMessage&&""!==this.options.ValidatorMessage&&input.attr("data-msg-sqlvalidator",this.options.ValidatorMessage),this.options&&this.options.Hide&&me.addClass("hideControl"),input.attr("autocomplete","off")}setValue(value){let me=$(this);if(me.attr("mode")&&"view"===me.attr("mode").toLowerCase())this.setValueView(value),me.attr("value",value);else{let input=me.find("input[type=text]");me.attr("value",value),input.val(value)}}setValueView(value){this.value=value;let input=$(this).find("label");null!==value&&/[&<>"'`=\/]/im.test(value)&&(value=flexygo.string.escapeHTML(value)),input.html(value)}getValue(){let me=$(this);if(me.attr("mode")&&"view"===me.attr("mode").toLowerCase())return this.value;let input=me.find("input[type=text]");return""===input.val()?null:input.val()}triggerDependencies(){let me,input;(input=(me=$(this)).find("input[type=text]")).trigger("change")}}FlxBarcodeElement.observedAttributes=["type","property","required","disabled","requiredmessage","mask","style","class","decimalplaces","minvalue","maxvalue","maxvaluemessage","minvaluemessage","regexp","regexptext","validatormessage","placeholder","iconclass","helpid","allownewfunction","allownewobject","hide","tag","barcodereaders"],wc.FlxBarcodeElement=FlxBarcodeElement}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-barcode",flexygo.ui.wc.FlxBarcodeElement);