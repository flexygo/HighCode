var flexygo;!function(flexygo){!function(ui){!function(wc){class FlxCodeElement extends HTMLElement{constructor(){super(),this.type="html",this.options=null,this.moduleName=null,this.editor="codemirror",this.intellisense="online",this.libraryLoaded=!1,this.readonly=!1,this.inTemplate=!1,this.help=!1,this.myCM=null,this.value=null,this.connected=!1}connectedCallback(){let element=$(this);"undefined"!=typeof monaco&&(this.editor="monaco");let mode=element.attr("mode");flexygo.utils.isBlank(mode)?this.renderMode="edit":this.renderMode=mode.toLowerCase(),this.type=element.attr("type")||"html","true"!=($(this).attr("forcecodemirror")||"").toLowerCase()&&"preview"!=this.renderMode||(this.editor="codemirror");let propName=element.attr("property");if(propName&&flexygo.utils.isBlank(this.options)){let parentCtl=element.closest("flx-edit,flx-list,flx-propertymanager,flx-view,flx-filter");if(parentCtl&&parentCtl.length>0){let wcParent=parentCtl[0];if(parentCtl.is("flx-filter")){let objName=element.attr("object");this.options=jQuery.extend(!0,{},wcParent.properties[objName+"-"+propName])}else this.options=jQuery.extend(!0,{},wcParent.properties[propName])}this.property=propName}else $(this.closest(".flxhelp")).length>0&&(this.editor="codemirror",this.help=!0);this.inTemplate=!!element.attr("template"),this.width=element.attr("width"),element.removeAttr("width"),this.height=element.attr("height")?element.attr("height"):"300px",element.removeAttr("height"),element.attr("editor",this.editor),void 0!==element.attr("Required")&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequired=!0),void 0!==element.attr("Disabled")&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Locked=!0);let RequiredMessage=element.attr("RequiredMessage");RequiredMessage&&""!=RequiredMessage&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequiredMessage=RequiredMessage);let Class=element.attr("Theme");Class&&""!=Class&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=Class);let PlaceHolder=element.attr("PlaceHolder");PlaceHolder&&""!=PlaceHolder&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PlaceHolder=PlaceHolder);let IconClass=element.attr("IconClass");IconClass&&""!=IconClass&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IconClass=IconClass);let HelpId=element.attr("HelpId");HelpId&&""!=HelpId&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.HelpId=HelpId);let Hide=element.attr("Hide");Hide&&""!=Hide&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Hide="true"==Hide);let MaxNumOfChars=element.attr("MaxNumOfChars");MaxNumOfChars&&""!==MaxNumOfChars&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.MaxNumOfChars=parseInt(MaxNumOfChars));const SearchFunction=element.attr("SearchFunction");SearchFunction&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.SearchFunction=SearchFunction);const ChatGPTSettingId=element.attr("ChatGPTSettingId");ChatGPTSettingId&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.ChatGPTSettingId=ChatGPTSettingId);let val=element.html();if(this.help=$(element)[0].hasAttribute("help"),!this.connected){"codemirror"==this.editor?this.initCodeMirror():this.initMonaco(),this.connected=!0;let Value=element.attr("Value");Value&&""!=Value?this.setValue(Value):val&&""!=val&&this.setValue(val)}}static setTypeScriptLibraries(libraries){this.typeScriptLibraries=libraries}static setOfflineLibraries(libraries){this.offlineLibraries=libraries}static setHtmlStyles(styles){this.htmlStyles=styles}static getTypeScriptLibraries(){return this.typeScriptLibraries}static getOfflineLibraries(){return this.offlineLibraries}static getHtmlStyles(){return this.htmlStyles}attributeChangedCallback(attrName,oldVal,newVal){let element=$(this);if(this.connected&&oldVal!=newVal){if("type"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.type=newVal),"property"==attrName.toLowerCase()&&newVal&&""!=newVal){let propName=newVal,parentCtl=element.closest("flx-edit, flx-list,flx-propertymanager");if(parentCtl&&parentCtl.length>0){let wcParent=parentCtl[0];this.options=jQuery.extend(!0,{},wcParent.properties[propName])}this.property=newVal}"required"==attrName.toLowerCase()&&(this.options||(this.options=new flexygo.api.ObjectProperty),void 0!==element.attr("required")?this.options.IsRequired=!0:this.options.IsRequired=!1,"codemirror"==this.editor?element.find("textarea").prop("required",this.options.IsRequired):element.find("input").prop("required",this.options.IsRequired)),"disabled"==attrName.toLowerCase()&&(this.options||(this.options=new flexygo.api.ObjectProperty),void 0!==element.attr("disabled")?this.options.Locked=!0:this.options.Locked=!1,element.find("textarea").prop("disabled",this.options.Locked)),"requiredmessage"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequiredMessage=newVal),"theme"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=newVal),"placeholder"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PlaceHolder=newVal),"iconclass"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IconClass=newVal),"helpid"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.HelpId=newVal),"hide"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Hide=newVal),this.connected&&this.refresh()}}refresh(){let val=this.getValue();"codemirror"==this.editor?this.initCodeMirror():(this.monaco&&this.monaco.dispose(),this.initMonaco()),val&&""!=val&&this.setValue(val)}initMonaco(){var _a;let me=$(this);if(me.attr("mode")&&"view"==me.attr("mode").toLowerCase())this.readonly=!0;else if(this.readonly=!1,"sql"==this.type&&0==(null===(_a=$(document.head).find('script[ID="sqlFormat"]'))||void 0===_a?void 0:_a.length)&&($(document.head).append(`<script id="sqlFormat" defer src="${flexygo.utils.resolveUrl("~/js/plugins/sql-formatter/sql-formatter.min.js")}"/>`),me.closest("flx-edit").length>0&&!flexygo.utils.isBlank(me.closest("flx-edit").attr("objectname"))&&!flexygo.utils.isBlank(me.closest("flx-edit").attr("objectwhere")))){let context=new flexygo.obj.Entity(me.closest("flx-edit").attr("objectname"),me.closest("flx-edit").attr("objectwhere"));context.read(),me.attr("ConnStringId",context.data.ConnStringId?context.data.ConnStringId.Value:context.getConfig().ConnStringId)}if(this.height&&$(this).css("height",this.height),this.width&&$(this).css("width",this.width),this.options&&this.options.Tag)try{let intellisenseConfig=JSON.parse(this.options.Tag);"boolean"==typeof intellisenseConfig.intellisense&&0==intellisenseConfig.intellisense?this.intellisense="none":flexygo.utils.isBlank(intellisenseConfig.intellisense)||(this.intellisense=intellisenseConfig.intellisense.toLowerCase()),this.intellisense="online"==this.intellisense||"offline"==this.intellisense?this.intellisense:"none"}catch(ex){console.log("Error: "+ex.message)}let rnd=$(`<input class="hidden"></input><div class="wizardButtons">${this.getWizardButton()}</div>`+'<div class="monaco-placeholder"></div><div class="superContainer"><div class="monacoContainer"></div></div>');me.html(rnd),this.setButtonsSettings(this),this.options&&this.options.Locked&&(this.readonly=this.options.Locked),this.options&&this.options.PlaceHolder&&(me.attr("placeholder",this.options.PlaceHolder),this.inTemplate&&$(me).find(".superContainer").css("margin-top","-19px")),this.setOptions(),this.setCodeEditor()}setCodeEditor(){var _a;let me=this;this.monaco&&this.monaco.dispose();let language=0!=monaco.languages.getEncodedLanguageId(me.type)?me.type:null===(_a=monaco.languages.getLanguages().find(lang=>lang.aliases&&lang.aliases.includes(me.type)))||void 0===_a?void 0:_a.id;this.monaco=monaco.editor.create($(me).find(".monacoContainer")[0],{value:flexygo.utils.isBlank(me.value)?"":me.value,language,theme:"dark"==$(document.body).attr("mode")?"vs-dark":"vs",readOnly:this.readonly,minimap:{enabled:!1},automaticLayout:!0});if(new MutationObserver((mutationsList,observer)=>{for(const mutation of mutationsList)if("childList"===mutation.type&&mutation.addedNodes.length>0){mutation.addedNodes.forEach(value=>{$(value).hasClass("view-line")&&me.adjustPlaceHolder($(value))}),observer.disconnect();break}}).observe($(me).find(".monacoContainer")[0],{childList:!0,subtree:!0}),this.monaco.onDidLayoutChange(e=>{me.adjustPlaceHolder($(this).find(".view-line"))}),this.monaco.onDidFocusEditorWidget(()=>{let librariesCount=Object.keys(monaco.languages.typescript.javascriptDefaults.getExtraLibs()).length;if("js"==me.type)if("online"==me.intellisense){if(!this.libraryLoaded){let libraries=flexygo.ui.wc.FlxCodeElement.getTypeScriptLibraries();monaco.languages.typescript.javascriptDefaults.setExtraLibs(libraries),this.libraryLoaded=!0}}else if("offline"==me.intellisense){if(!this.libraryLoaded){let libraries=flexygo.ui.wc.FlxCodeElement.getOfflineLibraries();monaco.languages.typescript.javascriptDefaults.setExtraLibs(libraries),this.libraryLoaded=!0}}else 0!==librariesCount&&monaco.languages.typescript.javascriptDefaults.setExtraLibs(null);flexygo.utils.isBlank($(me).attr("placeholder"))||me.readonly||$(me).find(".monaco-placeholder").addClass("focused")}),$(this).off("mousedown.flxcode").on("mousedown.flxcode",e=>{2===e.button&&$(me).addClass("openingContextMenu")}),this.monaco.onDidBlurEditorWidget(()=>{if(!$(me).hasClass("openingContextMenu")){let oldValue=me.value,newValue=me.monaco.getValue();flexygo.utils.isBlank($(me).attr("placeholder"))||me.readonly||$(me).find(".monaco-placeholder").removeClass("focused"),oldValue!=newValue&&($(me).find("input").val(newValue),me.value=newValue,me.triggerDependencies())}}),this.monaco.onContextMenu(()=>{$(me).removeClass("openingContextMenu")}),$(this).find(".superContainer")[0].style.backgroundColor=this.monaco._themeService._theme.getColor("editor.background")._toString,flexygo.utils.isBlank($(this).attr("placeholder"))||($($(this).find(".monaco-placeholder")[0]).html(`<span style="font-family:${this.monaco.getOption(monaco.editor.EditorOption.fontInfo).fontFamily}">${$(this).attr("placeholder")}</span>`),flexygo.utils.isBlank(me.monaco.getValue())?$(me).find(".monaco-placeholder").removeClass("focused"):$(me).find(".monaco-placeholder").addClass("focused")),this.readonly){let message=this.options&&this.options.Locked&&"view"!==$(this).attr("mode")?flexygo.localization.translate("flxcode.propertyLocked"):flexygo.localization.translate("flxcode.readonlyMode");$(this).tooltip({title:message,trigger:"manual",delay:{show:0,hide:5e3}}),this.monaco.onDidAttemptReadOnlyEdit(e=>{me.monaco.getContribution("editor.contrib.messageController").showMessage("",me.monaco.getPosition()),0==$(this).next("div.tooltip:visible").length&&($(this).tooltip("show"),setTimeout(function(){$(me).tooltip("hide")},1e3))})}if($(me).find("input").val(me.monaco.getValue()),"sql"==this.type){this.monaco.addAction({id:"format_sql",label:"Format Document",keybindings:[monaco.KeyMod.Shift|monaco.KeyMod.Alt|monaco.KeyCode.KeyF],precondition:"!editorReadonly && !inCompositeEditor",contextMenuGroupId:"1_modification",contextMenuOrder:1.2,run:function(){let newText=require("js/plugins/sql-formatter/sql-formatter.js").format(me.monaco.getValue(),{language:"transactsql",keywordCase:"upper"});me.monaco.executeEdits(null,[{text:newText,range:me.monaco.getModel().getFullModelRange()}])}});var contextKey=this.monaco.createContextKey("contentSelected",!1);this.monaco.onContextMenu(function(){let condition=!flexygo.utils.isBlank(me.monaco.getModel().getValueInRange(me.monaco.getSelection()));contextKey.set(condition)}),this.monaco.addAction({id:"format_selection_sql",label:"Format Selection",keybindings:[monaco.KeyMod.chord(monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyK,monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyF)],precondition:"contentSelected && !editorReadonly",contextMenuGroupId:"1_modification",contextMenuOrder:1.3,run:function(){let sqlFormatter=require("js/plugins/sql-formatter/sql-formatter.js");me.monaco.getSelections().forEach(e=>{let text=me.monaco.getModel().getValueInRange(e);try{text=sqlFormatter.format(text,{language:"transactsql",keywordCase:"upper"})}catch(ex){}me.monaco.getModel().pushEditOperations([],[{range:e,text,forceMoveMarkers:!0}],null)})}})}this.monaco.addAction({id:"fullscreen_action",label:"Flexygo: Toggle fullscreen",keybindings:[monaco.KeyCode.F11],contextMenuGroupId:"navigation",contextMenuOrder:1.5,run:function(){me.fullscreen()}}),this.monaco.addAction({id:"custom-esc",label:"Close",keybindings:[monaco.KeyCode.Escape],precondition:"!suggestWidgetVisible && !markersNavigationVisible && !findWidgetVisible",run:function(){let inFullscreen=$("flx-code.fullscreen");inFullscreen.length>0&&($(inFullscreen[0]).removeClass("fullscreen"),inFullscreen[0].monaco.layout())}})}adjustPlaceHolder(node){if(this.options&&this.options.PlaceHolder&&(null==node?void 0:node.length)>0){let placeholder=$(this).find(".monaco-placeholder"),placeholderHidden=placeholder.hasClass("focused");placeholderHidden&&$(this).find(".monaco-placeholder").removeClass("focused");let nodeRects=node[0].getBoundingClientRect();placeholder.css({width:nodeRects.width,height:nodeRects.height}),placeholder.offset({top:nodeRects.top,left:nodeRects.left}),placeholderHidden&&placeholder.addClass("focused")}}initCodeMirror(){var _a;let me=$(this);me.attr("mode")&&"view"==me.attr("mode").toLowerCase()||this.help?this.readonly=!0:this.readonly=!1;let txtArea='<textarea style="min-height:100%;width:100%;"></textarea>';this.help?"true"==(null===(_a=$(this).attr("returnEnabled"))||void 0===_a?void 0:_a.toLowerCase())?me.append(this.getHeadBar()).append($(txtArea)):me.html($(txtArea)):me.html($(this.getWizardButton()+txtArea)),!this.help&&this.setButtonsSettings(this),me.attr("onchange")&&""!=me.attr("onchange")&&((void 0).off("change"),(void 0).on("change",()=>{flexygo.utils.execDynamicCode.call(this,me.attr("onchange"))})),this.options&&this.options.Locked&&(this.readonly=this.options.Locked),this.options&&this.options.PlaceHolder&&me.attr("placeholder",this.options.PlaceHolder);let theme="freeware";this.options&&this.options.CssClass&&""!=this.options.CssClass&&(theme=this.options.CssClass),setTimeout(()=>{if(this.myCM){null!=this.myCM.getTextArea().parentNode&&this.myCM.toTextArea()}let options={mode:this.getMode(),styleActiveLine:!0,matchBrackets:!0,readOnly:this.readonly,lineNumbers:!0,placeholder:me.attr("placeholder"),theme,scrollbarStyle:"overlay",highlightSelectionMatches:{showToken:/\w/,annotateScrollbar:!1},extraKeys:{F11:cm=>{let isFS=!cm.getOption("fullScreen");cm.setOption("fullScreen",isFS),me.attr("isFS",String(isFS))},Esc:cm=>{cm.getOption("fullScreen")&&cm.setOption("fullScreen",!1),me.attr("isFS","false")}}};"javascript"==options.mode&&(options.lint=!0,options.gutters=["CodeMirror-lint-markers"]),this.myCM=CodeMirror.fromTextArea(me.find("textarea")[0],options);let maxnumofchars=0;this.options&&this.options.MaxNumOfChars&&this.options.MaxNumOfChars>0&&(maxnumofchars=this.options.MaxNumOfChars),this.myCM.enforceMaxLength=function(cm,change){var maxLength=maxnumofchars;if(maxLength&&change.update){var str=change.text.join("\n"),delta=str.length-(cm.indexFromPos(change.to)-cm.indexFromPos(change.from));if(delta<=0)return!0;(delta=cm.getValue().length+delta-maxLength)>0&&(str=str.substr(0,str.length-delta),change.update(change.from,change.to,str.split("\n")))}return!0},this.myCM.setOption("maxLength",maxnumofchars),this.myCM.on("beforeChange",this.myCM.enforceMaxLength),this.myCM.on("blur",cm=>{let oldValue=cm.getTextArea().value,newValue=cm.getValue();me.find("textarea").val(newValue),oldValue!=newValue&&this.triggerDependencies()})},500),this.setOptions()}setOptions(){let me=$(this),input="monaco"==this.editor?me.find("input"):me.find("textarea");this.options&&this.options.Name&&""!=this.options.Name?input.attr("name",this.options.Name):input.attr("name",flexygo.utils.uniqueName()),me.attr("tab")&&""!=me.attr("tab")&&input.attr("tabindex",me.attr("tab")),this.options&&this.options.IsRequired&&input.prop("required",this.options.IsRequired),this.options&&this.options.IsRequiredMessage&&input.attr("data-msg-required",this.options.IsRequiredMessage);const module=me.closest("flx-module")[0];(this.options&&this.options.CauseRefresh||module&&module.moduleConfig&&module.moduleConfig.PropsEventDependant&&module.moduleConfig.PropsEventDependant.includes(this.property))&&input.on("change",()=>{let ev={class:"property",type:"changed",sender:this,masterIdentity:this.property};flexygo.events.trigger(ev,me)}),this.options&&this.options.Hide&&me.addClass("hideControl")}getValue(){return"monaco"==this.editor?this.monaco?this.monaco.getValue():this.value?this.value:"":$(this).find("textarea").val()}setValue(value){flexygo.utils.isBlank(value)||(value=String(value)),"monaco"==this.editor?(this.monaco&&($(this).find("input").val(value),this.monaco&&(null==value&&(value=""),this.monaco.setValue(value))),this.value=value):($(this).find("textarea").val(value),this.myCM&&(null==value&&(value=""),this.myCM.getDoc().setValue(value)))}setValueWithHistory(value){flexygo.utils.isBlank(value)||(value=String(value)),"monaco"==this.editor&&this.monaco?(this.monaco.executeEdits(null,[{text:value,range:this.monaco.getModel().getFullModelRange()}]),this.value=value):this.setValue(value)}setValueView(value){let me=$(this);this.value=value,me.find("label").html(flexygo.string.escapeHTML(value))}fullscreen(value){"monaco"==this.editor?($(this).toggleClass("fullscreen"),this.monaco.layout()):(void 0===value&&(value=!0),value&&$("flx-code[isFS=true]").each((i,e)=>{e.myCM.setOption("fullScreen",!1),$(e).attr("isFS","false")}),this.myCM.setOption("fullScreen",value),$(this).attr("isFS",value))}getMode(){let type=$(this).attr("type");switch(type&&(type=type.toLowerCase()),type){case"html":return"htmlmixed";case"js":return"javascript";case"css":return"css";case"sql":return"text/x-mssql";case"csharp":return"text/x-csharp";case"plaintext":return"text/plain";case"json":return"application/json";default:return null}}getWizardButton(){var _a,_b,_c;let temButtons="";return(null===(_a=this.options)||void 0===_a?void 0:_a.SearchFunction)&&(temButtons=`<button class="btn btn-assistant" type= "button" name="wizardBtn" title= "${flexygo.localization.translate("viewmanager.openwizard")}"><i class="flx-icon icon-wizard-1"></i></button>`),(null===(_b=this.options)||void 0===_b?void 0:_b.AllowNewFunction)&&(temButtons+=`<button class="btn btn-assistant" type= "button" name="helpButton" title= "${flexygo.localization.translate("templates.openiconlist")}"><i class="flx-icon icon-images"></i></button>`),(null===(_c=this.options)||void 0===_c?void 0:_c.ChatGPTSettingId)&&(temButtons+='<button class="btn btn-assistant" type= "button" name="AIButton" title="Lowdy"><i class="flx-icon icon-roboto-logo"></i></button>'),temButtons}getHeadBar(){var _a;let headBar,me=this;if($(this).closest("flx-ai").length>0){let aiElement=$(this).closest("flx-ai")[0];headBar=$(`<div class="flx-headBar" >\n                                <span class="headBar-language">${this.type}</span>\n                                <button class="${void 0!==aiElement.targetItem&&$(null===(_a=aiElement.targetItem)||void 0===_a?void 0:_a.context).is("button")?"flx-icon icon-return-2":"flx-icon icon-copy"} copy_response icon-zoom-115 headbar-button" type="button"></button>\n                            </div>`),$(headBar).find(".headbar-button").off("click.headBarAction").on("click.headBarAction",function(){var _a;void 0!==aiElement.targetItem&&$(null===(_a=aiElement.targetItem)||void 0===_a?void 0:_a.context).is("button")?(aiElement.targetItem.is("flx-code")?aiElement.targetItem[0].setValueWithHistory(me.getValue()):aiElement.targetItem.val(me.getValue()),$(aiElement).find(".chat_ai_close").click()):flexygo.utils.copyClipboard(me.getValue())})}return headBar}triggerReturnEvent(context){var ev={class:"codeProperty",type:"returnAction",sender:context};flexygo.events.trigger(ev)}setButtonsSettings(m){let wizardBtn=$(this).find('[name="wizardBtn"]'),helpButton=$(this).find('[name="helpButton"]'),AIButton=$(this).find('[name="AIButton"]');"flx-edit"==$(this).closest("flx-module").attr("type")?(wizardBtn.show(),helpButton.show(),AIButton.show()):"flx-view"==$(this).closest("flx-module").attr("type")&&(wizardBtn.hide(),helpButton.hide(),AIButton.hide()),wizardBtn.on("click",function(){flexygo.utils.execDynamicCode.call(m,m.options.SearchFunction)}),helpButton.on("click",function(){flexygo.utils.execDynamicCode.call(m,m.options.AllowNewFunction)}),AIButton.on("click",function(){let options={TargetItem:$(this).closest("flx-code")};flexygo.ui.wc.FlxAIElement.prototype.open(options)})}triggerDependencies(){let me,input;me=$(this),(input="monaco"==this.editor?me.find("input"):me.find("textarea")).trigger("change")}}FlxCodeElement.observedAttributes=["type","property","required","disabled","requiredmessage","theme","placeholder","iconclass","helpid","hide"],wc.FlxCodeElement=FlxCodeElement}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-code",flexygo.ui.wc.FlxCodeElement);