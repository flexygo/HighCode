var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxTagElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.type="text",this.options=null,this.dropOptions=null,this.property=null,this.value=null,this.isDefaultValue=!0}connectedCallback(){let element=$(this);this.type=element.attr("type")||"text";let propName=element.attr("property");if(propName&&flexygo.utils.isBlank(this.options)){let parentCtl=element.closest("flx-edit,flx-list,flx-propertymanager,flx-view,flx-filter");if(parentCtl&&parentCtl.length>0){let wcParent=parentCtl[0];if(parentCtl.is("flx-filter")){let objName=element.attr("object");this.options=jQuery.extend(!0,{},wcParent.properties[objName+"-"+propName])}else this.options=jQuery.extend(!0,{},wcParent.properties[propName])}this.property=propName}void 0!==element.attr("Required")&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequired=!0);let Separator=element.attr("Separator");Separator&&""!==Separator?(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Separator=Separator):(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Separator||(this.options.Separator=";")),void 0!==element.attr("Disabled")&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Locked=!0);let RequiredMessage=element.attr("RequiredMessage");RequiredMessage&&""!==RequiredMessage&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequiredMessage=RequiredMessage);let Style=element.attr("Style");Style&&""!==Style&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Style=Style,element.attr("Control-Style",this.options.Style),element.attr("Style",""));let Class=element.attr("Class");Class&&""!==Class&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=Class,element.attr("Control-Class",this.options.CssClass),element.attr("Class",""));let PlaceHolder=element.attr("PlaceHolder");PlaceHolder&&""!==PlaceHolder&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PlaceHolder=PlaceHolder);let IconClass=element.attr("IconClass");IconClass&&""!==IconClass&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IconClass=IconClass);let Options=element.find("option");if(Options.length>0){this.options||(this.options=new flexygo.api.ObjectProperty),this.dropOptions=[];for(let i=0;i<Options.length;i++){let text=$(Options[i]).text(),value=$(Options[i]).val();null==text&&(text=value),this.dropOptions.push(text)}Options.remove()}let ctlClass=element.attr("Control-Class");ctlClass&&""!==ctlClass&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=ctlClass);let ctlStyle=element.attr("Control-Style");ctlStyle&&""!==ctlStyle&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Style=ctlStyle);let Hide=element.attr("Hide");Hide&&""!==Hide&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Hide="true"==Hide);let RegExp=element.attr("RegExp");RegExp&&""!==RegExp&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.RegExp=RegExp);let RegExpText=element.attr("RegExpText");RegExpText&&""!==RegExpText&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.RegExpText=RegExpText),this.init();let Value=element.attr("Value");Value&&""!==Value&&this.setValue(Value),this.isDefaultValue=!1,this.connected=!0}static get observedAttributes(){return["type","property","required","separator","disabled","requiredmessage","style","class","placeholder","iconclass","hide","regexp","regexptext"]}attributeChangedCallback(attrName,oldVal,newVal){let element=$(this);if(this.connected){if("type"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.type=newVal,this.refresh()),"property"===attrName.toLowerCase()&&newVal&&""!==newVal){let propName=newVal,parentCtl=element.closest("flx-edit, flx-list,flx-propertymanager");if(parentCtl&&parentCtl.length>0){let wcParent=parentCtl[0];this.options=jQuery.extend(!0,{},wcParent.properties[propName])}this.property=newVal,this.refresh()}"required"===attrName.toLowerCase()&&(this.options||(this.options=new flexygo.api.ObjectProperty),void 0!==element.attr("required")?this.options.IsRequired=!0:this.options.IsRequired=!1,element.find("div:not(.bootstrap-tagsinput)>input").prop("required",this.options.IsRequired)),"separator"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Separator=newVal,this.refresh()),"disabled"===attrName.toLowerCase()&&(this.options||(this.options=new flexygo.api.ObjectProperty),void 0!==element.attr("disabled")?this.options.Locked=!0:this.options.Locked=!1,element.find("input").prop("disabled",this.options.Locked)),"requiredmessage"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IsRequiredMessage=newVal,this.refresh()),"style"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Style=newVal,element.attr("Control-Style")!==this.options.Style&&(element.attr("Control-Style",this.options.Style),element.attr("Style",""),this.refresh())),"class"===attrName.toLowerCase()&&element.attr("Control-Class")!==newVal&&newVal!=oldVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.CssClass=newVal,element.attr("Control-Class")!==this.options.CssClass&&(""!=newVal&&(element.attr("Control-Class",this.options.CssClass),element.attr("Class",this.options.CssClass)),this.refresh())),"placeholder"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.PlaceHolder=newVal,this.refresh()),"iconclass"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.IconClass=newVal,this.refresh()),"hide"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.Hide=newVal,this.refresh()),"regexp"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.RegExp=newVal,this.refresh()),"regexptext"===attrName.toLowerCase()&&newVal&&""!==newVal&&(this.options||(this.options=new flexygo.api.ObjectProperty),this.options.RegExpText=newVal,this.refresh())}}refresh(){let val=this.getValue();this.init(),val&&""!==val&&this.setValue(val)}init(){let me=$(this);me.attr("mode")&&"view"===me.attr("mode").toLowerCase()?this.initViewMode():this.initEditMode()}initViewMode(){let iconsLeft,iconsRight,me=$(this);if(this.options&&this.options.ObjNameLink&&this.options.ObjWhereLink){let editCtl=me.closest("flx-view")[0];iconsRight=$('<div class="input-group-btn" />');let icon1=$('<button class="btn btn-default" type="button"><i class="flx-icon icon-link" /></button>').on("click",e=>{flexygo.nav.openPage("view",editCtl.parseEditString(this.options.ObjNameLink),editCtl.parseEditString(this.options.ObjWhereLink),null,this.options.TargetIdLink)});iconsRight.append(icon1)}let control=$("<div>");me.html(control);let input=$('<label class="form-control input-view" />');this.options&&this.options.IconClass&&""!==this.options.IconClass&&(iconsLeft=$('<span class="input-group-addon" ><i class="'+this.options.IconClass+'" /></span>'),control.append(iconsLeft)),control.append(input),iconsRight&&control.append(iconsRight),(iconsLeft||iconsRight)&&control.addClass("input-group"),this.options&&this.options.Style&&me.children("div").attr("style",this.options.Style),this.options&&this.options.CssClass&&me.children("div").addClass(this.options.CssClass),this.options&&this.options.Hide&&me.addClass("hideControl")}initEditMode(){let iconsLeft,me=$(this),iconsRight=this.getIconButtons(),control=$("<div>"),input=$('<input firstControl type="'+this.type+'" class="form-control" />');this.options&&this.options.IconClass&&""!==this.options.IconClass&&(iconsLeft=$('<span class="input-group-addon" ><i class="'+this.options.IconClass+'" /></span>')),iconsLeft&&control.append(iconsLeft),control.append(input),iconsRight&&control.append(iconsRight),(iconsLeft||iconsRight)&&control.addClass("input-group"),input.on("itemAdded",event=>{if(this.options.RegExp&&event.item&&!new RegExp(this.options.RegExp).test(event.item)){let values=input.tagsinput()[0].$container.find("> span");values.filter(i=>$(values[i]).text()===event.item).removeClass("label-info").addClass("label-danger")}const module=me.closest("flx-module")[0];if(this.options.SQLValidator||module&&module.moduleConfig&&module.moduleConfig.PropsEventDependant&&module.moduleConfig.PropsEventDependant.includes(this.property)){let ev={class:"property",type:"changed",sender:this,masterIdentity:this.property};flexygo.events.trigger(ev)}}),me.html(control),this.setOptions()}getIconButtons(){let icon1,ret=$('<div class="input-group-btn" />'),editCtl=$(this).closest("flx-edit, flx-list")[0],parseEdit=function(val,ctx,property){return val};return editCtl&&editCtl.parseEditString&&(parseEdit=editCtl.parseEditString),this.options&&(this.options.SearchCollection||this.options.SearchFunction)&&!this.options.Locked&&(icon1=$('<button class="btn btn-default" type="button"><i class="flx-icon icon-search" /></button>').on("click",e=>{this.options.SearchFunction&&flexygo.utils.execDynamicCode.call(this,parseEdit(this.options.SearchFunction,editCtl,this)),this.options.SearchCollection&&""!==this.options.SearchCollection&&(flexygo.events.on(this,"entity","selected",e=>{flexygo.events.off(this,"entity","selected");let entity=e.sender,config=entity.getConfig(),value=entity.data[config.KeyFields[0]].Value;this.options.SearchReturnFields&&""!==this.options.SearchReturnFields&&(value=entity.data[this.options.SearchReturnFields].Value),this.setValue(this.appendValue(value)),this.triggerDependencies(),$(document).find('flx-search[objectname="'+this.options.SearchCollection+'"]').closest(".ui-dialog").remove()}),flexygo.nav.openPage("search",parseEdit(this.options.SearchCollection,editCtl,this),parseEdit(this.options.SearchWhere,editCtl,this),null,"modal"))}),ret.append(icon1)),this.options&&this.options.ObjNameLink&&this.options.ObjWhereLink&&(icon1=$('<button class="btn btn-default" type="button"><i class="flx-icon icon-link" /></button>').on("click",e=>{flexygo.nav.openPage("view",parseEdit(this.options.ObjNameLink,editCtl,this),editCtl.parseEditString(this.options.ObjWhereLink,editCtl,this),null,this.options.TargetIdLink)}),ret.append(icon1)),this.options&&(this.options.AllowNewFunction||this.options.AllowNewObject)&&!this.options.Locked&&(icon1=$('<button class="btn btn-default" type="button"><i class="fa fa-plus" /></button>').on("click",e=>{this.options.AllowNewFunction?flexygo.utils.execDynamicCode.call(this,parseEdit(this.options.AllowNewFunction,editCtl,this)):this.options.AllowNewObject&&""!==this.options.AllowNewObject&&(flexygo.events.on(this,"entity","inserted",e=>{if(this.options.AllowNewObject===e.masterIdentity){flexygo.events.off(this,"entity","inserted");let value,entity=e.sender;if(this.options.AllowNewReturnFields&&""!=this.options.AllowNewReturnFields)value=entity.data[this.options.AllowNewReturnFields].Value;else{var config=e.sender.getConfig();value=entity.data[config.KeyFields[0]].Value}this.setValue(value),this.triggerDependencies(),$(document).find('flx-edit[objectname="'+this.options.AllowNewObject+'"]').closest(".ui-dialog").remove()}}),flexygo.nav.openPage("edit",parseEdit(this.options.AllowNewObject,editCtl,this),null,null,"modal"))}),ret.append(icon1)),""===ret.html()?null:ret}appendValue(value){let oldValue=this.getValue();return oldValue&&""!==oldValue?oldValue+this.options.Separator+value:value}setOptions(){let me=$(this),input=me.find("input");input.on("change.refreshvalue",e=>{me.attr("value",input.tagsinput("items").join(this.options.Separator))}),this.options&&this.options.Name&&""!==this.options.Name?input.attr("name",this.options.Name):input.attr("name",flexygo.utils.uniqueName()),me.attr("tab")&&""!==me.attr("tab")&&input.attr("tabindex",me.attr("tab")),this.options&&this.options.Locked&&input.prop("disabled",this.options.Locked);const module=me.closest("flx-module")[0];if((this.options&&this.options.CauseRefresh||module&&module.moduleConfig&&module.moduleConfig.PropsEventDependant&&module.moduleConfig.PropsEventDependant.includes(this.property))&&input.on("change",()=>{if(this.isDefaultValue)return;let ev={class:"property",type:"changed",sender:this,masterIdentity:this.property};flexygo.events.trigger(ev)}),this.options&&this.options.PlaceHolder&&input.attr("PlaceHolder",this.options.PlaceHolder),this.options&&this.options.Style&&me.children("div").attr("style",this.options.Style),this.options&&this.options.CssClass&&me.children("div").addClass(this.options.CssClass),this.options&&this.options.IsRequired&&input.prop("required",this.options.IsRequired),this.options&&this.options.IsRequiredMessage&&input.attr("data-msg-required",this.options.IsRequiredMessage),this.options&&this.options.Hide&&me.addClass("hideControl"),this.options&&this.options.RegExp&&""!==this.options.RegExp&&input.attr("regex",this.options.RegExp),this.options&&this.options.RegExpText&&""!==this.options.RegExpText&&input.attr("data-msg-regex",this.options.RegExpText),this.options&&this.options.ValidatorMessage&&""!==this.options.ValidatorMessage&&input.attr("data-msg-sqlvalidator",this.options.ValidatorMessage),this.options&&this.options.DropDownValues){this.dropOptions=[];for(let i=0;i<this.options.DropDownValues.length;i++){let text=this.options.DropDownValues[i].Value,value=this.options.DropDownValues[i].Key;null==text&&(text=value),this.dropOptions.push(text)}}this.dropOptions?input.tagsinput({delimiter:this.options.Separator,confirmKeys:[13],typeaheadjs:{source:this.getOptions(this.dropOptions)},freeInput:!1}):input.tagsinput({delimiter:this.options.Separator,confirmKeys:[13]})}setValue(value){let me=$(this);if(me.attr("mode")&&"view"===me.attr("mode").toLowerCase())this.setValueView(value);else{let input=me.find("[firstControl]");input.tagsinput("removeAll"),input.tagsinput("add",value),me.attr("value",value)}}setValueView(value){let input=$(this).find("label");this.value=value,this.options&&this.options.Separator&&""!=this.options.Separator?(value=value.split(this.options.Separator),input.html("<span>"+value.join("</span> <span>")+"</span>"),input.find("span").addClass("tag label label-info")):input.html(value)}getValue(){let me=$(this);if(me.attr("mode")&&"view"===me.attr("mode").toLowerCase())return this.value;{let input=me.find("[firstControl]");if(""===input.val())return null;let arr=input.tagsinput("items");return arr&&arr.constructor===Array?arr.join(this.options.Separator):null}}getSeparator(){return this.options.Separator}getOptions(strs){return function(q,cb){let matches;matches=[];let substrRegex=new RegExp(q,"i");$.each(strs,(i,str)=>{substrRegex.test(str)&&matches.push(str)}),cb(matches)}}triggerDependencies(){let me,input;(input=(me=$(this)).find("input")).trigger("change")}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-tag",flexygo.ui.wc.FlxTagElement);