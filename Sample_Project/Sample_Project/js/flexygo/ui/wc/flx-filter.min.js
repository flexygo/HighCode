var flexygo;!function(flexygo){!function(ui){!function(wc_1){wc_1.loadSavedSearches=function(objectname,module,btn){var cntMenu=$("flx-contextmenu")[0];if(!cntMenu.hideMenu(btn)){let list=module.find("flx-list, flx-kanban, flx-timeline")[0];list||(list=module.find("flx-search")[0]);let menuUl=$("<ul/>"),wcFil=module.find("flx-filter")[0];for(let key in list.savedSearches){let search=list.savedSearches[key],dv=search.Name.substring(0,parseFloat("25"));search.Name.length>25&&(dv+="...");let nNode=$('<li><span class="left" title="'+search.Name+'">'+dv+'</span><span style="min-width:5px" class="right removesearch" class="txt-danger removesearch" title= "delete" >&nbsp;&nbsp; x </span><div style="clear: both;"></div></li>').attr("Id",key).attr("SearchId",search.SearchId).attr("Generic",search.Generic.toString());search.Generic?("admins"!=flexygo.context.currentRoleId&&nNode.find("span.removesearch").remove(),menuUl.prepend(nNode)):menuUl.append(nNode),nNode.on("click",e=>{let SearchId=$(e.currentTarget).attr("SearchId"),Id=$(e.currentTarget).attr("Id");wcFil.renderFilter(SearchId),wcFil.setSavedFilterValues(Id)}),nNode.find(".removesearch").on("click",e=>{e.stopPropagation(),flexygo.msg.confirm(flexygo.localization.translate("flxlist.removecurrentfiltervalues"),result=>{if(result){let Id=$(e.currentTarget).closest("li").attr("Id");wcFil.removeSearchValue(Id)&&(delete list.savedSearches[Id],$(e.currentTarget).closest("li").remove())}})})}if(menuUl.children().length>0){let nConfig='<li class="separator"/>';menuUl.children().filter('[generic="true"]:last').index()+1<menuUl.children().length&&menuUl.children().filter('[generic="true"]:last').after(nConfig),menuUl.append(nConfig)}let nNode=$('<li><span><i class="flx-icon icon-save-2" /> '+flexygo.localization.translate("flxlist.currentfiltervalues")+"</span></li>");menuUl.append(nNode),nNode.on("click",e=>{wcFil.saveSearchValue()}),cntMenu.showMenu(menuUl,btn)}},wc_1.loadFilter=function(objectname,module,btn){var cntMenu=$("flx-contextmenu")[0];if(!cntMenu.hideMenu(btn)){let list=module.find("flx-list, flx-kanban, flx-timeline")[0];list||(list=module.find("flx-search")[0]);let actives=flexygo.storage.local.get("activeFilters"),menuUl=$("<ul/>"),wc=module[0],wcFil=module.find("flx-filter")[0],moduleName=wc.moduleName;"flx-moduletab"===wc.getAttribute("type")&&(moduleName=$(wc).find(".nav.nav-tabs .active[data-modname]").attr("data-modname"));let currentObjectName=wc.objectname;if(!currentObjectName){var moduleData=new flexygo.obj.Entity("SysModules",`ModuleName='${moduleName}'`);moduleData.read(),currentObjectName=moduleData.data&&moduleData.data.ObjectName&&moduleData.data.ObjectName.Value?moduleData.data.ObjectName.Value:currentObjectName}let filkey=objectname+"-"+moduleName;for(let key in list.searchSettings){let fil=list.searchSettings[key],ico="text"===fil.Type.toLowerCase()?"icon-text":"icon-filter-1",style=actives&&actives[filkey]&&actives[filkey]===key?"txt-outstanding":"",nNode=$('<li><span class="'+style+'"><i class="flx-icon '+ico+'" /> '+fil.Name+"</span></li>").attr("filterId",key);menuUl.append(nNode),nNode.on("click",e=>{let filId=$(e.currentTarget).attr("filterId");wcFil.renderFilter(filId)})}if(menuUl.children().length>=0){let nNode=$('<li><span><i class="flx-icon icon-filter-remove" /> '+flexygo.localization.translate("flxeditgrid.hide")+"</span></li>");menuUl.append(nNode),nNode.on("click",e=>{wcFil.renderFilter(null)})}let nConfig=$('<li class="separator"></li><li class="btnConfig"><span><i class="flx-icon icon-admon" /> '+flexygo.localization.translate("flxeditgrid.settings")+"</span></li>");menuUl.append(nConfig),nConfig.on("click",e=>{flexygo.debug.manageFilters(objectname,null,!1,module)}),cntMenu.showMenu(menuUl,btn)}},wc_1.loadPresets=function(objectname,module,btn){var cntMenu=$("flx-contextmenu")[0];if(!cntMenu.hideMenu(btn)){let list=module.find("flx-list, flx-kanban, flx-timeline")[0];list||(list=module.find("flx-search")[0]);let menuUl=$("<ul/>");for(let key in list.presets){let iconClass="",titleClass="",preset=list.presets[key];preset.IconClass&&(iconClass=preset.IconClass),preset.TitleClass&&(titleClass=preset.TitleClass);let nNode=$('<li><span><i class="icon-margin-right '+preset.IconName+" "+iconClass+'" /><span class="'+titleClass+'"> '+preset.Title+"</span></span></li>").attr("presetName",key);nNode.on("click",e=>{list.setPreset(key,preset.Title,preset.IconName+" "+iconClass)}),menuUl.append(nNode)}if(list.presets&&Object.keys(list.presets).length>0){let nNode=$('<li><span><i class="icon-margin-right fa fa-search-plus " /><span class=""> '+flexygo.localization.translate("flxfilter.showall")+"</span></span></li>").attr("presetName",null);nNode.on("click",e=>{list.setPreset(null,null,null)}),menuUl.append(nNode),menuUl.append($('<li class="separator" > </li>'))}cntMenu.showMenu(menuUl,btn)}};wc_1.FlxFilterInfo=class{};wc_1.FlxFilterElement=class extends HTMLElement{constructor(){super(),this.key=null,this.active=null,this.settings=null,this.grid=null}init(){let me=$(this);flexygo.events.on(this,"property","changed",this.onPropertyChanged,!0);let activeFilters=flexygo.storage.local.get("activeFilters");if(activeFilters&&null!=this.key&&void 0!==activeFilters[this.key]&&this.renderFilter(activeFilters[this.key]),this.settings){let module=me.closest("flx-module")[0];if(module){let moduleName=module.moduleName;module.componentString.includes("moduletab")&&(moduleName=$(module).find("flx-list, flx-kanban, flx-timeline")[0].moduleName);let history=flexygo.history.get(me);if(history&&history.filtersValues&&history.filtersValues[moduleName]){let state=history.filtersValues[moduleName];this.active=state.activeFilter,this.renderFilter(this.active,state.properties)}}}}refresh(){this.renderFilter(this.active)}renderFilter(active,filterValues){let me=$(this);this.saveActiveFilter(active),this.active=active,me.empty(),me.removeClass("active"),me.closest("flx-module").find(".filterButtons").remove();let moduleWidth=0;if(moduleWidth=me.closest("flx-module").width()/me.closest("#mainContent").width()*100,null!=active&&this.settings[active]){if(this.setProperties(this.settings[active].Properties),"text"===this.settings[active].Type.toLowerCase()){let placeholder=flexygo.localization.translate("flxfilter.searchplaceholder");$.each(this.properties,(i,prop)=>{placeholder+=prop.Label+", "}),placeholder=(placeholder=placeholder.trim()).substring(0,placeholder.length-1);let txtVal=filterValues&&filterValues.length>0?filterValues[0].value:"";me.html('<div class="search col-12"><input type="search" class="form-control" placeholder="'+placeholder+'" value="'+txtVal+'"></input></div>')}else $.each(this.properties,(i,prop)=>{let propCtl="",propValue="",propText="";filterValues&&$.each(filterValues,(j,fil)=>{if(prop.ObjectName===fil.objectname&&prop.Name===fil.objectproperty)return propValue=fil.value,propText=fil.text,!1}),"check"==prop.Type.toLowerCase()?(propCtl+='<div class="item col-3 col-s-6 text-muted">',propCtl+='    <div data-tag="control" class="filter-control filter-check">',propCtl+="<label>"+prop.Label+"&nbsp; </label><"+prop.WebComponent+' object="'+prop.ObjectName+'" path="'+prop.ObjectPath+'" property="'+prop.Name+'" filtertype="'+prop.Type+'" value="'+propValue+'" />',propCtl+="    </div>",propCtl+="</div>"):(propCtl+='<div class="item '+(moduleWidth<=40?"col-12":"col-3")+' col-s-12 text-muted">',propCtl+='    <div data-tag="control" class="filter-control">',propCtl+="<"+prop.WebComponent+' object="'+prop.ObjectName+'" path="'+prop.ObjectPath+'" property="'+prop.Name+'" filtertype="'+prop.Type+'" value="'+propValue+'" text="'+propText+'"/>',propCtl+="    </div>",propCtl+="</div>"),me.append(propCtl)}),me.find("div[data-tag=control] input").prop("required",!1);me.length>0&&me.addClass("active"),me.off("keypress").on("keypress",e=>{if(13==e.which){e.preventDefault();let multicomboHtml=e.target.closest("flx-multicombo");if(multicomboHtml){let multicomboJquery=$(multicomboHtml),listInput=multicomboJquery.find("li input"),tags=multicomboHtml.getValue().split(multicomboHtml.separator),selectedLi=multicomboJquery.find("li.selected"),listValues=multicomboJquery.find("li:not(.search)");""===listInput.val()&&0===selectedLi.length&&(listValues.length>1||1===listValues.length&&-1!==tags.indexOf(listValues.attr("data-value")))&&this.applyFilters(),-1!==tags.indexOf(selectedLi.attr("data-value"))&&this.applyFilters()}else this.applyFilters()}});let btnApply=$('<button class="btn btn-default txt-success"><i class="flx-icon icon-search"></i></button>'),btnClear=$('<button class="btn btn-default"><i class="flx-icon icon-clean"></i></button>'),filterBtn=$('<div class="filterButtons btn-group"></div>');me.closest("flx-module").find(".moduleToolbar").append(filterBtn),filterBtn.append(btnApply).append(btnClear),btnApply.on("click",()=>{this.applyFilters()}),btnClear.on("click",()=>{this.clearFilters()})}}saveActiveFilter(active){let activeFilters=flexygo.storage.local.get("activeFilters");null==activeFilters&&(activeFilters=new Object),null!=this.key&&(null==active?delete activeFilters[this.key]:activeFilters[this.key]=active,flexygo.storage.local.add("activeFilters",activeFilters))}setProperties(props){this.properties={},$.each(props,(i,e)=>{let prop=e.Config;prop.WebComponent=e.WebComponent,prop.Type=e.Type,prop.ObjectName=e.ObjectName,prop.ObjectPath=e.ObjectPath,prop.PlaceHolder=e.Label,prop.Locked=!1,prop.AllowNewFunction="",prop.AllowNewObject="",prop.AllowNewDefaults="",prop.ObjNameLink="",prop.SearchCollection=e.Config.SearchCollection,prop.SearchFunction=e.Config.SearchFunction,prop.SearchReturnFields=e.Config.SearchReturnFields,this.properties[prop.ObjectName+"-"+prop.Name]=prop})}onPropertyChanged(e){let wc=$(e.sender),me=$(wc.closest("flx-filter"));if(me.find(wc).length>0&&me[0].key==e.context.key){let propertyElement=e,containerItem=$(me.closest("flx-module")[0]),props=me.find("[property]"),propertyName=e.masterIdentity;if(props.length>0){let Properties=[];for(let i=0;i<props.length;i++){let prop=$(props[i])[0];Properties.push({Key:prop.property,Value:prop.getValue()})}wc[0];let params={SearchId:me[0].active,ObjectName:containerItem.find("flx-list")[0].objectname,PropertyObjectName:$(wc[0]).attr("object"),PropertyName:propertyName,Properties};this.paintLoadingFilter(propertyElement),flexygo.ajax.post("~/api/Edit","ProcessFilterDependencies",params,response=>{try{if(response)for(let i=0;i<response.length;i++){let itm=response[i],prop=me.find('[property="'+itm.PropertyName+'"]');prop.length>0&&this.refreshProperty(itm,prop)}this.removeLoadingFilter(propertyElement)}catch(e){flexygo.exceptions.httpShow(e),this.removeLoadingFilter(propertyElement)}})}}}paintLoadingFilter(e){let currentFilter=$(e.sender).closest(".item").closest("flx-filter")[0];if(currentFilter){let DependingProperties,currentProperties=currentFilter.settings[currentFilter.active].Properties;for(let key in currentProperties)if(currentProperties[key].PropertyName==e.masterIdentity){DependingProperties=currentProperties[key].DependingFilterProperties;break}for(let i=0;i<DependingProperties.length;i++){let DependantPropertyName=DependingProperties[i].DependantPropertyName,DependantObjectName=DependingProperties[i].DependantObjectName,HTMLProperty=$($(currentFilter)[0]).find(`[property="${DependantPropertyName}"][object="${DependantObjectName}"]`)[0].closest(".item");$(HTMLProperty).addClass("flx-relative"),$(HTMLProperty).addClass("flx-opacity"),0==$(HTMLProperty).find("#flx-dependency-loader").length&&$(HTMLProperty).append('<div id="flx-dependency-loader"></div>')}}}removeLoadingFilter(e){let me=$(e.sender).closest("flx-filter")[0];if(me){let DependingProperties,currentProperties=me.settings[me.active].Properties;for(let key in currentProperties)if(currentProperties[key].PropertyName==e.masterIdentity){DependingProperties=currentProperties[key].DependingFilterProperties;break}for(let i=0;i<DependingProperties.length;i++){let DependantPropertyName=DependingProperties[i].DependantPropertyName,DependantObjectName=DependingProperties[i].DependantObjectName,HTMLProperty=$($(me)[0]).find(`[property="${DependantPropertyName}"][object="${DependantObjectName}"]`)[0].closest(".item");$(HTMLProperty).find("#flx-dependency-loader").remove(),$(HTMLProperty).removeClass("flx-relative flx-opacity")}}}refreshProperty(itm,prop){if(prop.is("flx-multicombo")){let clearButton=$(prop).find("label.cleared > label.clickable");clearButton&&clearButton.trigger("click")}if(itm.changeSQL){let cntl=prop[0];cntl.changeSQLData&&cntl.changeSQLData(itm.newSQL,null)}}getfilterValues(){let me=$(this),ctls=me.find("[property]"),filters=[];if("text"==this.settings[this.active].Type.toLowerCase()){let val=me.find("input[type='search']").val(),txt=me.find("input[type='search']").text();if(!val||0===val.length)return void this.clearFilters(!1,!1);$.each(this.settings[this.active].Properties,(i,e)=>{filters.push({objectname:e.ObjectName,objectproperty:e.PropertyName,objectpath:e.ObjectName,value:val,text:txt,filtertype:"text"})})}else $.each(ctls,(i,e)=>{let ctl=$(e),txt=ctl.text();var txts=Array();ctl.is("flx-multicombo")&&(ctl.find(".tag").each(function(i,ob){txts.push($(ob).text())}),txt=txts.join("|"));let val=e.getValue();void 0!==val&&null!=val&&""!==val&&"|"!=val&&filters.push({objectname:ctl.attr("object"),objectproperty:ctl.attr("property"),objectpath:ctl.attr("path"),value:val,text:txt,filtertype:ctl.attr("filtertype").toLowerCase()})});this.grid.filterValues=filters}applyFilters(){this.getfilterValues(),this.grid.activeFilter=this.active,this.grid.setFilter(),this.saveFilterValueHistory(this.active,this.grid.filterValues);let ev={class:"module",type:"filtered",sender:$(this).closest("flx-module")[0],masterIdentity:this.settings[this.active].ObjectName,detailIdentity:this.active};flexygo.events.trigger(ev,$(this))}setSavedFilterValues(Id){let objects=JSON.parse(this.grid.savedSearches[Id].Values),me=$(this);if(this.clearFilters(!0),"text"==this.settings[this.active].Type.toLowerCase())me.find("input")[0].value=objects[0].value;else for(let key in objects){let ctl=me.find("[property="+objects[key].objectproperty+"]")[0];if("number-range"==objects[key].filtertype||"date-range"==objects[key].filtertype){let valMin=objects[key].value.split("|")[0],valMax=objects[key].value.split("|")[1];ctl.setValue(valMin,valMax)}else ctl.setValue(objects[key].value,objects[key].text)}this.applyFilters()}saveSearchValue(){this.active?$.sweetModal({title:flexygo.localization.translate("flxlist.savefilter"),width:"33%",content:'<div style="overflow: hidden;">\n                              <div class="'+("admins"!=flexygo.context.currentRoleId?"col-12":"col-10")+'">\n                              <label>'+flexygo.localization.translate("flxlist.name")+':</label>\n                              <div>\n                                <flx-text type="text"  id="name"/>\n                              </div>\n                            </div>\n                            <div class="col-2 '+("admins"!=flexygo.context.currentRoleId?"hide":"")+'">\n                              <label>'+flexygo.localization.translate("flxlist.generic")+':</label>\n                              <div>\n                                <flx-check id="generic"/>\n                              </div>\n                            </div>\n                            </div>',buttons:[{label:flexygo.localization.translate("flxlist.save"),classes:"bg-info",action:sweetModal=>{this.getfilterValues();var obj=new flexygo.obj.Entity("sysUserSearchValue");if(obj.read(),obj.data.Name.Value=sweetModal.$overlay.find("flx-text#name")[0].getValue(),obj.data.Values.Value=JSON.stringify(this.grid.filterValues),obj.data.SearchId.Value=this.active,obj.data.Generic.Value="admins"==flexygo.context.currentRoleId&&sweetModal.$overlay.find("flx-check#generic")[0].getValue(),obj.insert()){let newsearch={Id:obj.data.Id.Value,Name:obj.data.Name.Value,SearchId:obj.data.SearchId.Value,Values:obj.data.Values.Value,Generic:obj.data.Generic.Value};this.grid.savedSearches||(this.grid.savedSearches=[]),this.grid.savedSearches[newsearch.Id]=newsearch}}}]}):flexygo.msg.alert(flexygo.localization.translate("flxlist.selectfilterfirst"))}parseEditString(str){let props=$(this).find("[property]"),obj=new Object;for(let i=0;i<props.length;i++){let prop=$(props[i])[0];obj[prop.property]=prop.getValue()}return flexygo.utils.parser.compile(obj,str,this)}removeSearchValue(id){return!!new flexygo.obj.Entity("sysUserSearchValue","Id="+id).delete()}saveFilterValueHistory(active,filters){let me=$(this),module=me.closest("flx-module")[0],moduleName=module.moduleName;module.componentString.includes("moduletab")&&(moduleName=$(module).find("flx-list, flx-kanban, flx-timeline")[0].moduleName);let history=flexygo.history.get(me),page=this.grid&&this.grid.page?this.grid.page:0;history.filtersValues||(history.filtersValues=new flexygo.nav.ModuleFilterHistory);let histElem={activeFilter:active,activePage:page,properties:filters};history.filtersValues[moduleName]=histElem,flexygo.history.replace(history,me,!1),flexygo.history.historyLog.add("",history.description,history)}clearFilters(norefresh=!1,triggerEv=!0){let me=$(this),ctls=me.find("[property]");if($.each(ctls,(i,ctl)=>{$(ctl)[0].setValue(null)}),me.find("input[type='search']").val(""),this.grid.filterValues=null,!triggerEv)return;let ev={class:"module",type:"filtered",sender:me.closest("flx-module")[0],masterIdentity:this.settings[this.active].ObjectName,detailIdentity:this.active};flexygo.events.trigger(ev,me),norefresh||(this.saveFilterValueHistory(this.active,null),this.grid.refresh())}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-filter",flexygo.ui.wc.FlxFilterElement);