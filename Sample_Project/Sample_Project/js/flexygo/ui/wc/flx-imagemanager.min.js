var flexygo;!function(flexygo){!function(ui){!function(wc){wc.FlxImageManagerElement=class extends HTMLElement{constructor(){super(),this.imageClassId=null,this.additionalWhere=null}connectedCallback(){let element=$(this);this.connected=!0,this.objectName=element.attr("ObjectName"),this.objectWhere=element.attr("ObjectWhere"),this.objectId=element.attr("ObjectId"),this.moduleName=element.attr("ModuleName"),this.singleImage=element.attr("SingleImage"),this.empty=element.attr("Empty"),this.mode=element.attr("mode")||"","true"!=element.attr("manualInit")&&this.init()}disconnectedCallback(){flexygo.events.off(this,"entity","updated",this.onEntityUpdate)}static get observedAttributes(){return["modulename","objectname","objectwhere","objectid","singleimage","empty","mode"]}attributeChangedCallback(attrName,oldVal,newVal){if(!0===this.connected){let needInit=!1;"modulename"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.moduleName=newVal,needInit=!0):"objectname"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectName=newVal,needInit=!0):"objectwhere"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectWhere=newVal,needInit=!0):"objectid"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.objectId=newVal,needInit=!0):"singleimage"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.singleImage=newVal,needInit=!0):"empty"==attrName.toLowerCase()&&newVal&&""!=newVal?(this.empty=newVal,needInit=!0):"mode"==attrName.toLowerCase()&&newVal&&""!=newVal&&(this.mode=newVal,needInit=!0),needInit&&this.init()}}init(){flexygo.events.on(this,"entity","updated",this.onEntityUpdate);try{let me=$(this);var defString,defObject;me.removeAttr("manualInit"),$(this).closest("flx-module").find(".flx-noInitContent").remove(),defString=flexygo.history.getDefaults(this.objectName,me),defObject=JSON.parse(flexygo.utils.parser.replaceAll(defString,"'",'"'));let wcModule=me.closest("flx-module")[0];if(this.rObjectName=this.objectName&&this.objectId?this.objectName:defObject&&defObject.ObjectName?defObject.ObjectName:wcModule.objectdefaults?wcModule.objectdefaults.ObjectName:"",this.rObjectId=this.objectName&&this.objectId?this.objectId:defObject&&defObject.ObjectId?defObject.ObjectId:wcModule.objectdefaults?wcModule.objectdefaults.ObjectId:"",defObject&&defObject.additionalWhere?this.additionalWhere=defObject.additionalWhere:wcModule.objectdefaults&&wcModule.objectdefaults.additionalWhere&&(this.additionalWhere=wcModule.objectdefaults.additionalWhere),defObject&&defObject.ImageClassId?this.imageClassId=defObject.ImageClassId:wcModule.objectdefaults&&wcModule.objectdefaults.ImageClassId&&(this.imageClassId=wcModule.objectdefaults.ImageClassId),0==$(me).closest(".flx-slide.flx-slide-loading").length)this.render();else var loadSlideModal=setInterval(()=>{$(me).closest(".flx-slide.flx-slide-fullLoaded").length>0&&(this.render(),clearInterval(loadSlideModal))},200)}catch(ex){console.log(ex)}}refresh(){if("true"!=$(this).attr("manualInit"))try{this.render()}catch(ex){console.log(ex)}}render(){try{let me=$(this);var rendered="";"view"!=this.mode.toLowerCase()&&(rendered=`<div class="im-btn-container">\n                                <label method="upload" value="" type="" class="btn btn-default bg-outstanding btn-file im-btn">\n                                    <i class="flx-icon icon-upload-1" flx-fw=""></i><span class="hidden-xs">   ${flexygo.localization.translate("imagemanager.upload")}</span><input method="upload" value="" type="file" multiple class="hide" accept="image/*" />\n                                </label>\n                                <button type="button" method="downloadall" value="downloadall" class="btn btn-default im-btn im-btn im-btn-settings " data-original-title="" title="">\n                                    <i class="flx-icon icon-download"  ></i>\n                                </button>\n                                <button type="button" method="deleteall" value="deleteall" class="btn btn-default im-btn im-btn im-btn-settings" data-original-title="" title="">\n                                    <i class="flx-icon icon-close txt-danger"  ></i>\n                                </button>\n                                <button type="button" method="opensettings" value="settings" class="btn btn-default im-btn im-btn-settings develop-only" data-original-title="" title="">\n                                    <i class="flx-icon icon-settings" flx-fw="" ></i>\n                                </button>\n                                \n                            </div>`),rendered+='<div class="im-pry-container im-wall im-transition im-background-container">',"view"!=this.mode.toLowerCase()&&(rendered+=`<span class="background-elements">\n                                    <i class="flx-icon icon-upload-1"></i> ${flexygo.localization.translate("upload.info")}\n                             </span>`),rendered+="</div>",me.html(rendered),me.find('label[method="upload"]').tooltip({title:flexygo.localization.translate("imagemanager.upload"),placement:"bottom",trigger:"hover"}),me.find('button[method="downloadall"]').tooltip({title:flexygo.localization.translate("imagemanager.downloadall"),placement:"bottom",trigger:"hover"}),me.find('button[method="deleteall"]').tooltip({title:flexygo.localization.translate("imagemanager.deleteall"),placement:"bottom",trigger:"hover"}),me.find('button[method="opensettings"][value="settings"]').tooltip({title:flexygo.localization.translate("imagemanager.settings"),placement:"bottom",trigger:"hover"}),this.singleImage&&(me.find("div.im-btn-container").hide(),me.find("div.im-pry-container").css({"min-height":me.find("div.im-pry-container").width()+20+"px"}).css({"max-height":me.find("div.im-pry-container").width()+20+"px"}).addClass("im-pry-container-single")),this.mainEvents(),this.getImage()}catch(ex){console.log(ex)}}renderImage(imageId,name,descrip,classId,classDescrip,mainImage,orderNumber,path,faceEncoding=1,lastError=""){try{let me=$(this);var rendered,iconSize,iconEdit,iconFaceEncoding,error="Cant find any face on this picture yet";if(me.attr("mode")?(iconFaceEncoding="",0==faceEncoding&&(lastError.length>0&&(error=lastError),iconFaceEncoding='<div title="'+error+'" class="padding-left-s padding-top-s"><i class="flx-icon icon-warning txt-danger"> </i></div>')):iconFaceEncoding="",iconSize=me.find("div.im-pry-container").width()>250?"icon-3x":"icon-2x",iconEdit=this.singleImage&&mainImage?"fa fa-image":"flx-icon icon-pencil",rendered='<div imageId="'+imageId+'" order="'+orderNumber+`" class="im-item im-transition" style="${"view"==this.mode.toLowerCase()?"cursor: initial":""}">\n                                <div method="" class="im-data im-transition">\n                                    <div method="mainimage" value="`+(mainImage||"")+`" class="ignore-drag im-mainimage im-transition ${"recognition"==this.mode.toLowerCase()?"hidden":""}">\n                                        <i class="flx-icon icon-star im-item-corner-icon im-transition" flx-fw=""></i>\n                                        <div class="im-item-corner im-transition"></div>\n                                    </div>\n                                    <div method="removeimage" class="ignore-drag im-removeimage im-transition ${"view"==this.mode.toLowerCase()?"hidden":""}">\n                                        <i class="flx-icon flx-icon icon-document-remove" flx-fw=""></i>\n                                        \n                                    </div>\n                                                ${iconFaceEncoding}\n                                    <div class="im-data-container im-data-descrip im-transition">\n                                        <span class="im-name im-data-item im-data-name im-transition size-l">`+name.toUpperCase()+'</span>\n                                        <hr class="im-transition">\n                                        <span class="im-descrip im-data-item im-transition size-xs"><small>'+(classDescrip?classDescrip.toUpperCase():"")+`</small></span>\n                                    </div>\n                                    <div  method="preview" class="ignore-drag im-data-container im-data-container-action im-data-preview im-transition"\n                                    ${"view"==this.mode.toLowerCase()||"recognition"==this.mode.toLowerCase()?'style="margin: 15px calc(25%)"':""}\n                                     data-src="`+flexygo.utils.resolveUrl(path)+'" data-sub-html="<h3>'+name.toUpperCase()+"</h3><p>"+(descrip||"")+'</p>" >\n                                        <img style="display:none;" src="'+flexygo.utils.resolveUrl(path)+'" />\n                                        <i class="flx-icon icon-eye '+iconSize+` im-transition im-data-icon im-data-item" flx-fw=""></i>\n                                    </div>\n                                    <div  method="edit" class="ignore-drag im-data-container im-data-container-action im-data-edit im-transition ${"view"==this.mode.toLowerCase()||"recognition"==this.mode.toLowerCase()?"hidden":""}">\n                                        <i class="`+iconEdit+" "+iconSize+' im-transition im-data-icon im-data-item" flx-fw=""></i>\n                                    </div>\n                                </div>\n                                <div class="im-image im-transition" style="background-image: url(\''+flexygo.utils.resolveUrl(path)+"');\"></div>\n                            </div>",this.wall.appendBlock(rendered),mainImage&&me.find('div[imageid="'+imageId+'"]').find("div.im-data div.im-mainimage").addClass("im-mi-mainimage").find("div.im-item-corner").addClass("im-mi-item-corner"),this.singleImage)if(mainImage){me.find('div[imageid="'+imageId+'"]').find('div[method = "removeimage"]').hide(),me.find('div[imageid="'+imageId+'"]').find('div[method = "mainimage"]').hide(),me.find('div[imageid="'+imageId+'"]').find("div.im-data-descrip").addClass("im-data-descrip-single"),me.find('div[imageid="'+imageId+'"]').addClass("im-item-single"),this.wall.fixPos({top:0,left:0,block:me.find('div[imageid="'+imageId+'"]')});let size=me.find("div.im-pry-container").width()/1.34;this.wall.fixSize({height:size,width:size,block:me.find('div[imageid="'+imageId+'"]')}),this.wall.refresh()}else me.find('div[imageid="'+imageId+'"]').hide();this.imageEvents()}catch(ex){console.log(ex)}}mainEvents(){try{let me=$(this);if("view"!=this.mode.toLowerCase()){var dragDropZone=me.find("div.im-pry-container");dragDropZone.on("dragover",ev=>{ev.originalEvent&&ev.originalEvent.dataTransfer&&(ev.originalEvent.dataTransfer.dropEffect="copy"),dragDropZone.css("background-color","rgba(0,0,0,0.5)"),dragDropZone.find(".dtc-container, .dtc-btn-container button").css("background-color","rgba(0,0,0,0.5)")}).on("dragleave",ev=>{dragDropZone.css("background-color",""),dragDropZone.find(".dtc-container, .dtc-btn-container button").css("background-color","")}).on("drop",ev=>{ev.preventDefault(),dragDropZone.css("background-color",""),dragDropZone.find(".dtc-container, .dtc-btn-container button").css("background-color","");let dEvent=ev.originalEvent;for(var i=0;i<dEvent.dataTransfer.files.length;i++)this.imagesPreRender=[],this.imagesLength=dEvent.dataTransfer.files.length,this.imageReader(dEvent.dataTransfer.files[i])})}this.wall=new Freewall(me.find("div.im-wall")),this.wall.reset({selector:".im-item",draggable:!this.singleImage&&!flexygo.utils.isAgentMobile()&&"view"!=this.mode.toLowerCase(),animate:!0,cellW:()=>this.singleImage?me.find("div.im-pry-container").width()/1.35:"view"==this.mode?175:250,cellH:()=>this.singleImage?me.find("div.im-pry-container").width()/1.35:"view"==this.mode?175:250,delay:50,fixSize:0,gutterX:10,gutterY:10,cacheSize:!0,keepOrder:!0,rightToLeft:!1,bottomToTop:!1,onResize:()=>{this.singleImage&&(this.wall.fixSize({height:me.find("div.im-pry-container").width()/1.34,width:me.find("div.im-pry-container").width()/1.34,block:me.find("div.im-item")}),me.find("div.im-pry-container").css({"min-height":me.find("div.im-pry-container").width()+20+"px"}).css({"max-height":me.find("div.im-pry-container").width()+20+"px"})),this.wall.refresh()},onBlockDrop:function(){setTimeout(()=>{this.closest("flx-imagemanager").orderImage(this)},700)}}),this.wall.fitWidth(),this.wall.sortBy(function(a,b){return a.attributes.getNamedItem("order").value-b.attributes.getNamedItem("order").value}),me.find("input").off("change").on("change",e=>{var element,method;if(element=$(e.currentTarget),method=$(element).attr("method"),"file"===$(element).attr("type")&&"upload"===method&&element[0].files){for(let fl of element[0].files)this.imagesPreRender=[],this.imagesLength=element[0].files.length,this.imageReader(fl);$(element).val("")}}),me.find("button").off("click").on("click",e=>{var element,method,value;element=$(e.currentTarget),method=$(element).attr("method"),value=$(element).attr("value"),"opensettings"===method&&"settings"===value&&this.rObjectName&&("recognition"==this.mode?flexygo.nav.openPage("edit","sysObjectImageRecognitionSetting","ObjectName = '"+this.rObjectName+"'",null,"modal900x500",!1,me):flexygo.nav.openPage("edit","sysObjectImageSetting","ObjectName = '"+this.rObjectName+"'",null,"modal900x500",!1,me)),$(this).find("div[imageid]").length<=0&&("downloadall"===method||"deleteall"===method)?flexygo.msg.warning("imagemanager.noimages"):("downloadall"===method&&"downloadall"===value&&this.rObjectName&&!flexygo.utils.isBlank(this.rObjectId)&&this.downloadAllImages(this.rObjectName,this.rObjectId),"deleteall"===method&&"deleteall"===value&&this.rObjectName&&!flexygo.utils.isBlank(this.rObjectId)&&flexygo.msg.confirm("imagemanager.msgremoveall",result=>{result&&this.removeAllImages(this.rObjectName,this.rObjectId)}))}),this.singleImage&&$(document).off("dialogclosed.imagemanager").on("dialogclosed.imagemanager",(ev,hist)=>{"sysObjectImages"===hist.objectname&&this.refresh()})}catch(ex){console.log(ex)}}onEntityUpdate(e){let obj=e.sender,me=$(this);if("sysObjectImage"===obj.objectName||"sysObjectImageSetting"===obj.objectName){if("sysObjectImage"===obj.objectName){let params;if(me.find('div[imageid="'+obj.data.ImageId.Value+'"]').find("img").attr("src",flexygo.utils.resolveUrl(flexygo.utils.querystring.setParamValue(obj.data.Path.Text,"time",(new Date).getTime().toString()))),me.find('div[imageid="'+obj.data.ImageId.Value+'"]').find("div.im-image").css("background-image","url("+flexygo.utils.resolveUrl(flexygo.utils.querystring.setParamValue(obj.data.Path.Text,"time",(new Date).getTime().toString()))+")"),me.find('div[imageid="'+obj.data.ImageId.Value+'"]').find('div[method= "preview"]').attr("data-sub-html","<h3>"+obj.data.Name.Value.toUpperCase()+"</h3><p>"+obj.data.Descrip.Value+"</p>"),me.find('div[imageid="'+obj.data.ImageId.Value+'"]').find('div[method= "preview"]').attr("data-src",flexygo.utils.resolveUrl(flexygo.utils.querystring.setParamValue(obj.data.Path.Text,"time",(new Date).getTime().toString()))),me.find('div[imageid="'+obj.data.ImageId.Value+'"]').find("span.im-name").text(obj.data.Name.Value.toUpperCase()),me.find('div[imageid="'+obj.data.ImageId.Value+'"]').find("span.im-descrip").text(obj.data.ImageClassId.Text.toUpperCase()),!flexygo.utils.isBlank(this.rObjectId)&&this.rObjectName){params={ObjectId:this.rObjectId,ObjectName:this.rObjectName,AdditionalWhere:this.additionalWhere,ImageClassId:this.imageClassId};let url="~/api/ImageManager";"recognition"==this.mode&&(url="~/api/ImageRecognitionManager"),flexygo.ajax.post(url,"GetImages",params,response=>{if(response[0]&&!response[0].imageError)for(let image of response)me.find('div[imageid="'+image.imageId+'"]').attr("order",image.orderNumber),me.find('div[imageid="'+image.imageId+'"]').find('div[method= "mainimage"]').attr("value",image.mainImage),image.mainImage?me.find('div[imageid="'+image.imageId+'"]').find("div.im-data div.im-mainimage").addClass("im-mi-mainimage").find("div.im-item-corner").addClass("im-mi-item-corner"):me.find('div[imageid="'+image.imageId+'"]').find("div.im-data div.im-mainimage").removeClass("im-mi-mainimage").find("div.im-item-corner").removeClass("im-mi-item-corner"),this.wall.sortBy(function(a,b){return a.attributes.getNamedItem("order").value-b.attributes.getNamedItem("order").value});else response[0].permissionError&&flexygo.msg.warning("imagemanager.permissionerror")})}this.setGallery()}$(document).find('flx-edit[objectname="'+obj.objectName+'"]').closest(".ui-dialog").remove()}}imageEvents(){try{$(this).find("div.im-item").find("div").off("click").on("click",e=>{var element,method,value,imageId,defaults;if(method=(element=$(e.currentTarget)).attr("method"),value=element.attr("value"),imageId=element.closest("div.im-item").attr("imageId"),"mainimage"===method&&"view"!==this.mode.toLowerCase())this.updateImage(imageId,"true"!==value.toLocaleLowerCase(),parseInt(element.closest("div.im-item").attr("order")),this.rObjectName);else if("removeimage"===method)flexygo.msg.confirm("imagemanager.msgremove",result=>{result&&this.removeImage(imageId,this.rObjectName)});else if("edit"===method){var imgConf=new flexygo.obj.Entity("sysObjectImageSetting","ObjectName = '"+this.rObjectName+"'");imgConf.read();var mode=imgConf.data.TypeId.Value;if(this.singleImage){if(!flexygo.utils.isBlank(this.rObjectId)&&this.rObjectName)if("flexygo"==mode)defaults={ObjectName:this.rObjectName,ObjectId:this.rObjectId},flexygo.nav.openPage("list","sysObjectImages","Objects_Images.ObjectId = '"+this.rObjectId+"' And Objects_Images.ObjectName = '"+this.rObjectName+"'",JSON.stringify(defaults),"modal"+($(window).width()-30)+"x"+($(window).height()-50),!1,$(this));else{var objectERP=imgConf.data.ERPObjectName.Value;defaults={Objeto:objectERP,IdDocObjeto:this.rObjectId},flexygo.nav.openPage("list","AHORA_Imagenes","Objetos_Imagenes.IdDocObjeto = '"+this.rObjectId+"' And Objetos_Imagenes.Objeto = '"+objectERP+"'",JSON.stringify(defaults),"modal"+($(window).width()-30)+"x"+($(window).height()-50),!1,$(this))}}else"flexygo"==mode?flexygo.nav.openPage("edit","sysObjectImage","ImageId = '"+imageId+"'",null,"modal1000x570",!1,$(this)):flexygo.nav.openPage("edit","AHORA_Imagen","IdDoc = '"+imageId+"'",null,"modal1000x570",!1,$(this))}}),this.setGallery()}catch(ex){console.log(ex)}}setImage(name,base64){try{if(!flexygo.utils.isBlank(this.rObjectId)&&this.rObjectName){var params;if($(this),!(base64=base64?base64.split(",")[1]:null))return void flexygo.msg.warning("imagemanager.imageepmty");params={ObjectName:this.rObjectName,ObjectId:this.rObjectId,Name:name,Base64:base64,ImageClassId:this.imageClassId};let url="~/api/ImageManager";"recognition"==this.mode&&(url="~/api/ImageRecognitionManager"),flexygo.ajax.post(url,"SetImage",params,response=>{if(response&&!response.imageError){if(this.imagesPreRender.push(response),this.imagesLength===this.imagesPreRender.length)for(let file of this.imagesPreRender)this.renderImage(file.imageId,file.name,file.descrip,file.classId,file.classDescrip,file.mainImage,file.orderNumber,file.path,file.haveFaceEncoding,file.lastError),flexygo.msg.success("imagemanager.uploaded")}else response.permissionError?flexygo.msg.warning("imagemanager.permissionerror"):flexygo.msg.error("imagemanager.erroruploading")})}}catch(ex){console.log(ex)}}getImage(imageId){try{if(!flexygo.utils.isBlank(this.rObjectId)&&this.rObjectName){let me=$(this);var params;params={ObjectId:this.rObjectId,ObjectName:this.rObjectName,ImageId:imageId,AdditionalWhere:this.additionalWhere,ImageClassId:this.imageClassId};let url="~/api/ImageManager";"recognition"==this.mode&&(url="~/api/ImageRecognitionManager"),flexygo.ajax.post(url,"GetImages",params,response=>{if(response[0]&&!response[0].imageError)for(let image of response)this.renderImage(image.imageId,image.name,image.descrip,image.classId,image.classDescrip,image.mainImage,image.orderNumber,image.path,image.haveFaceEncoding,image.lastError);else response[0]&&response[0].permissionError?flexygo.msg.warning("imagemanager.permissionerror"):0===response.length&&this.singleImage?(me.find("div.im-pry-container").append('<div class="im-empty im-transition">'+this.empty+'</div><i class="flx-icon icon-upload-1 im-empty-icon im-transition" flx-fw="">'),me.find("div.im-pry-container").addClass("im-pry-container-empty"),me.find("div.im-pry-container").find("div.im-empty").off("click").on("click",e=>{if(!flexygo.utils.isBlank(this.rObjectId)&&this.rObjectName){let defaults;defaults={ObjectName:this.rObjectName,ObjectId:this.rObjectId},flexygo.nav.openPage("list","sysObjectImages","Objects_Images.ObjectId = '"+this.rObjectId+"' And Objects_Images.ObjectName = '"+this.rObjectName+"'",JSON.stringify(defaults),"modal"+($(window).width()-30)+"x"+($(window).height()-50),!1,me)}})):0===response.length&&"view"==this.mode&&me.html('<div class="box-info"><i class="flx-icon icon-information-2 icon-lg icon-margin-right"></i><span><strong>Info!</strong> '+flexygo.localization.translate("flxlist.noentriesfound")+"</span></div>")})}}catch(ex){console.log(ex)}}updateImage(imageId,mainImage,orderNumber,objectName){try{let me=$(this);var params;params={ImageId:imageId,MainImage:mainImage,OrderNumber:orderNumber,ObjectName:objectName};let url="~/api/ImageManager";"recognition"==this.mode&&(url="~/api/ImageRecognitionManager"),flexygo.ajax.post(url,"UpdateImage",params,response=>{response&&!response.imageError?(me.find("div.im-item div.im-data div.im-mainimage").attr("value","false").removeClass("im-mi-mainimage").find("div.im-item-corner").removeClass("im-mi-item-corner"),me.find('div[imageid="'+response.imageId+'"]').find("div.im-data div.im-mainimage").attr("value","true").addClass("im-mi-mainimage").find("div.im-item-corner").addClass("im-mi-item-corner"),flexygo.msg.success("imagemanager.updated")):response.permissionError?flexygo.msg.warning("imagemanager.permissionerror"):flexygo.msg.error("imagemanager.errorupdating")})}catch(ex){console.log(ex)}}orderImage(image){try{let me=$(this);var order=[];for(let item of me.find("div.im-item").toArray()){let newItem={imageId:item.attributes.getNamedItem("imageid").value,top:item.offsetTop,left:item.offsetLeft};order.push(newItem)}order.sort(function(a,b){return a.top===b.top?a.left-b.left:a.top-b.top}),order.forEach((item,index)=>{me.find('div[imageid="'+item.imageId+'"]').attr("order",index),image&&image.attributes.getNamedItem("imageid").value===item.imageId&&this.updateImage(image.attributes.getNamedItem("imageid").value,"true"===image.childNodes[1].children[0].attributes.getNamedItem("value").value,parseInt(image.attributes.getNamedItem("order").value),this.rObjectName)})}catch(ex){console.log(ex)}}removeImage(imageId,objectName){try{let me=$(this);var params;params={ImageId:imageId,ObjectName:objectName};let url="~/api/ImageManager";"recognition"==this.mode&&(url="~/api/ImageRecognitionManager"),flexygo.ajax.post(url,"RemoveImage",params,response=>{response&&!response.imageError?(me.find('div[imageid="'+imageId+'"]').remove(),this.wall.fitWidth(),flexygo.msg.success("imagemanager.removed"),this.setGallery(),0!=response.imageId.length&&(me.find("div.im-item div.im-data div.im-mainimage").attr("value","false").removeClass("im-mi-mainimage").find("div.im-item-corner").removeClass("im-mi-item-corner"),me.find('div[imageid="'+response.imageId+'"]').find("div.im-data div.im-mainimage").attr("value","true").addClass("im-mi-mainimage").find("div.im-item-corner").addClass("im-mi-item-corner")),this.orderImage()):response.permissionError?flexygo.msg.warning("imagemanager.permissionerror"):flexygo.msg.error("imagemanager.errorremoving")})}catch(ex){console.log(ex)}}removeAllImages(objectName,objectId){try{let me=$(this);var params;params={ObjectName:objectName,ObjectId:objectId,AdditionalWhere:this.additionalWhere,ImageClassId:this.imageClassId};let url="~/api/ImageManager";"recognition"==this.mode&&(url="~/api/ImageRecognitionManager"),flexygo.ajax.post(url,"RemoveAllImages",params,response=>{response&&!response.imageError?(me.find('div[class="im-pry-container"]').empty(),this.wall.fitWidth(),this.refresh(),flexygo.msg.success("imagemanager.removedall"),this.setGallery()):response.permissionError?flexygo.msg.warning("imagemanager.permissionerror"):flexygo.msg.error("imagemanager.errorremoving")})}catch(ex){console.log(ex)}}downloadAllImages(objectName,objectId){try{var params;params={ObjectName:objectName,ObjectId:objectId,AdditionalWhere:this.additionalWhere,ImageClassId:this.imageClassId};let url="~/api/ImageManager";"recognition"==this.mode&&(url="~/api/ImageRecognitionManager"),flexygo.ajax.post(url,"DownloadAllImages",params,response=>{response&&!response.imageError?flexygo.utils.execDynamicCode(response.javacode):response.permissionError?flexygo.msg.warning("imagemanager.permissionerror"):flexygo.msg.error("imagemanager.errordownload")})}catch(ex){console.log(ex)}}imageReader(file){try{var reader;$(this),(reader=new FileReader).onload=(e=>{var tempImage=new Image;tempImage.onload=(ev=>{let imgWidth,imgHeight;imgWidth=tempImage.naturalWidth,imgHeight=tempImage.naturalHeight;var imgConf=new flexygo.obj.Entity("sysObjectImageSetting","ObjectName = '"+this.rObjectName+"'");let cnfHeight,cnfWidth,ratio;imgConf.read(),cnfWidth=imgConf.data.MaxWidth.Value?imgConf.data.MaxWidth.Value:imgWidth,cnfHeight=imgConf.data.MaxHeight.Value?imgConf.data.MaxHeight.Value:imgHeight,ratio=(ratio=Math.min(cnfWidth/imgWidth,cnfHeight/imgHeight))>1?1:ratio;var canvas=document.createElement("canvas");canvas.width=imgWidth*ratio,canvas.height=imgHeight*ratio;let ctx=canvas.getContext("2d");ctx.drawImage(tempImage,0,0,canvas.width,canvas.height);let cnfCompression=this.setCompression(imgConf.data.Compression.Value,file.type,canvas,ctx);this.setImage(file.name,canvas.toDataURL(file.type,cnfCompression))}),tempImage.src=reader.result}),reader.readAsDataURL(file)}catch(ex){console.log(ex)}}setCompression(compression,fileType,canvas,ctx){if(!compression||0===compression)return null;if("image/png"===fileType){let optionsgRgb={};switch(compression){case 1:optionsgRgb.colors=192;break;case 2:optionsgRgb.colors=128;break;case 3:optionsgRgb.colors=64}let rgbQuant=new RgbQuant(optionsgRgb);rgbQuant.sample(canvas);let img=rgbQuant.reduce(canvas),uint=new Uint8ClampedArray(img.buffer),imageData=new ImageData(uint,canvas.width,canvas.height);ctx.putImageData(imageData,0,0),canvas.getContext("2d").drawImage(canvas,0,0,canvas.width,canvas.height)}else switch(compression){case 1:return.75;case 2:return.5;case 3:return.25}return null}getClassification(){try{$(this),flexygo.ajax.post("~/api/ImageManager","GetClassification",null,response=>{response&&(this.classification=response)})}catch(ex){console.log(ex)}}setGallery(){try{let me=$(this);me.find(".im-wall").data("lightGallery")&&me.find(".im-wall").data("lightGallery").destroy(!0),me.find(".im-wall").lightGallery({selector:'div[method="preview"]',thumbnail:!0,animateThumb:!0,share:!1,rotate:!0,rotateLeft:!1,preload:2})}catch(ex){console.log(ex)}}showFaces(file,objectname,tolerance,filterids,isb64,e){let processName="FindFaces";isb64&&(processName="FindFacesB64");let p=new flexygo.Process(processName),params=[];params.push({Key:"File",Value:file}),params.push({Key:"ObjectName",Value:objectname}),params.push({Key:"Tolerance",Value:tolerance}),params.push({Key:"FilterIds",Value:filterids}),p.run(params,r=>{let histObj=new flexygo.nav.FlexygoHistory;histObj.targetid="popup";let modal=flexygo.targets.createContainer(histObj,!0,e);if(!modal)return;modal.empty(),modal.closest(".ui-dialog").find(".ui-dialog-title").html(r.Data.Faces.length+" faces found.");let canvas=$("<canvas></canvas>")[0],context=canvas.getContext("2d");var img=new Image;img.onload=function(){canvas.width=img.width,canvas.height=img.height,context.drawImage(img,0,0);let colorIndex=0;r.Data.Faces.forEach(function(face){colorIndex>=flexygo.utils.colors.length&&(colorIndex=0),context.strokeStyle=flexygo.utils.hexToRgbA(flexygo.utils.colors[colorIndex],"1"),context.lineWidth=3,context.strokeRect(face.Left,face.Top,face.Right-face.Left,face.Bottom-face.Top),context.fillStyle=flexygo.utils.hexToRgbA(flexygo.utils.colors[colorIndex],"0.6"),context.fillRect(face.Left,face.Top,face.Right-face.Left,face.Bottom-face.Top);let faceItm=$('<div style="float:left;margin-right:10px;"/>');faceItm.css("border","solid 2px "+flexygo.utils.hexToRgbA(flexygo.utils.colors[colorIndex],"1")),faceItm.css("background-color",flexygo.utils.hexToRgbA(flexygo.utils.colors[colorIndex],"0.6")),faceItm.data(face),face.MostPosibleObject?faceItm.html(face.MostPosibleObject.ObjectName+" "+face.MostPosibleObject.ObjectId+"<br/> Dist: "+face.MostPosibleObject.Distance):faceItm.html("Unknown"),modal.append(faceItm),colorIndex+=1});let imgH=$('<img style="width:100%;margin-top:10px"/>');imgH.attr("src",canvas.toDataURL()),modal.append(imgH)},img.src=flexygo.utils.resolveUrl(file)})}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-imagemanager",flexygo.ui.wc.FlxImageManagerElement);