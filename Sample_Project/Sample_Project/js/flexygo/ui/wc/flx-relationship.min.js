var flexygo;!function(flexygo){var ui_1;ui_1=flexygo.ui||(flexygo.ui={}),(ui_1.wc||(ui_1.wc={})).FlxRelationshipElement=class extends HTMLElement{constructor(){super(),this.previousOffset={top:null,left:null}}connectedCallback(){let element=this;0==$(document.head).find('script[id="leader-line"]').length&&$(document.head).append(`<script ID="leader-line" defer src="${flexygo.utils.resolveUrl("~/js/plugins/LeaderLine/leader-line.min.js")}"/>`),this.connected=!0,this.objectName=$(this).attr("ObjectName"),this.objectWhere=$(this).attr("ObjectWhere"),this.inputPropertyName=$(this).attr("InputPropertyName")?$(this).attr("InputPropertyName"):"",this.secundaryInputPropertyName=$(this).attr("secundaryInputPropertyName")?$(this).attr("secundaryInputPropertyName"):"",this.confModuleName=$(this).attr("ConfModuleName")?$(this).attr("ConfModuleName"):"",this.moduleName=$(this).attr("ModuleName"),this.relations={},this.paperScale=1,this.relationlineSize=4,flexygo.events.off(this,"module","resized"),flexygo.events.off(this,"property","changed"),flexygo.events.off(this,"module","loaded"),$(window).off("resize.relationship").on("resize.relationship",function(){element.paperScale=1,element.resizePaper()}),flexygo.events.on(this,"module","resized",function(e){element.paperScale=1,element.resizePaper()}),flexygo.events.on(this,"property","changed",this.onPropertyConfChange),flexygo.events.on(this,"module","loaded",this.setObjects),$("#mainContent").off("scroll.relationship").on("scroll.relationship",function(){let initialX=element.initialDimentions.wrapper.properties.translateX,initialY=element.initialDimentions.wrapper.properties.translateY;$(element).find(".wrapper").css("transform",`translate(${initialX+this.scrollLeft}px,${initialY+this.scrollTop}px)`),element.adjustRelationLines(),element.adjustWrapper()}),"true"!=$(this).attr("manualInit")&&this.init()}disconnectedCallback(){var _a,_b;flexygo.events.off(this,"module","resized"),$(window).off("resize.relationship"),$("#mainContent").off("scroll.relationship"),null===(_b=null===(_a=$(this.confModule))||void 0===_a?void 0:_a.find(`[property="${this.inputPropertyName}"]`))||void 0===_b||_b.removeAttr("disabled"),flexygo.events.off(this,"property","changed"),flexygo.events.off(this,"module","loaded"),this.clearRelations()}observedAttributes(){return[]}attributeChangedCallback(attrName,oldVal,newVal){}init(){var _a,_b;try{this.paperScale=1,this.parentKeyProperties=[],$(this).removeAttr("manualInit"),$(this).closest("flx-module").find(".flx-noInitContent").remove(),this.render(),$(this).find(".relationship-container").data("lastScale",this.paperScale),$(this).find(".paper").css({height:3*$("#mainContent")[0].getBoundingClientRect().height,width:2*$("#mainContent")[0].getBoundingClientRect().width}),$(this).find(".paper").data("originalHeight",3*$("#mainContent")[0].getBoundingClientRect().height),!flexygo.utils.isBlank(this.confModuleName)&&$(this).closest("main").find(`flx-module[modulename="${this.confModuleName}"]`).length>0&&(this.confModule=$(this).closest("main").find(`flx-module[modulename="${this.confModuleName}"]`),this.parentObjectName=this.confModule.find('[property="ObjectName"]').val(),this.childObjectName=this.confModule.find('[property="ChildCollection"]').val(),this.manageInputValue=!this.confModule.find('[property="manual"]').val(),this.manageInputValue?(this.checkSintaxis=!0,null===(_b=$(this.confModule).find(`[property="${this.inputPropertyName}"]`))||void 0===_b||_b.attr("disabled","disabled")):(this.checkSintaxis=!this.confModule.find('[property="manual"]').val(),null===(_a=$(this.confModule).find(`[property="${this.inputPropertyName}"]`))||void 0===_a||_a.removeAttr("disabled")),$(this).attr("focusable",`${this.manageInputValue}`)),flexygo.utils.isBlank(this.parentObjectName)&&flexygo.utils.isBlank(this.childObjectName)?(this.centerOffset(),this.updateDimentions()):(this.renderTables(),this.adjustPaperSize(),this.mainEvents(),this.centerOffset(),this.adjustTablesPosition(),this.adjustWrapper(),this.confModule&&(this.setRelations(),this.adjustRelationLines()),this.updateDimentions())}catch(ex){console.log(ex)}}refresh(){"true"!=$(this).attr("manualInit")&&(this.clearRelations(),this.init(),this.adjustWrapper(),this.adjustRelationLines())}render(){try{let me=$(this),rendered="";rendered=`<div class="scroller-paper">\n                                <div class="paper">\n                                    <div class="relationship-container" scale="1" >\n                                    </div>\n                                    <div class="wrapper"></div>\n                            </div>\n                        </div>\n                    </div>\n                    <div id="customContextMenu" class="hidden">\n                        <ul>\n                            <li id="removeRelationOption">Remove Relation</li>\n                        </ul>\n                    </div>\n                    <div class="relationship-toolbar">\n                        <span class="relationship-buttons">\n                            <b title="${flexygo.localization.translate("flxrelationship.zoomInButton")}" id="zoomRelationship" class="flx-icon icon-zoom-1" ></b>\n                            <b title="${flexygo.localization.translate("flxrelationship.zoomOutButton")}" id="zoomOutRelationship" class="flx-icon icon-zoomout" ></b>\n                            <b title="${flexygo.localization.translate("flxrelationship.suggestionsButton")}" id="relationshipSuggestions" class="flx-icon icon-idea2"></b>\n                            <b title="${flexygo.localization.translate("flxrelationship.clearButton")}" id="clearRelationships" class="flx-icon icon-clean-1" ></b>\n                        </span>\n                    </div>`,me.html(rendered)}catch(ex){console.log(ex)}}renderTables(table="both"){let renderedTables="";if(flexygo.utils.isBlank(this.parentObjectName))flexygo.utils.isBlank(this.parentObjectName)&&$(this).find(".parent-object").length>0&&$(this).find(".relationship-container>.parent-object").remove();else if("parent-object"==table||"both"==table)$(this).find(".relationship-container>.parent-object").remove(),renderedTables+=`<div class="table parent-object" ObjectName="${this.parentObjectName}" style="margin:0 3em 0 0;">\n                                    <div class="tableTab"></div>\n                                    <div class="header no-select">\n                                        <span class="title">${this.parentObjectName}</span>\n                                    </div>\n                                    <div class="properties">\n                                        ${this.renderProperties(this.parentObjectName,"parent-object")}\n                                    </div>\n                                </div>`;else{let parentObject=$(this).find(".parent-object");renderedTables+=parentObject.length>0?parentObject[0].outerHTML:""}if(flexygo.utils.isBlank(this.childObjectName))flexygo.utils.isBlank(this.childObjectName)&&$(this).find(".child-object").length>0&&$(this).find(".relationship-container>.child-object").remove();else if("child-object"==table||"both"==table)$(this).find(".relationship-container>.child-object").remove(),renderedTables+=`<div class="table child-object" ObjectName="${this.childObjectName}" style="margin: 0 0 0 3em;">\n                                    <div class="tableTab"></div>\n                                    <div class="header no-select">\n                                        <span class="title">${this.childObjectName}</span>\n                                    </div>\n                                    <div class="properties">\n                                        ${this.renderProperties(this.childObjectName,"child-object")}\n                                    </div>\n                                </div>`;else{let childObject=$(this).find(".child-object");renderedTables+=childObject.length>0?childObject[0].outerHTML:""}$(this).find(".relationship-container").html(renderedTables),$(this).find(".table .header").each((i,element)=>{let headerDims=element.getBoundingClientRect(),titleDims=$(element).find(".title")[0].getBoundingClientRect();headerDims.width<titleDims.width&&($(element).css("justify-content","start"),$(element).find(".title").css({width:"100%","text-overflow":"ellipsis",overflow:"hidden"}),$(element).attr("title",$(element).closest(".table").attr("objectname")))}),$(this).find(".table .nameProperties li").each((i,element)=>{let listItemDims=element.getBoundingClientRect(),spanDims=$(element).find("span")[0].getBoundingClientRect();listItemDims.width<spanDims.width&&$(element).attr("title",$(element).attr("propertyname"))})}renderProperties(ObjectName,selector){let propertiesTemplate=$('<div>\n                                            <div class="nameProperties">\n                                                <ul/>\n                                            </div>\n                                            <div class="typeProperties">\n                                                <ul/>\n                                            </div>\n                                        </div>');return flexygo.ajax.syncPost("~/api/Edit","GetEditConfig",{ObjectName},response=>{if(response)for(let property of Object.keys(response.Properties)){let clearType=response.Properties[property].DataType.split(".");propertiesTemplate.find(".nameProperties ul").append($(` <li PropertyName="${property}"><span>${property}</span></li>`));let typeElement=$(` <li PropertyName="${property}"><span>${clearType[clearType.length-1].replace(/\d/g,"")}</span></li>`);response.Properties[property].Key&&(typeElement.append($('<i class="flx-icon icon-key-2"></i>')),typeElement.find("span").css("margin-right","-4px")),propertiesTemplate.find(".typeProperties ul").append(typeElement),"parent-object"==selector&&response.Properties[property].Key&&this.parentKeyProperties.push(property)}}),propertiesTemplate.html()}setObjects(e){var _a,_b,_c,_d,_e,_f,_g,_h,_j;let moduleConf=this.confModule?this.confModule:$($(this).closest("main")).find(`flx-module[modulename="${this.confModuleName}"]`).length>0?$($(this).closest("main")).find(`flx-module[modulename="${this.confModuleName}"]`)[0]:void 0;if((null===(_b=null===(_a=null==e?void 0:e.sender)||void 0===_a?void 0:_a.moduleName)||void 0===_b?void 0:_b.toLowerCase())==this.confModuleName&&$(moduleConf).length>0&&$(moduleConf)[0]===e.sender){if(this.parentObjectName=$(e.sender).find('[property="ObjectName"]').val(),this.childObjectName=$(e.sender).find('[property="ChildCollection"]').val(),this.parentKeyProperties=[],this.manageInputValue=!$(e.sender).find('[property="manual"]').val(),this.manageInputValue?(this.checkSintaxis=!0,null===(_d=$(this.confModule).find(`[property="${this.inputPropertyName}"]`))||void 0===_d||_d.attr("disabled","disabled")):(this.checkSintaxis=!$(e.sender).find('[property="manual"]').val(),null===(_c=$(this.confModule).find(`[property="${this.inputPropertyName}"]`))||void 0===_c||_c.removeAttr("disabled")),$(this).attr("focusable",`${this.manageInputValue}`),this.confModule=$(e.sender),this.renderTables(),this.adjustPaperSize(),this.mainEvents(),this.initialDimentions&&(this.initialDimentions["relationship-container"].properties.height=$(this).find(".relationship-container")[0].getBoundingClientRect().height),this.adjustTablesPosition(),this.adjustWrapper(),this.setRelations(),this.confModule&&flexygo.utils.isBlank(null===(_e=this.confModule.find(`[property="${this.secundaryInputPropertyName}"]`))||void 0===_e?void 0:_e.val())){let relationshipValue=null===(_g=null===(_f=this.confModule)||void 0===_f?void 0:_f.find(`[property="${this.inputPropertyName}"]`))||void 0===_g?void 0:_g.val();null===(_j=null===(_h=this.confModule)||void 0===_h?void 0:_h.find(`[property="${this.secundaryInputPropertyName}"]`))||void 0===_j||_j.val(relationshipValue)}1!=this.paperScale?(this.paperScale=1,this.resizePaper()):this.adjustRelationLines(),this.updateDimentions()}}onPropertyConfChange(e){var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k,_l,_m,_o,_p,_q;if((null==e?void 0:e.sender)&&$(e.sender).closest("flx-module")[0]===$(this.confModule)[0])if("objectname"==(null===(_a=null==e?void 0:e.masterIdentity)||void 0===_a?void 0:_a.toLowerCase())){let value=$(e.sender).val()?$(e.sender).val():"";value.toLowerCase()!=this.parentObjectName&&(this.parentObjectName=value,null===(_c=null===(_b=this.confModule)||void 0===_b?void 0:_b.find(`[property="${this.inputPropertyName}"]`))||void 0===_c||_c.val(null),null===(_e=null===(_d=this.confModule)||void 0===_d?void 0:_d.find(`[property="${this.secundaryInputPropertyName}"]`))||void 0===_e||_e.val(null),this.parentKeyProperties=[],this.clearRelations(),this.renderTables("parent-object"),this.adjustPaperSize(),this.mainEvents(),this.initialDimentions&&(this.initialDimentions["relationship-container"].properties.height=$(this).find(".relationship-container")[0].getBoundingClientRect().height),this.adjustTablesPosition(),this.adjustWrapper(),1==this.paperScale&&this.updateDimentions(),this.suggestRelations())}else if("childcollection"==(null===(_f=null==e?void 0:e.masterIdentity)||void 0===_f?void 0:_f.toLowerCase())){let value=$(e.sender).val()?$(e.sender).val():"";value.toLowerCase()!=this.childObjectName&&(this.childObjectName=value,null===(_h=null===(_g=this.confModule)||void 0===_g?void 0:_g.find(`[property="${this.inputPropertyName}"]`))||void 0===_h||_h.val(null),null===(_k=null===(_j=this.confModule)||void 0===_j?void 0:_j.find(`[property="${this.secundaryInputPropertyName}"]`))||void 0===_k||_k.val(null),this.clearRelations(),this.renderTables("child-object"),this.adjustPaperSize(),this.mainEvents(),this.initialDimentions&&(this.initialDimentions["relationship-container"].properties.height=$(this).find(".relationship-container")[0].getBoundingClientRect().height),this.adjustTablesPosition(),this.adjustWrapper(),1==this.paperScale&&this.updateDimentions(),this.suggestRelations())}else"manual"==(null===(_l=null==e?void 0:e.masterIdentity)||void 0===_l?void 0:_l.toLowerCase())?(this.manageInputValue=!$(e.sender).val(),this.manageInputValue?null===(_m=$(this.confModule).find(`[property="${this.inputPropertyName}"]`))||void 0===_m||_m.attr("disabled","disabled"):null===(_o=$(this.confModule).find(`[property="${this.inputPropertyName}"]`))||void 0===_o||_o.removeAttr("disabled"),$(this).attr("focusable",`${this.manageInputValue}`),this.mainEvents()):(null===(_p=null==e?void 0:e.masterIdentity)||void 0===_p?void 0:_p.toLowerCase())==this.inputPropertyName.toLowerCase()&&0==this.manageInputValue?this.setRelations():"advanced"==(null===(_q=null==e?void 0:e.masterIdentity)||void 0===_q?void 0:_q.toLowerCase())&&(this.checkSintaxis=!$(e.sender).val())}updateDimentions(){let wrapperTransform=/\(([^)]+)\)/g.exec($(this).find(".wrapper").css("transform")),wrapperTranslateValues=wrapperTransform?wrapperTransform[1].split(","):null,wrapperTranslateX=0,wrapperTranslateY=0;wrapperTranslateValues&&wrapperTranslateValues.length>5?(wrapperTranslateX=parseInt(wrapperTranslateValues[4]),wrapperTranslateY=parseInt(wrapperTranslateValues[5])):this.initialDimentions&&this.initialDimentions.wrapper&&this.initialDimentions.wrapper.properties&&(wrapperTranslateX=this.initialDimentions.wrapper.properties.translateX,wrapperTranslateY=this.initialDimentions.wrapper.properties.translateY),this.initialDimentions={table:{properties:{width:flexygo.utils.parser.replaceAll($(this).find(".table").css("width"),"px","")},elementData:{ListItem:{selector:".table li",properties:{"font-size":flexygo.utils.parser.replaceAll($(this).find(".table li").css("font-size"),"px",""),padding:flexygo.utils.parser.replaceAll($(this).find(".table li").css("padding"),"px","")}},List:{selector:".table ul",properties:{padding:flexygo.utils.parser.replaceAll($(this).find(".table ul").css("padding"),"px","")}},TableTab:{selector:".table .tableTab",properties:{height:flexygo.utils.parser.replaceAll($(this).find(".table .tableTab").css("height"),"px","")}},Header:{selector:".table .header",properties:{margin:flexygo.utils.parser.replaceAll($(this).find(".table .header").css("margin"),"px","")}},Title:{selector:".table .title",properties:{"font-size":flexygo.utils.parser.replaceAll($(this).find(".table .title").css("font-size"),"px",""),padding:flexygo.utils.parser.replaceAll($(this).find(".table .title").css("padding"),"px","")}}},"parent-object":{properties:{margin:flexygo.utils.parser.replaceAll($(this).find(".table.parent-object").css("margin"),"px",""),height:$(this).find(".table.parent-object").height()}},"child-object":{properties:{margin:flexygo.utils.parser.replaceAll($(this).find(".table.child-object").css("margin"),"px",""),height:$(this).find(".table.child-object").height()}}},paper:{properties:{width:flexygo.utils.parser.replaceAll($(this).find(".paper").css("width"),"px",""),height:$(this).find(".paper").data("originalHeight")}},"relationship-container":{properties:{width:$(this).find(".relationship-container").width(),height:$(this).find(".relationship-container").height(),padding:flexygo.utils.parser.replaceAll($(this).find(".relationship-container").css("padding"),"px","")}},wrapper:{properties:{translateX:wrapperTranslateX,translateY:wrapperTranslateY}}}}clearRelations(refresh=!1){var _a,_b;let removedKeys=[];flexygo.utils.showLoadingEffect(1e4,$(this));try{for(let key of Object.keys(this.relations))removedKeys.push(key.replace(/[^.]+\.([^-.]+)-[^-.]+\.([^-.]+)/,"$1=$2")),this.removeRelation(key,!1);if(refresh){this.setNewRelationValue();let secundaryInput=null===(_a=this.confModule)||void 0===_a?void 0:_a.find(`[property="${this.secundaryInputPropertyName}"]`),currentSecundaryInputValues=null===(_b=null==secundaryInput?void 0:secundaryInput.val())||void 0===_b?void 0:_b.split("|"),filteredArray=[];for(let key of currentSecundaryInputValues)removedKeys.includes(key)||filteredArray.push(key);currentSecundaryInputValues=filteredArray,null==secundaryInput||secundaryInput.val(null==currentSecundaryInputValues?void 0:currentSecundaryInputValues.join("|"))}}catch(ex){}finally{flexygo.utils.removeLoadingEffect($(this))}}mainEvents(){let me=this;$(this).find(".table").draggable({cancel:"ul",stack:".table",drag:me.adjustRelationLines,scroll:!1}),1==this.manageInputValue?($(this).find(".properties ul").off("mouseenter.toogleHover").on("mouseenter.toogleHover","li",function(){me.toogleOnHover(this,!0)}),$(this).find(".properties ul").off("mouseleave.toogleHover").on("mouseleave.toogleHover","li",function(){me.toogleOnHover(this,!1)}),$(this).find(".properties ul").off("click.addRelation").on("click.addRelation","li",function(){me.propertySelected(this)}),$(this).find(".properties ul").off("contextmenu.showRelationMenu").on("contextmenu.showRelationMenu","li",function(e){e.preventDefault();let PropertyName=$(this).attr("PropertyName"),ObjectName=$(this).closest(".table").attr("ObjectName");me.showContextMenu(`${ObjectName}.${PropertyName}`,e),$(me).find("#customContextMenu #removeRelationOption").off("click.removeRelation").on("click.removeRelation",function(){flexygo.utils.showLoadingEffect(1e4,$(me));try{for(let key of Object.keys(me.relations)){let properties=key.split("-");properties[0]!=`${ObjectName}.${PropertyName}`&&properties[1]!=`${ObjectName}.${PropertyName}`||me.removeRelation(key,me.manageInputValue)}}catch(ex){}finally{flexygo.utils.removeLoadingEffect($(me))}})}),$(this).find(".paper").off("click.clearRelationsView").on("click.clearRelationsView",function(e){me.discardRelation(e)}),$(this).find('.relationship-buttons [id="relationshipSuggestions"]').on("click.suggestRelations",function(){me.suggestRelations()})):($(this).find(".properties ul").off("mouseenter.toogleHover"),$(this).find(".properties ul").off("mouseleave.toogleHover"),$(this).find(".properties ul").off("click.addRelation"),$(this).find(".properties ul").off("contextmenu.showRelationMenu").on("contextmenu.showRelationMenu",function(e){e.preventDefault()}),$(this).find("#customContextMenu #removeRelationOption").off("click.removeRelation"),$(this).find(".paper").off("click.clearRelationsView")),$(this).find(".paper").off("mousewheel.paperZoom").on("mousewheel.paperZoom",function(e){let zoomLevel=me.paperScale;(e.originalEvent.wheelDelta||-e.originalEvent.detail)>0?zoomLevel+=.2:zoomLevel-=.2,zoomLevel=Math.min(Math.max(zoomLevel,.4),3),(me.paperScale>.4||me.paperScale<3)&&(me.paperScale=parseFloat(zoomLevel.toFixed(1)),me.resizePaper()),e.preventDefault()}),$(this).find('.relationship-buttons [id="zoomRelationship"]').off("click.zoomButton").on("click.zoomButton",function(e){let zoomLevel=me.paperScale;zoomLevel+=.2,zoomLevel=Math.min(Math.max(zoomLevel,.4),3),(me.paperScale>.4||me.paperScale<3)&&(me.paperScale=parseFloat(zoomLevel.toFixed(1)),me.resizePaper())}),$(this).find('.relationship-buttons [id="zoomOutRelationship"]').off("click.zoomOutButton").on("click.zoomOutButton",function(e){let zoomLevel=me.paperScale;zoomLevel-=.2,zoomLevel=Math.min(Math.max(zoomLevel,.4),3),(me.paperScale>.4||me.paperScale<3)&&(me.paperScale=parseFloat(zoomLevel.toFixed(1)),me.resizePaper())}),$(this).find('.relationship-buttons [id="clearRelationships"]').off("click.clearRelationsButton").on("click.clearRelationsButton",function(){me.clearRelations(!0)}),$(this).find(".paper").draggable({drag:function(event,ui){let paper=ui.helper,scrollerPaper=paper.closest(".scroller-paper");if(null==me.previousOffset.left)me.previousOffset.left=ui.offset.left,me.previousOffset.top=ui.offset.top;else{if(me.previousOffset.left<ui.offset.left&&paper[0].getBoundingClientRect().left>=scrollerPaper[0].getBoundingClientRect().left)return!1;if(me.previousOffset.left>ui.offset.left&&paper[0].getBoundingClientRect().right<=scrollerPaper[0].getBoundingClientRect().right)return!1;if(me.previousOffset.top<ui.offset.top&&paper[0].getBoundingClientRect().top>=scrollerPaper[0].getBoundingClientRect().top)return!1;if(me.previousOffset.top>ui.offset.top&&paper[0].getBoundingClientRect().bottom<=scrollerPaper[0].getBoundingClientRect().bottom)return!1;me.previousOffset.left=ui.offset.left,me.previousOffset.top=ui.offset.top,me.adjustRelationLines();let parts=$(me).find(".paper").css("inset").split(" "),left=-1*parseInt(parts[0])+"px",right=-1*parseInt(parts[3])+"px",transformedValue=left+" "+parts[1]+" "+parts[2]+" "+right;$(me).find(".wrapper").css("inset",transformedValue),me.adjustWrapper()}},scroll:!1})}propertySelected(selectedProperty){let selectedProperties=$(this).find(".properties li.selectedProperty"),tableClass=$(selectedProperty).closest(".table")[0].classList[1],propertyName=$(selectedProperty).attr("propertyname");if(selectedProperties.length>0){let parentProperty=null,childProperty=null;$(selectedProperties[0]).closest(".table")[0].classList.contains("parent-object")?(parentProperty=selectedProperties[0],childProperty=selectedProperty):(parentProperty=selectedProperty,childProperty=selectedProperties[0]),flexygo.utils.showLoadingEffect(1e4,$(this));try{this.addRelation(parentProperty,childProperty,this.manageInputValue)}catch(ex){}finally{flexygo.utils.removeLoadingEffect($(this))}$(selectedProperties).removeClass("selectedProperty")}else $(this).find(`.${tableClass} li[propertyname="${propertyName}"]`).addClass("selectedProperty")}addRelation(parentProperty,childProperty,refresh){let parentTable=parentProperty.closest(".table"),childTable=childProperty.closest(".table"),parentObjectName=$(parentTable).attr("ObjectName"),childObjectName=$(childTable).attr("ObjectName"),parentPropertyName=$(parentProperty).attr("Propertyname"),childPropertyName=$(childProperty).attr("Propertyname"),key=`${parentObjectName}.${parentPropertyName}-${childObjectName}.${childPropertyName}`,alreadyRelated=!1,sameObject=parentObjectName===childObjectName;for(let existingKey in this.relations){let[existingParentKey,existingChildKey]=existingKey.split("-");if(existingParentKey===`${parentObjectName}.${parentPropertyName}`||existingChildKey===`${childObjectName}.${childPropertyName}`){alreadyRelated=!0;break}}if(!alreadyRelated&&!sameObject){let nodes=this.getAnchorNodes(parentPropertyName,childPropertyName),line=new LeaderLine(nodes.start.node,nodes.end.node,{color:"rgb(177, 177, 177)",startPlug:"behind",endPlug:"behind",startSocketGravity:"0",startSocket:nodes.start.socket,endSocket:nodes.end.socket,size:this.relationlineSize*this.paperScale});this.relations[key]=line,$(document.body).find("> .leader-line").attr("id",key);let leaderLineElement=$(document.body).find(`> .leader-line[id="${key}"]`)[0];$(this).find(".wrapper")[0].appendChild(leaderLineElement),refresh&&this.setNewRelationValue()}}setRelations(){var _a,_b,_c,_d,_e,_f,_g;flexygo.utils.showLoadingEffect(1e4,$(this));try{this.clearRelations();let invalidSyntax=!1,invalidProperties=!1,relationArray=null===(_c=null===(_b=null===(_a=this.confModule)||void 0===_a?void 0:_a.find(`[property=${this.inputPropertyName}]`))||void 0===_b?void 0:_b.val())||void 0===_c?void 0:_c.split("|"),newRelationString="";if(relationArray){const regex=/([a-zA-Z0-9_]+)=([a-zA-Z0-9_]+)/,findElement=selector=>$(this).find(selector);for(let relation of relationArray)if(regex.exec(relation)){let properties=relation.split("="),parentProperty=findElement(`.parent-object .properties li[propertyname="${properties[0]}"]`),childProperty=findElement(`.child-object .properties li[propertyname="${properties[1]}"]`);parentProperty.length>0&&childProperty.length>0?(this.addRelation(parentProperty,childProperty,!1),newRelationString+=relation+"|"):invalidProperties=!0}else invalidSyntax=!0;invalidSyntax&&this.checkSintaxis?(flexygo.msg.warning(flexygo.localization.translate("flxrelationship.invalidSintaxis"),null),null===(_e=null===(_d=this.confModule)||void 0===_d?void 0:_d.find('[property="ObjectRelation"]'))||void 0===_e||_e.val(newRelationString.replace(/(\|)$/,""))):invalidProperties&&this.checkSintaxis&&(flexygo.msg.warning(flexygo.localization.translate("flxrelationship.invalidProperties"),null),null===(_g=null===(_f=this.confModule)||void 0===_f?void 0:_f.find('[property="ObjectRelation"]'))||void 0===_g||_g.val(newRelationString.replace(/(\|)$/,"")))}}catch(ex){}finally{flexygo.utils.removeLoadingEffect($(this))}}suggestRelations(){flexygo.utils.showLoadingEffect(1e4,$(this));try{for(let key of this.parentKeyProperties){let childProperty=$(this).find(`.table.child-object li[PropertyName="${key}"]`);if(childProperty.length>0){let parentProperty=$(this).find(`.table.parent-object li[PropertyName="${key}"]`);this.addRelation(parentProperty,childProperty,!0)}}}catch(ex){}finally{flexygo.utils.removeLoadingEffect($(this))}}removeRelation(relationKey,refresh){var _a,_b,_c,_d;let line=$(this).find(`.leader-line[id="${relationKey}"]`)[0];if(line)$(document.body)[0].appendChild(line),this.relations[relationKey].remove();else{let bodyLine=$(document.body).find(`> .leader-line[id="${relationKey}"]`);bodyLine.length>0&&bodyLine.remove()}if(delete this.relations[relationKey],$(this).find("#customContextMenu").addClass("hidden"),refresh){this.setNewRelationValue();let removedRelation=relationKey.replace(/[^.]+\.([^-.]+)-[^-.]+\.([^-.]+)/,"$1=$2"),defaults=null===(_b=null===(_a=this.confModule)||void 0===_a?void 0:_a.find(`[property="${this.secundaryInputPropertyName}"]`))||void 0===_b?void 0:_b.val().split("|");for(let relationIndex in defaults)defaults[relationIndex]==removedRelation&&delete defaults[relationIndex];let newInputValue=defaults.join("|");null===(_d=null===(_c=this.confModule)||void 0===_c?void 0:_c.find(`[property="${this.secundaryInputPropertyName}"]`))||void 0===_d||_d.val(newInputValue)}}discardRelation(event){if(!$(event.target).is("li")&&!$(event.target).is("span")){let selectedProperties=$(this).find(".properties li.selectedProperty");selectedProperties.length>0&&$(selectedProperties).removeClass("selectedProperty"),$(this).find("#customContextMenu").addClass("hidden")}}setNewRelationValue(){var _a,_b,_c,_d,_e,_f;let result="",keys=Object.keys(this.relations),newKeys=[];keys.forEach((key,index)=>{newKeys.push(key.replace(/[^.]+\.([^-.]+)-[^-.]+\.([^-.]+)/,"$1=$2"))}),result=newKeys.join("|"),null===(_b=null===(_a=this.confModule)||void 0===_a?void 0:_a.find(`[property="${this.inputPropertyName}"]`))||void 0===_b||_b.val(result);let lastRelation=result.split("|"),currentSecundaryValue=null===(_d=null===(_c=this.confModule)||void 0===_c?void 0:_c.find(`[property="${this.secundaryInputPropertyName}"]`))||void 0===_d?void 0:_d.val(),secundaryInputValue="";secundaryInputValue=flexygo.utils.isBlank(currentSecundaryValue)?lastRelation[lastRelation.length-1]:currentSecundaryValue+"|"+lastRelation[lastRelation.length-1],null===(_f=null===(_e=this.confModule)||void 0===_e?void 0:_e.find(`[property="${this.secundaryInputPropertyName}"]`))||void 0===_f||_f.val(secundaryInputValue)}adjustRelationLines(){let me=$(this).closest("flx-relationship")[0];for(let key in me.relations){let line=me.relations[key],nodes=me.getAnchorNodes($(line.start).closest("li").attr("PropertyName"),$(line.end).closest("li").attr("PropertyName"));line.setOptions({size:me.relationlineSize*me.paperScale}),line.setOptions({start:nodes.start.node,startSocket:nodes.start.socket}),line.setOptions({end:nodes.end.node,endSocket:nodes.end.socket}),$(".leader-line").css("z-index",$(me).zIndex()),line.position()}}adjustPaperSize(){let currentPaperDimentions={width:0,height:0};this.initialDimentions?(currentPaperDimentions.width=parseFloat(this.initialDimentions.paper.properties.width),currentPaperDimentions.height=parseFloat(this.initialDimentions.paper.properties.height)):(currentPaperDimentions.width=$(this).find(".paper")[0].getBoundingClientRect().width,currentPaperDimentions.height=$(this).find(".paper")[0].getBoundingClientRect().height);let widthDiff=currentPaperDimentions.width-flexygo.utils.parser.replaceAll($(this).find(".relationship-container").css("width"),"px",""),heightDiff=currentPaperDimentions.height-flexygo.utils.parser.replaceAll($(this).find(".relationship-container").css("height"),"px","");if(widthDiff<400){let increaseSize=400;widthDiff<0&&(increaseSize-=widthDiff),$(this).find(".paper").css("height",currentPaperDimentions.width+increaseSize)}if(heightDiff<400){let increaseSize=400;heightDiff<0&&(increaseSize-=heightDiff),$(this).find(".paper").css("height",currentPaperDimentions.height+increaseSize)}}adjustTablesPosition(){let conteinerHeight=0,scrollerHeight=$(this).find(".scroller-paper")[0].getBoundingClientRect().height;if(scrollerHeight<(conteinerHeight=this.initialDimentions?this.initialDimentions["relationship-container"].properties.height:$(this).find(".relationship-container")[0].getBoundingClientRect().height)){$(this).find(".relationship-container").css("top",0);let scrollerRects=$(this).find(".scroller-paper")[0].getBoundingClientRect(),newTop=-$(this).find(".relationship-container")[0].getBoundingClientRect().top+scrollerRects.top+10;$(this).find(".relationship-container").css("top",newTop);let maximumTablesHeight=3*conteinerHeight+newTop;if(scrollerHeight<maximumTablesHeight){let newHeight=scrollerHeight+Math.abs(conteinerHeight-maximumTablesHeight);$(this).find(".paper").css("height",newHeight+300+"px")}this.tablesPositioned=!0}else $(this).find(".relationship-container").css("top",""),this.centerOffset(),this.tablesPositioned=!1}adjustWrapper(){let wrapper=$(this).find(".wrapper");wrapper.css({inset:"",transform:""});let translateX=`${wrapper[0].getBoundingClientRect().left+pageXOffset}`,translateY=`${wrapper[0].getBoundingClientRect().top+pageYOffset}`;this.initialDimentions&&this.tablesPositioned&&(this.initialDimentions.wrapper.properties.translateX=-translateX,this.initialDimentions.wrapper.properties.translateY=-translateY),wrapper.css("transform",`translate(-${translateX}px,-${translateY}px)`)}resizePaper(){let currentScale=parseFloat($(this).find(".relationship-container").attr("scale"));if(.4!=currentScale&&3!=currentScale||currentScale!=this.paperScale){$(this).find(".relationship-container").data("lastScale",currentScale);for(let key in this.initialDimentions.table.elementData){let element=this.initialDimentions.table.elementData[key];for(let property in element.properties){let value=element.properties[property];this.scaleStyle(element.selector,property,value)}}this.scaleStyle(".table","width",this.initialDimentions.table.properties.width),this.scaleStyle(".table.parent-object","top",flexygo.utils.parser.replaceAll($(this).find(".table.parent-object").css("top"),"px",""),currentScale),this.scaleStyle(".table.parent-object","left",flexygo.utils.parser.replaceAll($(this).find(".table.parent-object").css("left"),"px",""),currentScale),this.scaleStyle(".table.parent-object","height",this.initialDimentions.table["parent-object"].properties.height),this.scaleStyle(".table.child-object","top",flexygo.utils.parser.replaceAll($(this).find(".table.child-object").css("top"),"px",""),currentScale),this.scaleStyle(".table.child-object","left",flexygo.utils.parser.replaceAll($(this).find(".table.child-object").css("left"),"px",""),currentScale),this.scaleStyle(".table.child-object","height",this.initialDimentions.table["child-object"].properties.height),this.scaleStyle(".table.parent-object","margin",this.initialDimentions.table["parent-object"].properties.margin),this.scaleStyle(".table.child-object","margin",this.initialDimentions.table["child-object"].properties.margin),$(this).find(".relationship-container").attr("scale",this.paperScale),$(this).find(".paper").css("inset",""),this.centerOffset(),this.adjustTablesPosition(),this.adjustWrapper(),this.adjustRelationLines()}}getAnchorNodes(firstPropertyName,secondPropertyName){let parentCoords=$(this).find(".parent-object")[0].getBoundingClientRect(),nodes={start:{},end:{}},childCoords=$(this).find(".child-object")[0].getBoundingClientRect(),halfWidth=parentCoords.width/2;return childCoords.left>=parentCoords.left+halfWidth?(nodes.start.node=$(this).find(".parent-object").find(`.properties .typeProperties li[PropertyName="${firstPropertyName}"] span`)[0],nodes.start.socket="right",nodes.end.node=$(this).find(".child-object").find(`.properties .nameProperties li[PropertyName="${secondPropertyName}"] span`)[0],nodes.end.socket="left"):childCoords.left<=parentCoords.left+halfWidth&&Math.trunc(childCoords.right)>Math.trunc(parentCoords.left)?(nodes.start.node=$(this).find(".parent-object").find(`.properties .nameProperties li[PropertyName="${firstPropertyName}"] span`)[0],nodes.start.socket="left",nodes.end.node=$(this).find(".child-object").find(`.properties .nameProperties li[PropertyName="${secondPropertyName}"] span`)[0],nodes.end.socket="left"):(nodes.start.node=$(this).find(".parent-object").find(`.properties .nameProperties li[PropertyName="${firstPropertyName}"] span`)[0],nodes.start.socket="left",nodes.end.node=$(this).find(".child-object").find(`.properties .typeProperties li[PropertyName="${secondPropertyName}"] span`)[0],nodes.end.socket="right"),nodes}scaleStyle(element,property,initialValue,currentScale=null){let result="";initialValue=initialValue||0;for(let currentVal of initialValue.toString().split(" "))result+=(currentScale?currentVal/currentScale*this.paperScale:currentVal*this.paperScale)+"px ";$(this).find(element).css(property,result)}showContextMenu(relationKey,event){let existingRelation=!1;for(let key in this.relations)if(key.includes(relationKey)){existingRelation=!0;break}if(existingRelation){let customContextMenu=$(this).find("#customContextMenu");customContextMenu.css({top:event.clientY+"px",left:event.clientX+"px"}),customContextMenu.removeClass("hidden")}}toogleOnHover(element,onHover){if(onHover){let index=$(element).index();"typeProperties"==element.closest("div").classList.value?$($(element).closest(".properties")).find(".nameProperties ul li").eq(index).addClass("active"):$($(element).closest(".properties")).find(".typeProperties ul li").eq(index).addClass("active")}else{let index=$(element).index();"typeProperties"==element.closest("div").classList.value?$($(element).closest(".properties")).find(".nameProperties ul li").eq(index).removeClass("active"):$($(element).closest(".properties")).find(".typeProperties ul li").eq(index).removeClass("active")}}centerOffset(element=null){let context=element&&"flx-relationship"==element.tagName.toLowerCase()?$(element)[0]:this;if(context){let container=$(context).find(".scroller-paper")[0];container.scrollLeft=(container.scrollWidth-container.clientWidth)/2,container.scrollTop=(container.scrollHeight-container.clientHeight)/2}}}}(flexygo||(flexygo={})),window.customElements.define("flx-relationship",flexygo.ui.wc.FlxRelationshipElement);