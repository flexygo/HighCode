var flexygo;!function(flexygo){!function(ui){!function(wc){wc.LoadNodesParams=class{};wc.NavigationNode=class{};wc.HierarchicalNode=class{};wc.FlxNodeManagerElement=class extends HTMLElement{constructor(){super(),this.connected=!1,this.method=null,this.deleteMethod="DeleteNode",this.relocateMethod="RelocateNode",this.refreshMetod="RefreshNodes",this.rootNodeId="",this.openNodes=null,this.scrollY=0,this.sortableList=null,this.template='<li id="fgnsli_{{NodeId}}" strType="{{strType}}">\n            <div>\n                <div>\n                    <i class="flx-icon {{IconClass|isnull:icon-menu,{{IconClass}}}}"/>\n                    <span>{{Title}} <small>({{strType}})</small></span>\n                </div>\n                <div class="btn-panel">\n                        <i class="flx-icon icon-plus" data-action="add"/>\n                        <i class="flx-icon icon-order-down-2" data-action="toggle"/>\n                        <i class="flx-icon icon-pencil" data-action="edit"/>\n                    <i class="flx-icon icon-delete-2" data-action="del"/>\n                    <i class="flx-icon icon-lock-1" data-action="security"/>\n                </div>\n            </div>\n            <div class="row collapse editnode" id="Node{{NodeId}}" NodeId="{{NodeId}}"/>\n            {{getChildNodes(json)}}\n        </li>'}connectedCallback(){let element=$(this);this.connected=!0;let initNode=element.attr("initNode");initNode&&(this.method="GetNodesById",this.methodParams={ParentId:initNode,HideAutoSQLNodes:!0},this.initNode=initNode),this.init()}init(){this.loadNodes()}refreshNavBar(){$(document).find("flx-nav").each((i,e)=>{let navbar=$(e)[0];navbar&&navbar.refresh()})}refresh(){this.loadNodes()}loadNodes(){$(this).empty(),flexygo.ajax.post("~/api/Navigation",this.method,this.methodParams,response=>{let arrOrdered=this.sortNodes(flexygo.utils.lowerKeys(response,!0),"order");$(this).html('<div class="managerpanel"></div>'),this.loadNodesRet(arrOrdered)})}setRootNode(ret){let rootnode=null;return $.each(ret,(i,e)=>{let thisnode=e;if(""==e.parentnodeid?rootnode=e:$.each(ret,(i,ee)=>{if(ee.parentnodeid===thisnode.nodeid)return rootnode=thisnode,!1}),rootnode)return ret.splice(i,1),e.childnodes=ret,ret=[e],!1}),rootnode}loadNodesRet(ret){let rootnode=null,me=$(this);this.rootNodeId="",(rootnode=this.setRootNode(ret))?this.rootNodeId=rootnode.nodeid:(this.rootNodeId=ret&&1==ret.length?ret[0].nodeid:"root",rootnode={nodeid:this.rootNodeId,parentnodeid:"",childnodes:ret,title:flexygo.localization.translate("nodemanager.title"),order:0,strtype:""});let cnt=flexygo.utils.parser.recursiveCompile(rootnode,this.template,this),elem=$('<ul class="sortable" />').html(cnt).first();me.find(".managerpanel").append(elem);let btnroot=me.find("#fgnsli_"+this.rootNodeId).find(".btn-panel").first();btnroot.find('[data-action="del"]').first().hide(),btnroot.find('[data-action="edit"]').first().hide(),btnroot.find('[data-action="toggle"]').first().removeClass("icon-order-down-2").addClass("icon-order-up-2"),this.sortableList=me.find(".sortable"),this.sortableList.nestedSortable({forcePlaceholderSize:!0,listType:"ul",handle:"div",helper:"clone",items:"li",opacity:.6,placeholder:"placeholder",revert:250,tabSize:25,tolerance:"pointer",toleranceElement:"> div",maxLevels:0,isTree:!1,expandOnHover:700,startCollapsed:!1,protectRoot:!0,relocate:(e,f)=>{let nodes=this.sortableList.nestedSortable("toHierarchy",{expression:/(.+)[_](.+)/}),nodeid=f.item.attr("id");nodeid=nodeid.substring(nodeid.indexOf("_")+1);let params=this.findNode(nodes,nodeid);params&&flexygo.ajax.post("~/api/Navigation",this.relocateMethod,params,response=>{this.refreshNavBar()})}}).disableSelection(),me.find('[data-action="edit"]').on("click",e=>{$(e.currentTarget).hasClass("active")?$(e.currentTarget).removeClass("active"):($(e.currentTarget).addClass("active"),me.find('[data-action="add"]').removeClass("active")),this.showEdit($(e.target).closest("li").children(".editnode"),!1)}),me.find('[data-action="add"]').on("click",e=>{$(e.currentTarget).hasClass("active")?$(e.currentTarget).removeClass("active"):($(e.currentTarget).addClass("active"),me.find('[data-action="edit"]').removeClass("active")),this.showEdit($(e.target).closest("li").children(".editnode"),!0)}),me.find('[data-action="toggle"]').on("click",e=>{let icon=$(e.currentTarget),opened=icon.hasClass("icon-order-up-2"),content=$(e.currentTarget).closest("li").children("ul").first();opened?(content.hide(),icon.removeClass("icon-order-up-2 active").addClass("icon-order-down-2")):(content.show(),icon.removeClass("icon-order-down-2").addClass("icon-order-up-2 active")),this.saveNodesState()}),me.find('[data-action="del"]').on("click",e=>{let node=$(e.currentTarget).closest("li").children(".editnode")[0].id;Lobibox.confirm({title:flexygo.localization.translate("nodemanager.deletenode"),msg:flexygo.localization.translate("nodemanager.deletenodequestion"),iconClass:"",callback:(dlg,type,ev)=>{"yes"==type&&this.deleteNode(node)}})}),me.find('[data-action="security"]').on("click",e=>{let node=$(e.currentTarget).closest("li").children(".editnode")[0].id.replace("Node","");flexygo.nav.openPage("view","sysNavigationNode","NodeId='"+node+"'",null,"modal800x600",!0,$(e.currentTarget),!1)})}showEdit(placeHolder,isNewNode){if(placeHolder.hasClass("in")&&placeHolder.attr("isnewnode")===isNewNode.toString())placeHolder.collapse("hide"),placeHolder.closest("li").find("> div:first-child").removeClass("active"),this.sortableList.sortable("enable"),placeHolder.empty(),placeHolder.removeAttr("isnewnode"),placeHolder.closest(".ui-dialog").find(".ui-dialog-titlebar-close").length>0&&placeHolder.closest("main.pageContainer").off("dialogbeforeclose");else{placeHolder.closest("li").find("> div:first-child").addClass("active"),placeHolder.collapse("hide"),flexygo.events.off(placeHolder,"module","loaded"),flexygo.events.on(placeHolder,"module","loaded",e=>{(e.context=placeHolder)&&(setTimeout(()=>{placeHolder.collapse("show")},100),flexygo.events.off(placeHolder,"module","loaded"))}),this.sortableList.sortable("disable");let editModuleName="sysmod-edit-generic",containerTemplate='<div class="cntBody nopadding size-xs"></div><div class="cntBodyFooter"></div>',container=$('<flx-module class="nodeEdit"/>').html(containerTemplate).attr("modulename",editModuleName).attr("type","flx-edit").addClass("empty");placeHolder.attr("isnewnode",isNewNode.toString()),placeHolder.empty(),placeHolder.append(container);let module=null,parent=placeHolder.attr("nodeid");if(!0===isNewNode){let objDef={parentNodeId:parent},strobjDef=JSON.stringify(objDef);module=$("<flx-edit />").attr("ObjectName","sysNavigationNode").attr("defaults",strobjDef).attr("modulename",editModuleName),flexygo.events.on(this,"entity","all",e=>{flexygo.events.off(this,"entity","all"),"inserted"===e.type&&(this.saveNodesState(),placeHolder.closest(".ui-dialog").find(".ui-dialog-titlebar-close").length>0&&placeHolder.closest("main.pageContainer").off("dialogbeforeclose"),flexygo.ajax.post("~/api/Navigation",this.refreshMetod,null,response=>{this.loadNodes(),this.refreshNavBar()}))})}else module=$("<flx-edit />").attr("ObjectName","sysNavigationNode").attr("ObjectWhere","Nodeid='"+placeHolder.attr("nodeid")+"'").attr("modulename",editModuleName);container.find(".cntBody").append(module);let ctrl=container[0];ctrl.moduleName=editModuleName,ctrl.canCollapse=!0,ctrl.canEnlarge=!0,ctrl.canRefresh=!0,ctrl.canConfig=!1,ctrl.init()}}findNode(nodes,nodeid,parentid){let res=null;return $.each(nodes,(i,e)=>e.id===nodeid?(res={id:e.id,parentid,order:i},!1):(!e.children||!(res=this.findNode(e.children,nodeid,e.id)))&&void 0),res}sortNodes(nodes,orderby){let ordered=flexygo.utils.sortObject(nodes,orderby);return $.each(nodes,(i,e)=>{let obj=e.childnodes;0===Object.keys(obj).length&&obj.constructor===Object||(e.childnodes=this.sortNodes(e.childnodes,orderby))}),ordered}getChildNodes(json){let cnt="",ret=json.childnodes;if(Object.keys(ret).length>0)for(let nKey in ret)cnt+=flexygo.utils.parser.recursiveCompile(ret[nKey],this.template,this);let style="";return json.nodeid!==this.rootNodeId&&(style='style="display:none"'),""!=cnt?"<ul data-navnode "+style+">"+cnt+"</ul>":"<ul data-navnode ></ul>"}deleteNode(node){let params={nodeId:node};flexygo.ajax.post("~/api/Navigation",this.deleteMethod,params,response=>{$(this).find("#fgnsli_"+node.toLowerCase().replace("node","")).remove(),this.refreshNavBar()})}saveOpenNode(btn){if(btn.hasClass("icon-order-up-2")){let parent=btn.closest("li");this.openNodes.push(parent.attr("id"));let ul=parent.children("ul [data-navnode]");$.each(ul.children(),(i,e)=>{let childbtn=$(e).children().first().find('[data-action="toggle"]');childbtn.length>0&&this.saveOpenNode(childbtn)})}}saveNodesState(){this.openNodes=[];let me=$(this),btn=me.find(".sortable").children("li").children().first().find('[data-action="toggle"]');this.saveOpenNode(btn),this.scrollY=me.find(".sortable").parent().scrollTop()}restoreNodesState(){let list=$(this).find(".sortable");this.openNodes&&$.each(this.openNodes,(i,e)=>{let node=$("#"+e);if(node){let btn=node.children().first().find('[data-action="toggle"]');btn.find("i").first().hasClass("icon-order-down-2")&&btn.trigger("click")}}),this.openNodes=[],list.parent().scrollTop(this.scrollY)}}}(ui.wc||(ui.wc={}))}(flexygo.ui||(flexygo.ui={}))}(flexygo||(flexygo={})),window.customElements.define("flx-nodemanager",flexygo.ui.wc.FlxNodeManagerElement);