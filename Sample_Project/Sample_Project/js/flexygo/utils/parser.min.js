var flexygo;!function(flexygo){!function(utils){!function(parser){function replaceAll(str,find,replace){if(!str||find==replace)return str;return str.toString().replace(new RegExp(function(str){let callee=arguments.callee;if(!callee.sRE){let specials=["/",".","*","+","?","|","(",")","[","]","{","}","\\"];callee.sRE=new RegExp("(\\"+specials.join("|\\")+")","gim")}return str.replace(callee.sRE,"\\$1")}(find),"ig"),replace)}function escapeJsString(str){return str&&(str=replaceAll(str,"\\","\\\\"),str=replaceAll(str,"'","\\'")),str}function escapeSqltring(str){return str&&(str=replaceAll(str,"'","''")),str}function escapeHtmlString(str){return str&&(str=replaceAll(str,"&","&amp;"),str=replaceAll(str,"<","&lt;"),str=replaceAll(str,">","&gt;"),str=replaceAll(str,'"',"&quot"),str=replaceAll(str,"'","&#39;"),str=replaceAll(str,",","&#44;"),str=replaceAll(str,":","&#58;"),str=replaceAll(str,"|","&#124;")),str}parser.recursiveCompile=function(json,template,contextFunctions,lastTemplate,AddTimeZone=!1){let hasMoreMatches=template.match(/{{([^{}]+)}}/g),retString=flexygo.utils.parser.compile(json,template,contextFunctions,AddTimeZone);return lastTemplate&&retString==lastTemplate||null==hasMoreMatches||(retString=flexygo.utils.parser.recursiveCompile(json,retString,contextFunctions,retString,AddTimeZone)),retString},parser.compile=function(json,template,contextFunctions,AddTimeZone=!1){let matches=template.match(/{{([^{}]+)}}/g),retString=template;if(null!=matches){json=flexygo.utils.lowerKeys(json);let contextVars=flexygo.utils.lowerKeys(flexygo.context);for(let i=0;i<matches.length;i++){var skipReplace=!1;let marker=matches[i],rValue="",isFunction=!1;if(-1!=marker.indexOf("("))try{let fFunc=marker.substring(2,marker.length-2).trim(),fName=fFunc.substring(0,fFunc.indexOf("(")).trim();(contextFunctions&&"function"==typeof contextFunctions[fName]||"function"==typeof flexygo.utils.execDynamicCode.call(this,fName))&&(isFunction=!0)}catch(e){}if(isFunction){let fFunc=marker.substring(2,marker.length-2).trim(),fName=fFunc.substring(0,fFunc.indexOf("(")).trim(),fParams=fFunc.substring(fFunc.indexOf("(")+1,fFunc.lastIndexOf(")")).trim().split(",");for(let j=0;j<fParams.length;j++){let jKey=fParams[j].toLowerCase().trim();if(jKey.startsWith("'")&&jKey.endsWith("'")||jKey.startsWith('"')&&jKey.endsWith('"'))fParams[j]=jKey.slice(1,-1);else if(json&&void 0!==json[jKey]&&null!=json[jKey]||contextVars&&void 0!==contextVars[jKey]&&null!=contextVars[jKey]||"json"===jKey||"template"===jKey||"contextfunctions"===jKey||"this"===jKey){let value;value=json&&void 0!==json[jKey]&&null!=json[jKey]?flexygo.utils.parser.getValue(json[jKey]):"json"===jKey?json:"template"===jKey?template:"contextfunctions"===jKey||"this"===jKey?contextFunctions:contextVars[jKey],fParams[j]=value}}try{rValue=contextFunctions&&void 0!==contextFunctions[fName]?contextFunctions[fName].apply(contextFunctions,fParams):flexygo.utils.execDynamicCode.call(this,fName).apply(null,fParams)}catch(ex){rValue=ex.message}}else if(-1!=marker.indexOf("|")){let jKey,jKeyUp,propFormat,auxMarker=marker.substring(2,marker.length-2).trim();if(auxMarker.toLowerCase().startsWith("flxpath")&&auxMarker.split("|").length>=3?(jKeyUp=auxMarker.split("|").slice(0,3).join("|").trim(),propFormat=auxMarker.split("|").slice(3).join("|").trim()):(jKeyUp=auxMarker.split("|")[0].trim(),propFormat=auxMarker.split("|")[1].trim()),jKey=jKeyUp.toLowerCase(),json&&void 0!==json[jKey]||contextVars&&void 0!==contextVars[jKey]||contextFunctions&&void 0!==contextFunctions[jKeyUp]||"currentdatetime"==jKey||"currentdate"==jKey){"currentdatetime"==jKey?rValue=moment().format("YYYYMMDD HHmmss"):"currentdate"==jKey?rValue=moment().format("YYYYMMDD"):json&&void 0!==json[jKey]?rValue=flexygo.utils.parser.getValue(json[jKey],"Value"):contextVars&&void 0!==contextVars[jKey]?rValue=contextVars[jKey]:contextFunctions&&void 0!==contextFunctions[jKeyUp]&&(rValue=contextFunctions[jKeyUp]);let typeF=propFormat.toLowerCase(),strFormat="";if(-1!=typeF.indexOf(":")&&(typeF=propFormat.substring(propFormat.indexOf(":"),0).toLowerCase().trim(),strFormat=propFormat.substring(propFormat.indexOf(":")+1).trim()),"date"==typeF)""==strFormat&&(strFormat="LL"),rValue="W"==strFormat?AddTimeZone?moment(rValue).locale(flexygo.profiles.culture).format():moment.utc(rValue).locale(flexygo.profiles.culture).format():rValue&&""!=rValue&&moment.utc(rValue).isValid()?AddTimeZone?moment(rValue).locale(flexygo.profiles.culture).format(strFormat):moment.utc(rValue).locale(flexygo.profiles.culture).format(strFormat):"";else if("fromnow"==typeF)rValue&&""!=rValue&&moment.utc(rValue).isValid()&&(rValue=AddTimeZone?moment(rValue).locale(flexygo.profiles.culture).fromNow():moment(moment.utc(rValue).format().split("+")[0]).locale(flexygo.profiles.culture).fromNow());else if("tonow"==typeF)rValue&&""!=rValue&&moment.utc(rValue).isValid()&&(rValue=AddTimeZone?moment(rValue).locale(flexygo.profiles.culture).toNow():moment(moment.utc(rValue).format().split("+")[0]).locale(flexygo.profiles.culture).toNow());else if("decimal"==typeF)rValue&&""!=rValue&&$.isNumeric(rValue)&&(rValue=strFormat&&""!=strFormat?"es-es"==flexygo.profiles.culture.toLowerCase()?parseFloat(parseFloat(rValue).toFixed(strFormat)).toLocaleString("ca-ES",{minimumFractionDigits:strFormat}):parseFloat(parseFloat(rValue).toFixed(strFormat)).toLocaleString(flexygo.profiles.culture,{minimumFractionDigits:strFormat}):"es-es"==flexygo.profiles.culture.toLowerCase()?parseFloat(rValue).toLocaleString("ca-ES"):parseFloat(rValue).toLocaleString(flexygo.profiles.culture));else if("url"==typeF)rValue&&""!=rValue&&(rValue=flexygo.utils.resolveUrl(rValue));else if("switch"==typeF){let found=!1;null==rValue&&(rValue="null");let valuesTemp=strFormat.toString().trim();valuesTemp=(valuesTemp=valuesTemp.substring(1,valuesTemp.length-1)).split(",");let values=new Object;for(let z=0;z<valuesTemp.length;z++){let arrKey=valuesTemp[z].split(":")[0].toString().trim(),arrValue=valuesTemp[z].split(":")[1].toString().trim();values[arrKey]=arrValue}for(let switchvalue in values)if(switchvalue.toLowerCase()==rValue.toString().toLowerCase()){rValue=values[switchvalue],found=!0;break}found||void 0===values.else||"null"==(rValue=values.else)&&(rValue="")}else if("string"==typeF)rValue&&""!=rValue?(rValue=flexygo.string.HTMLtoText(rValue),"lower"==strFormat.toLowerCase()?rValue=rValue.toLowerCase():"upper"==strFormat.toLowerCase()?rValue=rValue.toUpperCase():$.isNumeric(strFormat)&&rValue.length>parseFloat(strFormat)&&(rValue=rValue.substring(0,parseFloat(strFormat))+"..."),rValue=flexygo.utils.parser.replaceAll(rValue,"\n","<br>")):rValue="";else if("isnull"==typeF){let arrFormat=strFormat.split(",");null==rValue||""===rValue||"null"==rValue?rValue=arrFormat[0]:arrFormat.length>1&&(rValue=strFormat.substring(strFormat.indexOf(",")+1))}else if("bool"==typeF){let arrFormat=strFormat.split(",");rValue=void 0!==rValue&&null!=rValue&&rValue&&""!=rValue&&"0"!=rValue&&"false"!=rValue.toString().toLowerCase()&&"null"!=rValue.toString().toLowerCase()?arrFormat[0]:arrFormat.length>1?arrFormat[1]:""}else"value"==typeF?null==rValue&&(rValue=""):"html"==typeF?rValue=escapeHtmlString(rValue):"js"==typeF?rValue=escapeJsString(rValue):"sql"==typeF?rValue=escapeSqltring(rValue):"qr"==typeF&&(rValue=!strFormat||isNaN(strFormat)||isNaN(parseFloat(strFormat))?flexygo.utils.generateQR(rValue):flexygo.utils.generateQR(rValue,parseFloat(strFormat)))}else if("toolbar"==jKey){let module=$(contextFunctions).closest("flx-module")[0];contextFunctions.TemplateToolbarCollection&&contextFunctions.TemplateToolbarCollection[propFormat]&&(rValue=module.getTemplateToolbar(contextFunctions.TemplateToolbarCollection[propFormat].Toolbar,json._objectname,json._objectwhere))}else skipReplace=!0}else{let jKeyUp=marker.substring(2,marker.length-2).trim(),jKey=jKeyUp.toLowerCase();json&&void 0!==json[jKey.toLowerCase()]||contextVars&&void 0!==contextVars[jKey.toLowerCase()]||contextFunctions&&void 0!==contextFunctions[jKeyUp]||"currentdatetime"==jKey||"currentdate"==jKey?"currentdatetime"==jKey?rValue=moment().format("YYYYMMDD HHmmss"):"currentdate"==jKey?rValue=moment().format("YYYYMMDD"):json&&void 0!==json[jKey]&&null!=json[jKey]?rValue=flexygo.utils.parser.getValue(json[jKey]):contextVars&&void 0!==contextVars[jKey]?rValue=contextVars[jKey]:contextFunctions&&void 0!==contextFunctions[jKeyUp]&&(rValue=contextFunctions[jKeyUp]):skipReplace=!0,"string"==typeof rValue&&-1!=rValue.indexOf("/Date")?rValue=moment(rValue).locale(flexygo.profiles.culture).format("LL"):"object"==typeof rValue&&null!=rValue&&rValue.Hours&&(rValue=moment(rValue).utc().format("LTS")),null==rValue&&(rValue="")}skipReplace||(retString=flexygo.utils.parser.replaceAll(retString,marker,rValue))}}return retString},parser.compileTemplate=function(tmp,dataTbl,ctx){let rendered="";if(dataTbl&&dataTbl.length>0){if(tmp.Header&&""!=tmp.Header&&(dataTbl[0]._objectdefaults=tmp.defaults._objectdefaults,rendered+=flexygo.utils.parser.recursiveCompile(dataTbl[0],tmp.Header,ctx)),tmp.Body&&""!=tmp.Body){let lastItem=null;if(dataTbl.length>0){rendered+=flexygo.utils.parser.paintGroupHeader(dataTbl[0],tmp.Groups,ctx);for(let i=0;i<dataTbl.length;i++)dataTbl[i]._objectdefaults=tmp.defaults._objectdefaults,rendered+=flexygo.utils.parser.controlGroup(lastItem,dataTbl[i],tmp.Groups,ctx),rendered+=flexygo.utils.parser.recursiveCompile(dataTbl[i],tmp.Body,ctx),lastItem=dataTbl[i];rendered+=flexygo.utils.parser.paintGroupFooter(dataTbl[dataTbl.length-1],tmp.Groups,ctx)}}tmp.Footer&&""!=tmp.Footer&&(dataTbl[0]._objectdefaults=tmp.defaults._objectdefaults,rendered+=flexygo.utils.parser.recursiveCompile(dataTbl[0],tmp.Footer,ctx))}else tmp.Empty&&""!=tmp.Empty&&(rendered+=flexygo.utils.parser.recursiveCompile(tmp.defaults,tmp.Empty,ctx));return rendered},parser.paintGroupHeader=function(item,groups,ctx){let str="",arrGroups=flexygo.utils.sortObject(groups,"Order");for(let i=0;i<arrGroups.length;i++)void 0!==item[arrGroups[i].GroupField]&&(str+=flexygo.utils.parser.recursiveCompile(item,arrGroups[i].Header,ctx));return str},parser.paintGroupFooter=function(item,groups,ctx){let str="",arrGroups=flexygo.utils.sortObject(groups,"Order");for(let i=arrGroups.length-1;i>=0;i--)void 0!==item[arrGroups[i].GroupField]&&(str+=flexygo.utils.parser.recursiveCompile(item,arrGroups[i].Footer,ctx));return str},parser.controlGroup=function(prev,item,groups,ctx){let str="",arrGroups=flexygo.utils.sortObject(groups,"Order"),lvl=-1;for(let i=0;i<arrGroups.length;i++){let key=arrGroups[i].GroupField;if(void 0!==item[key]&&null!=prev&&void 0!==prev[key]&&prev[key]!=item[key]){lvl=i;break}}if(lvl>-1){for(let i=arrGroups.length-1;i>=lvl;i--)str+=flexygo.utils.parser.recursiveCompile(prev,arrGroups[i].Footer,ctx);for(let i=lvl;i<arrGroups.length;i++)str+=flexygo.utils.parser.recursiveCompile(item,arrGroups[i].Header,ctx)}return str},parser.getValue=function(val,prop){if(null==val)return null;let type=typeof val;return"object"==(type=type.toLocaleLowerCase())?prop?val[prop]:val.Text:val},parser.replaceAll=replaceAll,parser.formatDate=function(value){return value},parser.formatNumber=function(value){return value},parser.formatDecimal=function(value){return value},parser.escapeJsString=escapeJsString,parser.escapeSqltring=escapeSqltring,parser.escapeHtmlString=escapeHtmlString}(utils.parser||(utils.parser={}))}(flexygo.utils||(flexygo.utils={}))}(flexygo||(flexygo={}));