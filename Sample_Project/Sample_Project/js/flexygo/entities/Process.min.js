var flexygo,__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};!function(flexygo){flexygo.Process=class{constructor(processName,objectName,objectWhere){this.objectName=null,this.objectWhere=null,this.processName=null,this.module=null,this.config=null,this.showProgress=!0,this.moreProcesses=!1,this.processName=processName,this.objectName=objectName,this.objectWhere=objectWhere}read(){let ret=!1,params={ProcessName:this.processName};return flexygo.ajax.syncPost("~/api/Process","getProcessInfoByName",params,response=>{this.config=response,ret=!0}),ret}run(processparams,cllback,targetid,excludeHist=!0,triggerElement,lastProcessName){var params={ProcessName:this.processName,ObjectName:this.objectName,ObjectWhere:this.objectWhere,ProcessParams:processparams,LastProcessName:lastProcessName};cllback||(cllback=(response=>__awaiter(this,void 0,void 0,function*(){if(response){if(this.moreProcesses=response.MoreProcesses,response.Refresh&&triggerElement){let cnt=triggerElement.closest(".pageContainer"),parent=cnt.data("opener"),modCol=null;(modCol=parent||cnt).find("flx-module").each((i,e)=>{let wc=$(e)[0];wc.refresh&&wc.refresh()})}let res=!0;if(response.JSCode){let el=this;triggerElement&&triggerElement[0]&&(el=triggerElement[0]);let objTrick=Object,funcParams={processname:this.processName,objectname:this.objectName,objectwhere:this.objectWhere,targetid,excludeHist,triggerElement,currentProcess:this};res=yield flexygo.utils.execAsyncFunction(response.JSCode,objTrick.keys(funcParams),objTrick.values(funcParams)).catch(err=>{throw flexygo.msg.error(flexygo.utils.getErrorMessage(err)),err})}if(response.LastProcessName&&!1!==res?this.run(processparams,cllback,targetid,excludeHist,triggerElement,response.LastProcessName):this.closeLoading(!0),response.MoreProcesses||(response.LastException&&response.LastException.Message?flexygo.msg.error(response.LastException.Message):response.WarningMessage?flexygo.msg.warning(response.WarningMessage):response.SuccessMessage&&flexygo.msg.success(response.SuccessMessage),this.closeLoading()),response.CloseParamWindow&&response.Success&&this.module&&this.module.closeWindow(),response.ClearSelectionBag&&response.Success){let ent=new flexygo.obj.Entity(this.objectName);flexygo.selection.clear(ent.getConfig().ObjectName)}let ev={class:"process",type:"executed",sender:this,masterIdentity:this.processName};flexygo.events.trigger(ev)}}))),flexygo.ajax.post("~/api/Process","execProcessByName",params,cllback,null,()=>{this.closeLoading()},()=>{this.showLoading()})}showLoading(){var title;title=this.config&&this.config.LoadingMessage?this.config.LoadingMessage:flexygo.localization.translate("process.executing"),this.showProgress&&this.config&&[0,1,5,6].includes(this.config.TypeId)&&(this.progressBar=Lobibox.progress({title,closeOnEsc:!1,closeButton:!1,onShow:()=>{this.progressTimer=setInterval(()=>this.moveLoading(),500)}}))}moveLoading(){if(this.progressBar){let actVal=this.progressBar.getProgress();actVal=actVal+1>=100?0:actVal+1,this.progressBar.setProgress(actVal)}}closeLoading(lastProcess=!1){if(this.progressBar&&(clearInterval(this.progressTimer),this.progressTimer=null,this.progressBar.destroy(),this.progressBar=null),lastProcess){this.progressTimer&&clearInterval(this.progressTimer);let lobiboxLoading=$("div.lobibox.lobibox-progress");if(lobiboxLoading.length>0){let lobiboxBackdrop=lobiboxLoading.next();lobiboxBackdrop.length>0&&lobiboxBackdrop.hasClass("lobibox-backdrop")&&lobiboxBackdrop.filter(".lobibox-backdrop").remove(),lobiboxLoading.remove()}}}}}(flexygo||(flexygo={}));