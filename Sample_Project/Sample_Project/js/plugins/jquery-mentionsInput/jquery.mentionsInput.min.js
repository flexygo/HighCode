!function($,_,undefined){var KEY={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},defaultSettings={triggerChar:"@",onDataRequest:$.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!1,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:_.template('<div class="mentions-input-box"></div>'),autocompleteList:_.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:_.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:_.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:_.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:_.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:_.template("@[<%= value %>](<%= type %>:<%= id %>)"),mentionItemHighlight:_.template("<strong><span><%= value %></span></strong>")}},utils={htmlEncode:function(str){return _.escape(str)},regexpEncode:function(str){return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(value,term){return term||term.length?value.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+term+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):value},setCaratPosition:function(domNode,caretPos){if(domNode.createTextRange){var range=domNode.createTextRange();range.move("character",caretPos),range.select()}else domNode.selectionStart?(domNode.focus(),domNode.setSelectionRange(caretPos,caretPos)):domNode.focus()},rtrim:function(string){return string.replace(/\s+$/,"")}},MentionsInput=function(settings){var elmInputBox,elmInputWrapper,elmAutocompleteList,elmWrapperBox,elmMentionsOverlay,elmActiveAutoCompleteItem,mentionsCollection=[],autocompleteItemCollection={},inputBuffer=[],currentDataQuery="";function updateValues(){var syntaxMessage=getInputBoxValue();_.each(mentionsCollection,function(mention){var textSyntax=settings.templates.mentionItemSyntax(mention);syntaxMessage=syntaxMessage.replace(new RegExp(utils.regexpEncode(mention.value),"g"),textSyntax)});var mentionText=utils.htmlEncode(syntaxMessage);_.each(mentionsCollection,function(mention){var formattedMention=_.extend({},mention,{value:utils.htmlEncode(mention.value)}),textSyntax=settings.templates.mentionItemSyntax(formattedMention),textHighlight=settings.templates.mentionItemHighlight(formattedMention);mentionText=mentionText.replace(new RegExp(utils.regexpEncode(textSyntax),"g"),textHighlight)}),mentionText=(mentionText=mentionText.replace(/\n/g,"<br />")).replace(/ {2}/g,"&nbsp; "),elmInputBox.data("messageText",syntaxMessage),elmInputBox.trigger("updated"),elmMentionsOverlay.find("div").html(mentionText)}function resetBuffer(){inputBuffer=[]}function addMention(mention){for(var currentMessage=getInputBoxValue(),caretStart=elmInputBox[0].selectionStart,shortestDistance=!1,bestLastIndex=!1,regex=new RegExp("\\"+settings.triggerChar+currentDataQuery,"gi");regex.exec(currentMessage);)(!1===shortestDistance||Math.abs(regex.lastIndex-caretStart)<shortestDistance)&&(shortestDistance=Math.abs(regex.lastIndex-caretStart),bestLastIndex=regex.lastIndex);var startCaretPosition=bestLastIndex-currentDataQuery.length-1,currentCaretPosition=bestLastIndex,start=currentMessage.substr(0,startCaretPosition),end=currentMessage.substr(currentCaretPosition,currentMessage.length),startEndIndex=(start+mention.value).length+1;_.find(mentionsCollection,function(object){return object.id==mention.id})||mentionsCollection.push(mention),resetBuffer(),currentDataQuery="",hideAutoComplete();var updatedMessageText=start+mention.value+" "+end;elmInputBox.val(updatedMessageText),elmInputBox.trigger("mention"),updateValues(),elmInputBox.focus(),utils.setCaratPosition(elmInputBox[0],startEndIndex)}function getInputBoxValue(){return $.trim(elmInputBox.val())}function onAutoCompleteItemClick(e){var elmDistanceFromTop,bodyDistanceFromTop,elmTarget=$(this);return addMention(autocompleteItemCollection[elmTarget.attr("data-uid")]),elmDistanceFromTop=$(elmInputBox).offset().top,bodyDistanceFromTop=$("body").offset().top,$(window).scrollTop()>elmDistanceFromTop&&$(window).scrollTop(elmDistanceFromTop-bodyDistanceFromTop),!1}function onInputBoxClick(e){resetBuffer()}function onInputBoxBlur(e){hideAutoComplete()}function onInputBoxInput(e){var inputText;updateValues(),inputText=getInputBoxValue(),mentionsCollection=_.reject(mentionsCollection,function(mention,index){return!mention.value||-1==inputText.indexOf(mention.value)}),mentionsCollection=_.compact(mentionsCollection);var triggerCharIndex=_.lastIndexOf(inputBuffer,settings.triggerChar);triggerCharIndex>-1&&(currentDataQuery=inputBuffer.slice(triggerCharIndex+1).join(""),currentDataQuery=utils.rtrim(currentDataQuery),_.defer(_.bind(doSearch,this,currentDataQuery)))}function onInputBoxKeyPress(e){if(e.keyCode!==KEY.BACKSPACE){var typedValue=String.fromCharCode(e.which||e.keyCode);inputBuffer.push(typedValue)}}function onInputBoxKeyDown(e){if(e.keyCode===KEY.LEFT||e.keyCode===KEY.RIGHT||e.keyCode===KEY.HOME||e.keyCode===KEY.END)return _.defer(resetBuffer),void(navigator.userAgent.indexOf("MSIE 9")>-1&&_.defer(updateValues));if(e.keyCode!==KEY.BACKSPACE){if(!elmAutocompleteList.is(":visible"))return!0;switch(e.keyCode){case KEY.UP:case KEY.DOWN:var elmCurrentAutoCompleteItem=null;return(elmCurrentAutoCompleteItem=e.keyCode===KEY.DOWN?elmActiveAutoCompleteItem&&elmActiveAutoCompleteItem.length?elmActiveAutoCompleteItem.next():elmAutocompleteList.find("li").first():$(elmActiveAutoCompleteItem).prev()).length&&selectAutoCompleteItem(elmCurrentAutoCompleteItem),!1;case KEY.RETURN:case KEY.TAB:if(elmActiveAutoCompleteItem&&elmActiveAutoCompleteItem.length)return elmActiveAutoCompleteItem.trigger("mousedown"),!1}return!0}inputBuffer=inputBuffer.slice(0,-1+inputBuffer.length)}function hideAutoComplete(){elmActiveAutoCompleteItem=null,elmAutocompleteList.empty().hide()}function selectAutoCompleteItem(elmItem){elmItem.addClass(settings.classes.autoCompleteItemActive),elmItem.siblings().removeClass(settings.classes.autoCompleteItemActive),elmActiveAutoCompleteItem=elmItem}function populateDropdown(query,results){if(elmAutocompleteList.show(),!settings.allowRepeat){var mentionValues=_.pluck(mentionsCollection,"value");results=_.reject(results,function(item){return _.include(mentionValues,item.name)})}if(results.length){elmAutocompleteList.empty();var elmDropDownList=$("<ul>").appendTo(elmAutocompleteList).hide();_.each(results,function(item,index){var itemUid=_.uniqueId("mention_");autocompleteItemCollection[itemUid]=_.extend({},item,{value:item.name});var elmListItem=$(settings.templates.autocompleteListItem({id:utils.htmlEncode(item.id),display:utils.htmlEncode(item.name),type:utils.htmlEncode(item.type),content:utils.highlightTerm(utils.htmlEncode(item.display?item.display:item.name),query)})).attr("data-uid",itemUid);(0===index&&selectAutoCompleteItem(elmListItem),settings.showAvatars)&&(item.icon?$(settings.templates.autocompleteListItemIcon({icon:item.icon})):$(settings.templates.autocompleteListItemAvatar({avatar:item.avatar,display:item.name}))).prependTo(elmListItem);elmListItem=elmListItem.appendTo(elmDropDownList)}),elmAutocompleteList.show(),settings.onCaret&&function(elmAutocompleteList,elmInputBox){var elmAutocompleteListPosition=elmAutocompleteList.css("position");if("absolute"==elmAutocompleteListPosition){var position=function($el){var a,b,c,d,e,f,g,h,i,j,k;if((i=$el[0])&&$(i).is("textarea")&&null!=i.selectionEnd){for(g={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},j=0,k=(h=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;j<k;j++)g[e=h[j]]=$(i).css(e);return c=document.createElement("div"),$(c).css(g),$(i).after(c),b=document.createTextNode(i.value.substring(0,i.selectionEnd)),a=document.createTextNode(i.value.substring(i.selectionEnd)),(d=document.createElement("span")).innerHTML="&nbsp;",c.appendChild(b),c.appendChild(d),c.appendChild(a),c.scrollTop=i.scrollTop,f=$(d).position(),$(c).remove(),f}}(elmInputBox),lineHeight=parseInt(elmInputBox.css("line-height"),10)||18;elmAutocompleteList.css("width","15em"),elmAutocompleteList.css("left",position.left),elmAutocompleteList.css("top",lineHeight+position.top);var elmInputBoxRight=elmInputBox.offset().left+elmInputBox.width(),elmAutocompleteListRight=elmAutocompleteList.offset().left+elmAutocompleteList.width();elmInputBoxRight<=elmAutocompleteListRight&&elmAutocompleteList.css("left",Math.abs(elmAutocompleteList.position().left-(elmAutocompleteListRight-elmInputBoxRight)))}else if("fixed"==elmAutocompleteListPosition){var offset=function($el){var a,b,c,d,e,f,g,h,i,j,k;if((i=$el[0])&&$(i).is("textarea")&&null!=i.selectionEnd){for(g={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},j=0,k=(h=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;j<k;j++)g[e=h[j]]=$(i).css(e);return c=document.createElement("div"),$(c).css(g),$(i).after(c),b=document.createTextNode(i.value.substring(0,i.selectionEnd)),a=document.createTextNode(i.value.substring(i.selectionEnd)),(d=document.createElement("span")).innerHTML="&nbsp;",c.appendChild(b),c.appendChild(d),c.appendChild(a),c.scrollTop=i.scrollTop,f=$(d).offset(),$(c).remove(),f}}(elmInputBox),lineHeight=parseInt(elmInputBox.css("line-height"),10)||18;elmAutocompleteList.css("width","15em"),elmAutocompleteList.css("left",offset.left+1e4),elmAutocompleteList.css("top",lineHeight+offset.top)}}(elmAutocompleteList,elmInputBox),elmDropDownList.show()}else hideAutoComplete()}function doSearch(query){query&&query.length&&query.length>=settings.minChars?settings.onDataRequest.call(this,"search",query,function(responseData){populateDropdown(query,responseData)}):hideAutoComplete()}function resetInput(currentVal){mentionsCollection=[];for(var match,mentionText=utils.htmlEncode(currentVal),regex=new RegExp("("+settings.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),newMentionText=mentionText;null!=(match=regex.exec(mentionText));)newMentionText=newMentionText.replace(match[0],match[2]),mentionsCollection.push({id:match[4],type:match[3],value:match[2],trigger:match[1]});elmInputBox.val(newMentionText),updateValues()}return settings=$.extend(!0,{},defaultSettings,settings),{init:function(domTarget){"true"!==(elmInputBox=$(domTarget)).attr("data-mentions-input")&&(elmInputWrapper=elmInputBox.parent(),elmWrapperBox=$(settings.templates.wrapper()),elmInputBox.wrapAll(elmWrapperBox),elmWrapperBox=elmInputWrapper.find("> div.mentions-input-box"),elmInputBox.attr("data-mentions-input","true"),elmInputBox.bind("keydown",onInputBoxKeyDown),elmInputBox.bind("keypress",onInputBoxKeyPress),elmInputBox.bind("click",onInputBoxClick),elmInputBox.bind("blur",onInputBoxBlur),navigator.userAgent.indexOf("MSIE 8")>-1?elmInputBox.bind("propertychange",onInputBoxInput):elmInputBox.bind("input",onInputBoxInput),settings.elastic&&elmInputBox.elastic()),(elmAutocompleteList=$(settings.templates.autocompleteList())).appendTo(elmWrapperBox),elmAutocompleteList.delegate("li","mousedown",onAutoCompleteItemClick),(elmMentionsOverlay=$(settings.templates.mentionsOverlay())).prependTo(elmWrapperBox),resetInput(settings.defaultValue),settings.prefillMention&&addMention(settings.prefillMention)},val:function(callback){_.isFunction(callback)&&callback.call(this,mentionsCollection.length?elmInputBox.data("messageText"):getInputBoxValue())},reset:function(){resetInput()},resetValue:function(defaultValue){resetInput(defaultValue)},reinit:function(){resetInput(!1)},getMentions:function(callback){_.isFunction(callback)&&callback.call(this,mentionsCollection)}}};$.fn.mentionsInput=function(method,settings){var outerArguments=arguments;return"object"!=typeof method&&method||(settings=method),this.each(function(){var instance=$.data(this,"mentionsInput")||$.data(this,"mentionsInput",new MentionsInput(settings));return _.isFunction(instance[method])?instance[method].apply(this,Array.prototype.slice.call(outerArguments,1)):"object"!=typeof method&&method?void $.error("Method "+method+" does not exist"):instance.init.call(this,this)})}}(jQuery,_);